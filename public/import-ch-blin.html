<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importer danych CH Blin√≥w ‚Üí Supabase</title>
    <!-- Supabase Client - import map + ESM module -->
    <script type="importmap">
    {
      "imports": {
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
    </script>
    <script type="module">
      import { createClient } from '@supabase/supabase-js'
      window.createSupabaseClient = createClient
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            min-height: 300px;
            resize: vertical;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .message {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
            display: block;
        }
        
        .message.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
            display: block;
        }
        
        .field-mapping {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .mapping-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .mapping-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .mapping-item select,
        .mapping-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .hint {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #1976d2;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì• Importer danych CH Blin√≥w</h1>
            <p>Zaimportuj dane genealogiczne do Genealog Indexer'a</p>
        </div>
        
        <div class="content">
            <!-- KROK 1: Wklejenie danych -->
            <div class="section">
                <h2>1Ô∏è‚É£ Wklej dane z CH BLIN.txt</h2>
                <textarea id="sourceData" placeholder="Wklej tutaj zawarto≈õƒá CH BLIN.txt (Tab-separated)..."></textarea>
                <button class="btn-primary" onclick="parseData()">üìä Przeanalizuj dane</button>
                <button class="btn-secondary" onclick="clearInput()">üßπ Wyczy≈õƒá</button>
                <div id="message" class="message"></div>
            </div>
            
            <!-- KROK 2: Mapowanie kolumn -->
            <div class="section" id="mappingSection" style="display: none;">
                <h2>2Ô∏è‚É£ Mapowanie kolumn</h2>
                <div class="hint">
                    ‚úì System automatycznie wykry≈Ç nag≈Ç√≥wki. Je≈õli potrzebujesz dostosowaƒá mapowanie, zmie≈Ñ warto≈õci poni≈ºej.
                </div>
                <div class="field-mapping" id="mappingControls"></div>
            </div>
            
            <!-- KROK 3: PodglƒÖd -->
            <div class="section" id="previewSection" style="display: none;">
                <h2>3Ô∏è‚É£ PodglƒÖd danych</h2>
                <div class="stats" id="statsContainer"></div>
                <div class="table-wrapper">
                    <table>
                        <thead id="previewHead"></thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- KROK 4: Export -->
            <div class="section" id="exportSection" style="display: none;">
                <h2>4Ô∏è‚É£ Eksportuj dane</h2>
                <p style="margin-bottom: 15px;">Wybierz format eksportu:</p>
                <button class="btn-success" onclick="exportAsJSON()">üíæ Export JSON (do localStorage)</button>
                <button class="btn-success" onclick="exportAsCSV()">üìã Export CSV</button>
                <button class="btn-success" onclick="exportAsSupabase()">üöÄ Export do Supabase</button>
                <button class="btn-primary" onclick="downloadToIndexer()">üéØ Za≈Çaduj do Indexer'a</button>
                <button class="btn-secondary" onclick="checkImporterLocalStorage()" style="margin-left: 10px;">üîç Sprawd≈∫ localStorage</button>
                <button class="btn-secondary" onclick="showDebugData()" style="margin-left: 10px;">üêõ Debug: Poka≈º dane</button>
                
                <!-- Pasek postƒôpu -->
                <div id="progressContainer" style="display: none; margin-top: 20px;">
                    <h3>üìä Postƒôp eksportu</h3>
                    <div style="background: #333; border-radius: 5px; overflow: hidden; height: 30px; margin: 10px 0;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #0f0, #0f0); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold; font-size: 12px;"></div>
                    </div>
                    <div id="progressText" style="color: #0f0; font-size: 14px; text-align: center;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Supabase configuration
        var SUPABASE_URL = 'https://jbwkrconzozhgzikabmv.supabase.co';
        var SUPABASE_KEY = 'sb_publishable_X0Qm9TSqq0nOOtCo8RycMQ_PeirqbMt';
        var supabase = null;

        // Get or create supabase instance
        async function getSupabaseClient() {
            // Najpierw sprawd≈∫ czy supabase JU≈ª jest inicjalizowany
            if (supabase && typeof supabase.from === 'function') {
                return supabase;
            }
            
            if (!supabase) {
                if (window.createSupabaseClient && typeof window.createSupabaseClient === 'function') {
                    console.log('üîç Calling createSupabaseClient (ESM import)...');
                    supabase = window.createSupabaseClient(SUPABASE_URL, SUPABASE_KEY);
                    
                    console.log('üîç After createSupabaseClient, supabase.from exists?', 'from' in supabase);
                    console.log('üîç supabase type:', typeof supabase);
                    
                    if (supabase && typeof supabase.from === 'function') {
                        console.log('‚úÖ Supabase client created successfully!');
                        return supabase;
                    } else {
                        console.error('‚ùå createSupabaseClient nie zwr√≥ci≈Ç obiektu z metodƒÖ from');
                        return null;
                    }
                } else {
                    console.error('‚ùå window.createSupabaseClient not available');
                    return null;
                }
            }
            return supabase;
        }

        // Initialize Supabase when library is loaded
        function initSupabase() {
            supabase = getSupabaseClient();
            if (supabase) {
                console.log('‚úÖ Supabase initialized');
                console.log('  supabase.from:', typeof supabase.from);
            }
        }

        // Wait for supabase to be ready
        async function waitForSupabase(timeout = 10000) {
            const startTime = Date.now();
            while (!window.createSupabaseClient) {
                if (Date.now() - startTime > timeout) {
                    console.error('‚ùå Timeout waiting for createSupabaseClient');
                    return false;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            console.log('‚úÖ createSupabaseClient ready');
            return true;
        }

        // Try to init immediately and on load
        if (document.readyState === 'loading') {
            window.addEventListener('load', async () => {
                await waitForSupabase();
                initSupabase();
            });
        } else {
            waitForSupabase().then(() => initSupabase());
        }

        let parsedData = [];
        let columnHeaders = [];
        let fieldMapping = {
            record_id: 'ID',                          // ‚úì Identyfikator aktu
            christening_year: 'ROK',                  // ‚úì Rok
            christening_act_number: 'NR.',            // ‚úì Numer aktu (UPPERCASE, bez spacji)
            child_last_name: 'NAZWISKO',              // ‚úì Nazwisko dziecka (UPPERCASE)
            child_first_name: 'IMIƒò',                 // ‚úì Imiƒô dziecka (UPPERCASE)
            child_location: 'MIEJSCOWO≈öƒÜ',            // ‚úì Miejscowo≈õƒá (UPPERCASE)
            father_first_name: 'IMIƒòO',               // ‚úì Imiƒô ojca (UPPERCASE, bez spacji)
            father_last_name: 'NAZWISKOO',            // ‚úì Nazwisko ojca (UPPERCASE)
            father_age: 'WO',                         // ‚úì Wiek ojca (UPPERCASE)
            mother_first_name: 'IM',                  // ‚úì Imiƒô matki
            mother_last_name: 'NM',                   // ‚úì Nazwisko matki
            mother_age: 'WM',                         // ‚úì Wiek matki (UPPERCASE)
            notes: 'UWAGI',                           // ‚úì Uwagi (UPPERCASE)
            notes_org: 'UWAGI ORG'                    // ‚úì Uwagi organizacyjne
        };
        
        function showMessage(text, type = 'info') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
        }
        
        function notify(message, type = 'info') {
            showMessage(message, type);
        }
        
        function parseData() {
            const sourceText = document.getElementById('sourceData').value.trim();
            
            if (!sourceText) {
                showMessage('‚ùå Wklej dane przed analizƒÖ', 'error');
                return;
            }
            
            try {
                const lines = sourceText.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 2) {
                    showMessage('‚ùå Minimum 2 linie wymagane (nag≈Ç√≥wek + dane)', 'error');
                    return;
                }
                
                // Parse headers - UPPERCASE + trim dla sp√≥jno≈õci
                columnHeaders = lines[0].split('\t').map(h => h.trim().toUpperCase());
                console.log('üìã Found headers (normalized):', columnHeaders);
                console.log('üìã Field mapping:', fieldMapping);
                
                // Debug: poka≈º jakie kolumny znaleziono i czy siƒô mapujƒÖ
                let debugMsg = 'üîç Znalezione kolumny:\n';
                columnHeaders.forEach(col => {
                    const mapped = Object.entries(fieldMapping).find(([k, v]) => v === col);
                    debugMsg += `  ‚Ä¢ "${col}" ${mapped ? `‚úÖ ‚Üí ${mapped[0]}` : '‚ùå niezmapowana'}\n`;
                });
                console.log(debugMsg);
                
                // Parse data rows
                parsedData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split('\t');
                    if (values.length > 0 && values[0].trim()) {
                        parsedData.push(values);
                    }
                }
                
                showMessage(`‚úÖ Wczytano ${parsedData.length} rekord√≥w z ${columnHeaders.length} kolumnami`, 'success');
                
                // Show next steps
                document.getElementById('mappingSection').style.display = 'block';
                document.getElementById('previewSection').style.display = 'block';
                document.getElementById('exportSection').style.display = 'block';
                
                renderMapping();
                renderPreview();
                
            } catch (error) {
                showMessage(`‚ùå B≈ÇƒÖd: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function renderMapping() {
            const container = document.getElementById('mappingControls');
            container.innerHTML = '';
            
            const fields = [
                { key: 'record_id', label: 'üÜî Identyfikator aktu', required: true },
                { key: 'christening_year', label: 'üìÖ Rok chrztu', required: true },
                { key: 'christening_act_number', label: 'üî¢ Numer aktu', required: true },
                { key: 'child_first_name', label: 'üë∂ Imiƒô dziecka', required: true },
                { key: 'child_last_name', label: 'üë∂ Nazwisko dziecka', required: true },
                { key: 'child_location', label: 'üìç Miejscowo≈õƒá dziecka', required: false },
                { key: 'father_first_name', label: 'üë® Imiƒô ojca', required: true },
                { key: 'father_last_name', label: 'üë® Nazwisko ojca', required: true },
                { key: 'father_age', label: 'üë® Wiek ojca', required: false },
                { key: 'mother_first_name', label: 'üë© Imiƒô matki', required: true },
                { key: 'mother_last_name', label: 'üë© Nazwisko matki', required: true },
                { key: 'mother_age', label: 'üë© Wiek matki', required: false },
                { key: 'notes', label: 'üìù Uwagi/Notatki', required: false },
                { key: 'notes_org', label: 'üìã Uwagi organizacyjne', required: false }
            ];
            
            fields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'mapping-item';
                const required = field.required ? '‚ö†Ô∏è Wymagane' : 'Opcjonalne';
                div.innerHTML = `
                    <label>${field.label} <span style="font-size: 0.8em; color: #999;">${required}</span></label>
                    <select onchange="updateMapping('${field.key}', this.value)">
                        <option value="">-- Nie mapuj --</option>
                        ${columnHeaders.map((h, i) => `<option value="${h}" ${fieldMapping[field.key] === h ? 'selected' : ''}>${h}</option>`).join('')}
                    </select>
                `;
                container.appendChild(div);
            });
        }
        
        function updateMapping(fieldKey, columnName) {
            // Normalize: uppercase i trim
            fieldMapping[fieldKey] = columnName ? columnName.trim().toUpperCase() : null;
            renderPreview();
        }
        
        function renderPreview() {
            const previewHead = document.getElementById('previewHead');
            const previewBody = document.getElementById('previewBody');
            const statsContainer = document.getElementById('statsContainer');
            
            previewHead.innerHTML = '<tr><th>#</th><th>ID</th><th>Imiƒô</th><th>Nazwisko</th><th>Rok</th><th>Nr.</th><th>Miejsc.</th><th>Ojciec</th><th>Wiek O</th><th>Matka</th><th>Wiek M</th><th>Uwagi</th><th>Uwagi org</th></tr>';
            previewBody.innerHTML = '';
            
            let validCount = 0;
            let filledCount = 0;
            
            const getColValue = (row, key) => {
                const colName = fieldMapping[key];
                if (!colName) return '';
                const colIdx = columnHeaders.indexOf(colName);
                return colIdx >= 0 ? (row[colIdx] || '').trim() : '';
            };
            
            parsedData.slice(0, 100).forEach((row, idx) => {
                const id = getColValue(row, 'record_id');
                const firstName = getColValue(row, 'child_first_name');
                const lastName = getColValue(row, 'child_last_name');
                const year = getColValue(row, 'christening_year');
                const num = getColValue(row, 'christening_act_number');
                const location = getColValue(row, 'child_location');
                const fatherFirstName = getColValue(row, 'father_first_name');
                const fatherLastName = getColValue(row, 'father_last_name');
                const fatherAge = getColValue(row, 'father_age');
                const motherFirstName = getColValue(row, 'mother_first_name');
                const motherLastName = getColValue(row, 'mother_last_name');
                const motherAge = getColValue(row, 'mother_age');
                const notes = getColValue(row, 'notes');
                const notesOrg = getColValue(row, 'notes_org');
                
                if (firstName || lastName) validCount++;
                if (firstName && lastName && year) filledCount++;
                
                const fatherName = (fatherFirstName + ' ' + fatherLastName).trim();
                const motherName = (motherFirstName + ' ' + motherLastName).trim();
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${idx + 1}</td>
                    <td style="font-size: 0.8em; color: #0078d4;">${id}</td>
                    <td>${firstName}</td>
                    <td><strong>${lastName}</strong></td>
                    <td style="text-align: center;">${year}</td>
                    <td style="text-align: center;">${num}</td>
                    <td style="font-size: 0.85em;">${location}</td>
                    <td style="font-size: 0.85em;">${fatherName}</td>
                    <td style="text-align: center;">${fatherAge}</td>
                    <td style="font-size: 0.85em;">${motherName}</td>
                    <td style="text-align: center;">${motherAge}</td>
                    <td style="font-size: 0.8em; color: #666;">${notes}</td>
                    <td style="font-size: 0.8em; color: #999;">${notesOrg}</td>
                `;
                previewBody.appendChild(tr);
            });
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${parsedData.length}</div>
                    <div class="stat-label">Razem rekord√≥w</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${validCount}</div>
                    <div class="stat-label">Z imieniem/nazwiskiem</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${filledCount}</div>
                    <div class="stat-label">Kompletne (3+ pola)</div>
                </div>
            `;
        }
        
        function convertToIndexerFormat() {
            const acts = [];
            
            parsedData.forEach((row, idx) => {
                // Mapuj wszystkie kolumny
                const getColValue = (key) => {
                    const colName = fieldMapping[key];
                    if (!colName) return '';
                    const colIdx = columnHeaders.indexOf(colName);
                    return colIdx >= 0 ? (row[colIdx] || '').trim() : '';
                };
                
                const recordId = getColValue('record_id');
                const firstName = getColValue('child_first_name');
                const lastName = getColValue('child_last_name');
                
                if (!firstName && !lastName) return; // Skip empty rows
                
                const act = {
                    id: recordId || `CH.LUB.BLIN.${idx}`,
                    imageIdx: 0,
                    actNum: idx + 1,
                    type: 'christening',
                    timestamp: new Date().toISOString(),
                    fieldValues: {
                        // Metadane
                        christening_year: getColValue('christening_year'),
                        christening_act_number: getColValue('christening_act_number'),
                        
                        // Dziecko
                        child_first_name: firstName,
                        child_last_name: lastName,
                        child_birth_date: getColValue('child_location'),
                        
                        // Ojciec
                        father_first_name: getColValue('father_first_name'),
                        father_last_name: getColValue('father_last_name'),
                        father_age: getColValue('father_age'),
                        father_info: `${getColValue('father_first_name')} ${getColValue('father_last_name')}, wiek: ${getColValue('father_age')}`,
                        
                        // Matka
                        mother_first_name: getColValue('mother_first_name'),
                        mother_last_name: getColValue('mother_last_name'),
                        mother_age: getColValue('mother_age'),
                        mother_maiden_name: '',
                        mother_info: `${getColValue('mother_first_name')} ${getColValue('mother_last_name')}, wiek: ${getColValue('mother_age')}`,
                        
                        // Inne
                        christening_registration_date: '',
                        christening_name: '',
                        reporter_info: '',
                        witness1_info: '',
                        witness2_info: '',
                        notes: getColValue('notes'),
                        notes_org: getColValue('notes_org')
                    },
                    fieldROIs: {},
                    actROI: null
                };
                
                acts.push(act);
            });
            
            return acts;
        }
        
        function exportAsJSON() {
            const acts = convertToIndexerFormat();
            const data = {
                imageActs: acts,
                timestamp: new Date().toISOString(),
                source: 'CH_BLIN_IMPORT',
                recordCount: acts.length
            };
            
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, 'CH_BLIN_IMPORT.json', 'application/json');
            showMessage(`‚úÖ Eksportowano ${acts.length} akt√≥w do JSON`, 'success');
        }
        
        function exportAsCSV() {
            let csv = 'ID,Imiƒô dziecka,Nazwisko dziecka,Rok,Nr.,Miejscowo≈õƒá,Imiƒô ojca,Nazwisko ojca,Wiek ojca,Imiƒô matki,Nazwisko matki,Wiek matki,Uwagi,Uwagi org\n';
            
            const getColValue = (row, key) => {
                const colName = fieldMapping[key];
                if (!colName) return '';
                const colIdx = columnHeaders.indexOf(colName);
                return colIdx >= 0 ? (row[colIdx] || '').trim() : '';
            };
            
            parsedData.forEach(row => {
                const id = getColValue(row, 'record_id');
                const firstName = getColValue(row, 'child_first_name');
                const lastName = getColValue(row, 'child_last_name');
                const year = getColValue(row, 'christening_year');
                const num = getColValue(row, 'christening_act_number');
                const location = getColValue(row, 'child_location');
                const fatherFirstName = getColValue(row, 'father_first_name');
                const fatherLastName = getColValue(row, 'father_last_name');
                const fatherAge = getColValue(row, 'father_age');
                const motherFirstName = getColValue(row, 'mother_first_name');
                const motherLastName = getColValue(row, 'mother_last_name');
                const motherAge = getColValue(row, 'mother_age');
                const notes = getColValue(row, 'notes');
                const notesOrg = getColValue(row, 'notes_org');
                
                csv += `"${id}","${firstName}","${lastName}","${year}","${num}","${location}","${fatherFirstName}","${fatherLastName}","${fatherAge}","${motherFirstName}","${motherLastName}","${motherAge}","${notes}","${notesOrg}"\n`;
            });
            
            downloadFile(csv, 'CH_BLIN_IMPORT.csv', 'text/csv;charset=utf-8');
            showMessage(`‚úÖ Eksportowano do CSV`, 'success');
        }
        
        async function exportAsSupabase() {
            console.log('üöÄ exportAsSupabase called');
            const acts = convertToIndexerFormat();
            
            // Czekaj a≈º biblioteka siƒô za≈Çaduje
            const libReady = await waitForSupabase(5000);
            if (!libReady) {
                showMessage('‚ùå Supabase library timeout - spr√≥buj ponownie', 'error');
                return;
            }
            
            // Inicjalizuj je≈õli jeszcze nie
            if (!supabase) {
                console.log('‚è≥ Inicjalizujƒô Supabase...');
                initSupabase();
            }
            
            if (!supabase) {
                console.error('‚ùå Supabase client undefined');
                showMessage('‚ùå Supabase nie jest dostƒôpny - czekaj chwilƒô i spr√≥buj ponownie', 'error');
                return;
            }
            
            try {
                console.log('üì§ Wysy≈Çanie ' + acts.length + ' akt√≥w do Supabase...');
                showMessage('‚è≥ Wysy≈Çanie do Supabase...', 'info');
                
                // U≈ºyj sendActualData() kt√≥ra obs≈Çuguje batching
                await sendActualData(acts);
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                showMessage(`‚ùå B≈ÇƒÖd: ${error.message}`, 'error');
            }
        }
        
        function downloadToIndexer() {
            console.log('üéØ downloadToIndexer called');
            const acts = convertToIndexerFormat();
            console.log('üìä Converted acts:', acts.length);
            
            const jsonStr = JSON.stringify({
                imageActs: acts,
                timestamp: new Date().toISOString()
            });
            const sizeKB = (jsonStr.length / 1024).toFixed(1);
            
            console.log(`üìä Data size: ${sizeKB} KB`);
            
            // Je≈õli dane sƒÖ ma≈Çe (<4MB), zapisz do localStorage
            if (jsonStr.length < 4000000) {
                console.log('‚úÖ Data fits in localStorage, saving...');
                try {
                    const existing = JSON.parse(localStorage.getItem('genealog_data') || '{}');
                    const merged = {
                        ...existing,
                        imageActs: [...(existing.imageActs || []), ...acts]
                    };
                    localStorage.setItem('genealog_data', JSON.stringify(merged));
                    console.log('üíæ Saved to localStorage, total acts:', merged.imageActs.length);
                    showMessage(`‚úÖ Za≈Çadowano ${acts.length} akt√≥w do localStorage (${sizeKB} KB)!\n\n‚è≠Ô∏è Otw√≥rz viewer-osd-v8.11.html`, 'success');
                } catch (error) {
                    console.error('‚ùå localStorage error:', error);
                    showMessage(`‚ö†Ô∏è localStorage error: ${error.message}\n\nWysy≈Çam do Firestore zamiast...`, 'error');
                    sendToFirestore(acts);
                }
            } else {
                // Dane za du≈ºe na localStorage - wy≈õlij do Firestore
                console.log(`‚ö†Ô∏è Data too large for localStorage (${sizeKB} KB), sending to Firestore...`);
                showMessage(`üì§ Dane za du≈ºe na localStorage (${sizeKB} KB)\n\nWysy≈Çam bezpo≈õrednio do Firestore...`, 'info');
                sendToFirestore(acts);
            }
        }
        
        function sendToFirestore(acts) {
            if (!db) {
                showMessage('‚ùå Firebase nie dostƒôpny', 'error');
                return;
            }
            
            console.log('üî• Sending ' + acts.length + ' acts to Firestore...');
            console.log('üìç Collection: public_imports');
            showMessage(`üì§ Wysy≈Çam ${acts.length} akt√≥w do Firestore...\n\nTo mo≈ºe potrwaƒá kilka sekund...`, 'info');
            
            // Test - wy≈õlij jeden dokument na test
            const testDoc = db.collection('public_imports').doc('_test_' + Date.now());
            testDoc.set({
                test: true,
                timestamp: new Date().toISOString()
            })
            .then(() => {
                console.log('‚úÖ Test write succeeded!');
                testDoc.delete(); // Usu≈Ñ test doc
                sendActualData(acts);
            })
            .catch(error => {
                console.error('‚ùå Test write failed:', error);
                showMessage(
                    `‚ùå Nie mogƒô pisaƒá do Firestore!\n\n` +
                    `B≈ÇƒÖd: ${error.message}\n\n` +
                    `Sprawd≈∫:\n` +
                    `1. Firebase Console ‚Üí Security Rules\n` +
                    `2. Czy public_imports collection jest dostƒôpna?\n` +
                    `3. Czy masz internet?\n\n` +
                    `Fallback: Pobieranie jako JSON...`,
                    'error'
                );
                // Fallback - pobierz JSON
                const json = JSON.stringify({
                    imageActs: acts,
                    timestamp: new Date().toISOString(),
                    source: 'CH_BLIN_IMPORT'
                }, null, 2);
                downloadFile(json, 'CH_BLIN_IMPORT.json', 'application/json');
            });
        }
        
        async function sendActualData(acts) {
            console.log('üì• Sending actual data to Supabase... ilo≈õƒá akt√≥w:', acts.length);
            
            // Poka≈º pasek postƒôpu
            document.getElementById('progressContainer').style.display = 'block';
            
            // Czekaj a≈º biblioteka bƒôdzie dostƒôpna
            const libReady = await waitForSupabase(5000);
            if (!libReady) {
                console.error('‚ùå Supabase library nie za≈Çadowa≈Ça siƒô');
                showMessage('‚ùå Supabase library timeout', 'error');
                return;
            }
            
            // Pobierz client (teraz asynchronicznie)
            const client = await getSupabaseClient();
            if (!client) {
                console.error('‚ùå Nie mogƒô utworzyƒá Supabase client');
                showMessage('‚ùå Supabase client creation failed', 'error');
                return;
            }
            
            if (typeof client.from !== 'function') {
                console.error('‚ùå client.from is not a function. client:', client);
                console.error('  client keys:', Object.keys(client || {}));
                showMessage('‚ùå Supabase client.from is not available', 'error');
                return;
            }
            
            const totalActs = acts.length;
            const batchId = Date.now();
            const batchSize = 100; // Supabase batch size (RLS friendly)
            
            let processedCount = 0;
            let errorCount = 0;
            
            // Podziel na mniejsze batche
            for (let batchStart = 0; batchStart < totalActs; batchStart += batchSize) {
                const batchEnd = Math.min(batchStart + batchSize, totalActs);
                const batchActsSlice = acts.slice(batchStart, batchEnd);
                
                // Przygotuj dane do wstawienia - FLAT STRUCTURE dla Supabase
                const dataToInsert = batchActsSlice.map((act, idx) => {
                    const row = {
                        // Zawsze wygeneruj unikalny ID aby uniknƒÖƒá duplikat√≥w (PK)
                        // Format: CH.BLIN.TIMESTAMP.GLOBAL_INDEX
                        id: `CH.BLIN.${batchId}.${String(batchStart + idx).padStart(5, '0')}`,
                        // Przechowaj oryginalne ID z danych
                        original_id: act.id,
                        source: 'CH_BLIN',
                        
                        // fieldValues - rozpakuj do p≈Çaskiej struktury
                        christening_year: act.fieldValues?.christening_year,
                        christening_act_number: act.fieldValues?.christening_act_number,
                        child_first_name: act.fieldValues?.child_first_name,
                        child_last_name: act.fieldValues?.child_last_name,
                        child_birth_date: act.fieldValues?.child_birth_date,
                        father_first_name: act.fieldValues?.father_first_name,
                        father_last_name: act.fieldValues?.father_last_name,
                        father_age: act.fieldValues?.father_age,
                        mother_first_name: act.fieldValues?.mother_first_name,
                        mother_last_name: act.fieldValues?.mother_last_name,
                        mother_age: act.fieldValues?.mother_age,
                        notes: act.fieldValues?.notes,
                        notes_org: act.fieldValues?.notes_org,
                        location: act.fieldValues?.location || act.fieldValues?.child_birth_date
                    };
                    
                    // Usu≈Ñ undefined i null warto≈õci aby mieƒá czystsze inserty
                    Object.keys(row).forEach(key => {
                        if (row[key] === undefined || row[key] === null || row[key] === '') {
                            delete row[key];
                        }
                    });
                    
                    return row;
                });
                
                console.log(`üì¶ Batch ${batchStart/batchSize + 1}: ${batchActsSlice.length} rekord√≥w`);
                console.log('üì§ Wysy≈Çane dane (pierwsze 2):', dataToInsert.slice(0, 2));
                
                // Wy≈õlij do Supabase
                const { data, error } = await client
                    .from('public_imports')
                    .insert(dataToInsert);
                
                if (error) {
                    console.error(`‚ùå Batch error (${batchStart}-${batchEnd}):`, error);
                    console.error('   Details:', error.details);
                    console.error('   Message:', error.message);
                    console.error('   Code:', error.code);
                    console.error('   Hint:', error.hint);
                    errorCount++;
                    showMessage(`‚ùå B≈ÇƒÖd batch: ${error.message}\n\nCode: ${error.code}\nDetails: ${error.details}`, 'error');
                } else {
                    processedCount += batchActsSlice.length;
                    const batchNum = Math.ceil(processedCount / batchSize);
                    const totalBatches = Math.ceil(totalActs / batchSize);
                    
                    // Aktualizuj pasek postƒôpu
                    const percent = Math.round((processedCount / totalActs) * 100);
                    document.getElementById('progressBar').style.width = percent + '%';
                    document.getElementById('progressBar').textContent = percent + '%';
                    document.getElementById('progressText').textContent = `Wys≈Çano ${batchNum}/${totalBatches} batchy (${processedCount}/${totalActs} akt√≥w)`;
                    
                    console.log(`‚úÖ Batch ${batchNum}/${totalBatches} sent (${processedCount}/${totalActs} acts)`);
                    showMessage(`‚è≥ Wys≈Çano ${batchNum}/${totalBatches} batchy...`, 'info');
                }
            }
            
            if (errorCount === 0) {
                console.log(`‚úÖ‚úÖ ALL ${totalActs} ACTS SENT TO SUPABASE!`);
                console.log(`üìç Batch ID: ${batchId}`);
                console.log(`üéâ Table: public_imports`);
                
                // Koniec - pasek na 100%
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressBar').textContent = '100%';
                document.getElementById('progressBar').style.background = 'linear-gradient(90deg, #0f0, #00ff00)';
                document.getElementById('progressText').textContent = `‚úÖ Wszystkie ${totalActs} akt√≥w wys≈Çane!`;
                
                showMessage(
                    `‚úÖ Wys≈Çano ${totalActs} akt√≥w do Supabase!\n\n` +
                    `üìç Table: public_imports\n` +
                    `üìã Batch ID: ${batchId}\n\n` +
                    `‚è≠Ô∏è Kroki:\n` +
                    `1. Otw√≥rz viewer-osd-v8.11.html\n` +
                    `2. Dane powinny siƒô za≈Çadowaƒá\n` +
                    `3. Brak limit√≥w reads!`,
                    'success'
                );
            } else {
                showMessage(`‚ö†Ô∏è ${processedCount}/${totalActs} wys≈Çano, ${errorCount} b≈Çƒôd√≥w`, 'warning');
            }
        }
        
        function splitAndStorageData(merged, newActsCount) {
            console.log('üîÄ Splitting data into parts...');
            const acts = merged.imageActs || [];
            const partsNeeded = Math.ceil(acts.length / 1000);
            
            try {
                // Store metadata
                localStorage.setItem('genealog_data_split', JSON.stringify({
                    _split: true,
                    totalParts: partsNeeded,
                    totalActs: acts.length,
                    timestamp: new Date().toISOString()
                }));
                
                // Store parts
                for (let i = 0; i < partsNeeded; i++) {
                    const start = i * 1000;
                    const end = Math.min(start + 1000, acts.length);
                    const part = {
                        part: i + 1,
                        totalParts: partsNeeded,
                        acts: acts.slice(start, end)
                    };
                    localStorage.setItem(`genealog_data_part_${i+1}`, JSON.stringify(part));
                }
                
                showMessage(`‚úÖ Za≈Çadowano ${newActsCount} akt√≥w (podzielone na ${partsNeeded} czƒô≈õci)!`, 'success');
                console.log(`‚úÖ Data split into ${partsNeeded} parts`);
            } catch (error) {
                console.error('‚ùå Split storage error:', error);
                showMessage(`‚ùå B≈ÇƒÖd podzia≈Çu danych: ${error.message}`, 'error');
            }
        }
        
        function checkImporterLocalStorage() {
            try {
                const splitMeta = localStorage.getItem('genealog_data_split');
                if (splitMeta) {
                    const meta = JSON.parse(splitMeta);
                    const sizeKB = (splitMeta.length / 1024).toFixed(1);
                    alert(`‚úÖ localStorage (podzielone):\n\nCzƒô≈õci: ${meta.totalParts}\nAkty: ${meta.totalActs}\n\nGotowe do viewer-osd-v8.11.html`);
                    return;
                }
                
                const data = localStorage.getItem('genealog_data');
                if (data) {
                    let displayData = data;
                    let info = '';
                    
                    // Check if compressed
                    try {
                        const parsed = JSON.parse(data);
                        if (parsed._compressed) {
                            info = `\n(Skompresowane: ${(data.length/1024).toFixed(1)} KB)`;
                            displayData = `Dane skompresowane (${parsed._originalSize} bajt√≥w)`;
                        }
                    } catch (e) {}
                    
                    const parsed = displayData.startsWith('{') ? JSON.parse(displayData) : { _compressed: true };
                    const actsCount = parsed.imageActs?.length || '?';
                    const sizeKB = (data.length / 1024).toFixed(1);
                    console.log('üìä localStorage:', { acts: actsCount, size: sizeKB + ' KB' });
                    alert(`‚úÖ localStorage ma dane:\n\nAkty: ${actsCount}\nRozmiar: ${sizeKB} KB${info}\n\nGotowe do otwarcia viewer-osd-v8.11.html`);
                } else {
                    console.log('‚ùå localStorage pusty');
                    alert('‚ùå localStorage jest pusty\n\nKliki: Przeanalizuj ‚Üí Za≈Çaduj do Indexer\'a');
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå B≈ÇƒÖd: ' + error.message);
            }
        }
        
        function showDebugData() {
            console.clear();
            console.log('=== üêõ DEBUG DANE IMPORTU ===');
            console.log('üìã Kolumny znalezione:', columnHeaders);
            console.log('üó∫Ô∏è  Mapowanie p√≥l:', fieldMapping);
            
            if (parsedData.length === 0) {
                alert('‚ùå Brak danych do analizy. Najpierw wczytaj plik.');
                return;
            }
            
            // Sprawd≈∫ pierwsze 3 wiersze
            let debug = 'üêõ PIERWSZE 3 WIERSZE DANYCH:\n\n';
            for (let i = 0; i < Math.min(3, parsedData.length); i++) {
                const row = parsedData[i];
                debug += `Wiersz ${i + 1}:\n`;
                columnHeaders.forEach((col, idx) => {
                    const val = (row[idx] || '').substring(0, 50);
                    debug += `  ${col}: "${val}"\n`;
                });
                debug += '\n';
            }
            
            // Sprawd≈∫ mapowanie
            debug += 'üó∫Ô∏è  MAPOWANIE:\n';
            Object.entries(fieldMapping).forEach(([field, colName]) => {
                const found = columnHeaders.includes(colName);
                debug += `  ${field}: "${colName}" ${found ? '‚úÖ' : '‚ùå'}\n`;
            });
            
            console.log(debug);
            alert(debug);
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type + ';charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function clearInput() {
            document.getElementById('sourceData').value = '';
            parsedData = [];
            columnHeaders = [];
            document.getElementById('mappingSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
            document.getElementById('message').textContent = '';
        }
    </script>
</body>
</html>
