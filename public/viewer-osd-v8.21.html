<!DOCTYPE html>
<html lang="pl">
<!--
═══════════════════════════════════════════════════════════════════════════════
  GENEALOG INDEXER v8.21 - SCHEMA DOKUMENTACJI BAZY DANYCH
═══════════════════════════════════════════════════════════════════════════════
  Data aktualizacji: 2026-02-03 12:30:00
  
  BAZA DANYCH: Supabase (PostgreSQL)
  TABELA: public_imports (5512+ rekordów - akta chrztów z Blinowa)
  
  ═══════════════════════════════════════════════════════════════════════════
  SCHEMAT KOLUMN (28 kolumn):
  ═══════════════════════════════════════════════════════════════════════════
  
  1. id (UUID, PRIMARY KEY)
     - Unikalny identyfikator rekordu w Supabase
     - Auto-generated
     - Typ: uuid
  
  2. original_id (TEXT, UNIQUE INDEX)
     - Oryginalny ID z importu: "CH.LUB.BLIN.YYYY.NNN"
     - Np: "CH.LUB.BLIN.1785.001"
     - Typ: text
     - IMPORTANT: Używany do UPDATE queries!
  
  3. christening_year (INTEGER)
     - Rok chrzczenia: 1878-1889
     - Typ: integer
     - Range: 1878-1889
  
  4. christening_act_number (TEXT)
     - Numer aktu chrzczenia
     - Typ: text
     - Np: "14", "27/1878"
  
  5-7. DZIECKO (Chrzestne):
     5. child_first_name (TEXT)
        - Imię dziecka
        - Typ: text
     6. child_last_name (TEXT)
        - Nazwisko dziecka
        - Typ: text
     7. child_birth_date (TEXT) ⭐ DODANA 3.02.2026
        - Data urodzenia dziecka
        - Format: TEXT (np. "1878-05-15" lub "15 maj 1878")
        - Typ: text
  
  8-11. OJCIEC:
     8. father_first_name (TEXT)
        - Imię ojca
        - Typ: text
     9. father_last_name (TEXT)
        - Nazwisko ojca
        - Typ: text
     10. father_age (TEXT) ⭐ DODANA 3.02.2026
         - Wiek ojca w momencie chrzczenia
         - Format: TEXT (np. "35", "35 lat", "ok. 35")
         - Typ: text
  
  12-15. MATKA:
     12. mother_first_name (TEXT)
         - Imię matki
         - Typ: text
     13. mother_last_name (TEXT)
         - Nazwisko matki
         - Typ: text
     14. mother_maiden_name (TEXT) ⭐ DODANA 3.02.2026
         - Nazwisko panieńskie matki
         - Typ: text
     15. mother_age (TEXT) ⭐ DODANA 3.02.2026
         - Wiek matki w momencie chrzczenia
         - Format: TEXT (np. "32", "32 lata", "ok. 32")
         - Typ: text
  
  16-19. ŚWIADKOWIE (Godparents):
     16. witness_1_first_name (TEXT) 
     17. witness_1_last_name (TEXT)
     18. witness_2_first_name (TEXT)
     19. witness_2_last_name (TEXT)
  
  20. witnesses (TEXT) ⭐ DODANA 3.02.2026
     - Skonsolidowana lista świadków
     - Format: TEXT (JSON array lub comma-separated)
     - Typ: text
  
  21. location (TEXT)
     - Miejscowość
     - Typ: text
     - Np: "Blinów"
  
  22. notes (TEXT)
     - Notatki dodatkowe (czyszczone/przetłumaczone)
     - Typ: text
  
  23. notes_org (TEXT)
     - Notatki oryginalne (z dokumentu)
     - Typ: text
  
  24. imageidx (INTEGER)
     - Index obrazu (0-based)
     - NULL = nie przypisany do obrazu
     - Typ: integer
     - Mapowanie: app.images[imageidx]
  
  25. image_path (TEXT)
     - Ścieżka do pliku obrazu
     - Np: "1878-1889 chrzty/blinow_ln-1.jpg"
     - Typ: text
  
  26. field_values (JSONB) [DEPRECATED - NIE WYSYŁANY DO SUPABASE]
     - Mapowanie pól (legacy)
     - Typ: jsonb
     - UWAGA: Dane rozeszły się po poszczególnych kolumnach
  
  27. created_at (TIMESTAMP WITH TIMEZONE)
     - Data utworzenia rekordu
     - Auto-set by Supabase
     - Format: 2025-02-03T12:30:00+00:00
  
  28. updated_at (TIMESTAMP WITH TIMEZONE)
     - Data ostatniej modyfikacji
     - Auto-updated by Supabase
     - Format: 2025-02-03T12:30:00+00:00
  
  ═══════════════════════════════════════════════════════════════════════════
  MAPOWANIE MIĘDZY APP A SUPABASE:
  ═══════════════════════════════════════════════════════════════════════════
  
  app.imageActs[].fieldValues:
    {
      "child_first_name": → child_first_name
      "child_last_name": → child_last_name
      "child_birth_date": → child_birth_date ⭐
      "father_first_name": → father_first_name
      "father_last_name": → father_last_name
      "father_age": → father_age ⭐
      "mother_first_name": → mother_first_name
      "mother_last_name": → mother_last_name
      "mother_maiden_name": → mother_maiden_name ⭐
      "mother_age": → mother_age ⭐
      "notes": → notes
      "notes_org": → notes_org
      "witnesses": → witnesses ⭐
      "location": → location
      "rok": → christening_year
      "nr": → christening_act_number
    }
  
  app.imageActs[]:
    {
      "id": → id (UUID)
      "original_id": → original_id (KEY FIELD!)
      "imageIdx": → imageidx (integer)
      "image_path": → image_path (text)
      "fieldValues": {powyżej}
    }
  
  ═══════════════════════════════════════════════════════════════════════════
  CONSTRAINTS I INDEKSY:
  ═══════════════════════════════════════════════════════════════════════════
  
  PRIMARY KEY: id (UUID)
  UNIQUE INDEX: original_id (CH.LUB.BLIN.YYYY.NNN)
  
  FOREIGN KEYS: Brak (tabela standalone)
  
  CONSTRAINTS:
    - original_id: NOT NULL, UNIQUE
    - created_at: auto-set by Supabase
    - updated_at: auto-updated by Supabase
    - Nullability: Wszystkie kolumny mogą być NULL (nullable)
  
  ═══════════════════════════════════════════════════════════════════════════
  HISTORIA ZMIAN:
  ═══════════════════════════════════════════════════════════════════════════
  
  2026-01-XX: Pierwotny import - 5512 rekordów z CH_BLIN.txt
  2026-02-03 12:30:00: DODANE KOLUMNY (5 nowych pól):
    + child_birth_date
    + father_age
    + mother_maiden_name
    + mother_age
    + witnesses
  
  ═══════════════════════════════════════════════════════════════════════════
  UWAGI DLA PROGRAMISTY:
  ═══════════════════════════════════════════════════════════════════════════
  
  1. UPDATE queries: zawsze używaj WHERE original_id = ... (nie id!)
  2. Nowe kolumny zawierają dane tekstowe, mogą mieć różne formaty
  3. imageidx i image_path są zsynchronizowane (jedno się zmienia, drugie też)
  4. Wszystkie pola genealogiczne są w fieldValues (dla wygody)
  5. Supabase auto-update updated_at przy każdym UPDATE
  6. JSONB field_values jest zastarzeły - dane są w kolumnach
  
  ═══════════════════════════════════════════════════════════════════════════
  DO SPRAWDZENIA W PRZYSZŁOŚCI:
  ═══════════════════════════════════════════════════════════════════════════
  
  - Czy wszystkie 5512 rekordów ma child_birth_date / father_age / itd?
  - Format danych w tych polach (czy są spójne?)
  - ROI_JSON - czy to osobna kolumna czy w fieldValues?
  - Potrzeba SELECT query do sprawdzenia NULL counts
  
═══════════════════════════════════════════════════════════════════════════════
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genealog Indexer v8.12 - Zaawansowany Indekser Akt z OCR</title>
    <script src="https://openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
    <!-- Supabase Client - import map + ESM module -->
    <script type="importmap">
    {
      "imports": {
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
    </script>
    <script type="module">
      import { createClient } from '@supabase/supabase-js'
      window.createSupabaseClient = createClient
    </script>
    <script>
        // Supabase configuration - czekaj aż biblioteka się załaduje
        const SUPABASE_URL = 'https://jbwkrconzozhgzikabmv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_X0Qm9TSqq0nOOtCo8RycMQ_PeirqbMt';
        let supabase = null;

        // Czekaj aż createSupabaseClient będzie dostępne (z importmap)
        async function initSupabaseClient() {
            let attempts = 0;
            while (!window.createSupabaseClient && attempts < 100) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }
            
            if (window.createSupabaseClient && typeof window.createSupabaseClient === 'function') {
                console.log('[Supabase] Client loaded');
                window.supabase_client = window.createSupabaseClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('[Supabase] Initialized');
                window.dispatchEvent(new Event('supabaseReady'));
            } else {
                console.error('[Supabase] Library failed to load');
            }
        }

        // 🆕 OPÓŹNIJ Supabase - inicjalizuj dopiero gdy będzie potrzeba (użytkownik kliknie "Ładuj Supabase")
        // Jeśli SQL istnieje, Supabase jest zbędny
        window.initSupabaseClient = initSupabaseClient;

        // ===== IndexedDB - OFFLINE STORAGE (dla 5512+ rekordów) =====
        const DB_NAME = 'genealogy_db';
        const STORE_NAME = 'imageActs';

        async function saveToIndexedDB(imageActs) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                
                request.onerror = () => reject(request.error);
                
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                
                request.onsuccess = () => {
                    const db = request.result;
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    
                    // Wyczyść starą zbiórkę
                    store.clear();
                    
                    // Zapisz każdy rekord
                    imageActs.forEach(act => {
                        store.put(act);
                    });
                    
                    transaction.oncomplete = () => {
                        console.log(`✅ Zapisano ${imageActs.length} rekordów do IndexedDB`);
                        resolve(true);
                    };
                    transaction.onerror = () => reject(transaction.error);
                };
            });
        }

        async function loadFromIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        console.log('⚠️ IndexedDB pusty');
                        resolve([]);
                        return;
                    }
                    
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = () => {
                        const data = getAllRequest.result;
                        console.log(`✅ Załadowano ${data.length} rekordów z IndexedDB`);
                        resolve(data);
                    };
                    getAllRequest.onerror = () => reject(getAllRequest.error);
                };
            });
        }

        // Udostępnij dla F12
        window.saveToIndexedDB = saveToIndexedDB;
        window.loadFromIndexedDB = loadFromIndexedDB;
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #0a0a0a;
            color: #ddd;
            overflow: hidden;
        }
        #app {
            display: grid;
            grid-template-rows: auto 1fr 25%;
            height: 100vh;
        }
        .toolbar {
            background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
            border-bottom: 1px solid #2a2a2a;
            padding: 5px 8px;
            display: flex;
            align-items: flex-start;
            align-content: flex-start;
            gap: 3px;
            min-height: auto;
            height: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 100;
            flex-wrap: wrap;
            overflow-x: visible;
            overflow-y: visible;
            grid-row: 1;
        }
        .toolbar-title {
            font-size: 11px;
            color: #0078d4;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: auto;
        }
        .toolbar-btn {
            background: #252525;
            border: 1px solid #3a3a3a;
            color: #bbb;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .toolbar-btn:hover {
            background: #2d2d2d;
            border-color: #0078d4;
            color: #0078d4;
            transform: translateY(-1px);
        }
        .toolbar-btn.active {
            background: #0078d4;
            border-color: #0078d4;
            color: white;
            box-shadow: 0 0 12px rgba(0,120,212,0.4);
        }
        .toolbar-btn.disabled {
            background: #1a1a1a;
            border-color: #333;
            color: #555;
            opacity: 0.5;
        }
        .toolbar-btn.disabled:hover {
            background: #1a1a1a;
            border-color: #333;
            color: #555;
            transform: none;
        }
        #actBtn {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        .toolbar-sep {
            width: 1px;
            height: 18px;
            background: #2a2a2a;
            margin: 0 1px;
            flex-shrink: 0;
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
            gap: 20px;
        }
        #loadingOverlay.hidden {
            display: none;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #0078d4;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            color: #888;
            font-size: 13px;
            font-family: monospace;
        }
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 100px 140px 1fr 300px;
            gap: 0;
            overflow: hidden;
            grid-row: 2;
        }
        .main-content.thumbs-collapsed {
            grid-template-columns: 0px 140px 1fr 300px;
        }
        .viewer-panel {
            flex: 1;
            background: #000;
            position: relative;
            display: flex;
            flex-direction: column;
            grid-column: 3;
        }
        .viewer-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #viewer {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #imageFallback {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            transition: transform 0.15s ease;
            z-index: 1;
            pointer-events: none;
        }
        #imageFallback.active {
            display: block;
        }
        .viewer-container.drag-over {
            border: 4px dashed #0078d4 !important;
            background-color: rgba(0, 120, 212, 0.05) !important;
        }
        .rotate-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            gap: 6px;
            z-index: 60;
        }
        .rotate-btn {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            color: #ddd;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .rotate-btn:hover {
            background: #252525;
            border-color: #0078d4;
            color: #0078d4;
        }
        .roi-info-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            color: #0078d4;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 60;
            display: none;
            border: 1px solid #0078d4;
        }
        .roi-info-overlay.visible {
            display: block;
        }
        .roi-overlay {
            border: 2px dashed #0078d4;
            background: rgba(0,120,212,0.15);
            pointer-events: none;
            z-index: 100;
        }
        .roi-overlay.active {
            border-color: #ff9800;
            border-width: 3px;
            background: rgba(255,152,0,0.2);
        }
        .act-overlay {
            border: 2px solid #10b981;
            background: none;
            pointer-events: none;
            z-index: 100;
        }
        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair !important;
            z-index: 50;
            pointer-events: none;
        }
        .context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #10b981;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            min-width: 200px;
        }
        .context-menu.active {
            display: block;
        }
        .context-menu-item {
            padding: 10px 15px;
            color: #fff;
            cursor: pointer;
            border-bottom: 1px solid #1a1a1a;
            font-size: 13px;
            transition: background 0.2s;
        }
        .context-menu-item:hover {
            background: rgba(16,185,129,0.2);
            color: #10b981;
        }
        .context-menu-item:last-child {
            border-bottom: none;
        }
        .context-menu-item.danger {
            color: #ff6b6b;
        }
        .context-menu-item.danger:hover {
            background: rgba(255,107,107,0.1);
            color: #ff8888;
        }
        .right-panel {
            background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
            border-left: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            grid-column: 4;
            min-width: 300px;
            max-height: 100%;
        }
        .right-panel.collapsed {
            min-width: 0;
            border: none;
        }
        .acts-panel {
            background: #0f0f0f;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
            overflow-y: auto;
            min-width: 140px;
            grid-column: 2;
        }
        .acts-panel.collapsed {
            min-width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }
        .act-button {
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .act-button:hover {
            background: #252525;
            border-color: #0078d4;
        }
        .act-button.active {
            background: #0078d4;
            border-color: #0078d4;
            color: white;
            font-weight: bold;
        }
        
        .acts-group-header {
            padding: 8px 6px;
            font-size: 11px;
            font-weight: 600;
            color: #aaa;
            background: #1a1a1a;
            border-bottom: 1px solid #3a3a3a;
            margin-top: 4px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        
        .acts-group-header:hover {
            background: #252525;
            color: #ddd;
        }
        
        .act-control-btn {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            padding: 1px 3px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .act-control-btn:hover {
            opacity: 0.8;
        }
        
        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 4px;
        }
        .panel-content::-webkit-scrollbar {
            width: 8px;
        }
        .panel-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .panel-content::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }
        .panel-content::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }
        #formsContainer {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 8px;
            padding: 0;
        }
        .records-sidebar {
            width: 50px;
            background: #151515;
            border-right: 1px solid #2a2a2a;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 8px;
        }
        .form-section {
            padding: 12px;
            border-bottom: 1px solid #2a2a2a;
            display: none;
            flex: 1;
            overflow-y: auto;
        }
        .form-section.active {
            display: block;
        }
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .form-header h3 {
            font-size: 13px;
            color: #ddd;
            font-weight: 600;
        }
        .record-counter {
            font-size: 10px;
            color: #888;
            background: #252525;
            padding: 3px 8px;
            border-radius: 10px;
        }
        .form-group {
            margin-bottom: 4px;
        }
        .form-group label {
            display: block;
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            background: #0f0f0f;
            border: 1px solid #3a3a3a;
            color: #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.15s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #0078d4;
            outline: none;
            background: #1a1a1a;
            box-shadow: 0 0 0 3px rgba(0,120,212,0.1);
        }
        .form-group input.has-roi {
            border-left: 4px solid #10b981;
            box-shadow: 0 0 8px rgba(16,185,129,0.3);
        }
        /* 🟢 P0: Color-Coded Fields - 3 status indicators */
        .form-group input.field-complete {
            border-left: 4px solid #10b981;  /* 🟢 Green - filled */
            box-shadow: 0 0 8px rgba(16,185,129,0.3);
        }
        .form-group input.field-roi-only {
            border-left: 4px solid #fbbf24;  /* 🟡 Yellow - ROI marked but no value */
            box-shadow: 0 0 8px rgba(251,191,36,0.3);
        }
        .form-group input.field-empty {
            border-left: 4px solid #ef4444;  /* 🔴 Red - empty & no ROI */
            box-shadow: 0 0 8px rgba(239,68,68,0.3);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
            font-family: 'Courier New', monospace;
        }
        .accordion-item {
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            background: #0f0f0f;
            margin-bottom: 4px;
        }
        .accordion-header {
            background: #1a1a1a;
            border: none;
            color: #ddd;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            width: 100%;
            text-align: left;
        }
        .accordion-header:hover {
            background: #252525;
        }
        .accordion-header.active {
            background: #0078d4;
            color: white;
        }
        .accordion-content {
            display: none;
            padding: 12px;
            background: #0f0f0f;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .accordion-content.active {
            display: block;
            max-height: 500px;
        }
        .form-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 12px;
        }
        .form-btn {
            background: #107c10;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .form-btn:hover {
            background: #0d6a0d;
        }
        .form-btn.danger {
            background: #c42b1c;
        }
        .form-btn.danger:hover {
            background: #a02318;
        }
        .thumbnails-bar {
            background: #0f0f0f;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            gap: 8px;
            overflow-y: auto;
            min-width: 100px;
        }
        .thumbnails-bar.collapsed {
            min-width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }
        /* 💡 Suggestions Fan - Wachlarz podpowiedzi */
        #suggestionsWachlarz {
            pointer-events: none;
            display: none;
        }
        #suggestionsWachlarz.visible {
            display: block;
            pointer-events: auto;
        }
        #suggestionsWachlarz .suggestion {
            background: rgba(20, 20, 40, 0.95);
            border: 1px solid #0078d4;
            color: #0078d4;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.15s ease;
            transform: translateX(-10px) rotate(-3deg);
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 8px rgba(0,120,212,0.2);
        }
        #suggestionsWachlarz .suggestion:hover {
            background: rgba(0, 120, 212, 0.2);
            border-color: #00ff88;
            color: #00ff88;
            transform: translateX(0) rotate(0deg);
            box-shadow: 0 4px 16px rgba(0,255,136,0.3);
        }
        @keyframes fanRotate {
            from {
                transform: translateX(-30px) rotate(-15deg) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(-10px) rotate(-3deg) scale(1);
                opacity: 1;
            }
        }
        .thumbnail {
            width: 100px;
            height: 75px;
            border: 2px solid #333;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            background: #1a1a1a;
            flex-shrink: 0;
            transition: all 0.2s ease;
            margin-bottom: 4px;
        }
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .thumbnail:hover {
            border-color: #0078d4;
        }
        .thumbnail.active {
            border-color: #0078d4;
            box-shadow: 0 0 16px rgba(0,120,212,0.6);
        }
        /* Custom tooltip dla miniaturki */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        /* Miniaturka hover efekt */
        .thumbnail:hover {
            border: 2px solid #0078d4;
            cursor: pointer;
        }
        .notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            background: #0078d4;
            color: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .notification.error {
            background: #c42b1c;
        }
        .notification.success {
            background: #107c10;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f0f0f;
        }
        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }
        /* Floating formularz nad obrazem */
        .floating-form {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 380px;
            max-height: 80vh;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            flex-direction: column;
            backdrop-filter: blur(4px);
            padding: 12px;
        }
        .floating-form.visible {
            display: flex;
        }
        .floating-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            color: #0078d4;
            font-weight: 600;
        }
        .floating-form-close {
            background: none;
            border: none;
            color: #ddd;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
        }
        .floating-form-close:hover {
            color: #0078d4;
        }
        .floating-form-content {
            flex: 1;
            overflow-y: auto;
        }
        .floating-form-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }
        /* Lepsze pin-upy – małe, eleganckie, przesuwalne */
        .field-pinup {
            display: none; /* 🔒 Hidden in v7.1 - act-only mode */
            position: absolute;
            width: 260px;
            background: rgba(15, 15, 20, 0.95);
            border: 1px solid rgba(0, 120, 212, 0.8);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.8);
            z-index: 101;
            padding: 10px;
            cursor: move;
            user-select: none;
            backdrop-filter: blur(12px);
            transition: all 0.2s ease;
            font-size: 12px;
        }
        .field-pinup:hover {
            box-shadow: 0 12px 32px rgba(0,120,212,0.3);
            border-color: #0099ff;
        }
        .field-pinup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: #0078d4;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .field-pinup-close {
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        .field-pinup-close:hover {
            color: #ff6b6b;
            background: rgba(255,107,107,0.15);
        }
        /* Panel z kartami aktów - przezroczysty i przesuwalny */
        #actsContainer {
            background: rgba(30, 30, 40, 0.6) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            pointer-events: none !important;
            transition: all 0.3s ease;
        }
        /* Ale same karty niech reagują na kliknięcia i hover */
        .act-card {
            pointer-events: auto !important;
            background: rgba(50, 50, 70, 0.8);
            border: 1px solid #555;
        }
        .ocr-btn {
            background: none;
            border: none;
            color: #00ccff;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ocr-btn:hover {
            color: #00ff88;
            background: rgba(0,204,255,0.15);
            transform: scale(1.15);
        }
        .ocr-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .field-pinup input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(10,10,10,0.8);
            border: 1px solid #3a3a3a;
            color: #ddd;
            border-radius: 6px;
            font-size: 13px;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        .field-pinup input:focus {
            border-color: #0078d4;
            background: rgba(20,20,30,0.9);
            box-shadow: 0 0 0 3px rgba(0,120,212,0.2);
            outline: none;
        }
        .field-pinup input.has-roi {
            border-left: 4px solid #10b981;
        }
        /* Wizard prompt – instrukcja dla bieżącego pola */
        .wizard-prompt {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,120,212,0.92);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 99;
            display: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(4px);
        }
        .wizard-prompt.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        .wizard-prompt button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.15s;
            font-size: 12px;
        }
        .wizard-prompt button:hover {
            background: rgba(255,255,255,0.3);
        }
        .wizard-progress {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,120,212,0.85);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 99;
            display: none;
            backdrop-filter: blur(4px);
        }
        .wizard-progress.visible {
            display: block;
        }
        .wizard-progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .wizard-progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }
        
        /* ===== POSTPROCESSING PANEL ===== */
        .postprocess-panel {
            position: fixed;
            right: 0;
            top: 40px;
            width: 320px;
            background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
            border-left: 1px solid #2a2a2a;
            border-radius: 6px 0 0 6px;
            padding: 12px;
            box-shadow: -4px 4px 16px rgba(0,0,0,0.6);
            z-index: 95;
            display: none;
            flex-direction: column;
            gap: 10px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .postprocess-panel.visible {
            display: flex;
        }
        .postprocess-title {
            font-size: 12px;
            color: #0078d4;
            font-weight: 600;
            text-transform: uppercase;
        }
        .postprocess-slider {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .postprocess-slider label {
            font-size: 11px;
            color: #888;
            font-weight: 500;
        }
        .postprocess-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #2a2a2a;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        .postprocess-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0078d4;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,120,212,0.5);
        }
        .postprocess-slider input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0078d4;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 8px rgba(0,120,212,0.5);
        }
        .postprocess-value {
            font-size: 10px;
            color: #0078d4;
            text-align: center;
        }
        .postprocess-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 10px;
        }
        .postprocess-btn {
            background: #0078d4;
            border: none;
            color: white;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.15s;
        }
        .postprocess-btn:hover {
            background: #0099ff;
        }
        .postprocess-btn.reset {
            background: #3a3a3a;
        }
        .postprocess-btn.reset:hover {
            background: #454545;
        }
        /* ⭐ P0: Progress Bar - Show field completion status */
        #progressBar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
            padding: 0 8px;
            height: 24px;
        }
        .progress-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .progress-bar {
            width: 100px;
            height: 6px;
            background: #1a1a1a;
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid #3a3a3a;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #0078d4 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(16,185,129,0.4);
        }
        .progress-text {
            font-size: 11px;
            color: #888;
            min-width: 35px;
            text-align: right;
        }
        
        /* ===== TABLE SECTION (25% height) ===== */
        .table-section {
            background: #0f0f0f;
            border-top: 2px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            grid-row: 3;
        }
        .table-header {
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            gap: 8px;
        }
        .table-header-title {
            font-size: 12px;
            font-weight: 600;
            color: #0078d4;
            text-transform: uppercase;
        }
        .table-header-actions {
            display: flex;
            gap: 6px;
        }
        .table-action-btn {
            background: #252525;
            border: 1px solid #3a3a3a;
            color: #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .table-action-btn:hover {
            background: #2d2d2d;
            border-color: #0078d4;
            color: #0078d4;
        }
        .table-container {
            flex: 1;
            overflow: auto;
            position: relative;
            overflow-x: auto;
            overflow-y: auto;
            height: 100%;
        }
        #dataTable {
            width: 100%;
            min-width: 1400px;
            border-collapse: collapse;
            font-size: 11px;
            color: #ddd;
            user-select: text;
        }
        #dataTable thead {
            background: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #dataTable thead th {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            color: #0078d4;
            white-space: nowrap;
            user-select: none;
        }
        #dataTable tbody tr {
            border-bottom: 1px solid #1a1a1a;
            transition: background 0.15s ease;
        }
        #dataTable tbody tr:hover {
            background: #1a1a1a;
        }
        #dataTable tbody tr.selected {
            background: rgba(0, 120, 212, 0.2);
        }
        #dataTable td {
            border: 1px solid #2a2a2a;
            padding: 6px 10px;
            background: #0f0f0f;
            position: relative;
        }
        #dataTable td:hover {
            background: #151515;
        }
        .cell-editable {
            cursor: text;
            user-select: text;
        }
        .cell-editable:hover {
            background: #252525 !important;
            border-color: #0078d4 !important;
            outline: 1px solid rgba(0, 120, 212, 0.3);
        }
        .cell-input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #0078d4;
            color: #ddd;
            padding: 4px 6px;
            font-size: 11px;
            font-family: inherit;
            border-radius: 2px;
        }
        .cell-input:focus {
            outline: none;
            box-shadow: 0 0 8px rgba(0, 120, 212, 0.5);
        }
        #dataTable th:first-child,
        #dataTable td:first-child {
            background: #141414;
            color: #888;
            font-weight: 500;
            width: 40px;
            text-align: center;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        .row-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #0078d4;
        }
        .paste-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #0078d4;
            border-radius: 8px;
            padding: 20px;
            z-index: 2000;
            display: none;
            flex-direction: column;
            gap: 12px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        }
        .paste-overlay.visible {
            display: flex;
        }
        .paste-overlay textarea {
            width: 100%;
            height: 150px;
            background: #0f0f0f;
            border: 1px solid #3a3a3a;
            color: #ddd;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        .paste-overlay-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .paste-overlay-btn {
            background: #0078d4;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.15s ease;
        }
        .paste-overlay-btn:hover {
            background: #0099ff;
        }
        .paste-overlay-btn.cancel {
            background: #3a3a3a;
        }
        .paste-overlay-btn.cancel:hover {
            background: #454545;
        }

        /* === PRAWA BELKA – główne poprawki === */
        #right-panel {
            width: 368px;               /* trochę więcej niż 360 – lepiej na większości ekranów */
            min-width: 340px;           /* bezpieczeństwo przed zbyt wąskim panelem */
            padding: 20px 16px 24px;    /* więcej powietrza na dole */
            box-sizing: border-box;
        }

        /* Grupy pól – wyraźniejsze oddzielenie */
        .field-group {
            background: #f9fafb;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px 14px 14px;
            margin-bottom: 20px;        /* ← większy odstęp między grupami */
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }

        .field-group > h3, 
        .field-group > .group-title {
            margin: -20px 0 14px -12px;
            padding: 4px 10px;
            background: white;
            display: inline-block;
            font-size: 1.05rem;
            font-weight: 600;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* Checkbox "to ojciec" – ładniej wygląda jako pierwszy element */
        .field-group .checkbox-wrapper {
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Pojedyncze pola – lepsza czytelność */
        .form-row,
        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px 18px;             /* ← lepsze proporcje odstępów */
            margin-bottom: 8px;
        }

        .form-row label,
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.86rem;
            color: #4b5563;
            white-space: nowrap;        /* ← najważniejsze – długie etykiety się nie łamią */
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 9px 11px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.96rem;
            box-sizing: border-box;
        }

        /* Przyciski na dole – bardziej odporne na małe ekrany */
        .form-actions,
        #form-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .form-actions button,
        #form-buttons button {
            flex: 1 1 110px;            /* nie pozwolą przyciskom stać się za małe */
            min-width: 100px;
            padding: 10px 14px;
        }

        /* Responsywność – kiedy panel robi się naprawdę wąski */
        @media (max-width: 460px) {
            #right-panel {
                width: 100%;
                min-width: unset;
                padding: 16px 12px;
            }
            
            .form-row,
            .form-group {
                grid-template-columns: 1fr;     /* wszystko jeden pod drugim */
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Ładowanie aplikacji...</div>
    </div>
    <div id="app">
        <div class="toolbar">
            <span id="imageCounter" style="color: #999; font-size: 11px; margin-right: 10px;"></span>
            
            <!-- Progress Bar -->
            <div id="progressBar">
                <span class="progress-text">Pola:</span>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <span class="progress-text" id="progressText">0/0</span>
                </div>
            </div>
            
            <div class="toolbar-sep"></div>
            
            <!-- AUTH: Google Login -->
            <button class="toolbar-btn" id="authBtn" title="Zaloguj się z Google">
                <i class="fab fa-google"></i> Login
            </button>
            
            <!-- SUPABASE: Load/Save -->
            <button class="toolbar-btn" onclick="loadFromSupabase()" title="Załaduj dane z Supabase (baza PostgreSQL, bez limitów)">
                <i class="fas fa-database"></i> Ładuj Supabase
            </button>
            <button class="toolbar-btn" onclick="exportFromLocalStorageToSupabase()" title="Zapisz dane do Supabase" id="saveSupabaseBtn" style="display: none;">
                <i class="fas fa-database"></i> Zapisz Supabase
            </button>
            <button class="toolbar-btn" onclick="checkLocalStorage()" title="Sprawdź localStorage">
                <i class="fas fa-database"></i> Debug
            </button>
            <button class="toolbar-btn" onclick="testMappingDiagnostics()" title="🧪 Test mapowania kolumn Supabase" style="background-color: #e67e22;">
                <i class="fas fa-flask"></i> Test Mapping
            </button>
            <button class="toolbar-btn" onclick="showSupabaseSchema()" title="📋 Pokaż dostępne kolumny w Supabase (cached)" style="background-color: #9b59b6;">
                <i class="fas fa-columns"></i> Schemat Bazy
            </button>
            
            <div class="toolbar-sep"></div>
            <button class="toolbar-btn" id="openBtn" title="Dodaj obrazy (Ctrl+O)">
                <i class="fas fa-folder-open"></i> Otwórz
            </button>
            <button class="toolbar-btn" id="sortBtn" title="Sortuj obrazy po nazwie">
                <i class="fas fa-sort-alpha-down"></i> Sort
            </button>
            <button class="toolbar-btn" onclick="exportData('simple')" title="Eksport CSV">
                <i class="fas fa-download"></i> Export
            </button>
            <button class="toolbar-btn" onclick="importCSV()" title="Import CSV">
                <i class="fas fa-upload"></i> CSV
            </button>
            <button class="toolbar-btn" onclick="importDatabase()" title="Importuj bazę danych (CSV/JSON)">
                <i class="fas fa-database"></i> Importuj DB
            </button>
            <button class="toolbar-btn" onclick="openPasteTableModal()" title="🆕 Wklej tabelę (tab-separated)">
                <i class="fas fa-paste"></i> 📋 Wklej Tabelę
            </button>
            <button class="toolbar-btn" onclick="importFromSQLiteFile()" title="🆕 Importuj z pliku SQLite (.db)">
                <i class="fas fa-upload"></i> 💾 SQLite Import
            </button>
            <button class="toolbar-btn" onclick="exportToSQLiteFile()" title="🆕 Eksportuj do pliku SQLite (.db)">
                <i class="fas fa-download"></i> 💾 SQLite Export
            </button>
            <button class="toolbar-btn" onclick="exportImportedRecordsToCSV()" title="Eksportuj rekordy do CSV (dla Office)">
                <i class="fas fa-file-csv"></i> Eksport CSV
            </button>
            <button class="toolbar-btn" onclick="exportDatabaseAdvanced()" title="🆕 Zaawansowany eksport (wybór zakresu i kolumn)">
                <i class="fas fa-sliders-h"></i> 📊 Eksport Zaawansowany
            </button>
            <button class="toolbar-btn" onclick="showDocumentTypeSelector()" title="🆕 Dynamiczny formularz genealogiczny">
                <i class="fas fa-form"></i> 📋 Formularz
            </button>
            <button class="toolbar-btn" onclick="loadFieldsConfig()" title="🆕 Wczytaj/odśwież konfigurację pól">
                <i class="fas fa-cogs"></i> ⚙️ Config
            </button>
            <button class="toolbar-btn" onclick="importJSON()" title="Import JSON">
                <i class="fas fa-file-import"></i> JSON
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- 🆕 UNDO/REDO -->
            <button class="toolbar-btn" id="undoBtn" onclick="undo()" title="Cofnij (Ctrl+Z)">
                <i class="fas fa-undo"></i> Cofnij
            </button>
            <button class="toolbar-btn" id="redoBtn" onclick="redo()" title="Przywróć (Ctrl+Y)">
                <i class="fas fa-redo"></i> Przywróć
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- EDIT: Zaznacz akt, Zaznacz pola, Clear -->
            <button class="toolbar-btn" id="roiBtn" title="Zaznacz granice całego aktu na obrazie (Ctrl+R)">
                <i class="fas fa-expand"></i> Granice aktu
            </button>
            <button class="toolbar-btn" id="toggleBoundariesBtn" title="Włącz/wyłącz widoczność granic aktów">
                <i class="fas fa-eye"></i> Widoczność granic
            </button>
            <button class="toolbar-btn" onclick="clearAllROIs()" title="Usuń wszystkie zaznaczenia">
                <i class="fas fa-trash-alt"></i> Clear
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- PANELS: Thumbs, Acts -->
            <button class="toolbar-btn" onclick="toggleThumbsPanel()" title="Miniatury">
                <i class="fas fa-images"></i> Thumbs
            </button>
            <button class="toolbar-btn" id="toggleActsBtn" title="Akty">
                <i class="fas fa-list"></i> Acts
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- VIEW: Fit, FS -->
            <button class="toolbar-btn" onclick="zoomReset()" title="Dopasuj">
                <i class="fas fa-expand-arrows-alt"></i> Fit
            </button>
            <button class="toolbar-btn" onclick="toggleFullscreen()" title="Fullscreen">
                <i class="fas fa-expand"></i> FS
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- FORMS: Pinupy, Clear -->
            <button class="toolbar-btn" onclick="showAllPinups()" title="Pinupy">
                <i class="fas fa-thumbtack"></i> PIN
            </button>
            <button class="toolbar-btn" onclick="clearPinups()" title="Zamknij PIN">
                <i class="fas fa-times"></i> ✕PIN
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- PROCESS: Filtry -->
            <button class="toolbar-btn" id="postprocessBtn" title="Filtry">
                <i class="fas fa-sliders-h"></i> Filtry
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- ADVANCED: Supabase, Clear -->
            <button class="toolbar-btn" onclick="loadFromSupabase()" title="Załaduj z Supabase (PostgreSQL, bez limitów)">
                <i class="fas fa-database"></i> Ładuj DB
            </button>
            <button class="toolbar-btn" onclick="saveChangesToSupabase()" title="💾 Zapisz zmiany do Supabase (UPDATE)" style="background-color: #27ae60;">
                <i class="fas fa-save"></i> Zapisz zmiany
            </button>
            <button class="toolbar-btn" onclick="exportFromLocalStorageToSupabase()" title="Eksportuj do Supabase">
                <i class="fas fa-database"></i> Zapisz DB
            </button>
            <button class="toolbar-btn" id="clearStorageBtn" title="Wyczyść" style="color: #e74c3c;">
                <i class="fas fa-trash-alt"></i> Wyczyść
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- SEARCH (prawy koniec) -->
            <input type="text" id="searchInput" placeholder="🔍 Szukaj..." title="Szukaj aktów" style="margin-left: auto; padding: 6px 10px; border: 1px solid #3a3a3a; background: #1a1a1a; color: #ddd; border-radius: 4px; font-size: 11px; width: 160px; flex-shrink: 0;">
        </div>
        <div id="advancedActModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.1); z-index:1000; justify-content:center; align-items:center; pointer-events:none;">
            <div id="advancedActModalContent" style="background:rgba(20,20,30,0.95); padding:20px; border-radius:8px; width:400px; pointer-events:auto; cursor:move; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
                <div style="background:#0078d4; padding:8px 12px; margin:-20px -20px 12px -20px; border-radius:8px 8px 0 0; cursor:move; user-select:none; color:white; font-weight:bold; font-size:14px;">Dodaj akty do strony</div>
                <label>Rok: <input id="modalYear" type="number" value="1900"></label><br>
                <label>Parafia: <input id="modalParish" type="text" value="Blinów"></label><br>
                <label>Województwo: <input id="modalWoj" type="text" value="LUB"></label><br>
                <label>Typ aktu: 
                    <select id="modalType">
                        <option value="christening">Akt Chrztu</option>
                        <option value="birth">Akt Urodzenia</option>
                        <option value="marriage">Akt Małżeństwa</option>
                        <option value="death">Akt Zgonu</option>
                    </select>
                </label><br>
                <label>Nr pierwszego aktu: <input id="modalFirstNr" type="number" value="1"></label><br>
                <label>Nr ostatniego aktu: <input id="modalLastNr" type="number" value="10"></label><br>
                <label><input id="modalIncomplete" type="checkbox"> Ostatni akt niepełny</label><br>
                <label><input id="modalPlusIndex" type="checkbox"> Dodaj pole indeksu</label><br>
                <button id="modalOK">OK</button>
                <button id="modalCopyPrev">Kopiuj z poprzedniej</button>
                <button id="modalCancel">Anuluj</button>
            </div>
        </div>
        
        <!-- 🆕 NOWY MODAL: Przypisanie aktów z bazy do obrazu -->
        <div id="assignActsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.1); z-index:1000; justify-content:center; align-items:center; pointer-events:none;">
            <div id="assignActsModalContent" style="background:rgba(20,20,30,0.95); padding:20px; border-radius:8px; width:450px; pointer-events:auto; cursor:move; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
                <div style="background:#0078d4; padding:8px 12px; margin:-20px -20px 12px -20px; border-radius:8px 8px 0 0; cursor:move; user-select:none; color:white; font-weight:bold; font-size:14px;">Przypisz akty do obrazu</div>
                
                <div id="assignActsInfo" style="background:#1a2332; padding:8px; border-radius:4px; margin-bottom:12px; font-size:12px; color:#a0a0a0;">
                    <div>Obraz: <span id="assignActsImageName" style="color:#0078d4; font-weight:bold;"></span></div>
                    <div>Dostępnych aktów bez obrazu: <span id="assignActsCount" style="color:#0078d4; font-weight:bold;">0</span></div>
                </div>
                
                <label style="display:block; margin-bottom:8px; font-size:13px;">
                    Numery aktów do przypisania (od):
                    <input id="assignActsFrom" type="number" value="1" style="width:100%; padding:4px; margin-top:4px; background:#2a2a3a; color:#fff; border:1px solid #444; border-radius:4px;">
                </label>
                
                <label style="display:block; margin-bottom:8px; font-size:13px;">
                    Numery aktów do przypisania (do):
                    <input id="assignActsTo" type="number" value="10" style="width:100%; padding:4px; margin-top:4px; background:#2a2a3a; color:#fff; border:1px solid #444; border-radius:4px;">
                </label>
                
                <div style="background:#1a2332; padding:8px; border-radius:4px; margin-bottom:12px; font-size:12px; color:#a0a0a0;">
                    <div>Liczba aktów do przypisania: <span id="assignActsRange" style="color:#0078d4; font-weight:bold;">10</span></div>
                </div>
                
                <div style="display:flex; gap:8px; margin-top:16px;">
                    <button id="assignActsOK" style="flex:1; padding:8px; background:#10b981; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Przypisz</button>
                    <button id="assignActsCancel" style="flex:1; padding:8px; background:#f59e0b; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Anuluj</button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="thumbnails-bar" id="thumbsBar"></div>
            
            <div class="acts-panel" id="actsPanel">
                <div style="display: flex; align-items: center; justify-content: space-between; font-size: 10px; font-weight: bold; color: #0078d4; padding: 4px 0; border-bottom: 1px solid #2a2a2a; margin-bottom: 4px;">
                    <span>AKTY</span>
                    <div style="display: flex; gap: 2px;">
                        <button class="act-control-btn" title="Dodaj nowy akt" style="font-size: 10px; padding: 2px 4px; background: #10b981; color: white; border: none; border-radius: 2px; cursor: pointer;">+</button>
                        <button class="act-control-btn" title="Usuń wybrany akt" style="font-size: 10px; padding: 2px 4px; background: #f59e0b; color: white; border: none; border-radius: 2px; cursor: pointer;">−</button>
                        <button class="act-control-btn" title="Usuń wszystkie akty" style="font-size: 10px; padding: 2px 4px; background: #ef4444; color: white; border: none; border-radius: 2px; cursor: pointer;">×</button>
                    </div>
                </div>
                <div id="actsList" style="display: flex; flex-direction: column; gap: 4px; flex: 1;"></div>
                <button class="toolbar-btn" title="Ukryj/Pokaż panel aktów" style="width: 100%; margin-top: 4px; padding: 4px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="viewer-panel">
                <div class="viewer-container" id="viewerContainer">
                    <div id="viewer"></div>
                    <img id="imageFallback" />
                    <canvas id="drawingCanvas"></canvas>
                    <div class="roi-info-overlay" id="roiInfo">Tryb zaznaczania</div>
                    <!-- Menu kontekstowe dla aktów -->
                    <div class="context-menu" id="actContextMenu">
                        <div class="context-menu-item" data-action="rename">Zmień nazwę aktu</div>
                        <div class="context-menu-item" data-action="delete-roi">Usuń granice aktu</div>
                        <div class="context-menu-item" data-action="delete-fields">Usuń pola w akcie</div>
                        <div class="context-menu-item danger" data-action="delete-act">Usuń akt</div>
                    </div>
                    <!-- Menu kontekstowe dla obrazu -->
                    <div class="context-menu" id="imageContextMenu">
                        <div class="context-menu-item" data-action="delete-all-acts">Usuń wszystkie akty</div>
                        <div class="context-menu-item" data-action="delete-all-rois">Usuń wszystkie granice</div>
                    </div>
                    <!-- 💡 Suggestions Fan - Wachlarz podpowiedzi -->
                    <div id="suggestionsWachlarz" style="position: absolute; z-index: 200; pointer-events: none; display: none;"></div>
                    <div class="rotate-controls">
                        <button class="rotate-btn" onclick="rotateImage(-90)" title="Obróć w lewo">
                            <i class="fas fa-undo-alt"></i>
                        </button>
                        <button class="rotate-btn" onclick="rotateImage(90)" title="Obróć w prawo">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </div>
                    <div class="floating-form" id="floatingForm">
                        <div class="floating-form-header">
                            <span id="floatingTitle">Akt <span id="floatingActNum">1</span></span>
                            <button class="floating-form-close" onclick="toggleFloatingForm(false)"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="floating-form-content" id="floatingFormContent"></div>
                        <div class="floating-form-actions">
                            <button class="form-btn" onclick="saveRecord(); toggleFloatingForm(false)" style="flex: 1;"><i class="fas fa-save"></i> Zapisz</button>
                            <button class="form-btn" onclick="toggleFloatingForm(false)" style="flex: 1; background: #3a3a3a; color: #ddd;">Anuluj</button>
                        </div>
                    </div>
                    <div id="fieldPinupsContainer"></div>
                    <div class="wizard-prompt" id="wizardPrompt">
                        <span id="wizardMessage">Zaznacz ROI dla: Imię dziecka</span>
                        <button onclick="skipCurrentField()"><i class="fas fa-forward"></i> Pomiń</button>
                    </div>
                    <div class="wizard-progress" id="wizardProgress">
                        <div>Wizard: <span id="wizardStep">1</span>/<span id="wizardTotal">5</span></div>
                        <div class="wizard-progress-bar">
                            <div class="wizard-progress-fill" id="wizardProgressFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-panel" id="rightPanel">
                <div class="panel-content">
                    <div id="formsContainer"></div>
                </div>
            </div>
        </div>
        
        <!-- ===== TABLE SECTION (25% height) ===== -->
        <div class="table-section" id="tableSection">
            <div class="table-header">
                <span class="table-header-title">📊 Dane (Excel-like)</span>
                <div class="table-header-actions">
                    <button class="table-action-btn" onclick="addTableRow()" title="Dodaj wiersz">
                        <i class="fas fa-plus"></i> Wiersz
                    </button>
                    <button class="table-action-btn" onclick="deleteSelectedRows()" title="Usuń zaznaczone">
                        <i class="fas fa-trash-alt"></i> Usuń
                    </button>
                    <button class="table-action-btn" onclick="showPasteDialog()" title="Wklej dane (Ctrl+V)">
                        <i class="fas fa-paste"></i> Wklej
                    </button>
                    <button class="table-action-btn" onclick="exportTableData()" title="Eksportuj tabelę">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" title="Zaznacz wszystko"></th>
                            <th title="Unikalny identyfikator aktu (CH.LUB.BLIN.YYYY.MM.NNN gdzie MM=miesiąc). Dla blizniaków czasem występuje: a, b, c (np. 1783.02.042a, 1783.02.042b)">ID</th>
                            <th title="Rok zgłoszenia chrztu">ROK</th>
                            <th title="Numer aktu w roku">Nr.</th>
                            <th title="Nazwisko dziecka">Nazwisko</th>
                            <th title="Imię dziecka">Imię</th>
                            <th title="Miejsce zdarzenia (parafia, miejscowość)">Miejscowość</th>
                            <th title="Imię ojca">ImięO</th>
                            <th title="Nazwisko ojca">NazwiskoO</th>
                            <th title="Wiek ojca w momencie chrztu">wO</th>
                            <th title="Imię matki">IM</th>
                            <th title="Nazwisko matki (rodzinne/rodowe). ⚠️ UWAGA: Kolumna NM zawiera nazwisko rodowe, ale czasem powinna być kolumna NRM (nazwisko rodowe matki) - do przeanalizowania w przyszłości">NM</th>
                            <th title="Wiek matki w momencie chrztu">wM</th>
                            <th title="Uwagi współczesne / notatki redakcji">Uwagi</th>
                            <th title="Notatki oryginalne z dokumentu">UWAGI ORG</th>
                            <th title="Ścieżka do pliku obrazu (dla aktualnego wpisu)">Ścieżka Obrazu</th>
                            <th title="Dane ROI (Region Of Interest) - zaznaczone obszary na obrazie">ROI (JSON)</th>
                            <th title="Opcje (edycja, usuwanie)">Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Paste Dialog -->
        <div class="paste-overlay" id="pasteOverlay">
            <div style="font-size: 12px; font-weight: 600; color: #0078d4;">Wklej dane (TSV/CSV)</div>
            <textarea id="pasteTextarea" placeholder="Wklej dane z Excela lub CSV..."></textarea>
            <div class="paste-overlay-actions">
                <button class="paste-overlay-btn" onclick="processPastedData()">OK</button>
                <button class="paste-overlay-btn cancel" onclick="closePasteDialog()">Anuluj</button>
            </div>
        </div>
        <div class="thumbnails-bar" id="thumbsBar"></div>
        
        <!-- Postprocessing Panel -->
        <div class="postprocess-panel" id="postprocessPanel">
            <div class="postprocess-title">🎨 Postprocessing</div>
            
            <!-- CORE FILTERS -->
            <div class="postprocess-slider">
                <label>Poziomy (cień/światło)</label>
                <input type="range" id="contrastSlider" min="-100" max="100" value="0" step="5">
                <div class="postprocess-value" id="contrastValue">0</div>
            </div>
            
            <div class="postprocess-slider">
                <label>Dla starych aktów</label>
                <input type="range" id="brightnessSlider" min="0" max="100" value="0" step="5">
                <div class="postprocess-value" id="brightnessValue">0%</div>
            </div>
            
            <div class="postprocess-slider">
                <label>Usuwanie sitowia</label>
                <input type="range" id="sharpenSlider" min="0" max="100" value="0" step="5">
                <div class="postprocess-value" id="sharpenValue">0%</div>
            </div>
            
            <div class="postprocess-slider" style="flex-direction: row; align-items: center;">
                <label style="flex: 1;">Auto-kontrast</label>
                <input type="checkbox" id="saturationSlider" style="width: 20px; height: 20px; cursor: pointer;">
                <div class="postprocess-value" id="saturationValue" style="flex: 0;">OFF</div>
            </div>
            
            <!-- ADVANCED FILTERS -->
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 9px; text-transform: uppercase; color: #0078d4; margin-bottom: 10px;">Filtry zaawansowane</div>
                
                <div class="postprocess-slider">
                    <label>Żółty/Sepia</label>
                    <input type="range" id="sepiaSlider" min="0" max="100" value="0" step="5">
                    <div class="postprocess-value" id="sepiaValue">0%</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Odcień (Hue)</label>
                    <input type="range" id="hueSlider" min="-180" max="180" value="0" step="5">
                    <div class="postprocess-value" id="hueValue">0°</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Nasycenie</label>
                    <input type="range" id="saturSlider" min="0" max="200" value="100" step="5">
                    <div class="postprocess-value" id="saturValue">100%</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Inwersja (odwrócenie)</label>
                    <input type="range" id="invertSlider" min="0" max="100" value="0" step="5">
                    <div class="postprocess-value" id="invertValue">0%</div>
                </div>
            </div>
            
            <!-- OPENCV ADVANCED FILTERS -->
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 9px; text-transform: uppercase; color: #10b981; margin-bottom: 10px;">🔬 Filtry OpenCV (zaawansowane)</div>
                
                <div class="postprocess-slider">
                    <label>Adaptive Threshold</label>
                    <input type="range" id="adaptiveThresholdSlider" min="0" max="100" value="0" step="5">
                    <div class="postprocess-value" id="adaptiveThresholdValue">OFF</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Gaussian Blur (denoise)</label>
                    <input type="range" id="gaussianBlurSlider" min="0" max="10" value="0" step="1">
                    <div class="postprocess-value" id="gaussianBlurValue">0</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Median Filter (denoise)</label>
                    <input type="range" id="medianBlurSlider" min="0" max="10" value="0" step="1">
                    <div class="postprocess-value" id="medianBlurValue">0</div>
                </div>
                
                <div class="postprocess-slider" style="flex-direction: row; align-items: center;">
                    <label style="flex: 1;">Histogram Equalization</label>
                    <input type="checkbox" id="histogramEqCheckbox" style="width: 20px; height: 20px; cursor: pointer;">
                    <div class="postprocess-value" id="histogramEqValue" style="flex: 0;">OFF</div>
                </div>
            </div>
            
            <div class="postprocess-buttons">
                <button class="postprocess-btn" onclick="saveProcessedAsNew()" style="grid-column: span 2;">💾 Zapisz przetworzony</button>
                <button class="postprocess-btn reset" onclick="resetPostprocessing()">↻ Reset</button>
            </div>
        </div>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    <input type="file" id="folderInput" webkitdirectory multiple accept="image/*" style="display: none;">
    <input type="file" id="singleImageInput" accept="image/jpeg,image/png,image/jpg,image/webp,image/tiff" style="display: none;">
    <script>
        const app = {
            images: [],
            imageActs: [],
            currentImageIdx: 0,
            currentActNum: null,
            currentTemplate: null,
            templates: [],
            viewer: null,
            roiMode: false,
            actMode: false,
            drawingCanvas: null,
            drawingCtx: null,
            activeField: null,
            
            // Paginacja tabeli
            tablePageSize: 100,  // Ilość aktów do wyświetlenia na jedną stronę
            tablePageIndex: 0,   // Obecna strona
            drawingROI: false,
            roiStartX: 0,
            roiStartY: 0,
            roiOverlays: [],
            overlayMap: new Map(),
            needsFullRedraw: true,
            wizardActive: false,
            wizardCurrentFieldIdx: 0,
            wizardFields: [],
            autoLoadFolder: true,  // Włącz automatyczne ładowanie folderu przy starcie
            showActBoundaries: true,  // Włącz/wyłącz widoczność granic aktów
            
            // 🆕 UNDO/REDO system
            undoStack: [],
            redoStack: []
        };
        
        // ===== LOCAL DATABASE (sql.js) =====
        let localDb = null;
        let SQL = null;  // 🆕 Globalna zmienna SQL
        
        async function initLocalDB() {
            try {
                SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
                });
                window.SQL = SQL;  // 🆕 Przypisz do window
                localDb = new SQL.Database();
                
                // Tworzymy tabelę dla aktów (oryginalna struktura)
                localDb.run(`
                    CREATE TABLE IF NOT EXISTS records (
                        original_id TEXT PRIMARY KEY,
                        display_id TEXT UNIQUE,
                        id TEXT UNIQUE,
                        type TEXT,
                        year TEXT,
                        nr INTEGER,
                        image_path TEXT,
                        field_values TEXT,
                        act_roi TEXT,
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                    );
                `);
                
                // 🆕 Nowa tabela dla importu CSV - BEZ unique constraint na ID (obsługuje duplikaty)
                localDb.run(`
                    CREATE TABLE IF NOT EXISTS imported_records (
                        row_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        id TEXT,
                        rok TEXT,
                        nr TEXT,
                        nazwisko TEXT,
                        imie TEXT,
                        miejscowosc TEXT,
                        imie_o TEXT,
                        nazwisko_o TEXT,
                        w_o TEXT,
                        im TEXT,
                        nm TEXT,
                        w_m TEXT,
                        uwagi TEXT,
                        uwagi_org TEXT,
                        image_path TEXT,
                        roi_json TEXT,
                        imported_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                        status TEXT DEFAULT 'new'
                    );
                `);
                
                console.log('✅ Lokalna baza SQLite zainicjowana (+ tabela imported_records)');
                return true;
            } catch (err) {
                console.error('❌ Błąd inicjalizacji sql.js:', err);
                return false;
            }
        }
        
        // Zapisz akt do lokalnej bazy
        function saveActToLocalDB(act) {
            if (!localDb) return;
            
            try {
                const fieldJson = JSON.stringify(act.fieldValues || {});
                const roiJson = act.actROI ? JSON.stringify(act.actROI) : null;
                
                localDb.run(`
                    INSERT OR REPLACE INTO records 
                    (original_id, display_id, id, type, year, nr, image_path, field_values, act_roi)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
                `, [
                    act.originalId || 'UNKNOWN',
                    act.displayId || act.id || 'UNKNOWN',
                    act.id || act.displayId || 'UNKNOWN',
                    act.type || 'christening',
                    act.year || '1900',
                    act.nr || 0,
                    act.imagePath || '',
                    fieldJson,
                    roiJson
                ]);
                
                console.log('[Local DB] Zapisano akt:', act.displayId);
            } catch (err) {
                console.error('[Local DB] Błąd zapisu:', err);
            }
        }
        
        // 🆕 Wczytaj importowane rekordy z bazy
        function loadImportedRecords() {
            if (!localDb) return [];
            
            try {
                const stmt = localDb.prepare("SELECT * FROM imported_records ORDER BY imported_at DESC");
                const records = [];
                while (stmt.step()) {
                    const row = stmt.getAsObject();
                    records.push({
                        rowId: row.row_id,
                        id: row.id,
                        rok: row.rok,
                        nr: row.nr,
                        nazwisko: row.nazwisko,
                        imie: row.imie,
                        miejscowosc: row.miejscowosc,
                        imieO: row.imie_o,
                        nazwiskoO: row.nazwisko_o,
                        wO: row.w_o,
                        im: row.im,
                        nm: row.nm,
                        wM: row.w_m,
                        uwagi: row.uwagi,
                        uwagiOrg: row.uwagi_org,
                        imagePath: row.image_path,
                        roiJson: row.roi_json,
                        status: row.status
                    });
                }
                stmt.free();
                console.log(`✅ Wczytano ${records.length} rekordów z imported_records`);
                return records;
            } catch (err) {
                console.error('[Local DB] Błąd wczytywania imported_records:', err);
                return [];
            }
        }
        
        // 🆕 Zapisz importowany rekord
        function saveImportedRecord(record) {
            if (!localDb) return;
            
            try {
                localDb.run(`
                    INSERT INTO imported_records 
                    (id, rok, nr, nazwisko, imie, miejscowosc, imie_o, nazwisko_o, w_o, im, nm, w_m, uwagi, uwagi_org, image_path, roi_json, status)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                `, [
                    record.id || '',
                    record.rok || '',
                    record.nr || '',
                    record.nazwisko || '',
                    record.imie || '',
                    record.miejscowosc || '',
                    record.imieO || '',
                    record.nazwiskoO || '',
                    record.wO || '',
                    record.im || '',
                    record.nm || '',
                    record.wM || '',
                    record.uwagi || '',
                    record.uwagiOrg || '',
                    record.imagePath || '',
                    record.roiJson || '',
                    record.status || 'new'
                ]);
                console.log('[Local DB] Zapisano importowany rekord:', record.id);
            } catch (err) {
                console.error('[Local DB] Błąd zapisu importowanego rekordu:', err);
            }
        }
        
        // 🆕 Aktualizuj importowany rekord
        function updateImportedRecord(rowId, record) {
            if (!localDb) return;
            
            try {
                localDb.run(`
                    UPDATE imported_records SET
                    id = ?, rok = ?, nr = ?, nazwisko = ?, imie = ?, miejscowosc = ?, 
                    imie_o = ?, nazwisko_o = ?, w_o = ?, im = ?, nm = ?, w_m = ?, uwagi = ?, uwagi_org = ?, image_path = ?, roi_json = ?, status = ?
                    WHERE row_id = ?
                `, [
                    record.id || '',
                    record.rok || '',
                    record.nr || '',
                    record.nazwisko || '',
                    record.imie || '',
                    record.miejscowosc || '',
                    record.imieO || '',
                    record.nazwiskoO || '',
                    record.wO || '',
                    record.im || '',
                    record.nm || '',
                    record.wM || '',
                    record.uwagi || '',
                    record.uwagiOrg || '',
                    record.imagePath || '',
                    record.roiJson || '',
                    record.status || 'edited',
                    rowId
                ]);
                console.log('[Local DB] Zaktualizowano rekord:', rowId);
            } catch (err) {
                console.error('[Local DB] Błąd aktualizacji:', err);
            }
        }
        
        // 🆕 Usuń importowany rekord
        function deleteImportedRecord(rowId) {
            if (!localDb) return;
            
            try {
                localDb.run(`DELETE FROM imported_records WHERE row_id = ?`, [rowId]);
                console.log('[Local DB] Usunięto rekord:', rowId);
            } catch (err) {
                console.error('[Local DB] Błąd usunięcia:', err);
            }
        }
        
        // 🆕 Wykryj duplikaty po ID
        function detectDuplicates() {
            if (!localDb) return {};
            
            try {
                const stmt = localDb.prepare(`
                    SELECT id, COUNT(*) as count FROM imported_records 
                    GROUP BY id HAVING count > 1
                `);
                const duplicates = {};
                while (stmt.step()) {
                    const row = stmt.getAsObject();
                    duplicates[row.id] = row.count;
                }
                stmt.free();
                return duplicates;
            } catch (err) {
                console.error('[Local DB] Błąd w detectDuplicates:', err);
                return {};
            }
        }
        
        // Wczytaj wszystkie akty z lokalnej bazy
        function loadActsFromLocalDB() {
            if (!localDb) return [];
            
            try {
                const stmt = localDb.prepare("SELECT * FROM records ORDER BY year, nr");
                const acts = [];
                while (stmt.step()) {
                    const row = stmt.getAsObject();
                    const act = {
                        originalId: row.original_id,
                        displayId: row.display_id,
                        id: row.id,
                        type: row.type,
                        year: row.year,
                        nr: row.nr,
                        imagePath: row.image_path,
                        fieldValues: JSON.parse(row.field_values || '{}'),
                        actROI: row.act_roi ? JSON.parse(row.act_roi) : {}
                    };
                    acts.push(act);
                }
                stmt.free();
                console.log(`✅ Wczytano ${acts.length} aktów z lokalnej bazy`);
                return acts;
            } catch (err) {
                console.error('[Local DB] Błąd wczytywania:', err);
                return [];
            }
        }
        
        // ===== PERFORMANCE MONITORING =====
        const perfMetrics = {};
        
        function measurePerf(name, fn) {
            return function(...args) {
                const start = performance.now();
                const result = fn.apply(this, args);
                const duration = (performance.now() - start).toFixed(2);
                
                if (!perfMetrics[name]) perfMetrics[name] = [];
                perfMetrics[name].push(duration);
                
                if (duration > 100) {
                    console.warn(`⏱️ ${name}: ${duration}ms (SLOW!)`);
                } else if (duration > 50) {
                    console.log(`⏱️ ${name}: ${duration}ms`);
                }
                
                return result;
            };
        }
        
        function showPerfReport() {
            console.log('%c=== PERFORMANCE REPORT ===', 'color: #00ff00; font-weight: bold;');
            for (const [name, times] of Object.entries(perfMetrics)) {
                const avg = (times.reduce((a,b) => parseFloat(a) + parseFloat(b), 0) / times.length).toFixed(2);
                const max = Math.max(...times.map(parseFloat)).toFixed(2);
                const count = times.length;
                console.log(`${name}: avg=${avg}ms max=${max}ms count=${count}`);
            }
        }
        
        window.perfReport = showPerfReport; // Udostępnij w consoli: perfReport()
        
        // ===== KONIEC PERFORMANCE MONITORING =====
        
        const postprocessState = {
            levels: 0,               // -100 to 100 (shadows/highlights)
            autoContrast: false,     // Auto histogram equalization
            archival: 0,             // 0-100 (dedykowany dla wyblakłych dokumentów)
            descreen: 0,             // 0-100 (removes halftone patterns)
            sepia: 0,                // 0-100 (żółty/sepia filtr dla starych aktów)
            hue: 0,                  // -180 to 180 (rotacja barwy)
            saturation: 100,         // 0-200 (nasycenie kolorów)
            invert: 0,               // 0-100 (inwersja, pomaga przy ciemnym tle)
            adaptiveThreshold: 0,    // 0-100 (adaptive thresholding strength)
            gaussianBlur: 0,         // 0-10 (Gaussian blur kernel)
            medianBlur: 0,           // 0-10 (Median denoise)
            histogramEq: false,      // boolean (histogram equalization)
            backgroundSubtraction: 0,// 0-100 (background leveling - NOWE!)
            morphologyClose: 0,      // 0-100 (connecting broken strokes - NOWE!)
            autoInvert: false        // boolean (auto-detect and invert - NOWE!)
        };
        
        // Presets dla typowych genealogicznych dokumentów - rozszerzone
        const presets = {
            'archival': { 
                levels: 20, autoContrast: true, archival: 80, descreen: 20, sepia: 0, hue: 0, saturation: 80, invert: 0,
                adaptiveThreshold: 0, gaussianBlur: 0, medianBlur: 0, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'faded': { 
                levels: 30, autoContrast: true, archival: 100, descreen: 10, sepia: 0, hue: 0, saturation: 70, invert: 0,
                adaptiveThreshold: 0, gaussianBlur: 0, medianBlur: 0, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'dark': { 
                levels: -20, autoContrast: false, archival: 0, descreen: 0, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 0, gaussianBlur: 0, medianBlur: 0, histogramEq: false,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'bright': { 
                levels: 20, autoContrast: true, archival: 0, descreen: 0, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 0, gaussianBlur: 0, medianBlur: 0, histogramEq: false,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'typewriter': { 
                levels: 10, autoContrast: true, archival: 0, descreen: 5, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 50, gaussianBlur: 0, medianBlur: 0, histogramEq: false,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'ink': {
                levels: 5, autoContrast: false, archival: 0, descreen: 30, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 60, gaussianBlur: 1, medianBlur: 1, histogramEq: false,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'genealogy-pro': {
                levels: 15, autoContrast: true, archival: 50, descreen: 15, sepia: 5, hue: 0, saturation: 85, invert: 0,
                adaptiveThreshold: 40, gaussianBlur: 1, medianBlur: 0, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'faded-advanced': {
                levels: 35, autoContrast: true, archival: 90, descreen: 20, sepia: 10, hue: 0, saturation: 75, invert: 0,
                adaptiveThreshold: 50, gaussianBlur: 2, medianBlur: 1, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'text-extraction': {
                levels: 25, autoContrast: true, archival: 60, descreen: 25, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 80, gaussianBlur: 0, medianBlur: 0, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'heavy-duty': {
                levels: 40, autoContrast: true, archival: 100, descreen: 50, sepia: 10, hue: 0, saturation: 70, invert: 0,
                adaptiveThreshold: 80, gaussianBlur: 1, medianBlur: 3, histogramEq: true,
                backgroundSubtraction: 50, morphologyClose: 50, autoInvert: true
            }
        };
        
        // Global flags for preview
        let previewTimeout = null;
        let isProcessing = false;
        let opencvReady = false;
        
        // 🆕 AUTO-LOAD LATEST SQL FILE
        async function autoLoadLatestSQLFile() {
            try {
                // Spróbuj pobrać listę plików z API (tylko na Node/Express)
                // Na zwykłym HTTP nie możemy listować, więc szukamy po wspólnym pattern
                const possibleNames = [
                    'genealogia_2026-02-03.db',
                    'genealogia_2026-02-02.db',
                    'genealogia_2026-02-01.db',
                    'genealogia_2026-01-31.db',
                    'genealogia_2026-01-30.db',
                    'genealogia.db'
                ];
                
                // Szukaj najnowszego pliku zaczynając od dzisiejszej daty
                for (const filename of possibleNames) {
                    try {
                        const response = await fetch(`/${filename}`, { method: 'HEAD' });
                        if (response.ok) {
                            console.log(`✅ Znaleziono SQL: ${filename}`);
                            
                            // Wczytaj plik
                            const dataResponse = await fetch(`/${filename}`);
                            const buffer = await dataResponse.arrayBuffer();
                            const SQL = window.SQL;
                            const importedDb = new SQL.Database(new Uint8Array(buffer));
                            
                            // Odczytaj dane z tabeli
                            const results = importedDb.exec('SELECT * FROM imported_records ORDER BY row_id DESC');
                            
                            if (!results || results.length === 0) {
                                console.log('⚠️ SQL jest pusty lub brak tabeli imported_records');
                                return;
                            }
                            
                            const columns = results[0].columns;
                            const rows = results[0].values;
                            
                            let imported = 0;
                            for (const row of rows) {
                                const record = {};
                                columns.forEach((col, idx) => {
                                    record[col] = row[idx];
                                });
                                
                                // Mapuj na wewnętrzny format app.imageActs
                                // 🔧 FIX: Mapuj STARE nazwy kolumn SQL na NOWE pola genealogiczne
                                // SQL ma: imie, nazwisko, imie_o, nazwisko_o, im, nm, w_o, w_m
                                // App oczekuje: child_first_name, child_last_name, father_first_name itd.
                                const recordId = record.id || record.original_id || '';
                                const isCHFormat = recordId.startsWith('CH.LUB.BLIN') || recordId.startsWith('CH.BLIN');
                                
                                const mappedRecord = {
                                    id: isCHFormat ? recordId : (record.original_id || recordId || ''),
                                    original_id: isCHFormat ? recordId : (record.original_id || recordId || ''),
                                    rok: record.rok || '',
                                    year: record.rok || '',
                                    christening_year: record.rok || '',
                                    nr: record.nr || record.christening_act_number || '',
                                    christening_act_number: record.nr || '',
                                    imageIdx: record.imageidx || null,
                                    image_path: record.image_path || '',
                                    
                                    // NOWE kolumny genealogiczne (v8.20+) - czytaj z NOWYCH nazw, fallback na STARE
                                    child_first_name: record.child_first_name || record.imie || '',
                                    child_last_name: record.child_last_name || record.nazwisko || '',
                                    child_birth_date: record.child_birth_date || '',
                                    father_first_name: record.father_first_name || record.imie_o || '',
                                    father_last_name: record.father_last_name || record.nazwisko_o || '',
                                    father_age: record.father_age || record.w_o || '',
                                    mother_first_name: record.mother_first_name || record.im || '',
                                    mother_last_name: record.mother_last_name || record.nm || '',
                                    mother_maiden_name: record.mother_maiden_name || '',
                                    mother_age: record.mother_age || record.w_m || '',
                                    witnesses: record.witnesses || '',
                                    
                                    // fieldValues
                                    fieldValues: record.field_values ? JSON.parse(record.field_values) : {
                                        child_first_name: record.child_first_name || record.imie || '',
                                        child_last_name: record.child_last_name || record.nazwisko || '',
                                        child_birth_date: record.child_birth_date || '',
                                        father_first_name: record.father_first_name || record.imie_o || '',
                                        father_last_name: record.father_last_name || record.nazwisko_o || '',
                                        father_age: record.father_age || record.w_o || '',
                                        mother_first_name: record.mother_first_name || record.im || '',
                                        mother_last_name: record.mother_last_name || record.nm || '',
                                        mother_maiden_name: record.mother_maiden_name || '',
                                        mother_age: record.mother_age || record.w_m || '',
                                        witnesses: record.witnesses || '',
                                        notes: record.uwagi || record.notes || '',
                                        notes_org: record.uwagi_org || record.notes_org || '',
                                        location: record.miejscowosc || ''
                                    },
                                    
                                    fieldROIs: record.roi_json ? JSON.parse(record.roi_json) : {},
                                    status: record.status || 'new'
                                };
                                
                                if (!app.imageActs) app.imageActs = [];
                                app.imageActs.push(mappedRecord);
                                imported++;
                            }
                            
                            importedDb.close();
                            
                            console.log(`✅ Auto-wczytano ${imported} rekordów z ${filename}`);
                            notify(`✅ Auto-wczytano ${imported} aktów z najnowszego SQL`, 'success');
                            
                            // 🔥 WAŻNE: Odśwież tabelę główną aby były widoczne dane!
                            renderRecordsTable();
                            
                            return; // Wyjdź po znalezieniu i załadowaniu
                        }
                    } catch (e) {
                        // Plik nie istnieje, spróbuj następny
                        continue;
                    }
                }
                
                // Jeśli nic nie znaleziono
                console.log('ℹ️ Brak SQL w folderze - użyj "Import SQL" lub "Ładuj Supabase"');
                
            } catch (error) {
                console.error('⚠️ Błąd auto-ładowania SQL:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Pokaż loading overlay
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('hidden');
            
            // Poczekaj max 10 sekund na Supabase inicjalizację
            await Promise.race([
                new Promise(r => window.addEventListener('supabaseReady', r, { once: true })),
                new Promise(r => setTimeout(r, 10000))
            ]);
            
            // Ukryj overlay i inicjalizuj app
            if (overlay) overlay.classList.add('hidden');
            await initApp();
        });

        async function initApp() {
            console.log('📍 DOMContentLoaded start');
            
            // ===== AGGRESSIVE CLEANUP FOR OLD SCHEMA =====
            try {
                const stored = localStorage.getItem('genealog_data');
                if (stored) {
                    const data = JSON.parse(stored);
                    // Detect if this is old schema (has 'chrzest' type)
                    const hasOldSchema = data.imageActs?.some(act => 
                        act.type === 'chrzest' || act.type === 'urodzenia' || act.type === 'malzenstwa' || act.type === 'zgony'
                    );
                    if (hasOldSchema) {
                        console.warn('⚠️ Old schema detected - clearing localStorage');
                        localStorage.clear();
                    }
                }
            } catch(e) {}
            
            // ===== VERSION CHECK - RESET OLD DATA =====
            const currentVersion = '8.7-dynamic-forms';
            const storedVersion = localStorage.getItem('genealog_version');
            if (storedVersion !== currentVersion) {
                console.warn(`⚠️ Version change detected (${storedVersion} → ${currentVersion}) - clearing localStorage`);
                localStorage.clear();
                localStorage.setItem('genealog_version', currentVersion);
            } else {
                localStorage.setItem('genealog_version', currentVersion);
            }
            
            // Initialize Firebase Auth State Listener (legacy - kept for compatibility)
            if (window.auth) {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        // User is signed in
                        console.log('🔥 User signed in:', user.displayName);
                        
                        // Update UI
                        const authBtn = document.getElementById('authBtn');
                        if (authBtn) {
                            authBtn.innerHTML = '<i class="fas fa-user-check"></i> ' + user.displayName.split(' ')[0];
                            authBtn.title = 'Wyloguj się';
                            authBtn.onclick = signOut;
                        }
                        
                        // Enable Supabase (no auth required)
                        app.storageMode = 'supabase';
                        
                    } else {
                        // User is signed out
                        console.log('💤 User signed out');
                        
                        // Update UI
                        const authBtn = document.getElementById('authBtn');
                        if (authBtn) {
                            authBtn.innerHTML = '<i class="fab fa-google"></i> Login';
                            authBtn.title = 'Zaloguj się z Google (opcjonalnie)';
                            authBtn.onclick = signInWithGoogle;
                        }
                        
                        // Supabase works without auth (public table)
                        app.storageMode = 'supabase';
                    }
                });
            } else {
                // No Firebase - use Supabase directly
                console.log('✅ Using Supabase directly (no auth required)');
                app.storageMode = 'supabase';
            }
            
            // Clear old oversized data from localStorage
            try {
                const oldData = localStorage.getItem('genealog_data');
                if (oldData && oldData.length > 5000000) { // Zwiększono limit z 1MB na 5MB
                    console.log('🧹 Clearing oversized localStorage data');
                    localStorage.removeItem('genealog_data');
                }
            } catch(e) {}
            
            loadFallbackTemplates();
            console.log('📍 Templates loaded:', app.templates.length);
            initViewer();
            console.log('📍 Viewer initialized');
            setupDrawingCanvas();
            console.log('📍 Canvas setup complete');
            // ===== INIT LOCAL SQL.JS DATABASE =====
            await initLocalDB();
            console.log('📍 Local SQL.js database initialized');
            await loadStorage();
            console.log('📍 Storage loaded, images:', app.images.length);
            
            // 🆕 Auto-load offline data z IndexedDB (jeśli istnieje)
            try {
                const offlineData = await loadFromIndexedDB();
                if (offlineData && offlineData.length > 0) {
                    app.imageActs = offlineData;
                    console.log(`✅ Auto-loaded ${offlineData.length} rekordów z offline IndexedDB`);
                }
            } catch (e) {
                console.log('⚠️ IndexedDB offline load failed:', e.message);
            }
            
            renderUI();
            console.log('📍 UI rendered');
            setupPostprocessSliders();
            console.log('📍 Postprocess sliders setup');
            setupEvents();
            console.log('📍 Events setup complete');
            
            // 🆕 Załaduj konfigurację pól genealogicznych
            await loadFieldsConfig();
            console.log('📍 Fields config loaded');
            
            // 🆕 Spróbuj załadować najnowszy SQL z folderu (genealogia_*.db)
            await autoLoadLatestSQLFile();
            console.log('📍 Auto-load SQL checked');
            
            // 🆕 Załaduj importowane rekordy i wyświetl w tabeli
            renderImportedRecordsTable();
            console.log('📍 Imported records loaded');
            
            // 🔥 WAŻNE: Odśwież tabelę główną (bywają akty z SQL!)
            renderRecordsTable();
            console.log('📍 Records table rendered');
            
            // 🆕 Dodaj kontrolki dla konsoli (F12)
            window.tableHelpers = {
                copyHeader: function() {
                    const headers = Array.from(document.querySelectorAll('#dataTable thead th'))
                        .map(th => th.textContent.trim())
                        .join('\t');
                    navigator.clipboard.writeText(headers).then(() => {
                        console.log('✅ Nagłówek skopiowany do schowka!');
                        console.log(headers);
                    });
                },
                copyTable: function() {
                    const table = document.getElementById('dataTable');
                    const headers = Array.from(table.querySelectorAll('thead th'))
                        .map(th => th.textContent.trim())
                        .join('\t');
                    const rows = Array.from(table.querySelectorAll('tbody tr'))
                        .map(tr => Array.from(tr.querySelectorAll('td'))
                            .map(td => td.textContent.trim())
                            .join('\t'))
                        .join('\n');
                    const content = headers + '\n' + rows;
                    navigator.clipboard.writeText(content).then(() => {
                        console.log(`✅ Cała tabela skopiowana! (${table.querySelectorAll('tbody tr').length} wierszy)`);
                    });
                },
                exportJSON: function() {
                    const records = loadImportedRecords();
                    const json = JSON.stringify(records, null, 2);
                    navigator.clipboard.writeText(json).then(() => {
                        console.log(`✅ JSON skopiowany! (${records.length} rekordów)`);
                    });
                },
                countRows: function() {
                    const count = document.querySelectorAll('#dataTable tbody tr').length;
                    console.log(`📊 Razem wierszy: ${count}`);
                },
                help: function() {
                    console.log('%c=== TABLE HELPERS (F12) ===', 'color: #0078d4; font-weight: bold; font-size: 14px;');
                    console.log('tableHelpers.copyHeader()  → Skopiuj nagłówek tabeli');
                    console.log('tableHelpers.copyTable()   → Skopiuj całą tabelę');
                    console.log('tableHelpers.exportJSON()  → Skopiuj dane jako JSON');
                    console.log('tableHelpers.countRows()   → Pokaż liczbę wierszy');
                    console.log('tableHelpers.help()        → Ten komunikat');
                }
            };
            console.log('💡 Wpisz tableHelpers.help() aby zobaczyć dostępne funkcje');
            
            // 🔧 NAPRAWIONO: Auto-load folder jest zabroniony w Firefox'ie - wyłącz
            // (użytkownik musi ręcznie kliknąć przycisk "Otwórz")
            if (app.autoLoadFolder) {
                // setTimeout(() => document.getElementById('folderInput').click(), 500);
                console.log('ℹ️ Auto-load folder disabled for security - click "Otwórz" button manually');
            }
            
            notify('v7.0 gotowy!', 'success');
        }
        
        function loadFallbackTemplates() {
            app.templates = [
                {
                    id: "christening",
                    name: "Akt Chrztu",
                    sections: [
                        {
                            id: "meta",
                            title: "<i class='fas fa-book'></i> Metadane",
                            expanded: true,
                            fields: [
                                {id: "christening_year", label: "Rok", type: "text"},
                                {id: "christening_act_number", label: "Numer aktu", type: "text"}
                            ]
                        },
                        {
                            id: "registration",
                            title: "<i class='fas fa-calendar'></i> Zgłoszenie",
                            expanded: true,
                            fields: [
                                {id: "christening_registration_date", label: "Data zgłoszenia (zwykle = data chrztu)", type: "text"}
                            ]
                        },
                        {
                            id: "child",
                            title: "<i class='fas fa-baby'></i> Dziecko",
                            expanded: true,
                            fields: [
                                {id: "child_first_name", label: "Imię dziecka", type: "text"},
                                {id: "child_last_name", label: "Nazwisko dziecka", type: "text"},
                                {id: "child_birth_date", label: "Dziecko urodzone dnia", type: "text"}
                            ]
                        },
                        {
                            id: "reporter",
                            title: "<i class='fas fa-user'></i> Osoba zgłaszająca",
                            expanded: false,
                            fields: [
                                {id: "reporter_info", label: "Imię, nazwisko, zawód, wiek, miejsce", type: "text"}
                            ]
                        },
                        {
                            id: "witnesses",
                            title: "<i class='fas fa-users'></i> Świadkowie",
                            expanded: false,
                            fields: [
                                {id: "witness1_info", label: "Świadek 1 (imię, nazwisko, wiek, zawód, miejsce)", type: "text"},
                                {id: "witness2_info", label: "Świadek 2 (imię, nazwisko, wiek, zawód, miejsce)", type: "text"}
                            ]
                        },
                        {
                            id: "mother",
                            title: "<i class='fas fa-woman'></i> Matka",
                            expanded: false,
                            fields: [
                                {id: "mother_first_name", label: "Imię matki", type: "text"},
                                {id: "mother_last_name", label: "Nazwisko matki", type: "text"},
                                {id: "mother_maiden_name", label: "Nazwisko panieńskie matki", type: "text"},
                                {id: "mother_info", label: "Matka – lata, miejsce zamieszkania, zawód", type: "text"}
                            ]
                        },
                        {
                            id: "confirmation",
                            title: "<i class='fas fa-check'></i> Potwierdzenie",
                            expanded: false,
                            fields: [
                                {id: "christening_name", label: "Nadano imię na chrzcie (potwierdzenie)", type: "text"}
                            ]
                        }
                    ]
                },
                {
                    id: "birth",
                    name: "Akt Urodzenia",
                    sections: [
                        {
                            id: "basic",
                            title: "<i class='fas fa-info-circle'></i> Podstawowe",
                            expanded: true,
                            fields: [
                                {id: "child_first_name", label: "Imię dziecka", type: "text"},
                                {id: "child_last_name", label: "Nazwisko dziecka", type: "text"}
                            ]
                        },
                        {
                            id: "parents",
                            title: "<i class='fas fa-users'></i> Rodzice",
                            expanded: false,
                            fields: [
                                {id: "father_name", label: "Ojciec", type: "text"},
                                {id: "mother_name", label: "Matka", type: "text"}
                            ]
                        }
                    ]
                },
                {
                    id: "marriage",
                    name: "Akt Małżeństwa",
                    sections: [
                        {
                            id: "basic",
                            title: "<i class='fas fa-info-circle'></i> Podstawowe",
                            expanded: true,
                            fields: [
                                {id: "groom_first_name", label: "Imię pana młodego", type: "text"},
                                {id: "groom_last_name", label: "Nazwisko pana młodego", type: "text"},
                                {id: "bride_first_name", label: "Imię panny młodej", type: "text"},
                                {id: "bride_last_name", label: "Nazwisko panny młodej (przed)", type: "text"}
                            ]
                        },
                        {
                            id: "parents",
                            title: "<i class='fas fa-users'></i> Rodzice",
                            expanded: false,
                            fields: [
                                {id: "groom_father", label: "Ojciec pana młodego", type: "text"},
                                {id: "groom_mother", label: "Matka pana młodego", type: "text"},
                                {id: "bride_father", label: "Ojciec panny młodej", type: "text"},
                                {id: "bride_mother", label: "Matka panny młodej", type: "text"}
                            ]
                        }
                    ]
                },
                {
                    id: "death",
                    name: "Akt Zgonu",
                    sections: [
                        {
                            id: "basic",
                            title: "<i class='fas fa-info-circle'></i> Podstawowe",
                            expanded: true,
                            fields: [
                                {id: "deceased_first_name", label: "Imię zmarłego", type: "text"},
                                {id: "deceased_last_name", label: "Nazwisko zmarłego", type: "text"},
                                {id: "age", label: "Wiek", type: "text"},
                                {id: "death_place", label: "Miejsce zgonu", type: "text"}
                            ]
                        },
                        {
                            id: "family",
                            title: "<i class='fas fa-users'></i> Rodzina",
                            expanded: false,
                            fields: [
                                {id: "spouse", label: "Małżonek/małżonka", type: "text"},
                                {id: "father", label: "Ojciec", type: "text"},
                                {id: "mother", label: "Matka", type: "text"}
                            ]
                        }
                    ]
                }
            ];
            app.currentTemplate = "christening";
        }
        
        function renderFormSections() {
            const perfStart = performance.now();
            // ===== Right panel - renders form for selected act =====
            const container = document.getElementById('formsContainer');
            if (!container) return;
            container.innerHTML = '';
            
            // Sprawdź czy mamy wybrany akt
            if (!app.currentActNum) {
                container.innerHTML = '<div style="padding: 12px; color: #666; font-size: 11px;">Wybierz akt z lewego panelu</div>';
                return;
            }
            
            // Szukaj aktu po actNum (ten zawsze istnieje)
            const act = app.imageActs.find(a => a.actNum === app.currentActNum);
            
            if (!act) {
                container.innerHTML = '<div style="padding: 12px; color: #888;">Akt nie znaleziony - szukaj po: ' + app.currentActNum + '</div>';
                return;
            }
            
            console.log('📋 renderFormSections - act:', act);
            console.log('📋 act.type:', act.type);

            // ===== SELECTOR TYPU AKTU – DROPDOWN W HEADERZE =====
            const header = document.createElement('div');
            header.style.cssText = 'padding: 12px; background: #252525; border-bottom: 1px solid #3a3a3a; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center; gap: 12px;';
            
            const titleSpan = document.createElement('span');
            // Pokaż skrót do indeksacji (CH.1783.No.1) z pełnym ID w tooltip
            titleSpan.textContent = 'Akt: ' + act.actNum + ' (' + (act.original_id || act.id) + ')';
            titleSpan.style.cssText = 'color: #0078d4; font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
            titleSpan.title = 'ID źródłowe: ' + (act.original_id || act.id);
            
            const typeSelect = document.createElement('select');
            typeSelect.style.cssText = 'padding: 4px 6px; background: #1a1a1a; border: 1px solid #0078d4; color: #ddd; border-radius: 3px; font-size: 11px; flex: 1;';
            typeSelect.innerHTML = app.templates.map(t => 
                `<option value="${t.id}" ${t.id === act.type ? 'selected' : ''}>${t.name}</option>`
            ).join('');
            
            // 🔧 Dodaj przycisk do wyboru pól
            const fieldsBtn = document.createElement('button');
            fieldsBtn.textContent = '🔧';
            fieldsBtn.title = 'Wybierz pola do wyświetlenia';
            fieldsBtn.style.cssText = 'padding: 4px 8px; background: #1a4d2e; border: 1px solid #10b981; color: #10b981; border-radius: 3px; cursor: pointer; font-size: 12px;';
            fieldsBtn.addEventListener('click', () => showFieldsSelector(act.type));
            
            // 💾 Dodaj przycisk do zapisania akta
            const saveBtn = document.createElement('button');
            saveBtn.textContent = '💾';
            saveBtn.title = 'Zapisz akt do Supabase';
            saveBtn.style.cssText = 'padding: 4px 8px; background: #1a4d2e; border: 1px solid #10b981; color: #10b981; border-radius: 3px; cursor: pointer; font-size: 12px;';
            saveBtn.addEventListener('click', () => {
                console.log('💾 Saving act:', act.id);
                saveStorage();
                notify(`✅ Akt ${act.id} zapisany do bazy`, 'success');
            });
            
            header.appendChild(titleSpan);
            header.appendChild(typeSelect);
            header.appendChild(fieldsBtn);
            header.appendChild(saveBtn);
            
            typeSelect.addEventListener('change', async (e) => {
                console.log('✅ Select change event - new type:', e.target.value);
                act.type = e.target.value;
                
                // Regenerate ID based on new type
                const actData = {
                    typ: act.type,
                    woj: act.woj || 'WAR',
                    parafia: act.parish || 'NEZNANE',
                    data_zgl: `${act.year || 1900}-00-01`,
                    nr_aktu: act.nr || 1,
                    is_copy: false
                };
                act.id = await autoGenerateID(actData);
                console.log('🔄 Regenerated ID to:', act.id);
                
                saveStorage();
                renderActsList(); // Update left panel with new ID
                renderFormSections();
            });
            
            container.appendChild(header);

            // ===== SPECIALIZED FORM FOR CHRISTENING (CHRZEST) =====
            if (act.type === 'christening') {
                renderChrzestForm(container, act);
                return;
            }

            // ===== GENERIC FORM FOR OTHER TYPES =====
            const template = app.templates.find(t => t.id === act.type);
            if (!template) {
                console.error('❌ Template not found for type:', act.type);
                container.innerHTML += '<p style="color: #888; padding: 12px;">Brak szablonu dla tego typu: ' + act.type + '</p>';
                return;
            }
            console.log('✅ Template loaded:', template.name);

            // Render sections
            template.sections.forEach(sec => {
                const secDiv = document.createElement('div');
                secDiv.style.marginBottom = '12px';
                
                const secTitle = document.createElement('div');
                secTitle.innerHTML = sec.title || sec.id;
                secTitle.style.cssText = 'color: #0078d4; font-weight: 600; font-size: 11px; margin-bottom: 6px; border-bottom: 1px solid #2a2a2a; padding-bottom: 4px;';
                secDiv.appendChild(secTitle);

                sec.fields.forEach(f => {
                    if (f.applicableTypes && !f.applicableTypes.includes(act.type)) {
                        return;
                    }

                    const group = document.createElement('div');
                    group.className = 'form-group';
                    group.style.marginBottom = '8px';
                    
                    const label = document.createElement('label');
                    label.textContent = f.label;
                    label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 3px;';
                    group.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = f.type || 'text';
                    input.className = 'field-input';
                    input.dataset.field = f.id;
                    input.placeholder = f.label;
                    input.value = act.fieldValues[f.id] || '';
                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                    
                    if (act.fieldROIs && act.fieldROIs[f.id]) {
                        input.classList.add('has-roi');
                        input.style.borderLeft = '4px solid #10b981';
                    }
                    
                    input.addEventListener('blur', (e) => {
                        act.fieldValues[f.id] = e.target.value;
                        updateCurrentRowInTable(); // Aktualizuj tabelę na żywo
                        saveStorage();
                    });
                    
                    // Enter zatwierdza edycję i cofa focus
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            input.blur();
                        }
                    });
                    
                    group.appendChild(input);
                    secDiv.appendChild(group);
                });

                container.appendChild(secDiv);
            });

            // ===== ADD CUSTOM FIELD BUTTON =====
            const addFieldDiv = document.createElement('div');
            addFieldDiv.style.marginTop = '12px';
            addFieldDiv.style.paddingTop = '12px';
            addFieldDiv.style.borderTop = '1px solid #2a2a2a';

            const addBtn = document.createElement('button');
            addBtn.textContent = '+ Dodaj pole';
            addBtn.style.cssText = 'background: #252525; border: 1px solid #3a3a3a; color: #ddd; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 10px; width: 100%;';
            
            addBtn.addEventListener('click', () => {
                const fieldId = prompt('ID pola (np. custom_note):');
                if (!fieldId) return;
                
                const fieldLabel = prompt('Nazwa pola:', fieldId);
                if (!fieldLabel) return;
                
                if (!act.fieldValues) act.fieldValues = {};
                act.fieldValues[fieldId] = '';
                
                saveStorage();
                renderFormSections();
            });

            addFieldDiv.appendChild(addBtn);
            container.appendChild(addFieldDiv);

            container.querySelector('.field-input')?.focus();
            
            const perfDuration = (performance.now() - perfStart).toFixed(2);
            if (perfDuration > 500) {
                console.warn(`⏱️ renderFormSections: ${perfDuration}ms (SLOW!)`);
            } else {
                console.log(`⏱️ renderFormSections: ${perfDuration}ms`);
            }
        }

        // ===== FIELDS SELECTOR - Pozwól użytkownikowi wybrać które pola pokazywać =====
        function showFieldsSelector(actType) {
            const savedFields = JSON.parse(localStorage.getItem(`visibleFields_${actType}`) || '{}');
            const template = app.templates.find(t => t.id === actType);
            if (!template) return;
            
            // Stwórz modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #1a1a1a; border: 2px solid #10b981; border-radius: 8px;
                padding: 20px; width: 90%; max-width: 400px; z-index: 10000;
                max-height: 80vh; overflow-y: auto;
            `;
            
            const title = document.createElement('h3');
            title.textContent = '🔧 Wybierz sekcje do wyświetlenia';
            title.style.cssText = 'color: #10b981; margin: 0 0 15px 0;';
            modal.appendChild(title);
            
            // Checkbox dla każdej sekcji
            template.sections.forEach(section => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = savedFields[section.id] !== false;  // Domyślnie zaznaczone
                checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
                checkbox.addEventListener('change', (e) => {
                    savedFields[section.id] = e.target.checked;
                    localStorage.setItem(`visibleFields_${actType}`, JSON.stringify(savedFields));
                });
                
                const text = document.createElement('span');
                text.textContent = section.title.replace(/<[^>]*>/g, '');  // Usuń HTML tags
                text.style.cssText = 'color: #ddd; font-size: 12px;';
                
                label.appendChild(checkbox);
                label.appendChild(text);
                modal.appendChild(label);
            });
            
            // Przyciski
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;';
            
            const resetBtn = document.createElement('button');
            resetBtn.textContent = '↻ Resetuj';
            resetBtn.style.cssText = 'padding: 8px; background: #1a3a3a; border: 1px solid #10b981; color: #10b981; border-radius: 3px; cursor: pointer; font-size: 11px;';
            resetBtn.addEventListener('click', () => {
                localStorage.removeItem(`visibleFields_${actType}`);
                modal.remove();
                renderFormSections();
            });
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '✓ Gotowe';
            closeBtn.style.cssText = 'padding: 8px; background: #1a4d2e; border: 1px solid #10b981; color: #10b981; border-radius: 3px; cursor: pointer; font-size: 11px;';
            closeBtn.addEventListener('click', () => {
                modal.remove();
                renderFormSections();
            });
            
            buttonsDiv.appendChild(resetBtn);
            buttonsDiv.appendChild(closeBtn);
            modal.appendChild(buttonsDiv);
            
            // Dodaj backdrop
            const backdrop = document.createElement('div');
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999;';
            backdrop.addEventListener('click', () => {
                backdrop.remove();
                modal.remove();
            });
            
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }

        // ===== DEBOUNCE HELPER =====
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function renderChrzestForm(container, act) {
            // ===== SPECIALIZED FORM FOR CHRISTENING (CHRZEST) =====
            // Dodaj padding-left żeby formularz był dalej od lewej krawędzi
            container.style.paddingLeft = '8px';
            
            // 🔧 Sprawdź czy sekcja powinna być widoczna
            const isVisibleSection = (sectionId) => {
                const savedFields = JSON.parse(localStorage.getItem('visibleFields_christening') || '{}');
                // Domyślnie wszystkie sekcje widoczne, chyba że użytkownik je ukrył
                return savedFields[sectionId] !== false;
            };
            
            console.log('📋 renderChrzestForm - act.fieldValues:', act.fieldValues);
            console.log('📋 renderChrzestForm - act.original_id:', act.original_id);
            console.log('📋 renderChrzestForm - act.id:', act.id);
            console.log('📋 fieldValues keys:', Object.keys(act.fieldValues || {}));
            console.log('📋 child_first_name:', act.fieldValues?.child_first_name);
            console.log('📋 father_first_name:', act.fieldValues?.father_first_name);
            console.log('📋 mother_first_name:', act.fieldValues?.mother_first_name);
            
            if (!act.fieldValues) act.fieldValues = {};
            
            // ===== MAPUJ NAZWY PÓL Z SUPABASE NA FORMULARZA =====
            // Supabase -> Formularz
            const fieldMapping = {
                'book_number': 'ksiega_nr',
                'page_number': 'strona_nr',
                'parish': 'parafia',
                'child_first_name': 'dziecko_imie',
                'child_last_name': 'dziecko_nazwisko',
                'child_birth_date': 'dziecko_data_ur',
                'child_gender': 'dziecko_plec',
                'child_legitimacy_status': 'dziecko_status',
                'father_first_name': 'ojciec_imie',
                'father_last_name': 'ojciec_nazwisko',
                'father_age': 'ojciec_wiek',
                'father_occupation': 'ojciec_zawod',
                'father_civil_status': 'ojciec_stan_cywilny',
                'mother_first_name': 'matka_imie',
                'mother_last_name': 'matka_nazwisko',
                'mother_maiden_name': 'matka_panienskie',
                'mother_age': 'matka_lata',
                'mother_occupation': 'matka_zawod',
                'mother_civil_status': 'matka_stan_cywilny',
                'location': 'matka_miejsce',
                'godfather_first_name': 'ojciec_chrzestny_imie',
                'godfather_last_name': 'ojciec_chrzestny_nazwisko',
                'godfather_place': 'ojciec_chrzestny_miejsce',
                'godmother_first_name': 'matka_chrzestna_imie',
                'godmother_last_name': 'matka_chrzestna_nazwisko',
                'godmother_place': 'matka_chrzestna_miejsce',
                'priest_first_name': 'ksiadz_imie',
                'priest_last_name': 'ksiadz_nazwisko',
                'priest_occupation': 'ksiadz_zawod',
                'christening_date': 'data_chrztu',
                'report_date': 'data_zgloszenia',
                'reporting_person_first_name': 'zglaszajacy_imie',
                'reporting_person_last_name': 'zglaszajacy_nazwisko',
                'reporting_person_occupation': 'zglaszajacy_zawod',
                'reporting_person_age': 'zglaszajacy_wiek',
                'reporting_person_place': 'zglaszajacy_miejsce',
                'witness_1_first_name': 'swiadek_1_imie',
                'witness_1_last_name': 'swiadek_1_nazwisko',
                'witness_1_occupation': 'swiadek_1_zawod',
                'witness_1_place': 'swiadek_1_miejsce',
                'witness_2_first_name': 'swiadek_2_imie',
                'witness_2_last_name': 'swiadek_2_nazwisko',
                'witness_2_occupation': 'swiadek_2_zawod',
                'witness_2_place': 'swiadek_2_miejsce',
                'witness_3_first_name': 'swiadek_3_imie',
                'witness_3_last_name': 'swiadek_3_nazwisko',
                'witness_3_occupation': 'swiadek_3_zawod',
                'witness_3_place': 'swiadek_3_miejsce',
                'witnesses': 'swiadkowie',
                'notes': 'custom_note',
                'notes_org': 'custom_note'
            };
            
            // Zrób kopię fieldValues z mapowaniem
            Object.keys(fieldMapping).forEach(supabaseField => {
                const formField = fieldMapping[supabaseField];
                if (act.fieldValues[supabaseField] && !act.fieldValues[formField]) {
                    act.fieldValues[formField] = act.fieldValues[supabaseField];
                    console.log(`📋 Mapuję ${supabaseField} -> ${formField} = ${act.fieldValues[formField]}`);
                }
            });

            // ===== PARSE DANYCH Z ID AKTU =====
            // Format ID: CH.WAR.PARAFIA.1890.00.00001.00
            let initialRok = act.fieldValues['rok'] || '';
            let initialNrAktu = act.fieldValues['nr_aktu'] || '';
            let initialDataZgloszenia = act.fieldValues['data_zgloszenia'] || '';
            
            if (act.id && !initialRok) {
                const idParts = act.id.split('.');
                if (idParts.length >= 4) {
                    initialRok = idParts[3]; // Rok z pozycji 3
                    act.fieldValues['rok'] = initialRok;
                }
                if (idParts.length >= 6) {
                    initialNrAktu = idParts[5].replace(/^0+/, '') || idParts[5]; // Nr aktu z pozycji 5, usuń wiodące 0
                    act.fieldValues['nr_aktu'] = initialNrAktu;
                }
                if (!initialDataZgloszenia && initialRok) {
                    initialDataZgloszenia = initialRok + '.**.--.';
                    act.fieldValues['data_zgloszenia'] = initialDataZgloszenia;
                }
            }

            // Lista pól w idealnej kolejności
            const baseFields = [
                // Nieużywane w v8.11 - wszystkie pola są w fieldGroups
            ];

            const extraFields = [
                // Nieużywane w v8.11 - wszystkie pola są w fieldGroups
            ];

            // ===== ROK, NR AKTU, DATA ZGŁOSZENIA (Z 4 POLAMI) W JEDNEJ LINII =====
            const headerWrapper = document.createElement('div');
            headerWrapper.style.cssText = 'display: grid; grid-template-columns: 80px 90px 1fr; gap: 6px; margin-bottom: 6px;';

            // PRE-DEFINE spinnerInputs i updateDateSpinner (będą używane w rokInput listener)
            const spinnerInputs = {};
            
            // Tablica dni tygodnia - zdefiniuj TUTAJ żeby była dostępna wszędzie
            const daysOfWeek = ['__', 'Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'So', 'Nd'];
            
            // Algorytm Zellera - zdefiniuj TUTAJ zanim updateDateSpinner
            // POLSKA: Reforma gregoriańska wdrożona 4/15 października 1582 r. (papież Grzegorz XIII)
            // Przed 1582-10-15: kalendarz juliański
            // Od 1582-10-15: kalendarz gregoriański
            // Testowe daty historyczne Polski:
            // - 15 lipca 1410: Bitwa pod Grunwaldem (wtorek)
            // - 3 maja 1791: Konstytucja 3 Maja (piątek)
            // - 29 listopada 1830: Powstanie Listopadowe (poniedziałek)
            // - 16 stycznia 2026: dzisiejsza data (piątek)
            const getDayOfWeekZeller = (rok, mies, dzien) => {
                let m = mies;
                let y = rok;
                if (m < 3) {
                    m += 12;
                    y -= 1;
                }
                const q = dzien;
                const K = y % 100;
                const J = Math.floor(y / 100);
                
                let h;
                // Dla dat PRZED reformą gregoriańską w Polsce (przed 1582-10-15), użyj kalendarza juliańskiego
                if (rok < 1582 || (rok === 1582 && (mies < 10 || (mies === 10 && dzien < 15)))) {
                    // Kalendarz juliański: h = (q + ⌊13(m+1)/5⌋ + K + ⌊K/4⌋ + 5 - J) mod 7
                    h = (q + Math.floor(13 * (m + 1) / 5) + K + Math.floor(K / 4) + 5 - J) % 7;
                } else {
                    // Kalendarz gregoriański (wersja najpopularniejsza i najbezpieczniejsza)
                    // h = (dzien + ⌊13(m+1)/5⌋ + K + ⌊K/4⌋ + ⌊J/4⌋ + 5*J) mod 7
                    h = (q + Math.floor(13 * (m + 1) / 5) + K + Math.floor(K / 4) + Math.floor(J / 4) + 5 * J) % 7;
                }
                
                // Standardowe mapowanie Zellera (dla obu kalendarzy)
                // h: 0=Sobota, 1=Niedziela, 2=Poniedziałek, 3=Wtorek, 4=Środa, 5=Czwartek, 6=Piątek
                const daysZeller = [6, 7, 1, 2, 3, 4, 5]; // mapowanie na indeksy w daysOfWeek
                return daysOfWeek[daysZeller[h]];
            };
            
            // Definiuj updateDateSpinner TUTAJ, zanim będzie używana w listenerach
            const updateDateSpinner = () => {
                const rok = spinnerInputs['rok_spinner']?.value || '----';
                const mies = spinnerInputs['mies_spinner']?.value || '';
                const dzien = spinnerInputs['dzien_spinner']?.value || '';
                
                // Format: RRRR.**.-- gdzie ** = miesiąc, -- = dzień (puste = nieznane)
                let dateStr = rok + '.';
                
                if (mies && mies !== '--' && mies !== '**') {
                    dateStr += mies.padStart(2, '0');
                } else {
                    dateStr += '**'; // Miesiąc nieznany
                }
                
                dateStr += '.';
                
                if (dzien && dzien !== '--' && dzien !== '**') {
                    dateStr += dzien.padStart(2, '0');
                } else {
                    dateStr += '--'; // Dzień nieznany
                }
                
                act.fieldValues['data_zgloszenia'] = dateStr;
                
                // ===== WALIDACJA DATY =====
                // Jeśli mamy pełną datę, sprawdź czy jest prawidłowa
                const dzienInput = spinnerInputs['dzien_spinner'];
                if (dzienInput && rok !== '----' && mies && mies !== '**' && mies !== '00' && dzien && dzien !== '--' && dzien !== '00') {
                    const maxDays = getMaxDaysInMonth(rok, mies);
                    const dzienVal = parseInt(dzien);
                    
                    if (dzienVal > maxDays) {
                        // Data nieprawidłowa - zaznacz na czerwono
                        dzienInput.style.borderColor = '#ef4444';
                        dzienInput.style.color = '#ef4444';
                    } else {
                        // Data prawidłowa - przywróć zielony
                        dzienInput.style.borderColor = '#10b981';
                        dzienInput.style.color = '#10b981';
                    }
                } else if (dzienInput) {
                    // Brak pełnej daty - przywróć zielony
                    dzienInput.style.borderColor = '#10b981';
                    dzienInput.style.color = '#10b981';
                }
                
                // Auto-wylicz dzień tygodnia jeśli mamy pełną datę
                const dayOfWeekInput = document.getElementById('dayOfWeekInput');
                if (dayOfWeekInput && rok !== '----' && mies && mies !== '**' && dzien && dzien !== '--') {
                    const calculatedDay = getDayOfWeekZeller(parseInt(rok), parseInt(mies), parseInt(dzien));
                    // Tylko auto-wylicz jeśli dzień tygodnia jest __ (nieznany)
                    if (dayOfWeekInput.value === '__' || dayOfWeekInput.value === '') {
                        dayOfWeekInput.value = calculatedDay;
                        // Aktualizuj index i fieldValues
                        const idx = daysOfWeek.indexOf(calculatedDay);
                        if (idx !== -1) {
                            window.currentDayIndex = idx;
                            act.fieldValues['dzien_tygodnia'] = calculatedDay;
                        }
                    }
                    // Zawsze waliduj dzień tygodnia gdy zmieni się data
                    const validateDayOfWeek = window.validateDayOfWeekFn;
                    if (validateDayOfWeek) validateDayOfWeek();
                }
                
                saveStorage();
            };

            // ROK (XXXX lub XXXX/XX lub XXXX-XX)
            const rokGroup = document.createElement('div');
            rokGroup.style.cssText = 'display: flex; flex-direction: column; gap: 1px;';
            
            const rokLabel = document.createElement('label');
            rokLabel.textContent = 'Rok';
            rokLabel.style.cssText = 'font-size: 9px; color: #666; text-transform: uppercase;';
            
            // SPINNER ROKU (zamiast zwykłego input)
            const rokSpinnerBox = document.createElement('div');
            rokSpinnerBox.style.cssText = `display: flex; flex-direction: column; align-items: center; gap: 0px; width: 50px;`;
            
            // Button UP (▲)
            const rokBtnUp = document.createElement('button');
            rokBtnUp.innerHTML = '▲';
            rokBtnUp.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 50px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Input field
            const rokInput = document.createElement('input');
            rokInput.type = 'text';
            rokInput.className = 'field-input';
            rokInput.dataset.field = 'rok';
            rokInput.id = 'rok';
            rokInput.placeholder = 'XXXX';
            rokInput.maxLength = '4';
            rokInput.value = initialRok;
            rokInput.style.cssText = 'padding: 2px 1px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; font-size: 9px; font-family: monospace; font-weight: 500; width: 50px; text-align: center; height: 18px;';
            
            // Button DOWN (▼)
            const rokBtnDown = document.createElement('button');
            rokBtnDown.innerHTML = '▼';
            rokBtnDown.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 50px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Zapisz reference w spinnerInputs
            spinnerInputs['rok_spinner'] = rokInput;
            
            rokBtnUp.addEventListener('click', (e) => {
                e.preventDefault();
                let val = parseInt(rokInput.value) || 1700;
                val = Math.min(val + 1, 2100);
                rokInput.value = String(val);
                act.fieldValues['rok'] = rokInput.value;
                updateDateSpinner();
                saveStorage();
            });
            
            rokBtnDown.addEventListener('click', (e) => {
                e.preventDefault();
                let val = parseInt(rokInput.value) || 2100;
                val = Math.max(val - 1, 1700);
                rokInput.value = String(val);
                act.fieldValues['rok'] = rokInput.value;
                updateDateSpinner();
                saveStorage();
            });
            
            rokInput.addEventListener('input', (e) => {
                // Pozwól tylko na cyfry
                e.target.value = e.target.value.replace(/[^\d]/g, '').slice(0, 4);
                act.fieldValues['rok'] = e.target.value;
            });
            
            rokInput.addEventListener('change', (e) => {
                updateDateSpinner();
                saveStorage();
            });
            
            rokSpinnerBox.appendChild(rokBtnUp);
            rokSpinnerBox.appendChild(rokInput);
            rokSpinnerBox.appendChild(rokBtnDown);
            
            rokGroup.appendChild(rokLabel);
            rokGroup.appendChild(rokSpinnerBox);
            headerWrapper.appendChild(rokGroup);

            // NR AKTU (SPINNER)
            const nrGroup = document.createElement('div');
            nrGroup.style.cssText = 'display: flex; flex-direction: column; gap: 1px;';
            
            const nrLabel = document.createElement('label');
            nrLabel.textContent = 'Nr aktu';
            nrLabel.style.cssText = 'font-size: 9px; color: #666; text-transform: uppercase;';
            
            // SPINNER NR AKTU
            const nrSpinnerBox = document.createElement('div');
            nrSpinnerBox.style.cssText = `display: flex; flex-direction: column; align-items: center; gap: 0px; width: 60px;`;
            
            // Button UP (▲)
            const nrBtnUp = document.createElement('button');
            nrBtnUp.innerHTML = '▲';
            nrBtnUp.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 60px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Input field
            const nrInput = document.createElement('input');
            nrInput.type = 'text';
            nrInput.className = 'field-input';
            nrInput.dataset.field = 'nr_aktu';
            nrInput.id = 'nr_aktu';
            nrInput.placeholder = 'XXX';
            nrInput.maxLength = '3';
            nrInput.value = initialNrAktu;
            nrInput.style.cssText = 'padding: 2px 1px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; font-size: 9px; font-family: monospace; font-weight: 500; width: 60px; text-align: center; height: 18px;';
            
            // Button DOWN (▼)
            const nrBtnDown = document.createElement('button');
            nrBtnDown.innerHTML = '▼';
            nrBtnDown.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 60px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Zapisz reference w spinnerInputs
            spinnerInputs['nraktu_spinner'] = nrInput;
            
            nrBtnUp.addEventListener('click', (e) => {
                e.preventDefault();
                let val = parseInt(nrInput.value) || 0;
                val += 1;
                if (val > 999) val = 0; // Cyklicznie: 0-999
                nrInput.value = String(val).padStart(3, '0');
                act.fieldValues['nr_aktu'] = nrInput.value;
                saveStorage();
            });
            
            nrBtnDown.addEventListener('click', (e) => {
                e.preventDefault();
                let val = parseInt(nrInput.value) || 0;
                val -= 1;
                if (val < 0) val = 999; // Cyklicznie: 999-0
                nrInput.value = String(val).padStart(3, '0');
                act.fieldValues['nr_aktu'] = nrInput.value;
                saveStorage();
            });
            
            nrInput.addEventListener('input', (e) => {
                // Pozwól tylko na cyfry i max 3
                e.target.value = e.target.value.replace(/[^\d]/g, '').slice(0, 3);
                act.fieldValues['nr_aktu'] = e.target.value;
            });
            
            nrInput.addEventListener('change', (e) => {
                saveStorage();
            });
            
            nrSpinnerBox.appendChild(nrBtnUp);
            nrSpinnerBox.appendChild(nrInput);
            nrSpinnerBox.appendChild(nrBtnDown);
            
            nrGroup.appendChild(nrLabel);
            nrGroup.appendChild(nrSpinnerBox);
            headerWrapper.appendChild(nrGroup);

            // DATA ZGŁOSZENIA
            // Przykład: Data 1410.07.15 (Wtorek) = Bitwa pod Grunwaldem (1410-07-15)
            // Dla przyszłych zmian: testuj z rzeczywistymi datami historycznymi
            const dataZglGroup = document.createElement('div');
            dataZglGroup.style.cssText = 'display: flex; flex-direction: column; gap: 1px;';
            
            const dataZglLabel = document.createElement('label');
            dataZglLabel.textContent = 'Data zgł.';
            dataZglLabel.title = 'Dla dat przed 1582 r.: wyliczanie dnia tygodnia wg kalendarza juliańskiego';
            dataZglLabel.style.cssText = 'font-size: 9px; color: #10b981; text-transform: uppercase; font-weight: 600; cursor: help;';
            
            // ===== CUSTOM DATE SPINNER =====
            const dateSpinnerWrapper = document.createElement('div');
            dateSpinnerWrapper.style.cssText = 'display: flex; gap: 1px; align-items: center; justify-content: flex-start;';
            
            // Funkcja do wyliczenia max dni w miesiącu
            const getMaxDaysInMonth = (rok, mies) => {
                if (!rok || !mies || mies === '**' || mies === '00') return 31; // Brak roku/miesiąca - domyślnie 31
                rok = parseInt(rok);
                mies = parseInt(mies);
                if (mies === 2) {
                    // Luty - sprawdź rok przestępny
                    const isLeapYear = (rok % 4 === 0 && rok % 100 !== 0) || (rok % 400 === 0);
                    return isLeapYear ? 29 : 28;
                } else if ([4, 6, 9, 11].includes(mies)) {
                    return 30; // Kwiecień, czerwiec, wrzesień, listopad
                } else {
                    return 31; // Pozostałe miesiące
                }
            };
            
            // Utwórz 3 spinner pola dla Data zgł: YYYY / MM / DD
            const spinnerFields = [
                { id: 'rok_spinner', placeholder: 'YYYY', min: 1700, max: 2100, width: 30, cyclic: false },
                { id: 'mies_spinner', placeholder: '**', min: 0, max: 12, width: 22, cyclic: true, emptySymbol: '**' },
                { id: 'dzien_spinner', placeholder: '--', min: 1, max: 31, width: 22, cyclic: true, emptySymbol: '--' }
            ];
            
            spinnerFields.forEach((field, idx) => {
                const spinnerBox = document.createElement('div');
                spinnerBox.style.cssText = `display: flex; flex-direction: column; align-items: center; gap: 0px;`;
                
                // Button UP (▲)
                const btnUp = document.createElement('button');
                btnUp.innerHTML = '▲';
                btnUp.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #10b981; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: ${field.width}px; height: 12px; flex: 0; display: flex; align-items: center; justify-content: center;`;
                btnUp.addEventListener('click', (e) => {
                    e.preventDefault();
                    let val = spinnerInputs[field.id].value.trim();
                    
                    if (field.id === 'mies_spinner') {
                        // Miesiąc: **→1→2→...→12→**
                        if (val === field.emptySymbol || val === '00') {
                            val = 1;
                        } else {
                            val = parseInt(val) || 0;
                            val += 1;
                            if (val > 12) val = 0; // Wróć do **
                        }
                    } else if (field.id === 'dzien_spinner') {
                        // Dzień: --→1→2→...→maxDays→--
                        const maxDays = getMaxDaysInMonth(spinnerInputs['rok_spinner'].value, spinnerInputs['mies_spinner'].value);
                        if (val === field.emptySymbol || val === '00') {
                            val = 1;
                        } else {
                            val = parseInt(val) || 0;
                            val += 1;
                            if (val > maxDays) val = 0; // Wróć do --
                        }
                    } else {
                        // Rok: normalna inkrementacja
                        val = parseInt(val) || field.min;
                        val = Math.min(val + 1, field.max);
                    }
                    
                    // Wyświetl
                    if (val === 0 && field.emptySymbol) {
                        spinnerInputs[field.id].value = field.emptySymbol;
                    } else {
                        spinnerInputs[field.id].value = String(val).padStart(field.placeholder.length, '0');
                    }
                    updateDateSpinner();
                });
                
                // Input field
                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.placeholder = field.placeholder;
                inputField.className = 'field-input';
                inputField.style.cssText = `padding: 2px 1px; background: #0f0f0f; border: 1px solid #10b981; color: #10b981; border-radius: 1px; font-size: 9px; font-family: monospace; font-weight: 500; width: ${field.width}px; text-align: center; height: 18px;`;
                inputField.maxLength = field.placeholder.length;
                
                // Ustaw początkową wartość
                if (initialDataZgloszenia) {
                    // Obsłuż formaty: YYYY.MM.DD, YYYY.**.-- itd.
                    const dateParts = initialDataZgloszenia.split(/[-\.*]/);
                    if (field.id === 'rok_spinner' && dateParts[0] && dateParts[0] !== '----') {
                        inputField.value = dateParts[0];
                    } else if (field.id === 'mies_spinner') {
                        if (dateParts[1] && dateParts[1] !== '**' && dateParts[1] !== '00') {
                            inputField.value = dateParts[1];
                        } else {
                            inputField.value = field.emptySymbol; // ** = nieznany miesiąc
                        }
                    } else if (field.id === 'dzien_spinner') {
                        if (dateParts[2] && dateParts[2] !== '--' && dateParts[2] !== '00') {
                            inputField.value = dateParts[2];
                        } else {
                            inputField.value = field.emptySymbol; // -- = nieznany dzień
                        }
                    }
                } else if (field.id === 'rok_spinner' && initialRok) {
                    inputField.value = initialRok.split(/[-/]/)[0]; // Wyciągnij XXXX z XXXX/XX
                } else if (field.emptySymbol) {
                    inputField.value = field.emptySymbol; // Domyślnie ** lub --
                }
                
                spinnerInputs[field.id] = inputField;
                
                inputField.addEventListener('input', (e) => {
                    // Pozwól na cyfry lub symbole puste
                    if (field.emptySymbol && (e.target.value === field.emptySymbol || e.target.value === '')) {
                        e.target.value = field.emptySymbol;
                    } else {
                        e.target.value = e.target.value.replace(/[^\d]/g, '').slice(0, field.placeholder.length);
                    }
                });
                
                inputField.addEventListener('change', updateDateSpinner);
                
                // Button DOWN (▼)
                const btnDown = document.createElement('button');
                btnDown.innerHTML = '▼';
                btnDown.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #10b981; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: ${field.width}px; height: 12px; flex: 0; display: flex; align-items: center; justify-content: center;`;
                btnDown.addEventListener('click', (e) => {
                    e.preventDefault();
                    let val = inputField.value.trim();
                    
                    if (field.id === 'mies_spinner') {
                        // Miesiąc: **←12←11←...←1←**
                        if (val === field.emptySymbol || val === '00') {
                            val = 12; // Jak klikamy dół od **, to 12
                        } else {
                            val = parseInt(val) || 1;
                            val -= 1;
                            if (val < 1) val = 0; // Wróć do **
                        }
                    } else if (field.id === 'dzien_spinner') {
                        // Dzień: --←maxDays←...←1←--
                        const maxDays = getMaxDaysInMonth(spinnerInputs['rok_spinner'].value, spinnerInputs['mies_spinner'].value);
                        if (val === field.emptySymbol || val === '00') {
                            val = maxDays; // Jak klikamy dół od --, to maxDays
                        } else {
                            val = parseInt(val) || 1;
                            val -= 1;
                            if (val < 1) val = 0; // Wróć do --
                        }
                    } else {
                        // Rok: normalna dekrementacja
                        val = parseInt(val) || field.max;
                        val = Math.max(val - 1, field.min);
                    }
                    
                    // Wyświetl
                    if (val === 0 && field.emptySymbol) {
                        inputField.value = field.emptySymbol;
                    } else {
                        inputField.value = String(val).padStart(field.placeholder.length, '0');
                    }
                    updateDateSpinner();
                });
                
                spinnerBox.appendChild(btnUp);
                spinnerBox.appendChild(inputField);
                spinnerBox.appendChild(btnDown);
                dateSpinnerWrapper.appendChild(spinnerBox);
            });
            
            // ===== CZWARTY ELEMENT W DATA ZGL: DZIEŃ TYGODNIA (SPINNER Z PRZYCISKAMI) =====
            const dayOfWeekBox = document.createElement('div');
            dayOfWeekBox.style.cssText = `display: flex; flex-direction: column; align-items: center; gap: 0px;`;
            
            // Button UP (▲)
            const dayOfWeekBtnUp = document.createElement('button');
            dayOfWeekBtnUp.innerHTML = '▲';
            dayOfWeekBtnUp.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #10b981; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 30px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Input field dnia tygodnia
            const dayOfWeekInput = document.createElement('input');
            dayOfWeekInput.type = 'text';
            dayOfWeekInput.id = 'dayOfWeekInput';
            dayOfWeekInput.placeholder = 'Pn';
            dayOfWeekInput.maxLength = '2';
            dayOfWeekInput.style.cssText = `padding: 2px 1px; background: #0f0f0f; border: 1px solid #10b981; color: #10b981; border-radius: 1px; font-size: 9px; font-family: monospace; font-weight: 500; width: 30px; text-align: center; height: 18px;`;
            dayOfWeekInput.value = 'Pn';
            
            // Button DOWN (▼)
            const dayOfWeekBtnDown = document.createElement('button');
            dayOfWeekBtnDown.innerHTML = '▼';
            dayOfWeekBtnDown.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #10b981; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 30px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // currentDayIndex - przechowuj w window aby by\u0142a dost\u0119pna wszędzie
            if (!window.currentDayIndex) window.currentDayIndex = 0;
            let currentDayIndex = window.currentDayIndex;
            
            // Funkcja do walidacji dnia tygodnia
            const validateDayOfWeek = () => {
                const rok = spinnerInputs['rok_spinner']?.value || '----';
                const mies = spinnerInputs['mies_spinner']?.value || '';
                const dzien = spinnerInputs['dzien_spinner']?.value || '';
                const selectedDay = dayOfWeekInput.value;
                
                // Jeśli dzień tygodnia to __, nie walidujemy
                if (selectedDay === '__') {
                    dayOfWeekInput.style.borderColor = '#10b981';
                    dayOfWeekInput.style.color = '#10b981';
                    return;
                }
                
                // Jeśli mamy pełną datę, sprawdź czy dzień tygodnia się zgadza
                if (rok !== '----' && mies && mies !== '**' && dzien && dzien !== '--') {
                    const calculatedDay = getDayOfWeekZeller(parseInt(rok), parseInt(mies), parseInt(dzien));
                    
                    if (selectedDay === calculatedDay) {
                        // Dzień się zgadza - zielony
                        dayOfWeekInput.style.borderColor = '#10b981';
                        dayOfWeekInput.style.color = '#10b981';
                    } else {
                        // Dzień się nie zgadza - CZERWONY
                        dayOfWeekInput.style.borderColor = '#ef4444';
                        dayOfWeekInput.style.color = '#ef4444';
                    }
                } else {
                    // Brak pełnej daty - nie walidujemy, zielony
                    dayOfWeekInput.style.borderColor = '#10b981';
                    dayOfWeekInput.style.color = '#10b981';
                }
            };
            
            // Zapisz do window aby była dostępna z updateDateSpinner
            window.validateDayOfWeekFn = validateDayOfWeek;
            
            dayOfWeekBtnUp.addEventListener('click', (e) => {
                e.preventDefault();
                currentDayIndex = (currentDayIndex + 1) % daysOfWeek.length; // Cyklicznie
                dayOfWeekInput.value = daysOfWeek[currentDayIndex];
                act.fieldValues['dzien_tygodnia'] = daysOfWeek[currentDayIndex];
                validateDayOfWeek();
                saveStorage();
            });
            
            dayOfWeekBtnDown.addEventListener('click', (e) => {
                e.preventDefault();
                currentDayIndex = (currentDayIndex - 1 + daysOfWeek.length) % daysOfWeek.length; // Cyklicznie
                dayOfWeekInput.value = daysOfWeek[currentDayIndex];
                act.fieldValues['dzien_tygodnia'] = daysOfWeek[currentDayIndex];
                validateDayOfWeek();
                saveStorage();
            });
            
            dayOfWeekInput.addEventListener('input', (e) => {
                // Pozwól wybrać dzień z listy lub __ dla nieokreślonego
                let val = e.target.value.toUpperCase();
                
                // Sprawdź czy to __
                if (val === '__' || val === '') {
                    currentDayIndex = 0; // __
                    dayOfWeekInput.value = '__';
                    act.fieldValues['dzien_tygodnia'] = '__';
                } else {
                    const idx = daysOfWeek.findIndex(d => d.includes(val));
                    if (idx !== -1) {
                        currentDayIndex = idx;
                        dayOfWeekInput.value = daysOfWeek[idx];
                        act.fieldValues['dzien_tygodnia'] = daysOfWeek[idx];
                    } else {
                        dayOfWeekInput.value = daysOfWeek[currentDayIndex];
                    }
                }
                validateDayOfWeek();
            });
            
            dayOfWeekInput.addEventListener('change', (e) => {
                validateDayOfWeek();
                saveStorage();
            });
            
            // Załaduj zapisaną wartość jeśli istnieje
            if (act.fieldValues['dzien_tygodnia']) {
                const savedDay = act.fieldValues['dzien_tygodnia'];
                const idx = daysOfWeek.indexOf(savedDay);
                if (idx !== -1) {
                    currentDayIndex = idx;
                    dayOfWeekInput.value = savedDay;
                }
            } else {
                dayOfWeekInput.value = '__'; // Domyślnie __
                currentDayIndex = 0;
            }
            
            // Waliduj na starcie
            validateDayOfWeek();
            
            dayOfWeekBox.appendChild(dayOfWeekBtnUp);
            dayOfWeekBox.appendChild(dayOfWeekInput);
            dayOfWeekBox.appendChild(dayOfWeekBtnDown);
            dateSpinnerWrapper.appendChild(dayOfWeekBox);
            
            dataZglGroup.appendChild(dataZglLabel);
            dataZglGroup.appendChild(dateSpinnerWrapper);
            headerWrapper.appendChild(dataZglGroup);
            
            // Dla dat sprzed 1582 r.: wyliczanie dnia tygodnia wg kalendarza juliańskiego
            // Różnica między kalendarzem gregoriańskim a juliańskim (reformacja 1582)

            container.appendChild(headerWrapper);

            // ===== KOMPLETNA LISTA WSZYSTKICH MOŻLIWYCH PÓL Z AKTÓW METRYKALNYCH =====
            // Do użytku w "+ Dodaj dowolne dane" - pozwala dodać pola z innych typów aktów
            const allAvailableFields = [
                // WSPÓLNE DLA WSZYSTKICH TYPÓW
                { id: 'numer_aktu', label: 'Numer aktu', category: 'Wspólne' },
                { id: 'data_aktu', label: 'Data aktu', category: 'Wspólne' },
                { id: 'parafia', label: 'Parafia/Miejsce', category: 'Wspólne' },
                { id: 'ksiadz_urzednik', label: 'Ksiądz/Urzędnik', category: 'Wspólne' },
                { id: 'jezyk_aktu', label: 'Język aktu', category: 'Wspólne' },
                { id: 'uwagi_marginalne', label: 'Uwagi marginalne', category: 'Wspólne' },
                { id: 'zrodlo_ksiega', label: 'Źródło/Księga', category: 'Wspólne' },
                
                // URODZENIA/CHRZTY
                { id: 'data_urodzenia', label: 'Data urodzenia', category: 'Urodzenia/Chrzty' },
                { id: 'miejsce_urodzenia', label: 'Miejsce urodzenia', category: 'Urodzenia/Chrzty' },
                { id: 'dziecko_imie', label: 'Imię dziecka', category: 'Urodzenia/Chrzty' },
                { id: 'dziecko_plec', label: 'Płeć dziecka', category: 'Urodzenia/Chrzty' },
                { id: 'legitymizacja', label: 'Legitymizacja', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_imie', label: 'Imię ojca', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_nazwisko', label: 'Nazwisko ojca', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_wiek', label: 'Wiek ojca', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_zawod', label: 'Zawód ojca', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_miejsce', label: 'Miejsce zamieszkania ojca', category: 'Urodzenia/Chrzty' },
                { id: 'matka_imie', label: 'Imię matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_nazwisko', label: 'Nazwisko matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_panienskie', label: 'Nazwisko panieńskie matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_lata', label: 'Wiek matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_zawod', label: 'Zawód matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_miejsce', label: 'Miejsce zamieszkania matki', category: 'Urodzenia/Chrzty' },
                { id: 'data_chrztu', label: 'Data chrztu', category: 'Urodzenia/Chrzty' },
                { id: 'imie_nadane_chrzest', label: 'Imię nadane na chrzcie', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestny_ojciec_imie', label: 'Imię ojca chrzestnego', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestny_ojciec_nazwisko', label: 'Nazwisko ojca chrzestnego', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestny_ojciec_zawod', label: 'Zawód ojca chrzestnego', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestna_matka_imie', label: 'Imię matki chrzestnej', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestna_matka_nazwisko', label: 'Nazwisko matki chrzestnej', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestna_matka_zawod', label: 'Zawód matki chrzestnej', category: 'Urodzenia/Chrzty' },
                { id: 'swiadek1_imie', label: 'Świadek 1 - Imię', category: 'Urodzenia/Chrzty' },
                { id: 'swiadek1_nazwisko', label: 'Świadek 1 - Nazwisko', category: 'Urodzenia/Chrzty' },
                { id: 'swiadek2_imie', label: 'Świadek 2 - Imię', category: 'Urodzenia/Chrzty' },
                { id: 'swiadek2_nazwisko', label: 'Świadek 2 - Nazwisko', category: 'Urodzenia/Chrzty' },
                
                // MAŁŻEŃSTWA/ŚLUBY
                { id: 'data_slubu', label: 'Data ślubu', category: 'Małżeństwa/Śluby' },
                { id: 'miejsce_slubu', label: 'Miejsce ślubu', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_imie', label: 'Imię pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_nazwisko', label: 'Nazwisko pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_wiek', label: 'Wiek pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_stan', label: 'Stan cywilny pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_zawod', label: 'Zawód pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_urodzenie', label: 'Miejsce urodzenia pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_zamieszkanie', label: 'Miejsce zamieszkania pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_rodzice', label: 'Imiona rodziców pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_imie', label: 'Imię panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_nazwisko_panienskie', label: 'Nazwisko panieńskie panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_wiek', label: 'Wiek panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_stan', label: 'Stan cywilny panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_zawod', label: 'Zawód panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_urodzenie', label: 'Miejsce urodzenia panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_zamieszkanie', label: 'Miejsce zamieszkania panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_rodzice', label: 'Imiona rodziców panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'zapowiedzi_daty', label: 'Daty zapowiedzi', category: 'Małżeństwa/Śluby' },
                { id: 'dyspensa', label: 'Dyspensa', category: 'Małżeństwa/Śluby' },
                { id: 'swiadkowie_slubu', label: 'Świadkowie ślubu', category: 'Małżeństwa/Śluby' },
                
                // ZGONY/POGRZEBY
                { id: 'data_zgonu', label: 'Data zgonu', category: 'Zgony/Pogrzeby' },
                { id: 'miejsce_zgonu', label: 'Miejsce zgonu', category: 'Zgony/Pogrzeby' },
                { id: 'data_pogrzebu', label: 'Data pogrzebu', category: 'Zgony/Pogrzeby' },
                { id: 'miejsce_pogrzebu', label: 'Miejsce pogrzebu', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_imie', label: 'Imię zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_nazwisko', label: 'Nazwisko zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_wiek', label: 'Wiek zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_plec', label: 'Płeć zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_stan', label: 'Stan cywilny zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_zawod', label: 'Zawód zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_urodzenie', label: 'Miejsce urodzenia zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_zamieszkanie', label: 'Miejsce zamieszkania zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_rodzice', label: 'Imiona rodziców zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_malzenyk', label: 'Imię małżonka', category: 'Zgony/Pogrzeby' },
                { id: 'przyczyna_zgonu', label: 'Przyczyna zgonu', category: 'Zgony/Pogrzeby' },
                { id: 'swiadkowie_zgonu', label: 'Świadkowie/informatorzy', category: 'Zgony/Pogrzeby' }
            ];

            // ===== RENDERUJ GRUPY PÓL (fieldGroups) - V8.11 STRUKTURA =====
            // Pola są zorganizowane w grupy z inteligentnym layoutem
            // Layout types: 'inline2' (2 pola obok siebie), 'grouped' (2-wierszowy: imie+nazwisko, zawód+wiek+miejsce), 'single' (jedno pole)
            
            const fieldGroups = [
                {
                    id: 'dziecko',
                    header: null,  // Brak nagłówka - dzieci nie mają grupy
                    layout: 'inline2',  // 2 pola w linii
                    fields: [
                        { id: "dziecko_imie", label: "Imię dziecka" },
                        { id: "dziecko_nazwisko", label: "Nazwisko dziecka" }
                    ]
                },
                {
                    id: 'zglaszajacy',
                    header: 'OSOBA ZGŁASZAJĄCA',
                    checkbox: { id: 'zglaszajacy_ojciec', label: 'to ojciec' },
                    layout: 'grouped',  // 2-wierszowy
                    fields: [
                        { id: "zglaszajacy_imie", label: "Imię" },
                        { id: "zglaszajacy_nazwisko", label: "Nazwisko" },
                        { id: "zglaszajacy_zawod", label: "Zawód" },
                        { id: "zglaszajacy_wiek", label: "Wiek" },
                        { id: "zglaszajacy_miejsce", label: "Miejsce" }
                    ]
                },
                {
                    id: 'swiadek1',
                    header: 'ŚWIADEK 1',
                    layout: 'grouped',
                    fields: [
                        { id: "swiadek1_imie", label: "Imię" },
                        { id: "swiadek1_nazwisko", label: "Nazwisko" },
                        { id: "swiadek1_zawod", label: "Zawód" },
                        { id: "swiadek1_wiek", label: "Wiek" },
                        { id: "swiadek1_miejsce", label: "Miejsce" }
                    ]
                },
                {
                    id: 'swiadek2',
                    header: 'ŚWIADEK 2',
                    layout: 'grouped',
                    fields: [
                        { id: "swiadek2_imie", label: "Imię" },
                        { id: "swiadek2_nazwisko", label: "Nazwisko" },
                        { id: "swiadek2_zawod", label: "Zawód" },
                        { id: "swiadek2_wiek", label: "Wiek" },
                        { id: "swiadek2_miejsce", label: "Miejsce" }
                    ]
                },
                {
                    id: 'dziecko_urodzenie',
                    header: null,
                    layout: 'single',
                    fields: [
                        { id: "dziecko_urodzone_dnia", label: "Dziecko urodzone dnia" }
                    ]
                },
                {
                    id: 'ojciec',
                    header: 'OJCIEC',
                    layout: 'grouped',
                    fields: [
                        { id: "ojciec_imie", label: "Imię" },
                        { id: "ojciec_nazwisko", label: "Nazwisko" },
                        { id: "ojciec_zawod", label: "Zawód" },
                        { id: "ojciec_wiek", label: "Wiek" },
                        { id: "ojciec_miejsce", label: "Miejsce" }
                    ]
                },
                {
                    id: 'matka',
                    header: 'MATKA',
                    layout: 'grouped',
                    fields: [
                        { id: "matka_imie", label: "Imię" },
                        { id: "matka_nazwisko", label: "Nazwisko" },
                        { id: "matka_panienskie", label: "Panieńskie" },
                        { id: "matka_lata", label: "Wiek" },
                        { id: "matka_miejsce", label: "Miejsce" },
                        { id: "matka_zawod", label: "Zawód" }
                    ]
                },
                {
                    id: 'imie_chrzest',
                    header: null,
                    layout: 'custom',
                    fields: [
                        { id: "imie_nadane_chrzest", label: "Ochrzczono jako:" }
                    ]
                },
                {
                    id: 'ksiadz',
                    header: 'KSIĘŻA (udzielający chrztu)',
                    layout: 'inline2',
                    fields: [
                        { id: "ksiadz_imie", label: "Imię" },
                        { id: "ksiadz_nazwisko", label: "Nazwisko" }
                    ]
                },
                {
                    id: 'notatki',
                    header: null,
                    layout: 'single',
                    fields: [
                        { id: "custom_note", label: "Dodatkowa notatka" },
                        { id: "extra_date", label: "Dodatkowa data" }
                    ]
                }
            ];
            
            // Renderuj grupy
            fieldGroups.forEach((group) => {
                // 🔧 Sprawdź czy ta grupa powinna być widoczna
                if (!isVisibleSection(group.id)) {
                    console.log(`🔇 Skipping hidden section: ${group.id}`);
                    return;  // Pomiń tę grupę
                }
                
                // Nagłówek grupy (jeśli istnieje)
                if (group.header) {
                    const groupHeader = document.createElement('div');
                    groupHeader.style.cssText = 'font-size: 11px; color: #10b981; font-weight: 600; margin-top: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; white-space: nowrap;';
                    
                    const headerText = document.createElement('span');
                    headerText.textContent = group.header;
                    groupHeader.appendChild(headerText);
                    
                    // Checkbox (jeśli istnieje - dla "to ojciec")
                    if (group.checkbox) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = group.checkbox.id;
                        checkbox.title = group.checkbox.label;
                        checkbox.checked = act.fieldValues[group.checkbox.id] === true || act.fieldValues[group.checkbox.id] === 'true';
                        checkbox.style.cssText = 'cursor: pointer; width: 12px; height: 12px; flex-shrink: 0;';
                        checkbox.addEventListener('change', (e) => {
                            act.fieldValues[group.checkbox.id] = e.target.checked;
                            
                            // AUTO-COPY ojciec z zgłaszającego jeśli checkbox zaznaczony
                            if (group.checkbox.id === 'zglaszajacy_ojciec' && e.target.checked) {
                                act.fieldValues['ojciec_imie'] = act.fieldValues['zglaszajacy_imie'] || '';
                                act.fieldValues['ojciec_nazwisko'] = act.fieldValues['zglaszajacy_nazwisko'] || '';
                                act.fieldValues['ojciec_zawod'] = act.fieldValues['zglaszajacy_zawod'] || '';
                                act.fieldValues['ojciec_wiek'] = act.fieldValues['zglaszajacy_wiek'] || '';
                                act.fieldValues['ojciec_miejsce'] = act.fieldValues['zglaszajacy_miejsce'] || '';
                                console.log('📋 Skopiowano OSOBA ZGŁASZAJĄCA → OJCIEC');
                                // Odśwież formularz aby pokazać zakopiowane dane
                                setTimeout(() => renderFormSections(), 100);
                            }
                            
                            saveStorage();
                        });
                        groupHeader.appendChild(checkbox);
                        
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.textContent = group.checkbox.label;
                        checkboxLabel.style.cssText = 'font-size: 9px; color: #888; cursor: pointer; margin: 0; flex-shrink: 0;';
                        checkboxLabel.htmlFor = group.checkbox.id;
                        groupHeader.appendChild(checkboxLabel);
                    }
                    
                    container.appendChild(groupHeader);
                }
                
                // Renderuj pola wg layoutu
                if (group.layout === 'inline2') {
                    // Dwa pola obok siebie
                    const row = document.createElement('div');
                    row.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;';
                    
                    group.fields.forEach(field => {
                        const fieldDiv = document.createElement('div');
                        const label = document.createElement('label');
                        label.textContent = field.label;
                        label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                        fieldDiv.appendChild(label);
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.dataset.field = field.id;
                        input.id = field.id;
                        input.className = 'field-input';
                        input.placeholder = field.label;
                        input.value = act.fieldValues[field.id] || '';
                        input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                        input.addEventListener('blur', (e) => { 
                            act.fieldValues[field.id] = e.target.value.trim(); 
                            updateCurrentRowInTable(); // Aktualizuj tabelę
                            saveStorage(); 
                        });
                        fieldDiv.appendChild(input);
                        row.appendChild(fieldDiv);
                    });
                    
                    container.appendChild(row);
                    
                } else if (group.layout === 'grouped') {
                    // Grouped: Dynamiczny layout
                    // - Jeśli 4 pola: 2 + 2
                    // - Jeśli 6 pól: 3 + 3
                    // - Jeśli 4 pola ale grupa MATKA: 3 + 1 (dla złych definicji)
                    
                    const fieldCount = group.fields.length;
                    let fieldsPerRow1, fieldsPerRow2;
                    
                    if (fieldCount === 4) {
                        fieldsPerRow1 = 2;
                        fieldsPerRow2 = 2;
                    } else if (fieldCount === 6) {
                        fieldsPerRow1 = 3;
                        fieldsPerRow2 = 3;
                    } else if (fieldCount === 3) {
                        fieldsPerRow1 = 3;
                        fieldsPerRow2 = 0;
                    } else {
                        fieldsPerRow1 = 2;
                        fieldsPerRow2 = fieldCount - 2;
                    }
                    
                    // Wiersz 1
                    if (fieldsPerRow1 > 0) {
                        const row1 = document.createElement('div');
                        const gridCols1 = '1fr '.repeat(fieldsPerRow1).trim();
                        row1.style.cssText = `display: grid; grid-template-columns: ${gridCols1}; gap: 8px; margin-bottom: 4px;`;
                        
                        for (let i = 0; i < fieldsPerRow1 && i < group.fields.length; i++) {
                            const field = group.fields[i];
                            const fieldDiv = document.createElement('div');
                            
                            // Specjalna logika dla matka_nazwisko - cały napis + pole to przycisk
                            if (group.id === 'matka' && field.id === 'matka_nazwisko') {
                                fieldDiv.style.cssText = 'cursor: pointer;';
                                
                                const label = document.createElement('label');
                                label.innerHTML = 'Nazwisko <span style="font-weight: bold;">v</span>';
                                label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px; cursor: pointer;';
                                fieldDiv.appendChild(label);
                                
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.dataset.field = field.id;
                                input.id = field.id;
                                input.className = 'field-input';
                                input.placeholder = field.label;
                                
                                const childLastName = act.fieldValues['dziecko_nazwisko'] || '';
                                
                                // Flaga czy sugestia jest zatwierdzona
                                let isConfirmed = act.fieldValues[field.id + '_confirmed'] || false;
                                
                                // Jeśli jest wartość w fieldValues ale nie potwierdzona, to szara sugestia
                                if (act.fieldValues[field.id]) {
                                    input.value = act.fieldValues[field.id];
                                    if (!isConfirmed) {
                                        input.style.cssText = 'width: 100%; padding: 5px; background: #0a0a0a; border: 1px solid #2a2a2a; color: #666; border-radius: 3px; font-size: 11px; cursor: pointer;';
                                        input.title = 'Kliknij aby zatwierdzić';
                                    } else {
                                        input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                    }
                                } else if (childLastName && !isConfirmed) {
                                    // Jeśli pole puste, pokaż sugestię nazwiska dziecka na szaro
                                    input.value = childLastName;
                                    input.style.cssText = 'width: 100%; padding: 5px; background: #0a0a0a; border: 1px solid #2a2a2a; color: #666; border-radius: 3px; font-size: 11px; cursor: pointer;';
                                    input.title = 'Kliknij aby zatwierdzić';
                                } else {
                                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                }
                                
                                // Klik na przycisk zatwierdza/odtwierda sugestię
                                const toggleConfirm = () => {
                                    isConfirmed = !isConfirmed;
                                    act.fieldValues[field.id + '_confirmed'] = isConfirmed;
                                    
                                    if (isConfirmed) {
                                        // Zatwierdzone - normalny styl, zapisz do fieldValues
                                        input.style.color = '#ddd';
                                        input.style.background = '#0f0f0f';
                                        input.style.borderColor = '#3a3a3a';
                                        input.style.cursor = 'text';
                                        input.title = '';
                                        act.fieldValues[field.id] = input.value.trim();
                                    } else {
                                        // Odtwierdzono - szara sugestia, nie zapisuj
                                        input.style.color = '#666';
                                        input.style.background = '#0a0a0a';
                                        input.style.borderColor = '#2a2a2a';
                                        input.style.cursor = 'pointer';
                                        input.title = 'Kliknij aby zatwierdzić';
                                        // Nie zapisuj szarej sugestii do fieldValues
                                    }
                                    saveStorage();
                                };
                                
                                label.addEventListener('click', toggleConfirm);
                                input.addEventListener('click', toggleConfirm);
                                
                                input.addEventListener('input', (e) => {
                                    // Jeśli user wpisze, przywróć normalny styl
                                    if (!isConfirmed) {
                                        isConfirmed = true;
                                        act.fieldValues[field.id + '_confirmed'] = true;
                                        input.style.color = '#ddd';
                                        input.style.background = '#0f0f0f';
                                        input.style.borderColor = '#3a3a3a';
                                        input.style.cursor = 'text';
                                        input.title = '';
                                    }
                                    act.fieldValues[field.id] = e.target.value.trim();
                                });
                                
                                // Zapisz tylko gdy user wyjedzie z pola (blur)
                                input.addEventListener('blur', (e) => {
                                    updateCurrentRowInTable();
                                    saveStorage();
                                });
                                
                                fieldDiv.appendChild(input);
                            } else if (group.id === 'matka' && field.id === 'matka_panienskie') {
                                // Panieńskie - przycisk "Panieńskie p" toggle: kopiuje i kasuje
                                fieldDiv.style.cssText = 'cursor: pointer;';
                                
                                const label = document.createElement('label');
                                label.innerHTML = 'Panieńskie <span style="font-weight: bold;">p</span>';
                                label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px; cursor: pointer;';
                                fieldDiv.appendChild(label);
                                
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.dataset.field = field.id;
                                input.id = field.id;
                                input.className = 'field-input';
                                input.placeholder = field.label;
                                input.value = act.fieldValues[field.id] || '';
                                input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                
                                // Flaga czy wartość została skopiowana przez przycisk
                                let isCopiedByButton = act.fieldValues[field.id + '_copied_by_button'] || false;
                                
                                // Jeśli jest wartość skopiowana przez button, pokaż na szaro
                                if (input.value && isCopiedByButton) {
                                    input.style.cssText = 'width: 100%; padding: 5px; background: #0a0a0a; border: 1px solid #2a2a2a; color: #666; border-radius: 3px; font-size: 11px; cursor: pointer;';
                                    input.title = 'Skopiowano - kliknij aby usunąć';
                                }
                                
                                input.addEventListener('input', (e) => {
                                    // Jeśli user wpisze, przywróć normalny styl i nie kasuj
                                    isCopiedByButton = false;
                                    act.fieldValues[field.id + '_copied_by_button'] = false;
                                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                    input.title = '';
                                    act.fieldValues[field.id] = e.target.value.trim();
                                });
                                
                                // Zapisz tylko gdy user wyjedzie z pola (blur)
                                input.addEventListener('blur', (e) => {
                                    updateCurrentRowInTable();
                                    saveStorage();
                                });
                                
                                // Toggle: klik na przycisk kopiuje/kasuje
                                const toggleCopy = () => {
                                    const childLastName = act.fieldValues['dziecko_nazwisko'] || '';
                                    
                                    if (!isCopiedByButton && !input.value) {
                                        // Kliknięcie 1 - kopiuj
                                        input.value = childLastName;
                                        isCopiedByButton = true;
                                        act.fieldValues[field.id + '_copied_by_button'] = true;
                                        input.style.cssText = 'width: 100%; padding: 5px; background: #0a0a0a; border: 1px solid #2a2a2a; color: #666; border-radius: 3px; font-size: 11px; cursor: pointer;';
                                        input.title = 'Skopiowano - kliknij aby usunąć';
                                        act.fieldValues[field.id] = childLastName;
                                    } else if (isCopiedByButton && input.value === childLastName) {
                                        // Kliknięcie 2 - kasuj (tylko jeśli równa się skopiowanemu)
                                        input.value = '';
                                        isCopiedByButton = false;
                                        act.fieldValues[field.id + '_copied_by_button'] = false;
                                        input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                        input.title = '';
                                        act.fieldValues[field.id] = '';
                                    }
                                    updateCurrentRowInTable(); // Aktualizuj tylko bieżący wiersz
                                    saveStorage(); // Wyślij do Supabase w tle
                                };
                                
                                label.addEventListener('click', toggleCopy);
                                input.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    if (isCopiedByButton) {
                                        toggleCopy();
                                    }
                                });
                                
                                fieldDiv.appendChild(input);
                            } else {
                                // Normalne pola
                                const label = document.createElement('label');
                                label.textContent = field.label;
                                label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                                fieldDiv.appendChild(label);
                                
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.dataset.field = field.id;
                                input.id = field.id;
                                input.className = 'field-input';
                                input.placeholder = field.label;
                                input.value = act.fieldValues[field.id] || '';
                                input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                input.addEventListener('input', (e) => { 
                                    act.fieldValues[field.id] = e.target.value.trim(); 
                                });
                                input.addEventListener('blur', (e) => {
                                    updateCurrentRowInTable();
                                    saveStorage();
                                });
                                fieldDiv.appendChild(input);
                            }
                            
                            row1.appendChild(fieldDiv);
                        }
                        container.appendChild(row1);
                    }
                    
                    // Wiersz 2
                    if (fieldsPerRow2 > 0) {
                        const row2 = document.createElement('div');
                        const gridCols2 = '1fr '.repeat(fieldsPerRow2).trim();
                        row2.style.cssText = `display: grid; grid-template-columns: ${gridCols2}; gap: 8px; margin-bottom: 8px;`;
                        
                        for (let i = fieldsPerRow1; i < fieldsPerRow1 + fieldsPerRow2 && i < group.fields.length; i++) {
                            const field = group.fields[i];
                            const fieldDiv = document.createElement('div');
                            const label = document.createElement('label');
                            label.textContent = field.label;
                            label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                            fieldDiv.appendChild(label);
                            
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.dataset.field = field.id;
                            input.id = field.id;
                            input.className = 'field-input';
                            input.placeholder = field.label;
                            input.value = act.fieldValues[field.id] || '';
                            input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                            input.addEventListener('blur', (e) => { 
                                act.fieldValues[field.id] = e.target.value.trim(); 
                                updateCurrentRowInTable(); // Aktualizuj tabelę
                                saveStorage(); 
                            });
                            fieldDiv.appendChild(input);
                            row2.appendChild(fieldDiv);
                        }
                        container.appendChild(row2);
                    }
                    
                } else if (group.layout === 'custom') {
                    // Custom layout - dla pola "Ochrzczono jako:"
                    if (group.id === 'imie_chrzest') {
                        group.fields.forEach(field => {
                            const fieldDiv = document.createElement('div');
                            fieldDiv.style.marginBottom = '8px';
                            
                            const label = document.createElement('label');
                            label.textContent = field.label;
                            label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                            fieldDiv.appendChild(label);
                            
                            // Container dla pola + przycisk
                            const inputContainer = document.createElement('div');
                            inputContainer.style.cssText = 'display: flex; gap: 6px; align-items: flex-start;';
                            
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.dataset.field = field.id;
                            input.id = field.id;
                            input.className = 'field-input';
                            input.placeholder = field.label;
                            input.value = act.fieldValues[field.id] || '';
                            
                            // Jeśli pole jest puste, automatycznie załaduj imię dziecka na żółto
                            const dzieckoImieDefault = act.fieldValues['dziecko_imie'] || '';
                            if (!input.value && dzieckoImieDefault) {
                                input.value = dzieckoImieDefault;
                                act.fieldValues[field.id] = dzieckoImieDefault;
                                act.fieldValues['imie_nadane_chrzest_suggested'] = true;
                            }
                            
                            input.style.cssText = 'flex: 1; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                            input.addEventListener('blur', (e) => { 
                                act.fieldValues[field.id] = e.target.value.trim(); 
                                updateCurrentRowInTable(); // Aktualizuj tabelę
                                saveStorage(); 
                            });
                            inputContainer.appendChild(input);
                            
                            // Przycisk "✓" - zatwierdza sugestię i zmienia na normalny widok
                            const confirmBtn = document.createElement('button');
                            confirmBtn.textContent = '✓';
                            confirmBtn.title = 'Potwierdź wartość i zmień kolor na normalny';
                            confirmBtn.style.cssText = 'padding: 5px 8px; background: #252525; border: 1px solid #3a3a3a; color: #fbbf24; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: bold; min-width: 32px; transition: all 0.2s;';
                            
                            confirmBtn.addEventListener('mouseover', (e) => {
                                e.target.style.background = '#2d2d2d';
                                e.target.style.borderColor = '#fbbf24';
                                e.target.style.color = '#ffdd57';
                            });
                            
                            confirmBtn.addEventListener('mouseout', (e) => {
                                e.target.style.background = '#252525';
                                e.target.style.borderColor = '#3a3a3a';
                                e.target.style.color = '#fbbf24';
                            });
                            
                            confirmBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                // Resetuj żółtą sugestię - przywróć normalny widok
                                input.style.borderLeft = '';
                                input.style.boxShadow = '';
                                input.style.backgroundColor = '';
                                input.style.background = '#0f0f0f';
                                input.style.color = '#ddd';
                                input.style.border = '1px solid #3a3a3a';
                                act.fieldValues['imie_nadane_chrzest_suggested'] = false;
                                saveStorage();
                            });
                            inputContainer.appendChild(confirmBtn);
                            fieldDiv.appendChild(inputContainer);
                            
                            // Jeśli jest sugestia, zaznacz na żółto od razu
                            if (act.fieldValues['imie_nadane_chrzest_suggested']) {
                                input.style.borderLeft = '4px solid #fbbf24';
                                input.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                                input.style.backgroundColor = 'rgba(251,191,36,0.05)';
                            }
                            
                            container.appendChild(fieldDiv);
                        });
                    }
                    
                } else {
                    // Layout 'single' - jedno pole na linię
                    
                    // Jeśli grupa ma checkbox ale bez headera, renderuj checkbox jako pole
                    if (group.checkbox && !group.header && group.fields.length === 0) {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.style.marginBottom = '8px';
                        checkboxDiv.style.paddingTop = '8px';
                        checkboxDiv.style.borderTop = '1px solid #2a2a2a';
                        checkboxDiv.style.display = 'flex';
                        checkboxDiv.style.alignItems = 'center';
                        checkboxDiv.style.gap = '8px';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = group.checkbox.id;
                        checkbox.checked = act.fieldValues[group.checkbox.id] === true || act.fieldValues[group.checkbox.id] === 'true';
                        checkbox.style.cssText = 'cursor: pointer; width: 16px; height: 16px;';
                        checkbox.addEventListener('change', (e) => {
                            act.fieldValues[group.checkbox.id] = e.target.checked;
                            
                            // AUTO-COPY ojciec z zgłaszającego jeśli checkbox zaznaczony
                            if (group.checkbox.id === 'zglaszajacy_ojciec' && e.target.checked) {
                                act.fieldValues['ojciec_imie'] = act.fieldValues['zglaszajacy_imie'] || '';
                                act.fieldValues['ojciec_nazwisko'] = act.fieldValues['zglaszajacy_nazwisko'] || '';
                                act.fieldValues['ojciec_zawod'] = act.fieldValues['zglaszajacy_zawod'] || '';
                                act.fieldValues['ojciec_wiek'] = act.fieldValues['zglaszajacy_wiek'] || '';
                                act.fieldValues['ojciec_miejsce'] = act.fieldValues['zglaszajacy_miejsce'] || '';
                                console.log('📋 Skopiowano OSOBA ZGŁASZAJĄCA → OJCIEC');
                                // Odśwież formularz aby pokazać zakopiowane dane
                                setTimeout(() => renderFormSections(), 100);
                            }
                            
                            saveStorage();
                        });
                        checkboxDiv.appendChild(checkbox);
                        
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.textContent = group.checkbox.label;
                        checkboxLabel.style.cssText = 'font-size: 11px; color: #ddd; cursor: pointer; margin: 0; flex: 1;';
                        checkboxLabel.htmlFor = group.checkbox.id;
                        checkboxDiv.appendChild(checkboxLabel);
                        
                        container.appendChild(checkboxDiv);
                    } else {
                        // Zwykłe pola single
                        group.fields.forEach(field => {
                            const fieldDiv = document.createElement('div');
                            fieldDiv.style.marginBottom = '4px';
                            const label = document.createElement('label');
                            label.textContent = field.label;
                            label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                            fieldDiv.appendChild(label);
                            
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.dataset.field = field.id;
                            input.id = field.id;
                            input.className = 'field-input';
                            input.placeholder = field.label;
                            input.value = act.fieldValues[field.id] || '';
                            input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                            input.addEventListener('blur', (e) => { 
                                act.fieldValues[field.id] = e.target.value.trim(); 
                                updateCurrentRowInTable(); // Aktualizuj tabelę
                                saveStorage(); 
                            });
                            fieldDiv.appendChild(input);
                            container.appendChild(fieldDiv);
                        });
                    }
                }
            });

            // ===== "DODAJ DOWOLNE DANE" BUTTON - ENABLED FOR CUSTOM DATA =====
            // Pozwala dodać dowolne dodatkowe dane (małżeństwo, zgon, inne informacje ze chrztu)
            const addFieldDiv = document.createElement('div');
            addFieldDiv.style.marginTop = '16px';
            addFieldDiv.style.paddingTop = '12px';
            addFieldDiv.style.borderTop = '1px solid #2a2a2a';
            
            // SAVE BUTTON
            const saveBtn = document.createElement('button');
            saveBtn.textContent = '💾 Zapisz zmiany';
            saveBtn.style.cssText = 'background: #0f4c1f; border: 1px solid #10b981; color: #10b981; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 11px; width: 100%; font-weight: 600; margin-bottom: 8px; transition: all 0.2s;';
            
            saveBtn.addEventListener('mouseover', (e) => {
                e.target.style.background = '#1a6d2e';
                e.target.style.color = '#34d399';
            });
            
            saveBtn.addEventListener('mouseout', (e) => {
                e.target.style.background = '#0f4c1f';
                e.target.style.color = '#10b981';
            });
            
            saveBtn.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('🔔 User clicked SAVE button');
                
                // Zapisz do Supabase i czekaj na obietnicę
                const currentAct = app.imageActs.find(a => a.actNum === app.currentActNum);
                if (!currentAct) {
                    console.warn('⚠️ Nie znaleziono bieżącego aktu');
                    return;
                }
                
                const supabase = window.supabase_client;
                if (supabase && currentAct.id) {
                    const supabaseId = currentAct.id;
                    const fieldValues = currentAct.fieldValues || {};
                    
                    // Mapowanie z powrotem do Supabase column names
                    const supabaseData = {
                        christening_year: fieldValues.rok,
                        christening_act_number: fieldValues.nr_aktu,
                        child_first_name: fieldValues.child_first_name || fieldValues.dziecko_imie,
                        child_last_name: fieldValues.child_last_name || fieldValues.dziecko_nazwisko,
                        father_first_name: fieldValues.father_first_name || fieldValues.ojciec_imie,
                        father_last_name: fieldValues.father_last_name || fieldValues.ojciec_nazwisko,
                        father_age: fieldValues.father_age || fieldValues.ojciec_wiek,
                        mother_first_name: fieldValues.mother_first_name || fieldValues.matka_imie,
                        mother_last_name: fieldValues.mother_last_name || fieldValues.matka_nazwisko,
                        mother_maiden_name: fieldValues.mother_maiden_name || fieldValues.matka_panienskie,
                        mother_age: fieldValues.mother_age || fieldValues.matka_lata,
                        witnesses: fieldValues.witnesses || fieldValues.swiadkowie,
                        location: fieldValues.location || fieldValues.matka_miejsce,
                        notes: fieldValues.notes || fieldValues.custom_note
                    };
                    
                    supabase.from('public_imports').update(supabaseData).eq('id', supabaseId).then(({ data, error }) => {
                        if (error) {
                            console.error('❌ Błąd zapisu do Supabase:', error.message);
                        } else {
                            console.log('✅ Zapisano do Supabase:', supabaseId);
                            // Po pomyślnym zapisie - odśwież tabelę (dane w pamięci już są aktualne)
                            renderRecordsTable();
                            console.log('✅ Tabela odświeżona - dane z pamięci');
                        }
                    });
                }
            });
            
            addFieldDiv.appendChild(saveBtn);

            const addBtn = document.createElement('button');
            addBtn.textContent = '+ Dodaj dowolne dane';
            addBtn.style.cssText = 'background: #252525; border: 1px solid #3a3a3a; color: #ddd; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 10px; width: 100%;';
            
            addBtn.addEventListener('click', () => {
                // Zbierz wszystkie dostępne pola z allAvailableFields
                const availableFieldsByCategory = {};
                
                allAvailableFields.forEach(field => {
                    // Sprawdź czy pole już istnieje w tym akcie
                    if (!act.fieldValues[field.id]) {
                        if (!availableFieldsByCategory[field.category]) {
                            availableFieldsByCategory[field.category] = [];
                        }
                        availableFieldsByCategory[field.category].push(field);
                    }
                });
                
                // Stwórz modal z listą pól pogrupowanych po kategoriach
                const modalOverlay = document.createElement('div');
                modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center;';
                
                const modal = document.createElement('div');
                modal.style.cssText = 'background: #1a1a1a; border: 1px solid #3a3a3a; border-radius: 6px; padding: 20px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.8); max-height: 80vh; overflow-y: auto;';
                
                const title = document.createElement('div');
                title.textContent = 'Dodaj pole';
                title.style.cssText = 'font-size: 13px; color: #0078d4; font-weight: 600; margin-bottom: 15px; text-transform: uppercase;';
                modal.appendChild(title);
                
                // Lista dostępnych pól pogrupowana po kategoriach
                if (Object.keys(availableFieldsByCategory).length > 0) {
                    const listLabel = document.createElement('label');
                    listLabel.textContent = 'Wszystkie dostępne pola:';
                    listLabel.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 10px; font-weight: 600; text-transform: uppercase;';
                    modal.appendChild(listLabel);
                    
                    const fieldSelect = document.createElement('select');
                    fieldSelect.style.cssText = 'width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 4px; font-size: 11px; margin-bottom: 15px; box-sizing: border-box;';
                    
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '-- Wybierz pole --';
                    fieldSelect.appendChild(emptyOption);
                    
                    // Dodaj pola pogrupowane po kategoriach
                    const categories = ['Wspólne', 'Urodzenia/Chrzty', 'Małżeństwa/Śluby', 'Zgony/Pogrzeby'];
                    categories.forEach(category => {
                        if (availableFieldsByCategory[category] && availableFieldsByCategory[category].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = category;
                            
                            availableFieldsByCategory[category].forEach(field => {
                                const option = document.createElement('option');
                                option.value = field.id;
                                option.textContent = field.label;
                                optgroup.appendChild(option);
                            });
                            
                            fieldSelect.appendChild(optgroup);
                        }
                    });
                    
                    modal.appendChild(fieldSelect);
                    
                    // Przycisk do dodania z listy
                    const addFromListBtn = document.createElement('button');
                    addFromListBtn.textContent = 'Dodaj z szablonu';
                    addFromListBtn.style.cssText = 'width: 100%; padding: 8px; background: #0078d4; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; margin-bottom: 12px; transition: all 0.2s;';
                    
                    addFromListBtn.addEventListener('mouseover', (e) => {
                        e.target.style.background = '#0099ff';
                    });
                    
                    addFromListBtn.addEventListener('mouseout', (e) => {
                        e.target.style.background = '#0078d4';
                    });
                    
                    addFromListBtn.addEventListener('click', () => {
                        const selectedId = fieldSelect.value;
                        if (!selectedId) {
                            alert('Wybierz pole z listy');
                            return;
                        }
                        
                        const selectedField = allAvailableFields.find(f => f.id === selectedId);
                        if (!selectedField) return;
                        
                        addCustomField(selectedField.id, selectedField.label);
                        document.body.removeChild(modalOverlay);
                    });
                    
                    modal.appendChild(addFromListBtn);
                    
                    // Separator
                    const separator = document.createElement('div');
                    separator.style.cssText = 'height: 1px; background: #3a3a3a; margin: 12px 0;';
                    modal.appendChild(separator);
                }
                
                // Pole do wpisania własnej nazwy pola
                const customLabel = document.createElement('label');
                customLabel.textContent = 'Lub wpisz własne pole:';
                customLabel.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;';
                modal.appendChild(customLabel);
                
                const customInput = document.createElement('input');
                customInput.type = 'text';
                customInput.placeholder = 'np. Małżeństwo, Notatka...';
                customInput.style.cssText = 'width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 4px; font-size: 11px; margin-bottom: 12px; box-sizing: border-box;';
                modal.appendChild(customInput);
                
                // Przyciski
                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.cssText = 'display: flex; gap: 8px;';
                
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Dodaj';
                confirmBtn.style.cssText = 'flex: 1; padding: 8px; background: #107c10; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s;';
                
                confirmBtn.addEventListener('mouseover', (e) => {
                    e.target.style.background = '#0d6a0d';
                });
                
                confirmBtn.addEventListener('mouseout', (e) => {
                    e.target.style.background = '#107c10';
                });
                
                confirmBtn.addEventListener('click', () => {
                    const fieldLabel = customInput.value.trim();
                    if (!fieldLabel) {
                        alert('Wpisz nazwę pola');
                        return;
                    }
                    
                    const fieldId = fieldLabel.toLowerCase().replace(/\s+/g, '_');
                    addCustomField(fieldId, fieldLabel);
                    document.body.removeChild(modalOverlay);
                });
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Anuluj';
                cancelBtn.style.cssText = 'flex: 1; padding: 8px; background: #3a3a3a; border: none; color: #ddd; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s;';
                
                cancelBtn.addEventListener('mouseover', (e) => {
                    e.target.style.background = '#454545';
                });
                
                cancelBtn.addEventListener('mouseout', (e) => {
                    e.target.style.background = '#3a3a3a';
                });
                
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(modalOverlay);
                });
                
                buttonsDiv.appendChild(confirmBtn);
                buttonsDiv.appendChild(cancelBtn);
                modal.appendChild(buttonsDiv);
                
                modalOverlay.appendChild(modal);
                document.body.appendChild(modalOverlay);
                customInput.focus();
                
                // Helper function - dodaj pole do formularza
                function addCustomField(fieldId, fieldLabel) {
                    if (!act.fieldValues) act.fieldValues = {};
                    
                    // Twórz pole
                    const fieldDiv = document.createElement('div');
                    fieldDiv.style.marginBottom = '4px';
                    
                    const label = document.createElement('label');
                    label.textContent = fieldLabel;
                    label.style.cssText = 'display: block; font-size: 10px; color: #10b981; margin-bottom: 2px; font-weight: 600;';
                    fieldDiv.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'field-input';
                    input.id = fieldId;
                    input.placeholder = fieldLabel;
                    input.value = act.fieldValues[fieldId] || '';
                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                    
                    input.addEventListener('blur', (e) => {
                        act.fieldValues[fieldId] = e.target.value.trim();
                        updateCurrentRowInTable(); // Aktualizuj tabelę
                        saveStorage();
                    });
                    
                    fieldDiv.appendChild(input);
                    container.insertBefore(fieldDiv, addFieldDiv);
                    input.focus();
                    saveStorage();
                }
            });

            addFieldDiv.appendChild(addBtn);
            container.appendChild(addFieldDiv);

            // ===== LOGIC: Auto-suggest mother's surname from father =====
            // Dodaj listener do pola ojciec_nazwisko aby sugerować nazwisko matki
            const ojciecNazwiskoInput = document.getElementById('ojciec_nazwisko');
            const matkaNazwiskoInput = document.getElementById('matka_nazwisko');
            
            if (ojciecNazwiskoInput && matkaNazwiskoInput) {
                ojciecNazwiskoInput.addEventListener('blur', (e) => {
                    const ojciecNazwisko = e.target.value.trim();
                    
                    // Jeśli pole matki jest puste i wpisano nazwisko ojca
                    if (ojciecNazwisko && !matkaNazwiskoInput.value.trim()) {
                        // Zasugeruj nazwisko ojca dla matki ze wskaźnikiem niepewności (żółty kolor)
                        matkaNazwiskoInput.value = ojciecNazwisko;
                        matkaNazwiskoInput.style.borderLeft = '4px solid #fbbf24';  // 🟡 Żółty - sugestia
                        matkaNazwiskoInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                        matkaNazwiskoInput.title = 'Zasugerowane na podstawie nazwiska ojca - zmień jeśli nieprecyzyjne';
                        // Zaznacz w fieldValues aby wiedzieć, że to sugestia
                        act.fieldValues['matka_nazwisko_suggested'] = true;
                        updateCurrentRowInTable(); // Aktualizuj tabelę
                        saveStorage();
                    } else if (!ojciecNazwisko) {
                        // Jeśli usunięto nazwisko ojca, usuń sugestię jeśli była
                        if (act.fieldValues['matka_nazwisko_suggested']) {
                            matkaNazwiskoInput.value = '';
                            matkaNazwiskoInput.style.borderLeft = '';
                            matkaNazwiskoInput.style.boxShadow = '';
                            matkaNazwiskoInput.title = '';
                            act.fieldValues['matka_nazwisko_suggested'] = false;
                            updateCurrentRowInTable(); // Aktualizuj tabelę
                            saveStorage();
                        }
                    }
                });
            }
            
            // Jeśli już był wpisany ojciec przy otwarciu, zasugeruj nazwisko matki
            if (ojciecNazwiskoInput && matkaNazwiskoInput) {
                const ojciecNazwisko = ojciecNazwiskoInput.value.trim();
                if (ojciecNazwisko && !matkaNazwiskoInput.value.trim() && !act.fieldValues['matka_nazwisko']) {
                    matkaNazwiskoInput.value = ojciecNazwisko;
                    matkaNazwiskoInput.style.borderLeft = '4px solid #fbbf24';  // 🟡 Żółty - sugestia
                    matkaNazwiskoInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                    matkaNazwiskoInput.title = 'Zasugerowane na podstawie nazwiska ojca - zmień jeśli nieprecyzyjne';
                    act.fieldValues['matka_nazwisko_suggested'] = true;
                }
            }
            
            // ===== LOGIC: Add confirm button for matka_nazwisko when suggested =====
            if (matkaNazwiskoInput && act.fieldValues['matka_nazwisko_suggested']) {
                addConfirmButtonToField(matkaNazwiskoInput, 'matka_nazwisko_suggested');
            }
            
            // ===== LOGIC: Auto-suggest priest info from previous act =====
            const ksiadzImieInput = document.getElementById('ksiadz_imie');
            const ksiadzNazwiskoInput = document.getElementById('ksiadz_nazwisko');
            
            if (ksiadzImieInput && ksiadzNazwiskoInput) {
                // Szukaj poprzedniego aktu na tej samej lub poprzedniej stronie
                let previousAct = null;
                
                // Najpierw spróbuj znaleźć poprzedni akt na tej samej stronie
                if (app.currentActNum > 0 && app.imageActs[app.currentImageIdx]) {
                    previousAct = app.imageActs[app.currentImageIdx][app.currentActNum - 1];
                } else if (app.currentImageIdx > 0 && app.imageActs[app.currentImageIdx - 1]) {
                    // Jeśli brak poprzedniego na tej stronie, weź ostatni z poprzedniej strony
                    const prevImageActs = app.imageActs[app.currentImageIdx - 1];
                    if (prevImageActs && prevImageActs.length > 0) {
                        previousAct = prevImageActs[prevImageActs.length - 1];
                    }
                }
                
                if (previousAct && previousAct.fieldValues) {
                    const prevKsIm = previousAct.fieldValues['ksiadz_imie'] || '';
                    const prevKsNaz = previousAct.fieldValues['ksiadz_nazwisko'] || '';
                    
                    // Jeśli są dane księdza w poprzednim akcie i pola są puste
                    if ((prevKsIm || prevKsNaz) && !ksiadzImieInput.value.trim() && !ksiadzNazwiskoInput.value.trim()) {
                        // Zasugeruj dane księdza
                        if (prevKsIm) {
                            ksiadzImieInput.value = prevKsIm;
                            ksiadzImieInput.style.borderLeft = '4px solid #fbbf24';
                            ksiadzImieInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                            ksiadzImieInput.style.backgroundColor = 'rgba(251,191,36,0.05)';
                            act.fieldValues['ksiadz_imie_suggested'] = true;
                            addConfirmButtonToField(ksiadzImieInput, 'ksiadz_imie_suggested');
                        }
                        
                        if (prevKsNaz) {
                            ksiadzNazwiskoInput.value = prevKsNaz;
                            ksiadzNazwiskoInput.style.borderLeft = '4px solid #fbbf24';
                            ksiadzNazwiskoInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                            ksiadzNazwiskoInput.style.backgroundColor = 'rgba(251,191,36,0.05)';
                            act.fieldValues['ksiadz_nazwisko_suggested'] = true;
                            addConfirmButtonToField(ksiadzNazwiskoInput, 'ksiadz_nazwisko_suggested');
                        }
                        
                        saveStorage();
                    }
                }
            }
            
            // ===== LOGIC: Highlight ksiadz fields if already filled from suggestion =====
            if (ksiadzImieInput && act.fieldValues['ksiadz_imie_suggested']) {
                ksiadzImieInput.style.borderLeft = '4px solid #fbbf24';
                ksiadzImieInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                ksiadzImieInput.style.backgroundColor = 'rgba(251,191,36,0.05)';
                addConfirmButtonToField(ksiadzImieInput, 'ksiadz_imie_suggested');
            }
            
            if (ksiadzNazwiskoInput && act.fieldValues['ksiadz_nazwisko_suggested']) {
                ksiadzNazwiskoInput.style.borderLeft = '4px solid #fbbf24';
                ksiadzNazwiskoInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                ksiadzNazwiskoInput.style.backgroundColor = 'rgba(251,191,36,0.05)';
                addConfirmButtonToField(ksiadzNazwiskoInput, 'ksiadz_nazwisko_suggested');
            }
            
            // ===== SYSTEM FIELDS (niewidoczne w zwykłym formularzu, ale edytowalne) =====
            // Dodaj divider
            const systemDivider = document.createElement('div');
            systemDivider.style.cssText = 'border-top: 1px solid #3a3a3a; margin: 10px 0; opacity: 0.5;';
            container.appendChild(systemDivider);
            
            // IMAGE_PATH - ścieżka do obrazu
            const imagePathGroup = document.createElement('div');
            imagePathGroup.style.cssText = 'margin-top: 8px;';
            
            const imagePathLabel = document.createElement('label');
            imagePathLabel.textContent = '📁 Ścieżka obrazu';
            imagePathLabel.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 4px; font-weight: 500; text-transform: uppercase;';
            imagePathGroup.appendChild(imagePathLabel);
            
            const imagePathInput = document.createElement('input');
            imagePathInput.type = 'text';
            imagePathInput.id = 'image_path_field';
            imagePathInput.placeholder = 'np. 1829/8098.jpg lub http://...';
            imagePathInput.value = act.image_path || (app.images && app.images[app.currentImageIdx]?.name) || '';
            imagePathInput.style.cssText = 'width: 100%; padding: 6px 8px; background: #1a1a1a; border: 1px solid #444; color: #aaa; border-radius: 4px; font-size: 11px; font-family: monospace; box-sizing: border-box;';
            
            imagePathInput.addEventListener('change', () => {
                act.image_path = imagePathInput.value;
                act.fieldValues['image_path'] = imagePathInput.value;
                saveStorage();
                console.log('✏️ Image path updated:', act.image_path);
            });
            
            imagePathGroup.appendChild(imagePathInput);
            container.appendChild(imagePathGroup);
            
            // ACT_ROI - zaznaczenie ROI na obrazie (wyświetl jako info)
            const actROIGroup = document.createElement('div');
            actROIGroup.style.cssText = 'margin-top: 8px;';
            
            const actROILabel = document.createElement('label');
            actROILabel.textContent = '📍 ROI (zaznaczenie na obrazie)';
            actROILabel.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 4px; font-weight: 500; text-transform: uppercase;';
            actROIGroup.appendChild(actROILabel);
            
            const actROIDisplay = document.createElement('div');
            const roiInfo = act.actROI 
                ? `x=${act.actROI.x}, y=${act.actROI.y}, w=${act.actROI.width}, h=${act.actROI.height}`
                : '(brak - zaznacz na obrazie przyciskiem ROI)';
            actROIDisplay.textContent = roiInfo;
            actROIDisplay.style.cssText = 'padding: 6px 8px; background: #1a1a1a; border: 1px solid #444; color: #666; border-radius: 4px; font-size: 10px; font-family: monospace; word-break: break-all;';
            
            // Przycisk do czyszczenia ROI
            const clearROIBtn = document.createElement('button');
            clearROIBtn.textContent = '✕ Wyczyść ROI';
            clearROIBtn.style.cssText = 'margin-top: 4px; padding: 4px 8px; background: #3a3a3a; border: 1px solid #555; color: #888; border-radius: 3px; font-size: 9px; cursor: pointer; width: 100%;';
            clearROIBtn.addEventListener('click', (e) => {
                e.preventDefault();
                act.actROI = null;
                act.fieldValues['actROI'] = null;
                actROIDisplay.textContent = '(brak - zaznacz na obrazie przyciskiem ROI)';
                redrawROIs();
                saveStorage();
                console.log('✏️ ROI cleared for act:', act.original_id);
            });
            
            actROIGroup.appendChild(actROIDisplay);
            actROIGroup.appendChild(clearROIBtn);
            container.appendChild(actROIGroup);
            
            // Focus first field
            container.querySelector('.field-input')?.focus();
        }
        
        // ===== Helper function: Add confirm button next to input field =====
        function addConfirmButtonToField(inputElement, suggestionFlagKey) {
            // Sprawdź czy przycisk już istnieje
            let existingBtn = inputElement.nextElementSibling;
            if (existingBtn && existingBtn.dataset.confirmBtn === 'true') {
                return; // Przycisk już istnieje
            }
            
            // Stwórz container dla przycisku
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '✓';
            confirmBtn.title = 'Potwierdź wartość i zmień kolor na normalny';
            confirmBtn.dataset.confirmBtn = 'true';
            confirmBtn.style.cssText = 'padding: 5px 8px; background: #252525; border: 1px solid #3a3a3a; color: #fbbf24; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: bold; min-width: 32px; transition: all 0.2s; position: absolute; right: 0; top: 20px;';
            
            confirmBtn.addEventListener('mouseover', (e) => {
                e.target.style.background = '#2d2d2d';
                e.target.style.borderColor = '#fbbf24';
                e.target.style.color = '#ffdd57';
            });
            
            confirmBtn.addEventListener('mouseout', (e) => {
                e.target.style.background = '#252525';
                e.target.style.borderColor = '#3a3a3a';
                e.target.style.color = '#fbbf24';
            });
            
            confirmBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // Resetuj żółtą sugestię - przywróć normalny widok
                inputElement.style.borderLeft = '';
                inputElement.style.boxShadow = '';
                inputElement.style.backgroundColor = '';
                // Upewnij się że pole ma normalny styl
                inputElement.style.background = '#0f0f0f';
                inputElement.style.color = '#ddd';
                inputElement.style.border = '1px solid #3a3a3a';
                app.imageActs[app.currentActNum][suggestionFlagKey] = false;
                saveStorage();
                // Usuń przycisk
                confirmBtn.remove();
            });
            
            // Umieść przycisk obok pola
            inputElement.parentElement.style.position = 'relative';
            inputElement.parentElement.appendChild(confirmBtn);
        }
        
        function setupFormEvents() {
            // ===== DEPRECATED - old form events not needed =====
        }
        
        // ⭐ P0: Update Progress Bar - Show N/M fields complete
        function updateProgressBar() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const inputs = activeForm.querySelectorAll('.field-input');
            const completed = Array.from(inputs).filter(input => 
                input.value?.trim().length > 0
            ).length;
            
            const total = inputs.length;
            const percent = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${completed}/${total}`;
            
            console.log(`📊 Progress: ${completed}/${total} (${percent.toFixed(0)}%)`);
        }
        
        // TASK #2: Search Handler - Filter acts by field values
        function setupSearchInput() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                
                if (!query) {
                    // Reset: show all act buttons
                    renderActButtons();
                    return;
                }
                
                // Filter acts on current image by field values
                const currentImageActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                const filtered = currentImageActs.filter(act => {
                    return Object.values(act.fieldValues || {}).some(val =>
                        val?.toString().toLowerCase().includes(query)
                    );
                });
                
                // Highlight matching acts
                const actBtns = document.querySelectorAll('.act-btn');
                actBtns.forEach(btn => {
                    const actNum = parseInt(btn.dataset.actNum);
                    const isMatched = filtered.some(a => a.actNum === actNum);
                    btn.style.opacity = isMatched ? '1' : '0.4';
                    btn.style.borderColor = isMatched ? '#0078d4' : '#3a3a3a';
                });
                
                console.log(`🔍 Search: znaleźliśmy ${filtered.length}/${currentImageActs.length} aktów`);
            });
        }
        
        // TASK #3: JSON Import - Load records from file
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        
                        // Validate structure
                        if (!Array.isArray(data.imageActs)) throw new Error('Brak imageActs array');
                        
                        // Import
                        app.imageActs = data.imageActs || [];
                        app.images = data.images || app.images; // Keep existing images if not in file
                        
                        saveStorage();
                        renderActButtons();
                        renderFormSections();
                        updateProgressBar();
                        
                        const count = app.imageActs.length;
                        notify(`✅ Importowano ${count} aktów z JSON`, 'success');
                        console.log('📥 JSON Import: SUCCESS', data);
                    } catch (err) {
                        notify(`❌ Błąd importu JSON: ${err.message}`, 'error');
                        console.error('❌ JSON Import ERROR:', err);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // TASK #4: Tab Navigation - Enhanced with Shift+Tab
        function setupTabNavigation() {
            document.addEventListener('keydown', (e) => {
                // Tab = next field, Shift+Tab = prev field
                if (e.key === 'Tab') {
                    const activeForm = document.querySelector('.form-section.active');
                    if (!activeForm) return;
                    
                    const inputs = Array.from(activeForm.querySelectorAll('.field-input'));
                    const currentIdx = inputs.indexOf(document.activeElement);
                    
                    if (currentIdx === -1) return;
                    
                    let nextIdx = e.shiftKey ? currentIdx - 1 : currentIdx + 1;
                    
                    // Wrap around
                    if (nextIdx < 0) nextIdx = inputs.length - 1;
                    if (nextIdx >= inputs.length) nextIdx = 0;
                    
                    e.preventDefault();
                    inputs[nextIdx].focus();
                    inputs[nextIdx].select?.();
                    
                    console.log(`⌨️ Tab: field ${nextIdx + 1}/${inputs.length}`);
                }
            });
        }
        
        // 🟢 P0: Color-Coded Fields - Update visual status of all fields
        function updateFieldStatus() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const act = getCurrentAct();
            const inputs = activeForm.querySelectorAll('.field-input');
            
            inputs.forEach(input => {
                const fieldId = input.dataset.field;
                const hasValue = input.value?.trim().length > 0;
                const hasROI = act?.fieldROIs?.[fieldId];
                
                // Remove all status classes
                input.classList.remove('field-complete', 'field-roi-only', 'field-empty');
                
                // Assign new status
                if (hasValue) {
                    input.classList.add('field-complete');  // 🟢 Green
                } else if (hasROI) {
                    input.classList.add('field-roi-only');  // 🟡 Yellow
                } else {
                    input.classList.add('field-empty');     // 🔴 Red
                }
            });
        }
        
        // ⭐ P0: AUTO-ZOOM TO ROI/ACT
        function zoomToROI(roi) {
            if (!app.viewer || !roi) return;
            const item = app.viewer.world.getItemAt(0);
            if (!item) return;
            const itemSize = item.getContentSize();
            const rect = new OpenSeadragon.Rect(
                roi.x * itemSize.x,
                roi.y * itemSize.y,
                roi.w * itemSize.x,
                roi.h * itemSize.y
            );
            const viewportRect = app.viewer.viewport.imageToViewportRectangle(rect);
            app.viewer.viewport.fitBounds(viewportRect, true);
            console.log('🔍 AUTO-ZOOM to ROI:', { x: roi.x.toFixed(2), y: roi.y.toFixed(2), w: roi.w.toFixed(2), h: roi.h.toFixed(2) });
        }
        
        function initViewer() {
            return new Promise((resolve) => {
                console.log('📍 Creating OpenSeadragon instance...');
                app.viewer = OpenSeadragon({
                    id: 'viewer',
                    prefixUrl: 'https://openseadragon.github.io/openseadragon/images/',

                    // Kontrolki OSD
                    showNavigationControl: true,
                    showZoomControl: true,
                    showHomeControl: true,
                    showFullPageControl: true,
                    showRotationControl: true,

                    // Gesty myszą
                    gestureSettingsMouse: {
                        scrollToZoom: true,
                        dragToPan: true,
                        clickToZoom: true,
                        dblClickToZoom: false,
                        flickEnabled: false
                    },

                    // Zoom
                    minZoomLevel: 0.5,
                    maxZoomLevel: 20,
                    
                    // Rotacja
                    rotationIncrement: 90,

                    // Kontrolki UI - wbudowane przyciski OSD (prawy górny róg)
                    navigationControlAnchor: OpenSeadragon.ControlAnchor.TOP_RIGHT,
                    showNavigationControl: true,
                    showZoomControl: true,
                    showHomeControl: true,
                    showFullPageControl: false,
                    showRotationControl: true
                });

                console.log('📍 OpenSeadragon instance created, viewer:', !!app.viewer);
                resolve();
            });
        }
        
        function setupDrawingCanvas() {
            app.drawingCanvas = document.getElementById('drawingCanvas');
            app.drawingCtx = app.drawingCanvas.getContext('2d');
            const container = document.querySelector('.viewer-container');
            
            const resize = () => {
                app.drawingCanvas.width = container.offsetWidth;
                app.drawingCanvas.height = container.offsetHeight;
            };
            resize();
            window.addEventListener('resize', resize);
            
            // Funkcja do aktualizacji pointer-events
            const updateCanvasInteraction = () => {
                if (app.roiMode || app.actMode) {
                    app.drawingCanvas.style.pointerEvents = 'auto';
                    app.drawingCanvas.style.cursor = 'crosshair';
                } else {
                    app.drawingCanvas.style.pointerEvents = 'none';
                    app.drawingCanvas.style.cursor = 'default';
                }
            };
            
            updateCanvasInteraction();
            
            app.drawingCanvas.addEventListener('mousedown', (e) => {
                if (!app.actMode) return;
                // roiMode wyłączony
                if (!app.currentActNum) { notify('Zaznacz akt w oknie AKTY zanim zaznaczysz granice', 'error'); return; }
                
                e.preventDefault();
                app.drawingROI = true;
                app.roiStartX = e.offsetX;
                app.roiStartY = e.offsetY;
                updateCanvasInteraction();
            });
            
            app.drawingCanvas.addEventListener('mousemove', (e) => {
                if (!app.drawingROI) return;
                app.drawingCtx.clearRect(0, 0, app.drawingCanvas.width, app.drawingCanvas.height);
                redrawROIs();
                
                let x = app.roiStartX, y = app.roiStartY, w = e.offsetX - x, h = e.offsetY - y;
                if (w < 0) { x += w; w = -w; }
                if (h < 0) { y += h; h = -h; }
                
                app.drawingCtx.strokeStyle = app.roiMode ? '#0078d4' : '#10b981';
                app.drawingCtx.fillStyle = app.roiMode ? 'rgba(0,120,212,0.15)' : 'rgba(16,185,129,0.1)';
                app.drawingCtx.setLineDash([5, 5]);
                app.drawingCtx.strokeRect(x, y, w, h);
                app.drawingCtx.fillRect(x, y, w, h);
                app.drawingCtx.setLineDash([]);
            });
            
            app.drawingCanvas.addEventListener('mouseup', (e) => {
                if (!app.drawingROI) return;
                app.drawingROI = false;
                updateCanvasInteraction();
                
                let x = Math.min(app.roiStartX, e.offsetX);
                let y = Math.min(app.roiStartY, e.offsetY);
                let w = Math.abs(e.offsetX - app.roiStartX);
                let h = Math.abs(e.offsetY - app.roiStartY);
                
                if (w < 10 || h < 10) { app.drawingCtx.clearRect(0, 0, app.drawingCanvas.width, app.drawingCanvas.height); return; }
                
                const roi = screenToImageRect(x, y, w, h);
                if (!roi) return;
                
                const act = getCurrentAct();
                if (!act) return;
                
                // roiMode wyłączony
                /*
                if (app.roiMode) {
                    // Normalizuj fieldId - zamień kropki na podkreślenia
                    const normalizedFieldId = app.activeField.dataset.field.replace(/\./g, '_');
                    act.fieldROIs[normalizedFieldId] = roi;
                    app.activeField.classList.add('has-roi');
                    notify('Pole zaznaczone', 'success');
                    setTimeout(() => startWizard(), 200);
                } else */ if (app.actMode) {
                    act.actROI = roi;
                    notify('✓ Granice aktu zaznaczone', 'success');
                    // Tryb actMode pozostaje włączony - user wyłączy manualnie gdy skończy zaznaczać wszystkie akty
                }
                
                saveStorage();
                app.drawingCtx.clearRect(0, 0, app.drawingCanvas.width, app.drawingCanvas.height);
                setTimeout(redrawROIs, 50);
            });
            
            app.drawingCanvas.addEventListener('mouseleave', () => {
                if (app.drawingROI) {
                    app.drawingROI = false;
                    updateCanvasInteraction();
                    app.drawingCtx.clearRect(0, 0, app.drawingCanvas.width, app.drawingCanvas.height);
                }
            });
            
            // Zapamiętaj funkcję aby mogła być wywołana z toggleROI/toggleActMode
            app.updateCanvasInteraction = updateCanvasInteraction;
        }
        
        function screenToImageRect(x, y, w, h) {
            const viewer = app.viewer;
            const item = viewer.world.getItemAt(0);
            if (!item) return null;
            
            try {
                const p1 = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(x, y));
                const p2 = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(x + w, y + h));
                const img1 = item.viewportToImageCoordinates(p1);
                const img2 = item.viewportToImageCoordinates(p2);
                const size = item.getContentSize();
                
                return {
                    x: img1.x / size.x,
                    y: img1.y / size.y,
                    w: (img2.x - img1.x) / size.x,
                    h: (img2.y - img1.y) / size.y
                };
            } catch (err) {
                console.error('Błąd konwersji:', err);
                return null;
            }
        }
        
        function redrawROIs() {
            try {
                const viewer = app.viewer;
                if (!viewer) return;
                
                const item = viewer.world.getItemAt(0);
                if (!item) {
                    // 🔧 NAPRAWIONO: Jeśli obraz jest w fallback, nie możemy rysować ROI w OSD
                    console.log('ℹ️ No OSD item - using fallback image mode');
                    return;
                }
            
            if (app.needsFullRedraw) {
                app.roiOverlays.forEach(overlay => viewer.removeOverlay(overlay));
                app.roiOverlays = [];
                app.overlayMap.clear();
                
                // Usuwamy wszelkie pozostałe overlay aktu z DOM
                document.querySelectorAll('.act-overlay').forEach(el => {
                    try {
                        viewer.removeOverlay(el);
                    } catch (e) {
                        // Overlay może być już usunięty
                    }
                    el.remove();
                });
            }
            
            const size = item.getContentSize();
            
            // Draw field ROIs ONLY for the currently selected act
            const currentAct = app.imageActs.find(a => 
                a.imageIdx === app.currentImageIdx && a.actNum === app.currentActNum
            );
            
            // Draw act overlays for all acts on current image
            const currentActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
            
            console.log('currentActs length:', currentActs.length, 'currentImageIdx:', app.currentImageIdx);
            
            // ONLY draw act boundaries if showActBoundaries is true
            if (app.showActBoundaries) {
                currentActs.forEach(act => {
                if (!act.actROI || typeof act.actROI !== 'object' || act.actROI.x === undefined) return;
                
                console.log('Drawing act overlay for act', act.actNum);
                
                const actTypeShort = act.type.toUpperCase().substring(0, 2);
                const actName = `${actTypeShort}.${act.year}.No.${String(act.nr || 0).padStart(2, '0')}`;
                
                const key = `act_${act.actNum}`;
                const imgRect = new OpenSeadragon.Rect(
                    act.actROI.x * size.x, act.actROI.y * size.y,
                    act.actROI.w * size.x, act.actROI.h * size.y
                );
                const viewportRect = viewer.viewport.imageToViewportRectangle(imgRect);
                
                if (viewportRect.width <= 0 || viewportRect.height <= 0) {
                    console.warn('Invalid viewportRect for act', act.actNum, viewportRect);
                    return;
                }
                
                let div = app.overlayMap.get(key);
                if (!div || app.needsFullRedraw) {
                    div = document.createElement('div');
                    div.className = 'act-overlay';
                    div.style.border = act.actNum === app.currentActNum ? '2px solid #10b981' : '2px dashed #999';
                    div.dataset.actNum = act.actNum;
                    const label = document.createElement('div');
                    label.textContent = actName;
                    label.style.cssText = 'color: #000000; font-size: 12px; font-weight: bold; padding: 4px 6px; background: none; text-decoration: none;';
                    div.appendChild(label);
                    
                    // Context menu dla aktu
                    div.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showActContextMenu(act.actNum, e.pageX, e.pageY);
                    });
                    
                    viewer.addOverlay({ element: div, location: viewportRect });
                    app.roiOverlays.push(div);
                    app.overlayMap.set(key, div);
                } else {
                    viewer.removeOverlay(div);
                    viewer.addOverlay({ element: div, location: viewportRect });
                }
                });
            }
            
            // Draw field ROIs ONLY for the currently selected act
            
            if (currentAct && currentAct.fieldROIs) {
                const actTypeShort = currentAct.type.toUpperCase().substring(0, 2);
                const actName = `${actTypeShort}.${currentAct.year}.No.${currentAct.nr.toString().padStart(2, '0')}`;
                
                Object.entries(currentAct.fieldROIs).forEach(([fieldId, roi]) => {
                    const key = `field_${currentAct.actNum}_${fieldId}`;
                    const imgRect = new OpenSeadragon.Rect(
                        roi.x * size.x, roi.y * size.y,
                        roi.w * size.x, roi.h * size.y
                    );
                    const viewportRect = viewer.viewport.imageToViewportRectangle(imgRect);
                    
                    if (viewportRect.width <= 0 || viewportRect.height <= 0) {
                        console.warn('Invalid viewportRect for field', fieldId, viewportRect);
                        return;
                    }
                    
                    console.log('Drawing field ROI for', fieldId, 'at', viewportRect);
                    
                    let div = app.overlayMap.get(key);
                    if (!div || app.needsFullRedraw) {
                        div = document.createElement('div');
                        div.className = 'roi-overlay';
                        const label = document.createElement('div');
                        label.textContent = actName;
                        label.style.cssText = 'color: white; font-size: 11px; padding: 4px; background: rgba(0,0,0,0.6); text-decoration: overline;';
                        div.appendChild(label);
                        
                        console.log('Adding overlay for', key, 'at', viewportRect);
                        viewer.addOverlay({ element: div, location: viewportRect });
                        app.roiOverlays.push(div);
                        app.overlayMap.set(key, div);
                    } else {
                        console.log('Updating overlay for', key);
                        viewer.removeOverlay(div);
                        viewer.addOverlay({ element: div, location: viewportRect });
                    }
                    
                    // Zawsze aktualizuj klasy
                    div.classList.remove('active');
                    if (app.activeField?.dataset.field === fieldId) {
                        div.classList.add('active');
                    }
                });
            }
            
            app.needsFullRedraw = true; // Reset flagi
            } catch (e) {
                console.error('Error in redrawROIs:', e);
            }
        }
        
        function setupEvents() {
            console.log('⚙️ setupEvents starting...');
            document.getElementById('fileInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
            
            document.getElementById('folderInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
            
            const viewerContainer = document.getElementById('viewerContainer');
            if (viewerContainer) {
                viewerContainer.addEventListener('dragover', (e) => { e.preventDefault(); viewerContainer.classList.add('drag-over'); });
                viewerContainer.addEventListener('dragleave', () => { viewerContainer.classList.remove('drag-over'); });
                viewerContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    viewerContainer.classList.remove('drag-over');
                    handleFiles(e.dataTransfer.files);
                });
            }
            
            // Toolbar button listeners (safe after DOM loaded)
            // Find by text content "Otwórz"
            let addImagesBtn = document.getElementById('openBtn');
            console.log('🔍 addImagesBtn found:', !!addImagesBtn, addImagesBtn?.title);
            if (addImagesBtn) addImagesBtn.addEventListener('click', addImages);
            
            const postprocessBtn = document.getElementById('postprocessBtn');
            if (postprocessBtn) postprocessBtn.addEventListener('click', togglePostprocessPanel);
            
            const actsBtn = document.getElementById('toggleActsBtn');
            if (actsBtn) actsBtn.addEventListener('click', toggleActsPanel);
            
            // Inne przyciski toolbar
            const sortBtn = document.getElementById('sortBtn');
            if (sortBtn) sortBtn.addEventListener('click', sortImages);
            
            const roiBtn = document.getElementById('roiBtn');
            if (roiBtn) roiBtn.addEventListener('click', toggleActMode);
            
            const toggleBoundariesBtn = document.getElementById('toggleBoundariesBtn');
            if (toggleBoundariesBtn) {
                toggleBoundariesBtn.addEventListener('click', toggleActBoundaries);
                // Ustaw stan początkowy przycisku
                toggleBoundariesBtn.classList.toggle('disabled', !app.showActBoundaries);
            }
            
            // Auth button
            const authBtn = document.getElementById('authBtn');
            if (authBtn) authBtn.addEventListener('click', signInWithGoogle);
            
            // const actBtn = document.getElementById('actBtn');
            // if (actBtn) actBtn.addEventListener('click', toggleROI);
            
            // Context menu dla viewerContainer (obraz)
            if (viewerContainer) {
                viewerContainer.addEventListener('contextmenu', (e) => {
                    const rect = viewerContainer.getBoundingClientRect();
                    const clickedOnOverlay = e.target.closest('.act-overlay');
                    if (!clickedOnOverlay) {
                        e.preventDefault();
                        showImageContextMenu(e.pageX, e.pageY);
                    }
                });
            }
            
            // Setup context menu handlers
            setupContextMenuHandlers();
            
            const clearStorageBtn = document.getElementById('clearStorageBtn');
            if (clearStorageBtn) {
                clearStorageBtn.addEventListener('click', () => {
                    if (confirm('⚠️ Wyczyść CAŁE localStorage? Wszystkie dane będą usunięte.')) {
                        localStorage.clear();
                        notify('✅ localStorage wyczyszczony. Odśwież stronę.', 'success');
                        setTimeout(() => location.reload(), 1500);
                    }
                });
            }
            
            // Close button in acts panel
            const actsPanel = document.getElementById('actsPanel');
            if (actsPanel) {
                const closeBtn = actsPanel.querySelector('button[title*="Ukryj"]');
                if (closeBtn) closeBtn.addEventListener('click', toggleActsPanel);
                
                // Act control buttons
                const addActBtn = actsPanel.querySelector('button[title*="Dodaj nowy akt"]');
                if (addActBtn) addActBtn.addEventListener('click', () => showAdvancedActModal());
                
                const removeActBtn = actsPanel.querySelector('button[title*="Usuń wybrany akt"]');
                if (removeActBtn) removeActBtn.addEventListener('click', () => {
                    if (app.currentActNum) {
                        deleteCurrentRecord();
                    } else {
                        notify('Najpierw wybierz akt do usunięcia', 'error');
                    }
                });
                
                const removeAllBtn = actsPanel.querySelector('button[title*="Usuń wszystkie akty"]');
                if (removeAllBtn) removeAllBtn.addEventListener('click', () => {
                    if (confirm('Czy na pewno chcesz usunąć wszystkie akty z tego obrazu?')) {
                        clearAllActsOnImage();
                    }
                });
            }
            
            document.addEventListener('keydown', (e) => {
                // ⭐ Arrow keys to navigate between acts
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    const currentActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                    if (currentActs.length === 0) return;
                    
                    const currentIdx = currentActs.findIndex(a => a.actNum === app.currentActNum);
                    let nextIdx = currentIdx;
                    
                    if (e.key === 'ArrowLeft') nextIdx = Math.max(0, currentIdx - 1);
                    if (e.key === 'ArrowRight') nextIdx = Math.min(currentActs.length - 1, currentIdx + 1);
                    
                    if (nextIdx !== currentIdx) {
                        selectAct(currentActs[nextIdx].actNum);
                        e.preventDefault();
                    }
                }
                
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'o') { e.preventDefault(); addImages(); }
                    if (e.key === 'r') { e.preventDefault(); toggleROI(); }
                    if (e.key === 'a') { e.preventDefault(); toggleActMode(); }
                    // ⌨️ P0: Ctrl+N = New Record
                    if (e.key === 'n') { 
                        e.preventDefault(); 
                        if (!app.currentImageIdx && app.currentImageIdx !== 0) {
                            notify('❌ Najpierw dodaj obrazy', 'error');
                            return;
                        }
                        showAdvancedActModal();
                        console.log('⌨️ Ctrl+N: New act');
                    }
                    // ⌨️ P0: Ctrl+S = Save Record
                    if (e.key === 's') { 
                        e.preventDefault(); 
                        saveRecord();
                        console.log('⌨️ Ctrl+S: Record saved');
                    }
                    // ⭐ P0: Ctrl+Shift+V = Copy Previous Record
                    if (e.key === 'V' && e.shiftKey) {
                        e.preventDefault();
                        copyPreviousRecord();
                        console.log('⌨️ Ctrl+Shift+V: Copy previous');
                    }
                }
                
                // Otwórz/zamknij duży floating formularz tylko po wciśnięciu Enter (gdy jest wybrany akt)
                // ALE: Jeśli focus jest w input field, nie otwieraj - pozwól wpisać normalnie
                if (e.key === 'Enter' && app.currentActNum && !document.querySelector('input:focus')) {
                    e.preventDefault();
                    toggleFloatingForm();
                }
                
                // ⭐ P0: Escape key - Close pinups / Close floating form
                if (e.key === 'Escape') {
                    const floatingForm = document.getElementById('floatingFormPanel');
                    if (floatingForm?.style.display === 'block') {
                        floatingForm.style.display = 'none';
                        console.log('🔌 Escape: Floating form closed');
                    } else if (app.pinupPositions && Object.keys(app.pinupPositions).length > 0) {
                        clearPinups();
                        console.log('🔌 Escape: All pinups cleared');
                    }
                }
            });
        }
        
        // Table editing listeners
        const dataTable = document.getElementById('dataTable');
        if (dataTable) {
            // Copy selected rows to clipboard (Ctrl+C)
            dataTable.addEventListener('copy', (e) => {
                const selectedRows = document.querySelectorAll('#dataTableBody tr');
                let textToCopy = [];
                
                selectedRows.forEach(row => {
                    if (row.querySelector('.row-checkbox')?.checked) {
                        const cells = row.querySelectorAll('td');
                        const rowData = [];
                        cells.forEach((cell, idx) => {
                            if (idx > 0) { // Skip checkbox
                                rowData.push(cell.textContent.trim());
                            }
                        });
                        textToCopy.push(rowData.join('\t'));
                    }
                });
                
                if (textToCopy.length > 0) {
                    e.preventDefault();
                    e.clipboardData.setData('text/plain', textToCopy.join('\n'));
                    notify(`📋 Skopiowano ${textToCopy.length} wierszy`, 'success');
                }
            });
            
            dataTable.addEventListener('click', (e) => {
                if (e.target.classList.contains('cell-editable')) {
                    const input = document.createElement('input');
                    input.value = e.target.textContent;
                    input.style.width = '100%';
                    e.target.innerHTML = '';
                    e.target.appendChild(input);
                    input.focus();
                    
                    input.addEventListener('blur', () => {
                        const newValue = input.value;
                        e.target.textContent = newValue;
                        
                        // Zapisz do aktu
                        const rowIdx = e.target.parentNode.rowIndex - 1; // -1 dla thead
                        const act = app.imageActs[rowIdx];
                        const cellIdx = e.target.cellIndex - 1; // -1 dla checkbox
                        
                        if (act && act.fieldValues) {
                            // Mapuj indeksy kolumn na fieldValues
                            // 0=checkbox, 1=ID, 2=Akt, 3=Imię dziecka, 4=Nazwisko dziecka, 5=Ojciec imię, 6=Ojciec nazwisko, 7=Matka imię, 8=Matka nazwisko, 9=Lokacja, 10=Uwagi, 11=Opis źródła
                            if (cellIdx === 1) act.id = newValue; // ID
                            else if (cellIdx === 3) act.fieldValues.child_first_name = newValue; // Imię dziecka
                            else if (cellIdx === 4) act.fieldValues.child_last_name = newValue; // Nazwisko dziecka
                            else if (cellIdx === 5) act.fieldValues.father_first_name = newValue; // Ojciec imię
                            else if (cellIdx === 6) act.fieldValues.father_last_name = newValue; // Ojciec nazwisko
                            else if (cellIdx === 7) act.fieldValues.mother_first_name = newValue; // Matka imię
                            else if (cellIdx === 8) act.fieldValues.mother_last_name = newValue; // Matka nazwisko
                            else if (cellIdx === 9) act.fieldValues.location = newValue; // Lokacja
                            else if (cellIdx === 10) act.fieldValues.notes = newValue; // Uwagi
                            else if (cellIdx === 11) act.fieldValues.notes_org = newValue; // Opis źródła
                            
                            // Zapisz do Firestore jeśli dostępny
                            if (window.db && act.id) {
                                db.collection('public_imports').doc(act.id).update(act).catch(err => console.error('❌ Error saving:', err));
                            }
                        }
                        
                        renderRecordsTable(); // Odśwież tabelę
                    });
                }
            });
            
            // Paste listener for table
            dataTable.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = (e.clipboardData || window.clipboardData).getData('text');
                const rows = pastedData.split('\n').map(row => row.split('\t'));
                
                const selectedRow = document.activeElement.closest('tr')?.rowIndex - 1 || 0;
                
                rows.forEach((rowData, i) => {
                    const act = app.imageActs[selectedRow + i];
                    if (act && act.fieldValues) {
                        // 0=ID, 1=Akt, 2=Imię dziecka, 3=Nazwisko dziecka, 4=Ojciec imię, 5=Ojciec nazwisko, 6=Matka imię, 7=Matka nazwisko, 8=Lokacja, 9=Uwagi, 10=Opis źródła
                        if (rowData[0]) act.id = rowData[0];
                        if (rowData[2]) act.fieldValues.child_first_name = rowData[2];
                        if (rowData[3]) act.fieldValues.child_last_name = rowData[3];
                        if (rowData[4]) act.fieldValues.father_first_name = rowData[4];
                        if (rowData[5]) act.fieldValues.father_last_name = rowData[5];
                        if (rowData[6]) act.fieldValues.mother_first_name = rowData[6];
                        if (rowData[7]) act.fieldValues.mother_last_name = rowData[7];
                        if (rowData[8]) act.fieldValues.location = rowData[8];
                        if (rowData[9]) act.fieldValues.notes = rowData[9];
                        if (rowData[10]) act.fieldValues.notes_org = rowData[10];
                        
                        // Zapisz do Firestore
                        if (window.db && act.id) {
                            db.collection('public_imports').doc(act.id).update(act).catch(err => console.error('❌ Error saving:', err));
                        }
                    }
                });
                
                renderRecordsTable();
                notify('📋 Wklejono dane', 'success');
            });
        }
        
        function saveRecord() {
            if (app.currentActNum === null) {
                notify('Zaznacz akt do zapisania', 'error');
                return;
            }
            const act = getCurrentAct();
            if (!act) return;

            const form = document.querySelector(`#form-${app.currentTemplate}`);
            if (!form) return;

            const data = {};
            form.querySelectorAll('.field-input').forEach(input => {
                const value = input.value.trim();
                if (value) {
                    data[input.dataset.field] = value;
                }
            });

            act.fieldValues = data;
            act.timestamp = new Date().toISOString();

            // 🔄 WAŻNE: Regeneruj oba ID jeśli zmienił się rok, nr aktu, woj lub parafia
            // original_id - krótkie ID dla użytkownika: CH.LUB.BLIN.1829.064
            // id - pełne ID dla bazy: CH.LUB.BLIN.1829.00.00064.00
            const year = data.rok || act.year || '1900';
            const nr_aktu = data.nr_aktu || act.nr || 0;
            const woj = data.woj || act.woj || 'LUB';
            const parafia = data.parafia || act.parish || 'UNKNOWN';
            
            // Zawsze regeneruj original_id (to główny ID dla użytkownika)
            act.original_id = `CH.LUB.BLIN.${year}.${String(nr_aktu).padStart(3, '0')}`;
            
            // Regeneruj pełne ID dla bazy
            const fullParish = parafia.substring(0, 6).toUpperCase();
            act.id = `CH.${woj.substring(0, 3).toUpperCase()}.${fullParish}.${year}.00.${String(nr_aktu).padStart(5, '0')}.00`;
            
            console.log('🔄 Updated IDs - original_id:', act.original_id, 'id:', act.id);

            renderActButtons();
            updateRecordCounter();
            redrawROIs();
            saveStorage();

            notify('Akt zapisany', 'success');
        }

        // ⭐ P0: Copy Previous Record - Duplicate values from last record
        function copyPreviousRecord() {
            if (app.currentActNum === null) {
                notify('❌ Zaznacz akt najpierw', 'error');
                return;
            }
            
            const currentActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
            const currentIdx = currentActs.findIndex(a => a.actNum === app.currentActNum);
            
            if (currentIdx === 0) {
                notify('⚠️ Brak poprzedniego aktu do skopiowania', 'warning');
                return;
            }
            
            const previousAct = currentActs[currentIdx - 1];
            const currentAct = getCurrentAct();
            if (!currentAct) return;
            
            // Copy fieldValues from previous
            currentAct.fieldValues = { ...previousAct.fieldValues };
            
            // Render form with new data
            renderFormSections();
            saveStorage();
            
            notify(`✨ Skopiowano z Aktu ${previousAct.actNum}`, 'success');
            console.log(`📋 COPY: Akt ${app.currentActNum} copied from Akt ${previousAct.actNum}`);
        }

        function deleteCurrentRecord() {
            if (app.currentActNum === null) {
                notify('Brak wybranego aktu do usunięcia', 'error');
                return;
            }

            if (!confirm('Czy na pewno usunąć ten akt? Tej operacji nie można cofnąć.')) {
                return;
            }

            app.imageActs = app.imageActs.filter(a => 
                !(a.imageIdx === app.currentImageIdx && a.actNum === app.currentActNum)
            );

            const remainingActs = app.imageActs
                .filter(a => a.imageIdx === app.currentImageIdx)
                .sort((a, b) => a.actNum - b.actNum);

            remainingActs.forEach((act, idx) => {
                act.actNum = idx + 1;
            });

            app.currentActNum = null;
            clearForm();
            renderActButtons();
            redrawROIs();
            updateRecordCounter();
            saveStorage();

            notify('Akt usunięty', 'success');
        }

        function clearAllActsOnImage() {
            app.imageActs = app.imageActs.filter(a => a.imageIdx !== app.currentImageIdx);
            app.currentActNum = null;
            clearForm();
            renderActsList();
            redrawROIs();
            updateRecordCounter();
            saveStorage();
            notify('Wszystkie akty usunięte z tego obrazu', 'success');
        }

        function updateRecordCounter() {
            const counter = document.getElementById('recordCounter');
            if (!counter) return;

            const totalActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx).length;

            if (app.currentActNum !== null) {
                counter.textContent = `Akt: #${app.currentActNum} / ${totalActs}`;
            } else {
                counter.textContent = totalActs > 0 ? `Akty: ${totalActs}` : 'Brak aktów';
            }
        }

        async function autoGenerateID(actData) {
            // Generuj ID w formacie: TYP.WOJ.PARAFIA.ROK.MIES.NR.SUF
            const typeMap = {
                // New template names (v8.7)
                'christening': 'CH',
                'birth': 'UR',
                'marriage': 'MZ',
                'death': 'ZG',
                // Old Polish names (legacy support)
                'chrzest': 'CH',
                'urodzenie': 'UR',
                'małżeństwo': 'MZ',
                'zgon': 'ZG',
                'indeks': 'IN'
            };
            
            const wójMap = {
                'LUB': 'LUB',
                'MAZ': 'MAZ',
                'WAR': 'WAR',
                'KUJ': 'KUJ',
                'POD': 'POD',
                'MAL': 'MAL',
                'SLA': 'SLA',
                'POM': 'POM',
                'GDA': 'GDA'
            };
            
            const typ = typeMap[actData.typ] || 'UR';
            const woj = wójMap[actData.woj] || actData.woj.substring(0, 3).toUpperCase();
            const parafia = (actData.parafia || 'NEZNANE').substring(0, 6).toUpperCase();
            
            // Parse rok i miesiąc z data_zgl (format: YYYY-MM-DD)
            // Miesiąc tylko jeśli podany, inaczej 00
            let rok = '1900';
            let mies = '00';
            if (actData.data_zgl) {
                const parts = actData.data_zgl.split('-');
                rok = parts[0] || '1900';
                mies = (parts[1] && parts[1] !== '00') ? parts[1] : '00';
            }
            
            const nr = String(actData.nr_aktu || 0).padStart(5, '0');
            const suf = actData.is_copy ? '01' : '00';
            
            const id = `${typ}.${woj}.${parafia}.${rok}.${mies}.${nr}.${suf}`;
            console.log('📝 Generated ID:', id, 'from:', actData);
            return id;

            /*
            const response = await fetch('https://api.x.ai/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer YOUR_API_KEY' },
                body: JSON.stringify({
                    model: 'grok-beta',
                    messages: [{ role: 'user', content: prompt }]
                })
            });
            const result = await response.json();
            return result.choices[0].message.content.trim();
            */
        }

        function renderActButtons() {
            // Całość funkcjonalności przeniesiona do panelu aktów (renderActsList)
            // Ta funkcja pozostawiona dla kompatybilności, ale nic nie robi
            const oldButtons = document.getElementById('actsContainer');
            if (oldButtons) oldButtons.remove();
        }

        function showActContextMenuPanel(actNum, event, btnElement) {
            // Menu kontekstowe dla konkretnego aktu (prawy klik na przycisku aktu w lewym oknie)
            // Opcje: zmień nazwę, usuń granice, usuń pola, usuń akt
            const existingMenu = document.getElementById('actContextMenu');
            if (existingMenu) existingMenu.remove();

            const menu = document.createElement('div');
            menu.id = 'actContextMenu';
            
            // Pozycja przy przycisku
            const rect = btnElement.getBoundingClientRect();
            menu.style.cssText = `
                position: fixed;
                top: ${rect.bottom + 5}px;
                left: ${rect.left}px;
                background: #2a2a2a;
                border: 1px solid #10b981;
                border-radius: 4px;
                padding: 4px 0;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                min-width: 200px;
            `;

            const options = [
                { label: 'Zmień nazwę aktu', action: () => editActName(actNum), color: '#ddd' },
                { label: 'Usuń granice aktu', action: () => deleteActROIPanel(actNum), color: '#ff9800' },
                { label: 'Usuń pola w akcie', action: () => deleteActFieldsPanel(actNum), color: '#ff9800' },
                { label: 'Usuń akt', action: () => deleteActPanel(actNum), color: '#ff6b6b' }
            ];

            options.forEach((opt, idx) => {
                const item = document.createElement('div');
                item.textContent = opt.label;
                item.style.cssText = `
                    padding: 8px 12px;
                    cursor: pointer;
                    color: ${opt.color};
                    font-size: 12px;
                    transition: background 0.15s;
                    ${idx < options.length - 1 ? 'border-bottom: 1px solid #1a1a1a;' : ''}
                `;
                item.onmouseover = () => item.style.background = 'rgba(255,152,0,0.1)';
                item.onmouseout = () => item.style.background = 'transparent';
                item.onclick = () => {
                    opt.action();
                    menu.remove();
                };
                menu.appendChild(item);
            });

            document.body.appendChild(menu);

            // Zamknij menu przy kliknięciu poza
            const closeMenu = (e) => {
                if (!menu.contains(e.target) && e.target !== btnElement) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 10);
        }

        function deleteActROIPanel(actNum) {
            const act = app.imageActs.find(a => a.actNum === actNum && a.imageIdx === app.currentImageIdx);
            if (act) {
                act.actROI = null;
                redrawROIs();
                saveStorage();
                renderActsList();
                notify('Granice aktu usunięte', 'success');
            }
        }

        function deleteActFieldsPanel(actNum) {
            const act = app.imageActs.find(a => a.actNum === actNum && a.imageIdx === app.currentImageIdx);
            if (act) {
                act.fieldROIs = {};
                redrawROIs();
                saveStorage();
                renderActsList();
                notify('Pola w akcie usunięte', 'success');
            }
        }

        function deleteActPanel(actNum) {
            if (!confirm('Czy na pewno usunąć akt? Ta operacja nie może być cofnięta.')) return;
            app.imageActs = app.imageActs.filter(a => a.actNum !== actNum);
            renderActsList();
            redrawROIs();
            saveStorage();
            notify('Akt usunięty', 'success');
        }

        function editActName(actNum) {
            const act = app.imageActs.find(a => a.actNum === actNum && a.imageIdx === app.currentImageIdx);
            if (!act) return;
            
            const currentName = formatActDisplayName(act);
            const newName = prompt('Zmień nazwę aktu:\n(format: TYP.ROK.N͞o.NR np. CH.1908.N͞o.60)', currentName);
            
            if (newName && newName.trim()) {
                // Jeśli to jest pełny ID w formacie CH.LUB.BLIN.1908.05.00060.00
                if (newName.includes('.') && newName.split('.').length >= 6) {
                    act.id = newName;
                } else {
                    // Jeśli to tylko skrócona nazwa, zastąp ostatnie części ID
                    const parts = act.id.split('.');
                    if (parts.length >= 6) {
                        // Parse nowej nazwy
                        const newParts = newName.split('.');
                        if (newParts.length >= 3) {
                            // CH.1908.N͞o.60 -> CH.LUB.BLIN.1908.05.00060.00
                            const typ = newParts[0];
                            const rok = newParts[1];
                            const nr = newParts[newParts.length - 1].padStart(5, '0');
                            parts[0] = typ;
                            parts[3] = rok;
                            parts[5] = nr;
                            act.id = parts.join('.');
                        }
                    }
                }
                saveStorage();
                renderActsList();
                notify('✅ Nazwa aktu zmieniona', 'success');
            }
        }

        function getCurrentAct() {
            if (app.currentActNum === null) return null;
            return app.imageActs.find(a => 
                a.imageIdx === app.currentImageIdx && a.actNum === app.currentActNum
            );
        }

        function selectAct(actNum) {
            const act = app.imageActs.find(a => 
                a.imageIdx === app.currentImageIdx && a.actNum === actNum
            );

            if (!act) {
                notify('Akt nie istnieje', 'error');
                return;
            }

            clearPinups();
            app.currentActNum = actNum;
            // loadActToForm(act);  // ❌ DEPRECATED - renderFormSections renderuje dynamicznie
            renderFormSections();  // Renderuj formularz w prawym panelu
            renderActButtons();
            updateRecordCounter();
            redrawROIs();

            if (act.actROI) {
                zoomToAct(act.actROI);
            }
            
            // Automatycznie otwórz pin-upy dla wszystkich pól z ROI w tym akcie
            if (act.fieldROIs && Object.keys(act.fieldROIs).length > 0) {
                setTimeout(() => {
                    Object.keys(act.fieldROIs).forEach(fieldId => {
                        createPinupForField(fieldId);
                    });
                }, 300);
            }
            
            // 🎯 NOWE: Jeśli akt ma image_path i obraz nie jest załadowany, załaduj go automatycznie
            if (act.image_path && app.images && app.images.length > 0) {
                const matchingImageIdx = app.images.findIndex(img => 
                    (img.relativePath === act.image_path || img.name === act.image_path) ||
                    (img.relativePath && img.relativePath.endsWith(act.image_path)) ||
                    (img.name && img.name.includes(act.image_path))
                );
                
                if (matchingImageIdx !== -1 && matchingImageIdx !== app.currentImageIdx) {
                    console.log(`[Auto-Load] Ładuję obraz ${act.image_path} do aktu ${act.id}`);
                    selectImage(matchingImageIdx, true);  // true = autoSelect, nie otwieraj modalu
                }
            }
            
            // E: Auto-focus pierwszy input w formularzu
            focusFirstField();
        }

        function loadActToForm(act) {
            clearForm();
            const form = document.querySelector(`#form-${app.currentTemplate}`);
            if (!form) return;

            form.querySelectorAll('.field-input').forEach(input => {
                const fieldId = input.dataset.field;
                const value = act.fieldValues[fieldId] || '';
                input.value = value;

                if (act.fieldROIs && act.fieldROIs[fieldId]) {
                    input.classList.add('has-roi');
                } else {
                    input.classList.remove('has-roi');
                }
            });
            
            updateFieldStatus();  // 🟢 Update colors when loading record
            updateProgressBar();  // ⭐ Update progress when loading record
            
            // ⭐ Auto-zoom to act ROI if exists
            if (act.actROI) {
                setTimeout(() => zoomToROI(act.actROI), 100);
            }
            
            // ⭐ Auto-focus first field
            const formEl = document.querySelector(`#form-${app.currentTemplate}`);
            const firstInput = formEl?.querySelector('.field-input');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 150);
                console.log('🎯 Auto-focus: first field focused');
            }
            
            // ⭐ Show summary notification
            const filledFields = Object.keys(act.fieldValues).length;
            const totalFields = formEl?.querySelectorAll('.field-input').length || 0;
            const roiCount = Object.keys(act.fieldROIs || {}).length;
            notify(`📋 Akt ${act.actNum} | ${filledFields}/${totalFields} pól | ${roiCount} ROI`, 'info');
        }

        function clearForm() {
            const activeForm = document.querySelector('.form-section.active');
            if (activeForm) {
                activeForm.querySelectorAll('.field-input').forEach(input => {
                    input.value = '';
                    input.classList.remove('has-roi');
                });
            }
            updateFieldStatus();  // 🟢 Update colors when clearing form
            updateProgressBar();  // ⭐ Update progress when clearing form
        }

        function showAdvancedActModal() {
            const modal = document.getElementById('advancedActModal');
            if (!modal) return;

            // Ładuj pamiętane wartości z localStorage
            const prevData = JSON.parse(localStorage.getItem('lastActSettings')) || {};
            document.getElementById('modalYear').value = prevData.year || new Date().getFullYear() - 100;
            document.getElementById('modalParish').value = prevData.parish || 'Brak';
            document.getElementById('modalWoj').value = prevData.woj || 'LUB';
            document.getElementById('modalType').value = prevData.type || 'christening';
            
            // Szukaj ostatniego aktu z POPRZEDNIEGO obrazu
            const prevActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx - 1).sort((a,b) => (a.nr || 0) - (b.nr || 0)) || [];
            const lastPrevNr = prevActs.length > 0 ? prevActs[prevActs.length - 1].nr || 0 : 0;
            const hasPrev = prevActs.length > 0;
            const defaultFirst = hasPrev ? lastPrevNr + 1 : 1;
            const defaultLast = defaultFirst + (prevActs.length || 10) - 1;

            document.getElementById('modalFirstNr').value = defaultFirst;
            document.getElementById('modalLastNr').value = defaultLast;
            document.getElementById('modalIncomplete').checked = !!prevData.incomplete;
            document.getElementById('modalPlusIndex').checked = !!prevData.plusIndex;

            modal.style.display = 'flex';
            
            // Uczynij modal przesuwnym
            const modalContent = document.getElementById('advancedActModalContent');
            makeElementDraggable(modalContent);

            document.getElementById('modalOK').onclick = async () => {
                const data = {
                    year: parseInt(document.getElementById('modalYear').value),
                    parish: document.getElementById('modalParish').value,
                    woj: document.getElementById('modalWoj').value,
                    type: document.getElementById('modalType').value,
                    firstNr: parseInt(document.getElementById('modalFirstNr').value),
                    lastNr: parseInt(document.getElementById('modalLastNr').value),
                    incomplete: document.getElementById('modalIncomplete').checked,
                    plusIndex: document.getElementById('modalPlusIndex').checked
                };
                localStorage.setItem('lastActSettings', JSON.stringify(data));

                const count = data.lastNr - data.firstNr + 1;
                const newActs = [];
                for (let i = 0; i < count; i++) {
                    const act = {
                        imageIdx: app.currentImageIdx,
                        actNum: i + 1, // actNum to numer aktu na stronie, nie globalny nr
                        nr: data.firstNr + i, // Globalny nr aktu
                        year: data.year,
                        parish: data.parish,
                        woj: data.woj,
                        type: data.type,
                        fieldValues: {},
                        fieldROIs: {},
                        actROI: null,
                        timestamp: new Date().toISOString()
                    };
                    if (data.plusIndex) act.index = ''; // Dodaj pole indeksu
                    if (i === count - 1 && data.incomplete) act.incomplete = true; // Flag
                    newActs.push(act);
                }

                // Generate IDs asynchronously
                for (const act of newActs) {
                    const actData = {
                        typ: act.type,
                        woj: act.woj,
                        parafia: act.parish,
                        data_zgl: `${act.year}-00-01`,
                        nr_aktu: act.nr,
                        is_copy: false
                    };
                    act.id = await autoGenerateID(actData);
                }

                app.imageActs.push(...newActs);

                saveStorage();
                renderActsList();
                renderRecordsTable();
                selectAct(1);
                updateRecordCounter();
                notify(`Utworzono ${count} aktów`, 'success');
                modal.style.display = 'none';
            };

            document.getElementById('modalCopyPrev').onclick = async () => {
                // Przelicz aktów z poprzedniego obrazu - mogły się zmienić!
                console.log('📋 copyPrev: currentImageIdx =', app.currentImageIdx, 'looking for imageIdx =', app.currentImageIdx - 1);
                const freshPrevActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx - 1).sort((a,b) => (a.nr || 0) - (b.nr || 0)) || [];
                console.log('📋 Found freshPrevActs:', freshPrevActs.length, 'acts with nr:', freshPrevActs.map(a => a.nr));
                if (freshPrevActs.length === 0) {
                    notify('Brak aktów na poprzedniej stronie', 'error');
                    return;
                }
                const freshLastPrevNr = freshPrevActs.length > 0 ? freshPrevActs[freshPrevActs.length - 1].nr || 0 : 0;
                console.log('📋 lastPrevNr =', freshLastPrevNr);
                
                const data = {
                    year: parseInt(document.getElementById('modalYear').value),
                    parish: document.getElementById('modalParish').value,
                    woj: document.getElementById('modalWoj').value,
                    type: document.getElementById('modalType').value,
                    incomplete: document.getElementById('modalIncomplete').checked,
                    plusIndex: document.getElementById('modalPlusIndex').checked
                };
                console.log('📋 copyPrev: kopiowanie poprzedniej strony');
                localStorage.setItem('lastActSettings', JSON.stringify(data));

                const lastPrevAct = freshPrevActs[freshPrevActs.length - 1]; // Bierz dane TYLKO z ostatniego aktu
                const copiedActs = [];
                freshPrevActs.forEach((prevAct, index) => {
                    const act = {
                        imageIdx: app.currentImageIdx,
                        actNum: index + 1,
                        nr: prevAct.nr, // KOPIUJ dokładny nr z poprzedniej strony!
                        year: data.year,
                        parish: data.parish,
                        woj: data.woj,
                        type: data.type,
                        fieldValues: JSON.parse(JSON.stringify(lastPrevAct.fieldValues)), // Dane TYLKO z ostatniego aktu!
                        fieldROIs: JSON.parse(JSON.stringify(lastPrevAct.fieldROIs)), // ROI TYLKO z ostatniego aktu!
                        actROI: lastPrevAct.actROI ? JSON.parse(JSON.stringify(lastPrevAct.actROI)) : null,
                        timestamp: new Date().toISOString()
                    };
                    if (data.plusIndex) act.index = lastPrevAct.index || '';
                    if (index === freshPrevActs.length - 1 && data.incomplete) act.incomplete = true;
                    copiedActs.push(act);
                });

                // Generate IDs asynchronously
                for (const act of copiedActs) {
                    const actData = {
                        typ: act.type,
                        woj: act.woj,
                        parafia: act.parish,
                        data_zgl: `${act.year}-00-01`,
                        nr_aktu: act.nr,
                        is_copy: false
                    };
                    act.id = await autoGenerateID(actData);
                }

                app.imageActs.push(...copiedActs);

                saveStorage();
                renderActsList();
                selectAct(1);
                updateRecordCounter();
                notify(`Skopiowano ${freshPrevActs.length} aktów z poprzedniej strony`, 'success');
                modal.style.display = 'none';
            };

            document.getElementById('modalCancel').onclick = () => modal.style.display = 'none';
        }

        // 🆕 UNDO/REDO SYSTEM =============================================================
        // Zapamiętaj stan przed zmianą (snapshot aktów)
        function pushUndoState(description = 'Zmiana') {
            // Zrób kopię aktualnego stanu imageActs
            const snapshot = JSON.parse(JSON.stringify(app.imageActs));
            app.undoStack.push({ snapshot, description });
            app.redoStack = [];  // Wyczyść redo stack gdy dokonasz nowej akcji
            console.log(`📸 Snapshot dodany: ${description} (${app.undoStack.length} w historii)`);
            updateUndoRedoButtons();
        }

        // Cofnij do poprzedniego stanu
        function undo() {
            if (app.undoStack.length === 0) {
                notify('⚠️ Nie ma czego cofać', 'warning');
                return;
            }

            // Zapamiętaj obecny stan w redo
            app.redoStack.push({ snapshot: JSON.parse(JSON.stringify(app.imageActs)), description: 'Przywracane' });

            // Przywróć poprzedni stan
            const previousState = app.undoStack.pop();
            app.imageActs = previousState.snapshot;

            console.log(`⏮️ Cofnięto: ${previousState.description}`);
            
            // Odśwież UI
            saveStorage();
            saveChangesToSupabase();  // 🆕 Wysyłaj zmiany do Supabase
            renderRecordsTable();
            renderActsList();
            updateUndoRedoButtons();
            notify(`⏮️ Cofnięto: ${previousState.description}`, 'info');
        }

        // Przywróć (redo)
        function redo() {
            if (app.redoStack.length === 0) {
                notify('⚠️ Nie ma czego przywracać', 'warning');
                return;
            }

            // Zapamiętaj obecny stan w undo
            app.undoStack.push({ snapshot: JSON.parse(JSON.stringify(app.imageActs)), description: 'Cofnięte' });

            // Przywróć stanu z redo
            const nextState = app.redoStack.pop();
            app.imageActs = nextState.snapshot;

            console.log(`⏭️ Przywrócono: ${nextState.description}`);
            
            // Odśwież UI
            saveStorage();
            saveChangesToSupabase();  // 🆕 Wysyłaj zmiany do Supabase
            renderRecordsTable();
            renderActsList();
            updateUndoRedoButtons();
            notify(`⏭️ Przywrócono`, 'info');
        }

        // Ustaw stan buttonów UNDO/REDO (enabled/disabled)
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (undoBtn) undoBtn.disabled = app.undoStack.length === 0;
            if (redoBtn) redoBtn.disabled = app.redoStack.length === 0;
        }

        // 🆕 NOWY MODAL: Przypisanie aktów z bazy do obrazu
        function showAssignActsModal(imageIdx) {
            const modal = document.getElementById('assignActsModal');
            if (!modal) {
                console.error('❌ assignActsModal not found!');
                return;
            }

            // Pobierz informacje o obrazie
            const imageName = app.images[imageIdx]?.name || `Obraz ${imageIdx}`;
            document.getElementById('assignActsImageName').textContent = imageName;

            // Policz ile aktów bez imageIdx jest dostępnych
            const unassignedActs = app.imageActs.filter(a => a.imageIdx === null || a.imageIdx === undefined);
            document.getElementById('assignActsCount').textContent = unassignedActs.length;

            // Ustaw domyślne wartości od-do
            const firstAssignedNum = unassignedActs.length > 0 
                ? (unassignedActs[0].nr || unassignedActs[0].christening_act_number || 1)
                : 1;
            const lastAssignedNum = unassignedActs.length > 0
                ? (unassignedActs[unassignedActs.length - 1].nr || unassignedActs[unassignedActs.length - 1].christening_act_number || unassignedActs.length)
                : Math.min(10, unassignedActs.length);

            const assignFromInput = document.getElementById('assignActsFrom');
            const assignToInput = document.getElementById('assignActsTo');
            
            assignFromInput.value = firstAssignedNum;
            assignToInput.value = lastAssignedNum;

            // Aktualizuj licznik zakresu
            function updateRange() {
                const from = parseInt(assignFromInput.value) || 1;
                const to = parseInt(assignToInput.value) || 10;
                const count = Math.max(0, to - from + 1);
                document.getElementById('assignActsRange').textContent = count;
            }
            updateRange();

            // Usuń poprzednie event listenery (aby nie kumulować)
            assignFromInput.replaceWith(assignFromInput.cloneNode(true));
            assignToInput.replaceWith(assignToInput.cloneNode(true));
            
            const newAssignFromInput = document.getElementById('assignActsFrom');
            const newAssignToInput = document.getElementById('assignActsTo');

            newAssignFromInput.addEventListener('change', updateRange);
            newAssignFromInput.addEventListener('input', updateRange);
            newAssignToInput.addEventListener('change', updateRange);
            newAssignToInput.addEventListener('input', updateRange);

            // Obsługa przycisków
            const assignOkBtn = document.getElementById('assignActsOK');
            const assignCancelBtn = document.getElementById('assignActsCancel');
            
            // Usuń poprzednie event listenery
            const newOkBtn = assignOkBtn.cloneNode(true);
            const newCancelBtn = assignCancelBtn.cloneNode(true);
            assignOkBtn.replaceWith(newOkBtn);
            assignCancelBtn.replaceWith(newCancelBtn);
            
            const finalOkBtn = document.getElementById('assignActsOK');
            const finalCancelBtn = document.getElementById('assignActsCancel');
            const finalFromInput = document.getElementById('assignActsFrom');
            const finalToInput = document.getElementById('assignActsTo');
            
            finalOkBtn.onclick = () => {
                const from = parseInt(finalFromInput.value);
                const to = parseInt(finalToInput.value);

                if (isNaN(from) || isNaN(to) || from > to) {
                    notify('⚠️ Proszę wpisać prawidłowy zakres numerów', 'error');
                    return;
                }

                // 🆕 Zapamiętaj stan PRZED przypisaniem (dla undo)
                pushUndoState(`Przypisanie aktów ${from}-${to} do ${imageName}`);

                // Przypisz imageIdx do wszystkich aktów w zakresie nr-u
                let assignedCount = 0;
                const imagePath = app.images[imageIdx]?.name || '';  // 🆕 Pobierz nazwę obrazu
                const assignedMainNumbers = new Set();  // Śledź które numery już przypisaliśmy
                
                // PIERWSZA PĘTLA: Przypisz główne numery
                app.imageActs.forEach(act => {
                    const actNr = act.nr || act.christening_act_number || 0;
                    if ((act.imageIdx === null || act.imageIdx === undefined) && actNr >= from && actNr <= to) {
                        act.imageIdx = imageIdx;
                        act.image_path = imagePath;  // 🆕 Ustaw ścieżkę obrazu
                        assignedMainNumbers.add(actNr);  // Pamiętaj że przypisaliśmy ten numer
                        assignedCount++;
                        console.log(`✅ Przypisano akt #${actNr} do obrazu ${imageIdx}: ${imageName}`);
                    }
                });

                // 🆕 DRUGA PĘTLA: Przypisz warianty (17A, 17B, 17C itd.) dla przypisanych głównych numerów
                app.imageActs.forEach(act => {
                    const actNr = act.nr || act.christening_act_number || 0;
                    // Sprawdź czy to wariant: np. 17A, 17B itd. (liczba + litera)
                    const match = String(actNr).match(/^(\d+)([A-Za-z]+)$/);
                    if (match) {
                        const baseNum = parseInt(match[1]);
                        const suffix = match[2];
                        // Jeśli główny numer (17) został przypisany - przypisz też wariant (17A, 17B itd.)
                        if (assignedMainNumbers.has(baseNum) && (act.imageIdx === null || act.imageIdx === undefined)) {
                            act.imageIdx = imageIdx;
                            act.image_path = imagePath;
                            assignedCount++;
                            console.log(`✅ Przypisano wariant akt #${actNr} (do-${baseNum}) do obrazu ${imageIdx}: ${imageName}`);
                        }
                    }
                });

                if (assignedCount > 0) {
                    saveStorage();
                    saveChangesToSupabase();  // 🆕 Wysyłaj zmiany do Supabase automatycznie
                    renderRecordsTable();  // Odśwież tabelę
                    renderActsList();  // Odśwież listę aktów
                    updateUndoRedoButtons();  // Odśwież stany buttonów undo/redo
                    notify(`✅ Przypisano ${assignedCount} aktów (+ warianty) do obrazu`, 'success');
                    console.log(`📊 Total assigned: ${assignedCount} acts to image ${imageIdx}`);
                } else {
                    notify('⚠️ Brak aktów do przypisania w tym zakresie', 'warning');
                }

                modal.style.display = 'none';
            };

            finalCancelBtn.onclick = () => modal.style.display = 'none';

            // Uczynij modal przesuwnym
            const modalContent = document.getElementById('assignActsModalContent');
            makeElementDraggable(modalContent);

            modal.style.display = 'flex';
        }

        function createActsForImage() {
            const firstNr = parseInt(document.getElementById('modalFirstNr')?.value) || 1;
            const lastNr = parseInt(document.getElementById('modalLastNr')?.value) || 10;
            const count = Math.max(1, lastNr - firstNr + 1);
            const typeSelect = document.getElementById('modalType');
            const type = typeSelect?.value?.toLowerCase() || 'christening';
            const year = parseInt(document.getElementById('modalYear')?.value) || new Date().getFullYear();
            const parish = document.getElementById('modalParish')?.value || '';

            closeActModal();

            // Sprawdź ile aktów już istnieje dla tego obrazu
            const existingActsForImage = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
            const startActNum = existingActsForImage.length > 0 
                ? Math.max(...existingActsForImage.map(a => a.actNum)) + 1 
                : 1;

            for (let i = 0; i < count; i++) {
                const actNumber = firstNr + i;
                const actNum = startActNum + i;  // Numeracja sekwencyjna dla tego obrazu
                
                // Generuj DWA rodzaje ID:
                // 1. original_id - KRÓTKI, dla użytkownika: CH.LUB.BLIN.1829.064
                const original_id = `CH.LUB.BLIN.${year}.${actNumber.toString().padStart(3, '0')}`;
                
                // 2. id - PEŁNY, dla bazy (Supabase): CH.LUB.BLINÓW.1829.00.00064.00
                const fullParish = (parish || 'UNKNOWN').substring(0, 6).toUpperCase();
                const id = `CH.LUB.${fullParish}.${year}.00.${actNumber.toString().padStart(5, '0')}.00`;
                
                const act = {
                    imageIdx: app.currentImageIdx,
                    actNum: actNum,  // ⭐ Uniwersalna numeracja dla tego obrazu
                    type: type,
                    year: year,
                    parish: parish,
                    nr: actNumber,
                    original_id: original_id,  // ← Główny ID dla użytkownika (widoczny w tabeli)
                    id: id,  // ← Wewnętrzny ID dla bazy (niewidoczny w tabeli)
                    fieldValues: {},
                    fieldROIs: {},
                    actROI: null,
                    timestamp: new Date().toISOString()
                };
                app.imageActs.push(act);
            }

            saveStorage();
            renderActButtons();
            renderFormSections();  // Odśwież prawy panel - listę aktów
            selectAct(1);
            updateRecordCounter();
            notify(`Utworzono ${count} aktów`, 'success');
        }

        // ===== NOWE: Wyszukiwanie aktów pasujących do obrazu =====
        function searchActsForImage(imageIdx, type, year, parish) {
            // Szukaj w app.imageActs aktów pasujących do type/year/parish
            // Które jeszcze nie mają przypisanego obrazu
            if (!type || year === 0) return [];
            
            return app.imageActs.filter(act => 
                act.type && act.type.toLowerCase() === type.toLowerCase() &&
                act.year === year &&
                act.parish === parish &&
                (act.imageIdx === undefined || act.imageIdx === null)
            );
        }

        // ===== NOWE: Załaduj obraz i szukaj pasujących aktów =====
        function loadImageAndSearchActs(imageIdx) {
            if (imageIdx < 0 || imageIdx >= app.images.length) return;

            // Pobierz dane z kontrolek modala (jeśli są widoczne)
            const typeVal = document.getElementById('modalType')?.value?.toLowerCase() || '';
            const yearVal = parseInt(document.getElementById('modalYear')?.value) || 0;
            const parishVal = document.getElementById('modalParish')?.value || '';

            if (typeVal && yearVal > 0 && parishVal) {
                // Szukaj pasujących aktów w bazie
                const matchingActs = searchActsForImage(imageIdx, typeVal, yearVal, parishVal);
                
                // Powiąż znalezione akty z tym obrazem
                if (matchingActs.length > 0) {
                    matchingActs.forEach((act, idx) => {
                        act.imageIdx = imageIdx;
                        // 🔧 FIX: NIE zmieniaj actNum! To unikalny ID aktu z bazy danych!
                        // act.actNum = idx + 1;  // ❌ USUNIĘTE - psuje powiązanie z bazą
                    });
                    console.log(`✅ Znaleziono ${matchingActs.length} aktów pasujących do obrazu ${imageIdx}`);
                    notify(`Załadowano ${matchingActs.length} aktów z bazy`, 'success');
                    saveStorage();
                }
            }
        }

        function exportData(type = 'full') {
            if (app.imageActs.length === 0) {
                notify('Brak aktów do eksportu', 'error');
                return;
            }

            const csv = generateCSV(type);
            const json = JSON.stringify(app.imageActs, null, 2);

            const suffix = type === 'full' ? '_z_ROI' : '_prosty';
            downloadFile(csv, `akty${suffix}.csv`, 'text/csv');
            downloadFile(json, 'akty.json', 'application/json');

            notify(`Eksportowano ${app.imageActs.length} aktów`, 'success');
        }

        function generateCSV(type = 'full') {
            let lines = [];
            const headers = ['Obraz', 'Akt', 'Typ', 'Data utworzenia'];
            const allFields = new Set();

            app.templates.forEach(t => {
                t.sections?.forEach(s => {
                    s.fields.forEach(f => allFields.add(f.label));
                });
            });

            allFields.forEach(label => {
                headers.push(label);
                if (type === 'full') {
                    headers.push(`ROI_${label}_X`);
                    headers.push(`ROI_${label}_Y`);
                    headers.push(`ROI_${label}_W`);
                    headers.push(`ROI_${label}_H`);
                }
            });

            if (type === 'full') {
                headers.push('Act_ROI_X', 'Act_ROI_Y', 'Act_ROI_W', 'Act_ROI_H');
            }

            lines.push(headers.join(','));

            app.imageActs.forEach(act => {
                const image = app.images[act.imageIdx];
                const imageName = image?.name || 'Nieznany';

                const row = [
                    imageName,
                    act.actNum,
                    app.currentTemplate,
                    new Date(act.timestamp).toLocaleString('pl-PL')
                ];

                allFields.forEach(label => {
                    const fieldId = [...app.templates.find(t => t.id === app.currentTemplate)?.sections || []]
                        .flatMap(s => s.fields)
                        .find(f => f.label === label)?.id || '';

                    const value = act.fieldValues[fieldId] || '';
                    row.push(value);

                    if (type === 'full') {
                        const roi = act.fieldROIs[fieldId];
                        row.push(roi?.x || '');
                        row.push(roi?.y || '');
                        row.push(roi?.w || '');
                        row.push(roi?.h || '');
                    }
                });

                if (type === 'full') {
                    const actROI = act.actROI;
                    row.push(actROI?.x || '');
                    row.push(actROI?.y || '');
                    row.push(actROI?.w || '');
                    row.push(actROI?.h || '');
                }

                lines.push(row.map(cell => `"${(cell + '').replace(/"/g, '""')}"`).join(','));
            });

            return '\uFEFF' + lines.join('\n');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type + ';charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function renderUI() {
            renderFormSections();
            renderActButtons();
            updateRecordCounter();
        }

        function selectImage(idx, autoSelect = false) {
            const perfStart = performance.now();
            console.log('🖼️ selectImage called with idx:', idx);
            if (idx < 0 || idx >= app.images.length) {
                console.log('❌ Invalid image index:', idx, 'max:', app.images.length);
                return;
            }

            app.currentImageIdx = idx;
            app.currentActNum = null;
            app.tablePageIndex = 0;  // 🔄 Resetuj stronę tablicy przy zmianie obrazu
            console.log('✅ Set currentImageIdx to:', idx);

            updateThumbs();
            updateImageCounter();
            renderActsList(); // Update acts panel when image changes
            // renderRecordsTable();  // 🔇 ZAKOMENTOWANE - renderowanie tabeli tylko po kliknięciu aktu, nie przy zmiane obrazu

            const actsOnImage = app.imageActs.filter(a => a.imageIdx === idx);

            if (!autoSelect && actsOnImage.length === 0) {
                const unassignedActs = app.imageActs.filter(a => a.imageIdx === null || a.imageIdx === undefined);
                if (unassignedActs.length > 0) {
                    // Są akty z bazy bez imageIdx - pokaż modal do przypisania zakresu
                    console.log(`📋 ${unassignedActs.length} unassigned acts found, showing assignment modal`);
                    showAssignActsModal(idx);  // 🆕 Nowy modal do przypisywania aktów z bazy
                } else {
                    // Brak aktów bez imageIdx - pokaż modal do tworzenia nowych
                    console.log('📋 No unassigned acts, showing create new acts modal');
                    showAdvancedActModal();
                }
            } else if (actsOnImage.length > 0) {
                selectAct(actsOnImage[0].actNum);
            }

            if (app.images[idx]) {
                const imageData = app.images[idx].data;
                console.log('📸 Opening image:', app.images[idx].name);
                console.log('📊 Image data length:', imageData ? imageData.length : 'null');
                
                // 🔧 NAPRAWIONO: Data URL nie działa z OpenSeadragon - używamy fallback'a (zwykły img element)
                const imageFallback = document.getElementById('imageFallback');
                if (!imageFallback) {
                    console.error('❌ imageFallback element not found!');
                } else if (imageData) {
                    imageFallback.src = imageData; // Data URL
                    imageFallback.classList.add('active');
                    console.log('✅ Image loaded via fallback img element');
                } else {
                    console.error('❌ No image data to display');
                }
                
                // Spróbuj również załadować do OSD (jeśli by URL był dostępny)
                if (app.viewer && app.images[idx].url) {
                    app.viewer.open({
                        type: 'image',
                        url: app.images[idx].url
                    });
                    console.log('✅ Image loaded in OSD');
                }

                // 🔧 NOWE: Zaktualizuj image_path dla WSZYSTKICH aktów na tym obrazie
                // (aby gdy klikniesz akt w tabeli, automatycznie ustawił się image_path)
                const imagePath = app.images[idx].relativePath || app.images[idx].name;
                if (imagePath) {
                    const actsOnImage = app.imageActs.filter(a => a.imageIdx === idx);
                    actsOnImage.forEach(act => {
                        if (!act.image_path) {  // Tylko jeśli nie ma już image_path
                            act.image_path = imagePath;
                            console.log(`📁 Ustawiłem image_path dla aktu ${act.id}: ${imagePath}`);
                        }
                    });
                }
            } else {
                console.log('❌ No image data at index:', idx);
            }

            redrawROIs();
            
            const perfDuration = (performance.now() - perfStart).toFixed(2);
            if (perfDuration > 1000) {
                console.warn(`⏱️ selectImage: ${perfDuration}ms (SLOW!)`);
            } else {
                console.log(`⏱️ selectImage: ${perfDuration}ms`);
            }
        }

        // function toggleROI() {
        //     app.roiMode = !app.roiMode;
        //     document.getElementById('actBtn').classList.toggle('active', app.roiMode);
        //     if (app.updateCanvasInteraction) app.updateCanvasInteraction();
        // }

        function toggleActMode() {
            app.actMode = !app.actMode;
            document.getElementById('roiBtn').classList.toggle('active', app.actMode);
            if (app.updateCanvasInteraction) app.updateCanvasInteraction();
        }

        function toggleActBoundaries() {
            app.showActBoundaries = !app.showActBoundaries;
            const btn = document.getElementById('toggleBoundariesBtn');
            if (btn) {
                btn.classList.toggle('disabled', !app.showActBoundaries);
            }
            // Natychmiastowo zmień widoczność wszystkich granic aktów
            document.querySelectorAll('.act-overlay').forEach(el => {
                el.style.display = app.showActBoundaries ? 'block' : 'none';
            });
        }

        // CONTEXT MENU - Menu kontekstowe dla aktów i obrazów
        let contextMenuState = {
            actNum: null,
            x: 0,
            y: 0
        };

        function showActContextMenu(actNum, x, y) {
            contextMenuState.actNum = actNum;
            contextMenuState.x = x;
            contextMenuState.y = y;
            const menu = document.getElementById('actContextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }

        function showImageContextMenu(x, y) {
            contextMenuState.actNum = null;
            contextMenuState.x = x;
            contextMenuState.y = y;
            const menu = document.getElementById('imageContextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }

        function hideContextMenus() {
            document.getElementById('actContextMenu').classList.remove('active');
            document.getElementById('imageContextMenu').classList.remove('active');
        }

        function deleteActROI() {
            if (contextMenuState.actNum === null) return;
            const act = app.imageActs.find(a => a.actNum === contextMenuState.actNum);
            if (act) {
                act.actROI = null;
                redrawROIs();
                saveStorage();
                notify('Granice aktu usunięte', 'success');
            }
            hideContextMenus();
        }

        function deleteActFields() {
            if (contextMenuState.actNum === null) return;
            const act = app.imageActs.find(a => a.actNum === contextMenuState.actNum);
            if (act) {
                act.fieldROIs = {};
                redrawROIs();
                saveStorage();
                notify('Pola w akcie usunięte', 'success');
            }
            hideContextMenus();
        }

        function deleteAct() {
            if (contextMenuState.actNum === null) return;
            if (!confirm('Czy na pewno usunąć akt? Ta operacja nie może być cofnięta.')) {
                hideContextMenus();
                return;
            }
            app.imageActs = app.imageActs.filter(a => a.actNum !== contextMenuState.actNum);
            renderActButtons();
            redrawROIs();
            saveStorage();
            notify('Akt usunięty', 'success');
            hideContextMenus();
        }

        function deleteAllActsOnImage() {
            if (!confirm('Czy na pewno usunąć WSZYSTKIE akty na tym obrazie? Ta operacja nie może być cofnięta.')) {
                hideContextMenus();
                return;
            }
            app.imageActs = app.imageActs.filter(a => a.imageIdx !== app.currentImageIdx);
            renderActButtons();
            redrawROIs();
            saveStorage();
            notify('Wszystkie akty na obrazie usunięte', 'success');
            hideContextMenus();
        }

        function deleteAllROIsOnImage() {
            const acts = app.imageActs.filter(act => act.imageIdx === app.currentImageIdx);
            acts.forEach(act => {
                act.actROI = null;
                act.fieldROIs = {};
            });
            redrawROIs();
            saveStorage();
            notify('Wszystkie granice na obrazie usunięte', 'success');
            hideContextMenus();
        }

        function setupContextMenuHandlers() {
            // Ukryj menu przy kliknieciu poza
            document.addEventListener('click', hideContextMenus);
            document.addEventListener('contextmenu', (e) => {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenus();
                }
            });
            
            // Handlery dla menu aktów
            const actMenu = document.getElementById('actContextMenu');
            actMenu.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                switch(action) {
                    case 'delete-roi': deleteActROI(); break;
                    case 'delete-fields': deleteActFields(); break;
                    case 'delete-act': deleteAct(); break;
                    case 'rename': {
                        const act = app.imageActs.find(a => a.actNum === contextMenuState.actNum);
                        if (act) {
                            const newName = prompt('Nowa nazwa aktu:', act.name || '');
                            if (newName !== null) {
                                act.name = newName;
                                saveStorage();
                                renderActButtons();
                                redrawROIs();
                                notify('✓ Nazwa zmieniona', 'success');
                            }
                        }
                        hideContextMenus();
                        break;
                    }
                }
            });
            
            // Handlery dla menu obrazu
            const imageMenu = document.getElementById('imageContextMenu');
            imageMenu.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                switch(action) {
                    case 'delete-all-acts': deleteAllActsOnImage(); break;
                    case 'delete-all-rois': deleteAllROIsOnImage(); break;
                }
            });
        }

        function clearAllROIs() {
            const acts = app.imageActs.filter(act => act.imageIdx === app.currentImageIdx);
            acts.forEach(act => {
                act.fieldROIs = {}; // Czyści ROI per-pole
                act.actROI = null; // Czyści główny ROI aktu
            });
            redrawROIs(); // Odśwież overlaye
            saveStorage(); // Zapisz zmiany
            notify('Wszystkie ROI usunięte z bieżącego skanu', 'success');
        }

        function sortImages() {
            app.images.sort(naturalSort);
            updateThumbs();
            // Zachowaj wybór bieżącego obrazu jeśli to możliwe
            const currentImageName = app.images[app.currentImageIdx]?.name;
            const newIndex = app.images.findIndex(img => img.name === currentImageName);
            app.currentImageIdx = newIndex >= 0 ? newIndex : 0;
            selectImage(app.currentImageIdx, true);
            notify('Obrazy posortowane po nazwie', 'success');
        }

        function zoomToAct(actROI) {
            if (!actROI) return;
            const item = app.viewer.world.getItemAt(0);
            if (!item) return;
            const itemSize = item.getContentSize();
            const rect = new OpenSeadragon.Rect(
                actROI.x * itemSize.x,
                actROI.y * itemSize.y,
                actROI.w * itemSize.x,
                actROI.h * itemSize.y
            );
            const viewportRect = app.viewer.viewport.imageToViewportRectangle(rect);
            app.viewer.viewport.fitBounds(viewportRect, true);
        }

        function rotateImage(degrees) {
            // 🔧 NAPRAWIONO: Obsługa rotacji dla fallback img elementu
            const imageFallback = document.getElementById('imageFallback');
            
            if (imageFallback && imageFallback.classList.contains('active')) {
                // Obracaj fallback img element
                const currentRotation = parseInt(imageFallback.style.transform.match(/rotate\((\d+)/)?.[1] || '0');
                const newRotation = (currentRotation + degrees + 360) % 360;
                imageFallback.style.transform = `rotate(${newRotation}deg)`;
                console.log(`📐 Image rotated to ${newRotation}°`);
            } else if (app.viewer && app.viewer.world.getItemAt(0)) {
                // Obracaj obraz w OpenSeadragon (jeśli jest załadowany)
                const current = app.viewer.viewport.getRotation();
                app.viewer.viewport.setRotation((current + degrees + 360) % 360);
                console.log(`📐 OSD image rotated`);
            }
        }

        function zoomReset() {
            // 🔧 NAPRAWIONO: Obsługa reset zoom dla fallback img
            const imageFallback = document.getElementById('imageFallback');
            
            if (imageFallback && imageFallback.classList.contains('active')) {
                // Fallback nie obsługuje zoom - ignoruj
                console.log('ℹ️ Zoom reset not supported for fallback image');
            } else if (app.viewer && app.viewer.world.getItemAt(0)) {
                // Reset zoom dla OSD
                app.viewer.viewport.fitBounds(app.viewer.world.getItemAt(0).getBounds());
                console.log('✅ OSD zoom reset');
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    notify(`Błąd fullscreen: ${err.message}`, 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Google Authentication
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                const result = await firebase.auth().signInWithPopup(provider);
                const user = result.user;
                
                console.log('✅ Google sign-in successful:', user.displayName);
                notify(`Zalogowano jako: ${user.displayName}`, 'success');
                
                // Update UI to show user is logged in
                const authBtn = document.getElementById('authBtn');
                if (authBtn) {
                    authBtn.innerHTML = '<i class="fas fa-user-check"></i> ' + user.displayName.split(' ')[0];
                    authBtn.title = 'Wyloguj się';
                    authBtn.onclick = signOut;
                }
                
                // Enable Firebase features
                app.storageMode = 'firebase';
                console.log('🔥 Switched to Firebase storage mode');
                
            } catch (error) {
                console.error('❌ Google sign-in error:', error);
                notify(`Błąd logowania: ${error.message}`, 'error');
            }
        }

        async function signOut() {
            try {
                await firebase.auth().signOut();
                console.log('👋 Signed out');
                notify('Wylogowano', 'info');
                
                // Reset UI
                const authBtn = document.getElementById('authBtn');
                if (authBtn) {
                    authBtn.innerHTML = '<i class="fab fa-google"></i> Login';
                    authBtn.title = 'Zaloguj się z Google';
                    authBtn.onclick = signInWithGoogle;
                }
                
                // Switch back to local storage
                app.storageMode = 'local';
                console.log('💾 Switched to local storage mode');
                
            } catch (error) {
                console.error('❌ Sign out error:', error);
                notify(`Błąd wylogowania: ${error.message}`, 'error');
            }
        }
        
        // 🆕 Importuj bazę z CSV/JSON
        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const content = await file.text();
                    if (file.name.endsWith('.csv')) {
                        await importCSVDatabase(content);
                    } else if (file.name.endsWith('.json')) {
                        await importJSONDatabase(content);
                    }
                } catch (err) {
                    console.error('❌ Błąd importu bazy:', err);
                    notify(`Błąd importu: ${err.message}`, 'error');
                }
            };
            input.click();
        }
        
        // 🆕 Importuj CSV do bazy
        async function importCSVDatabase(csvContent) {
            if (!localDb) {
                notify('Baza danych nie jest zainicjowana', 'error');
                return;
            }
            
            try {
                // Parsuj CSV
                const lines = csvContent.trim().split('\n');
                const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
                
                // Mapy kolumn
                const colMap = {
                    'id': 0, 'rok': 1, 'nr': 2, 'nazwisko': 3, 'imię': 4, 'miejscowość': 5,
                    'imięo': 6, 'nazwiskoo': 7, 'wo': 8, 'im': 9, 'nm': 10, 'wm': 11,
                    'uwagi': 12, 'uwagi org': 13, 'sciezka obrazu': 14, 'ścieżka obrazu': 14,
                    'imagepath': 14, 'roi': 15, 'roijson': 15, 'roi json': 15
                };
                
                // Dopasuj kolumny z nagłówkami
                const columnIndices = {};
                headers.forEach((h, idx) => {
                    // Normalizuj nagłówek
                    const normalized = h.replace(/[\s\-_]/g, '').toLowerCase();
                    for (let key in colMap) {
                        if (normalized.includes(key.replace(/[\s\-_]/g, ''))) {
                            columnIndices[key] = idx;
                            break;
                        }
                    }
                });
                
                console.log('Dopasowane kolumny:', columnIndices);
                
                // Wczytaj rekordy
                let imported = 0;
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const cols = lines[i].split('\t');
                    const record = {
                        id: cols[columnIndices.id] || '',
                        rok: cols[columnIndices.rok] || '',
                        nr: cols[columnIndices.nr] || '',
                        nazwisko: cols[columnIndices.nazwisko] || '',
                        imie: cols[columnIndices['imię']] || '',
                        miejscowosc: cols[columnIndices['miejscowość']] || '',
                        imieO: cols[columnIndices['imięo']] || '',
                        nazwiskoO: cols[columnIndices['nazwiskoo']] || '',
                        wO: cols[columnIndices['wo']] || '',
                        im: cols[columnIndices['im']] || '',
                        nm: cols[columnIndices['nm']] || '',
                        wM: cols[columnIndices['wm']] || '',
                        uwagi: cols[columnIndices['uwagi']] || '',
                        uwagiOrg: cols[columnIndices['uwagi org']] || '',
                        imagePath: cols[columnIndices['sciezka obrazu'] || columnIndices['ścieżka obrazu'] || columnIndices['imagepath']] || '',
                        roiJson: cols[columnIndices['roi'] || columnIndices['roijson'] || columnIndices['roi json']] || ''
                    };
                    
                    saveImportedRecord(record);
                    imported++;
                }
                
                console.log(`✅ Zaimportowano ${imported} rekordów z CSV`);
                notify(`✅ Zaimportowano ${imported} rekordów`, 'success');
                
                // Odśwież tabelę
                renderImportedRecordsTable();
            } catch (err) {
                console.error('❌ Błąd importu CSV:', err);
                notify(`Błąd: ${err.message}`, 'error');
            }
        }
        
        // 🆕 Importuj JSON do bazy
        async function importJSONDatabase(jsonContent) {
            if (!localDb) {
                notify('Baza danych nie jest zainicjowana', 'error');
                return;
            }
            
            try {
                const data = JSON.parse(jsonContent);
                const records = Array.isArray(data) ? data : data.records || [];
                
                let imported = 0;
                for (let record of records) {
                    // Normalizuj nazwy pól (mogą być różne w JSON)
                    const rec = {
                        id: record.id || record['ID'] || '',
                        rok: record.rok || record['ROK'] || '',
                        nr: record.nr || record['Nr.'] || '',
                        nazwisko: record.nazwisko || record['Nazwisko'] || '',
                        imie: record.imie || record['Imię'] || '',
                        miejscowosc: record.miejscowosc || record['Miejscowość'] || '',
                        imieO: record.imieO || record['ImięO'] || '',
                        nazwiskoO: record.nazwiskoO || record['NazwiskoO'] || '',
                        wO: record.wO || record['wO'] || '',
                        im: record.im || record['IM'] || '',
                        nm: record.nm || record['NM'] || '',
                        wM: record.wM || record['wM'] || '',
                        uwagi: record.uwagi || record['uwagi'] || '',
                        uwagiOrg: record.uwagiOrg || record['UWAGI ORG'] || '',
                        imagePath: record.imagePath || record['imagePath'] || record['Ścieżka Obrazu'] || record['image_path'] || '',
                        roiJson: record.roiJson || record['roiJson'] || record['ROI (JSON)'] || record['roi_json'] || ''
                    };
                    
                    saveImportedRecord(rec);
                    imported++;
                }
                
                console.log(`✅ Zaimportowano ${imported} rekordów z JSON`);
                notify(`✅ Zaimportowano ${imported} rekordów`, 'success');
                
                // Odśwież tabelę
                renderImportedRecordsTable();
            } catch (err) {
                console.error('❌ Błąd importu JSON:', err);
                notify(`Błąd JSON: ${err.message}`, 'error');
            }
        }
        
        // 🆕 Renderuj tabelę importowanych rekordów
        function renderImportedRecordsTable() {
            const records = loadImportedRecords();
            const duplicates = detectDuplicates();
            const tableBody = document.getElementById('dataTableBody');
            
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            records.forEach((record, idx) => {
                const row = tableBody.insertRow();
                const isDuplicate = duplicates[record.id];
                
                if (isDuplicate) {
                    row.style.backgroundColor = 'rgba(255, 193, 7, 0.2)';  // Żółte tło dla duplikatów
                    row.title = `⚠️ Duplikat! Jest ${isDuplicate} rekordów z ID: ${record.id}`;
                }
                
                // Checkbox
                const checkboxCell = row.insertCell();
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'row-checkbox';
                checkbox.dataset.rowId = record.rowId;
                checkboxCell.appendChild(checkbox);
                
                // Kolumny: ID, ROK, Nr., Nazwisko, Imię, Miejscowość, ImięO, NazwiskoO, wO, IM, NM, wM, uwagi, UWAGI ORG
                row.insertCell().textContent = record.id || '';
                row.insertCell().textContent = record.rok || '';
                row.insertCell().textContent = record.nr || '';
                row.insertCell().textContent = record.nazwisko || '';
                row.insertCell().textContent = record.imie || '';
                row.insertCell().textContent = record.miejscowosc || '';
                row.insertCell().textContent = record.imieO || '';
                row.insertCell().textContent = record.nazwiskoO || '';
                row.insertCell().textContent = record.wO || '';
                row.insertCell().textContent = record.im || '';
                row.insertCell().textContent = record.nm || '';
                row.insertCell().textContent = record.wM || '';
                row.insertCell().textContent = record.uwagi || '';
                row.insertCell().textContent = record.uwagiOrg || '';
                
                // 🆕 Ścieżka obrazu (skrócona)
                const imagePathCell = row.insertCell();
                const imageName = record.imagePath ? record.imagePath.split('/').pop().split('\\').pop() : '(brak)';
                imagePathCell.textContent = imageName;
                imagePathCell.title = record.imagePath || 'Brak ścieżki obrazu';
                imagePathCell.style.fontSize = '10px';
                imagePathCell.style.color = record.imagePath ? '#10b981' : '#888';
                
                // 🆕 ROI JSON (skrócone)
                const roiCell = row.insertCell();
                const hasROI = record.roiJson && record.roiJson.trim().length > 0;
                roiCell.textContent = hasROI ? '📍 ROI' : '(brak)';
                roiCell.title = record.roiJson || 'Brak danych ROI';
                roiCell.style.fontSize = '10px';
                roiCell.style.color = hasROI ? '#f59e0b' : '#888';
                
                // Akcje
                const actionsCell = row.insertCell();
                const editBtn = document.createElement('button');
                editBtn.textContent = '✏️';
                editBtn.className = 'table-action-btn';
                editBtn.style.padding = '2px 6px';
                editBtn.onclick = () => editImportedRecord(record);
                actionsCell.appendChild(editBtn);
                
                const delBtn = document.createElement('button');
                delBtn.textContent = '🗑️';
                delBtn.className = 'table-action-btn';
                delBtn.style.padding = '2px 6px';
                delBtn.onclick = () => {
                    deleteImportedRecord(record.rowId);
                    renderImportedRecordsTable();
                };
                actionsCell.appendChild(delBtn);
                
                // Klikn\u0105\u0107 w wiersz = edycja
                row.style.cursor = 'pointer';
                row.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                        editImportedRecord(record);
                    }
                };
            });
            
            console.log(`📊 Wyświetlono ${records.length} rekordów (duplikaty: ${Object.keys(duplicates).length})`);
        }
        
        // 🆕 Edytuj importowany rekord w panelu bocznym
        function editImportedRecord(record) {
            const rightPanel = document.getElementById('rightPanel');
            const formContent = rightPanel.querySelector('.panel-content');
            
            formContent.innerHTML = `
                <div style="padding: 12px;">
                    <h3 style="color: #0078d4; margin-bottom: 12px;">Edytuj rekord</h3>
                    <div style="font-size: 10px; color: #888; margin-bottom: 12px;">
                        ID: <strong>${record.id}</strong> 
                        ${record.status !== 'new' ? `<span style="color: #10b981;">(${record.status})</span>` : ''}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div class="form-group">
                            <label>ID</label>
                            <input type="text" value="${record.id || ''}" data-field="id">
                        </div>
                        <div class="form-group">
                            <label>Rok</label>
                            <input type="text" value="${record.rok || ''}" data-field="rok">
                        </div>
                        <div class="form-group">
                            <label>Nr.</label>
                            <input type="text" value="${record.nr || ''}" data-field="nr">
                        </div>
                        <div class="form-group">
                            <label>Nazwisko</label>
                            <input type="text" value="${record.nazwisko || ''}" data-field="nazwisko">
                        </div>
                        <div class="form-group">
                            <label>Imię</label>
                            <input type="text" value="${record.imie || ''}" data-field="imie">
                        </div>
                        <div class="form-group">
                            <label>Miejscowość</label>
                            <input type="text" value="${record.miejscowosc || ''}" data-field="miejscowosc">
                        </div>
                        <div class="form-group">
                            <label>Imię Ojca</label>
                            <input type="text" value="${record.imieO || ''}" data-field="imieO">
                        </div>
                        <div class="form-group">
                            <label>Nazwisko Ojca</label>
                            <input type="text" value="${record.nazwiskoO || ''}" data-field="nazwiskoO">
                        </div>
                        <div class="form-group">
                            <label>Wiek Ojca</label>
                            <input type="text" value="${record.wO || ''}" data-field="wO">
                        </div>
                        <div class="form-group">
                            <label>Imię Matki</label>
                            <input type="text" value="${record.im || ''}" data-field="im">
                        </div>
                        <div class="form-group">
                            <label>Nazwisko Matki</label>
                            <input type="text" value="${record.nm || ''}" data-field="nm">
                        </div>
                        <div class="form-group">
                            <label>Wiek Matki</label>
                            <input type="text" value="${record.wM || ''}" data-field="wM">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Uwagi</label>
                            <textarea data-field="uwagi" style="min-height: 60px;">${record.uwagi || ''}</textarea>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Uwagi Organizacyjne</label>
                            <textarea data-field="uwagiOrg" style="min-height: 60px;">${record.uwagiOrg || ''}</textarea>
                        </div>
                    </div>
                    
                    <!-- 🆕 Sekcja Obrazu -->
                    <div style="border-top: 1px solid #2a2a2a; padding-top: 12px; margin-bottom: 12px;">
                        <div style="font-size: 11px; font-weight: 600; color: #0078d4; margin-bottom: 8px;">🖼️ Obraz i ROI</div>
                        
                        <div class="form-group">
                            <label>Ścieżka obrazu</label>
                            <div style="display: flex; gap: 6px;">
                                <input type="text" id="imagePath_${record.rowId}" value="${record.imagePath || ''}" data-field="imagePath" style="flex: 1;" readonly style="background: #0a0a0a; color: #888;">
                                <button class="toolbar-btn" style="padding: 4px 10px; font-size: 10px;" onclick="selectImageFile(${record.rowId})">
                                    <i class="fas fa-folder-open"></i> Wybierz
                                </button>
                            </div>
                            ${record.imagePath ? `<div style="font-size: 9px; color: #10b981; margin-top: 4px;">✅ Obraz wybrany</div>` : ''}
                        </div>
                        
                        <div class="form-group">
                            <label>ROI JSON</label>
                            <textarea id="roiJson_${record.rowId}" data-field="roiJson" style="min-height: 60px; font-family: monospace; font-size: 9px;">${record.roiJson || ''}</textarea>
                            <div style="font-size: 9px; color: #888; margin-top: 4px;">Automatycznie uzupełniany przy rysowaniu ROI na obrazie</div>
                        </div>
                        
                        ${record.imagePath ? `
                            <button class="form-btn" onclick="loadImageFromPath('${record.imagePath.replace(/'/g, "\\'")}', ${record.rowId})" style="width: 100%; margin-bottom: 8px;">
                                <i class="fas fa-eye"></i> Podgląd obrazu
                            </button>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="form-btn" onclick="saveEditedImportedRecord(${record.rowId})" style="flex: 1;">
                            <i class="fas fa-save"></i> Zapisz
                        </button>
                        <button class="form-btn" style="flex: 1; background: #3a3a3a; color: #ddd;" onclick="renderImportedRecordsTable()">
                            <i class="fas fa-times"></i> Anuluj
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 🆕 Wybierz plik obrazu dla rekordu
        function selectImageFile(rowId) {
            const input = document.getElementById('singleImageInput');
            
            // Resetuj poprzedni onChange handler
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Sprawdzenie czy to jest obraz
                    if (!file.type.startsWith('image/')) {
                        notify('❌ To nie jest plik obrazu!', 'error');
                        return;
                    }
                    
                    // W przeglądarce web użyj FileReader do konwersji na Data URL
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        // Przechowaj data URL zamiast ścieżki (będzie działać w przeglądarce)
                        const dataUrl = evt.target.result;
                        const imagePathField = document.getElementById(`imagePath_${rowId}`);
                        if (imagePathField) {
                            imagePathField.value = file.name;
                        }
                        
                        // Od razu załaduj obraz do viewer
                        loadImageFromPath(dataUrl, rowId);
                        
                        notify(`✅ Obraz wybrany: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`, 'success');
                        console.log('📁 Plik:', file.name, 'Rozmiar:', (file.size / 1024).toFixed(1), 'KB', 'Typ:', file.type);
                    };
                    reader.onerror = (evt) => {
                        notify('❌ Błąd wczytywania pliku', 'error');
                        console.error('❌ Błąd FileReader:', evt);
                    };
                    reader.readAsDataURL(file);
                } else {
                    console.log('⚠️ Brak pliku wybranego');
                }
            };
            
            // Otwórz dialog wyboru pliku
            input.click();
        }
        
        // 🆕 Załaduj obraz z ścieżki/data URL do viewer
        function loadImageFromPath(imagePath, rowId) {
            try {
                const viewer = app.viewer;
                if (!viewer) return;
                
                // Jeśli to data URL - użyj bezpośrednio
                if (imagePath.startsWith('data:') || imagePath.startsWith('blob:')) {
                    const imageFallback = document.getElementById('imageFallback');
                    if (imageFallback) {
                        imageFallback.src = imagePath;
                        imageFallback.classList.add('active');
                    }
                    console.log('📁 Załadowano image fallback');
                } else {
                    // W przeglądarce web - spróbuj załadować przez HTTP
                    // To będzie działać jeśli plik jest dostępny via HTTP
                    const imageFallback = document.getElementById('imageFallback');
                    if (imageFallback) {
                        imageFallback.src = imagePath;
                        imageFallback.classList.add('active');
                    }
                }
                
                console.log('🖼️ Obraz załadowany do viewer');
                notify('✅ Obraz załadowany', 'success');
            } catch (err) {
                console.error('❌ Błąd załadowania obrazu:', err);
                notify('❌ Błąd załadowania obrazu', 'error');
            }
        }
        
        // 🆕 Zapisz edytowany rekord (z obrazem i ROI)
        function saveEditedImportedRecord(rowId) {
            const formContent = document.querySelector('.panel-content');
            const inputs = formContent.querySelectorAll('[data-field]');
            
            const record = {};
            inputs.forEach(input => {
                record[input.dataset.field] = input.value;
            });
            
            updateImportedRecord(rowId, record);
            notify('✅ Rekord zaktualizowany', 'success');
            renderImportedRecordsTable();
        }

        // 🆕 Eksportuj rekordy do CSV (dla Office'a)
        // 🆕 Eksportuj z wyborem zakresu wierszy i kolumn
        function exportDatabaseAdvanced() {
            const records = loadImportedRecords();
            if (records.length === 0) {
                notify('❌ Brak rekordów do eksportu', 'error');
                return;
            }

            // Dostępne kolumny
            const availableColumns = [
                { name: 'id', label: 'ID' },
                { name: 'rok', label: 'ROK' },
                { name: 'nr', label: 'Nr.' },
                { name: 'nazwisko', label: 'Nazwisko' },
                { name: 'imie', label: 'Imię' },
                { name: 'miejscowosc', label: 'Miejscowość' },
                { name: 'imieO', label: 'ImięO' },
                { name: 'nazwiskoO', label: 'NazwiskoO' },
                { name: 'wO', label: 'wO' },
                { name: 'im', label: 'IM' },
                { name: 'nm', label: 'NM' },
                { name: 'wM', label: 'wM' },
                { name: 'uwagi', label: 'Uwagi' },
                { name: 'uwagiOrg', label: 'UWAGI ORG' },
                { name: 'imagePath', label: 'Ścieżka Obrazu' },
                { name: 'roiJson', label: 'ROI (JSON)' }
            ];

            // Stwórz modal dialogu
            const modalHtml = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 10000; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                <h3>📊 Eksport Zaawansowany Bazy</h3>
                
                <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 6px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 8px;">📍 Zakreś Wierszy</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="display: block; font-size: 0.9em; margin-bottom: 4px;">Od wiersza:</label>
                            <input type="number" id="rangeStart" value="1" min="1" max="${records.length}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.9em; margin-bottom: 4px;">Do wiersza:</label>
                            <input type="number" id="rangeEnd" value="${records.length}" min="1" max="${records.length}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    <small style="color: #666; margin-top: 6px; display: block;">Razem: ${records.length} wierszy</small>
                </div>

                <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 6px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 8px;">📋 Kolumny do Eksportu</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 250px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                        ${availableColumns.map((col, idx) => `
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" class="col-checkbox" value="${col.name}" checked style="cursor: pointer;">
                                <span>${col.label}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div style="margin-top: 8px;">
                        <button onclick="document.querySelectorAll('.col-checkbox').forEach(c => c.checked = true)" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 6px; font-size: 0.9em;">✓ Wszystkie</button>
                        <button onclick="document.querySelectorAll('.col-checkbox').forEach(c => c.checked = false)" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">✗ Brak</button>
                    </div>
                </div>

                <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 6px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 8px;">💾 Format Eksportu</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="csv" checked style="cursor: pointer;"> CSV (Excel)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="json" style="cursor: pointer;"> JSON
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="sql" style="cursor: pointer;"> SQL INSERT
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="performAdvancedExport()" style="flex: 1; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">📤 Exportuj</button>
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove(); document.querySelectorAll('[style*=\\'position: fixed\\'][style*=\\'background: rgba\\']').forEach(e => e.remove());" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">✕ Anuluj</button>
                </div>
            </div>
            `;

            // Wyświetl modal
            const backdrop = document.createElement('div');
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;';
            backdrop.onclick = () => {
                backdrop.remove();
                backdrop.nextElementSibling?.remove();
            };

            const modal = document.createElement('div');
            modal.innerHTML = modalHtml;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }

        // 🆕 Wykonaj zaawansowany eksport
        function performAdvancedExport() {
            const records = loadImportedRecords();
            const rangeStart = parseInt(document.getElementById('rangeStart')?.value || 1) - 1;
            const rangeEnd = parseInt(document.getElementById('rangeEnd')?.value || records.length);
            const selectedColumns = Array.from(document.querySelectorAll('.col-checkbox:checked')).map(c => c.value);
            const format = document.querySelector('input[name="exportFormat"]:checked')?.value || 'csv';

            if (selectedColumns.length === 0) {
                notify('⚠️ Wybierz co najmniej jedną kolumnę', 'warning');
                return;
            }

            if (rangeStart < 0 || rangeEnd > records.length || rangeStart >= rangeEnd) {
                notify('⚠️ Nieprawidłowy zakres wierszy', 'warning');
                return;
            }

            try {
                const selectedRecords = records.slice(rangeStart, rangeEnd);
                let content, filename, mimeType;

                if (format === 'csv') {
                    content = exportToCSV(selectedRecords, selectedColumns);
                    filename = `genealogia_export_${rangeStart + 1}-${rangeEnd}_${new Date().toISOString().slice(0, 10)}.csv`;
                    mimeType = 'text/csv;charset=utf-8;';
                } else if (format === 'json') {
                    content = exportToJSON(selectedRecords, selectedColumns);
                    filename = `genealogia_export_${rangeStart + 1}-${rangeEnd}_${new Date().toISOString().slice(0, 10)}.json`;
                    mimeType = 'application/json;charset=utf-8;';
                } else if (format === 'sql') {
                    content = exportToSQL(selectedRecords, selectedColumns);
                    filename = `genealogia_export_${rangeStart + 1}-${rangeEnd}_${new Date().toISOString().slice(0, 10)}.sql`;
                    mimeType = 'text/plain;charset=utf-8;';
                }

                // Download
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                notify(`✅ Eksportowano ${selectedRecords.length} wierszy (${selectedColumns.length} kolumn) do ${format.toUpperCase()}`, 'success');
                
                // Zamknij modal
                document.querySelectorAll('[style*="position: fixed"]').forEach(el => el.remove());
                
            } catch (err) {
                console.error('❌ Błąd eksportu:', err);
                notify('❌ Błąd: ' + err.message, 'error');
            }
        }

        // Helper: Eksport do CSV
        function exportToCSV(records, columns) {
            const headers = columns.join('\t');
            const rows = records.map(rec => 
                columns.map(col => {
                    const val = rec[col] || '';
                    if (typeof val === 'string' && (val.includes('\t') || val.includes('"') || val.includes('\n'))) {
                        return `"${val.replace(/"/g, '""')}"`;
                    }
                    return val;
                }).join('\t')
            );
            return headers + '\n' + rows.join('\n');
        }

        // Helper: Eksport do JSON
        function exportToJSON(records, columns) {
            const data = records.map(rec => {
                const obj = {};
                columns.forEach(col => {
                    obj[col] = rec[col] || null;
                });
                return obj;
            });
            return JSON.stringify(data, null, 2);
        }

        // Helper: Eksport do SQL INSERT
        function exportToSQL(records, columns) {
            const lines = [];
            lines.push('-- Eksport genealogii z zakresu wierszy');
            lines.push(`-- Data: ${new Date().toISOString()}`);
            lines.push(`-- Razem rekordów: ${records.length}`);
            lines.push('');
            lines.push('INSERT INTO imported_records (row_id, ' + columns.join(', ') + ') VALUES');
            
            records.forEach((rec, idx) => {
                const values = [rec.rowId || 'NULL'];
                columns.forEach(col => {
                    const val = rec[col];
                    if (val === null || val === undefined || val === '') {
                        values.push('NULL');
                    } else if (typeof val === 'number') {
                        values.push(val.toString());
                    } else {
                        values.push(`'${String(val).replace(/'/g, "''")}'`);
                    }
                });
                lines.push(`(${values.join(', ')})${idx < records.length - 1 ? ',' : ';'}`);
            });
            
            return lines.join('\n');
        }

        // 🆕 Eksportuj do pliku SQLite (.db) - z Supabase (WSZYSTKIE REKORDY)
        async function exportToSQLiteFile() {
            try {
                notify('⏳ Przygotowuję export z obecnej tabeli...', 'info');
                
                // 🆕 ZMIENIONO: Eksportuj z app.imageActs (aktualne dane) zamiast z Supabase
                if (!app.imageActs || app.imageActs.length === 0) {
                    notify('❌ Brak danych do eksportu. Załaduj najpierw dane (Ładuj Supabase lub Import DB)', 'error');
                    return;
                }

                const actRecords = app.imageActs;
                console.log(`📦 Eksportuję ${actRecords.length} aktów z app.imageActs`);

                notify('⏳ Generuję bazę SQLite...', 'info');

                // Stwórz nową bazę SQL.js
                const SQL = window.SQL;
                if (!SQL) {
                    notify('❌ SQL.js nie jest dostępny', 'error');
                    return;
                }
                const newDb = new SQL.Database();

                // Stwórz tabelę z pełnymi kolumnami dla genealogi (synchronized z Supabase schema)
                // 🔧 FIX: DROP stare tabele aby zawsze mieć świeży schemat z nowymi kolumnami
                newDb.run(`DROP TABLE IF EXISTS imported_records`);
                
                newDb.run(`
                    CREATE TABLE imported_records (
                        row_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        id TEXT UNIQUE,
                        rok INTEGER,
                        nr TEXT,
                        nazwisko TEXT,
                        imie TEXT,
                        miejscowosc TEXT,
                        child_first_name TEXT,
                        child_last_name TEXT,
                        child_birth_date TEXT,
                        father_first_name TEXT,
                        father_last_name TEXT,
                        father_age TEXT,
                        mother_first_name TEXT,
                        mother_last_name TEXT,
                        mother_maiden_name TEXT,
                        mother_age TEXT,
                        witnesses TEXT,
                        uwagi TEXT,
                        uwagi_org TEXT,
                        image_path TEXT,
                        imageidx INTEGER,
                        roi_json TEXT,
                        field_values TEXT,
                        status TEXT DEFAULT 'indexed',
                        imported_at DATETIME DEFAULT CURRENT_TIMESTAMP
                    )
                `);

                // 🆕 Wstaw dane z app.imageActs (z uwzględnieniem wszystkich pól - 23 kolumny genealogiczne)
                let inserted = 0;
                for (const record of actRecords) {
                    try {
                        const fv = record.fieldValues || {};
                        newDb.run(
                            `INSERT OR REPLACE INTO imported_records 
                            (id, rok, nr, nazwisko, imie, miejscowosc, child_first_name, child_last_name, child_birth_date, father_first_name, father_last_name, father_age, mother_first_name, mother_last_name, mother_maiden_name, mother_age, witnesses, uwagi, uwagi_org, image_path, imageidx, roi_json, field_values, status)
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                            [
                                record.id || record.original_id || '',
                                parseInt(record.rok || record.year || record.christening_year || fv.rok || 0),
                                record.nr || record.christening_act_number || fv.nr || '',
                                // 🔧 FIX: Mapuj z NOWYCH pól, fallback na STARE
                                fv.child_last_name || fv.nazwisko || '',
                                fv.child_first_name || fv.imie || '',
                                fv.location || fv.miejscowosc || record.location || '',
                                fv.child_first_name || fv.imie || '',
                                fv.child_last_name || fv.nazwisko || '',
                                fv.child_birth_date || '',
                                fv.father_first_name || fv.imie_o || '',
                                fv.father_last_name || fv.nazwisko_o || '',
                                fv.father_age || fv.w_o || '',
                                fv.mother_first_name || fv.im || '',
                                fv.mother_last_name || fv.nm || '',
                                fv.mother_maiden_name || '',
                                fv.mother_age || fv.w_m || '',
                                fv.witnesses || '',
                                fv.notes || fv.uwagi || '',
                                fv.notes_org || fv.uwagi_org || '',
                                record.image_path || '',
                                record.imageIdx !== undefined && record.imageIdx !== null ? parseInt(record.imageIdx) : null,
                                record.fieldROIs ? JSON.stringify(record.fieldROIs) : '',
                                record.fieldValues ? JSON.stringify(record.fieldValues) : '',
                                'indexed'
                            ]
                        );
                        inserted++;
                    } catch (e) {
                        console.warn('⚠️ Błąd przy rekordzie:', record.id, e.message);
                    }
                }

                // Eksportuj do binarnego pliku
                const data = newDb.export();
                const blob = new Blob([data], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `genealogia_${new Date().toISOString().slice(0, 10)}.db`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                newDb.close();

                console.log(`✅ Eksportowano ${inserted} rekordów do SQLite`);
                notify(`✅ Eksportowano ${inserted} rekordów (z aktualnej tabeli) do pliku .db`, 'success');
            } catch (error) {
                console.error('❌ Błąd eksportu SQLite:', error);
                notify(`❌ Błąd: ${error.message}`, 'error');
            }
        }

        // 🆕 Modal do wklejania tab-separated tabel
        function openPasteTableModal() {
            const modalHtml = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 10000; max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <h3>📋 Wklej Tabelę (Tab-Separated)</h3>
                
                <div style="margin: 15px 0; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 4px;">
                    <strong>Format:</strong> Skopiuj z Excel/Calc i wklej poniżej<br/>
                    <strong>Kolumny:</strong> ID &nbsp; ROK &nbsp; Nr. &nbsp; Nazwisko &nbsp; Imię &nbsp; Miejscowość &nbsp; ImięO &nbsp; NazwiskoO &nbsp; wO &nbsp; IM &nbsp; NM &nbsp; wM &nbsp; uwagi &nbsp; UWAGI ORG
                </div>
                
                <textarea id="pasteTableArea" style="width: 100%; height: 400px; padding: 12px; font-family: monospace; font-size: 12px; border: 2px solid #ddd; border-radius: 4px; resize: vertical;" placeholder="Wklej tutaj dane z Excel/Calc...&#10;&#10;Przykład:&#10;ID	ROK	Nr.	Nazwisko	Imię	Miejscowość	ImięO	NazwiskoO	wO	IM	NM	wM	uwagi	UWAGI ORG&#10;1	1783	1	Kowalski	Jan	Warszawa	Adam	Kowalska	50	Maria	Nowak	45	Notatka	Uwaga org"></textarea>
                
                <div style="margin-top: 15px; padding: 12px; background: #f5f5f5; border-radius: 4px;">
                    <label style="display: block; margin-bottom: 8px;">
                        <strong>📊 Statystyka:</strong>
                    </label>
                    <small id="pasteStats" style="color: #666;">Wklej dane aby zobaczyć statystykę</small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="importPastedTable()" style="flex: 1; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">✅ Importuj</button>
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove(); document.querySelectorAll('[style*=\\'position: fixed\\'][style*=\\'background: rgba\\']').forEach(e => e.remove());" style="flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">✕ Anuluj</button>
                </div>
            </div>
            `;

            const backdrop = document.createElement('div');
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;';
            backdrop.onclick = () => {
                backdrop.remove();
                backdrop.nextElementSibling?.remove();
            };

            const modal = document.createElement('div');
            modal.innerHTML = modalHtml;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);

            // Automatycznie aktualizuj statystykę przy zmianach
            document.getElementById('pasteTableArea').addEventListener('input', function() {
                const lines = this.value.trim().split('\n');
                const dataLines = lines.filter(l => l.trim().length > 0).slice(1); // Pomijaj nagłówek
                const cols = lines[0]?.split('\t').length || 0;
                document.getElementById('pasteStats').textContent = 
                    `Wierszy: ${dataLines.length} | Kolumn: ${cols}`;
            });
        }

        // 🆕 Importuj wklejone dane
        function importPastedTable() {
            const textarea = document.getElementById('pasteTableArea');
            if (!textarea) return;

            const content = textarea.value.trim();
            if (!content) {
                notify('❌ Brak danych do importu', 'error');
                return;
            }

            try {
                const lines = content.split('\n');
                const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
                
                // Mapuj indeksy kolumn
                const colMap = {
                    'id': headers.indexOf('id'),
                    'rok': headers.findIndex(h => h.includes('rok')),
                    'nr': headers.findIndex(h => h.includes('nr.')),
                    'nazwisko': headers.findIndex(h => h.includes('nazwisko')),
                    'imie': headers.findIndex(h => h.includes('imię')),
                    'miejscowosc': headers.findIndex(h => h.includes('miejscowość')),
                    'imieO': headers.findIndex(h => h.includes('imie') && h.includes('o')),
                    'nazwiskoO': headers.findIndex(h => h.includes('nazwisko') && h.includes('o')),
                    'wO': headers.findIndex(h => h.includes('wo')),
                    'im': headers.findIndex(h => h === 'im'),
                    'nm': headers.findIndex(h => h === 'nm'),
                    'wM': headers.findIndex(h => h.includes('wm')),
                    'uwagi': headers.findIndex(h => h.includes('uwagi') && !h.includes('org')),
                    'uwagiOrg': headers.findIndex(h => h.includes('uwagi') && h.includes('org')),
                    'imagePath': headers.findIndex(h => h.includes('ścieżka') || h.includes('image')),
                    'roiJson': headers.findIndex(h => h.includes('roi'))
                };

                let imported = 0;
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;

                    const cols = lines[i].split('\t');
                    const record = {
                        id: colMap.id >= 0 ? (cols[colMap.id] || '') : '',
                        rok: colMap.rok >= 0 ? (cols[colMap.rok] || '') : '',
                        nr: colMap.nr >= 0 ? (cols[colMap.nr] || '') : '',
                        nazwisko: colMap.nazwisko >= 0 ? (cols[colMap.nazwisko] || '') : '',
                        imie: colMap.imie >= 0 ? (cols[colMap.imie] || '') : '',
                        miejscowosc: colMap.miejscowosc >= 0 ? (cols[colMap.miejscowosc] || '') : '',
                        imieO: colMap.imieO >= 0 ? (cols[colMap.imieO] || '') : '',
                        nazwiskoO: colMap.nazwiskoO >= 0 ? (cols[colMap.nazwiskoO] || '') : '',
                        wO: colMap.wO >= 0 ? (cols[colMap.wO] || '') : '',
                        im: colMap.im >= 0 ? (cols[colMap.im] || '') : '',
                        nm: colMap.nm >= 0 ? (cols[colMap.nm] || '') : '',
                        wM: colMap.wM >= 0 ? (cols[colMap.wM] || '') : '',
                        uwagi: colMap.uwagi >= 0 ? (cols[colMap.uwagi] || '') : '',
                        uwagiOrg: colMap.uwagiOrg >= 0 ? (cols[colMap.uwagiOrg] || '') : '',
                        imagePath: colMap.imagePath >= 0 ? (cols[colMap.imagePath] || '') : '',
                        roiJson: colMap.roiJson >= 0 ? (cols[colMap.roiJson] || '') : ''
                    };

                    saveImportedRecord(record);
                    imported++;
                }

                // Zamknij modal
                document.querySelectorAll('[style*="position: fixed"]').forEach(e => e.remove());

                renderImportedRecordsTable();
                console.log(`✅ Zaimportowano ${imported} rekordów z wklejonych danych`);
                notify(`✅ Zaimportowano ${imported} rekordów`, 'success');
            } catch (error) {
                console.error('❌ Błąd importu:', error);
                notify(`❌ Błąd: ${error.message}`, 'error');
            }
        }

        // 🆕 Importuj z pliku SQLite (.db)
        function importFromSQLiteFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.db,.sqlite,.sqlite3';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    notify('⏳ Wczytywanie bazy SQLite...', 'info');
                    const buffer = await file.arrayBuffer();
                    const SQL = window.SQL;
                    const importedDb = new SQL.Database(new Uint8Array(buffer));

                    // Odczytaj dane z tabeli
                    const results = importedDb.exec('SELECT * FROM imported_records ORDER BY row_id DESC');
                    
                    if (!results || results.length === 0) {
                        notify('❌ Baza nie zawiera tabeli imported_records', 'error');
                        return;
                    }

                    const columns = results[0].columns;
                    const rows = results[0].values;

                    let imported = 0;
                    for (const row of rows) {
                        const record = {};
                        columns.forEach((col, idx) => {
                            record[col] = row[idx];
                        });

                        // 🔧 FIX: Mapuj STARE nazwy kolumn SQL na NOWE pola genealogiczne
                        // SQL ma: imie, nazwisko, imie_o, nazwisko_o, im, nm, w_o, w_m
                        // App oczekuje: child_first_name, child_last_name, father_first_name itd.
                        const mappedRecord = {
                            id: record.id || record.original_id || '',
                            original_id: record.id || '',
                            rok: record.rok || '',
                            year: record.rok || '',
                            christening_year: record.rok || '',
                            nr: record.nr || record.christening_act_number || '',
                            christening_act_number: record.nr || '',
                            imageIdx: record.imageidx || null,
                            image_path: record.image_path || '',
                            
                            // NOWE kolumny genealogiczne (v8.20+) - czytaj z NOWYCH nazw, fallback na STARE
                            child_first_name: record.child_first_name || record.imie || '',
                            child_last_name: record.child_last_name || record.nazwisko || '',
                            child_birth_date: record.child_birth_date || '',
                            father_first_name: record.father_first_name || record.imie_o || '',
                            father_last_name: record.father_last_name || record.nazwisko_o || '',
                            father_age: record.father_age || record.w_o || '',
                            mother_first_name: record.mother_first_name || record.im || '',
                            mother_last_name: record.mother_last_name || record.nm || '',
                            mother_maiden_name: record.mother_maiden_name || '',
                            mother_age: record.mother_age || record.w_m || '',
                            witnesses: record.witnesses || '',
                            
                            // STARE kolumny (dla kompatybilności wstecznej)
                            nazwisko: record.nazwisko || record.father_last_name || '',
                            imie: record.imie || record.father_first_name || '',
                            miejscowosc: record.miejscowosc || '',
                            imieO: record.imie_o || record.father_first_name || '',
                            nazwiskoO: record.nazwisko_o || record.father_last_name || '',
                            wO: record.w_o || record.father_age || '',
                            im: record.im || record.mother_first_name || '',
                            nm: record.nm || record.mother_last_name || '',
                            wM: record.w_m || record.mother_age || '',
                            uwagi: record.uwagi || record.notes || '',
                            uwagiOrg: record.uwagi_org || record.notes_org || '',
                            roiJson: record.roi_json || '',
                            
                            // fieldValues object (dla consistency z app.imageActs)
                            fieldValues: record.field_values ? JSON.parse(record.field_values) : {
                                child_first_name: record.child_first_name || record.imie || '',
                                child_last_name: record.child_last_name || record.nazwisko || '',
                                child_birth_date: record.child_birth_date || '',
                                father_first_name: record.father_first_name || record.imie_o || '',
                                father_last_name: record.father_last_name || record.nazwisko_o || '',
                                father_age: record.father_age || record.w_o || '',
                                mother_first_name: record.mother_first_name || record.im || '',
                                mother_last_name: record.mother_last_name || record.nm || '',
                                mother_maiden_name: record.mother_maiden_name || '',
                                mother_age: record.mother_age || record.w_m || '',
                                witnesses: record.witnesses || '',
                                notes: record.uwagi || record.notes || '',
                                notes_org: record.uwagi_org || record.notes_org || '',
                                location: record.miejscowosc || ''
                            },
                            
                            fieldROIs: record.roi_json ? JSON.parse(record.roi_json) : {},
                            status: record.status || 'new'
                        };

                        // Zapisz do app.imageActs (zamiast do localDB)
                        // Aby dane były widoczne w tabeli zaraz po imporcie
                        if (!app.imageActs) app.imageActs = [];
                        app.imageActs.push(mappedRecord);
                        imported++;
                    }

                    importedDb.close();

                    // Odśwież tabelę główną (nie importedRecords)
                    renderRecordsTable();
                    updateThumbs();

                    console.log(`✅ Zaimportowano ${imported} rekordów z SQLite do app.imageActs`);
                    notify(`✅ Zaimportowano ${imported} rekordów (dane widoczne w głównej tabeli)`, 'success');
                } catch (error) {
                    console.error('❌ Błąd importu SQLite:', error);
                    notify(`❌ Błąd: ${error.message}`, 'error');
                }
            };
            input.click();
        }

        function exportImportedRecordsToCSV() {
            const records = loadImportedRecords();
            if (records.length === 0) {
                notify('Brak rekordów do eksportu', 'error');
                return;
            }
            
            try {
                // Nagłówki CSV (z polem ROI_JSON)
                const headers = [
                    'ID',
                    'Rok',
                    'Nr.',
                    'Nazwisko',
                    'Imię',
                    'Miejscowość',
                    'Imię Ojca',
                    'Nazwisko Ojca',
                    'Wiek Ojca',
                    'Imię Matki',
                    'Nazwisko Matki',
                    'Wiek Matki',
                    'Uwagi',
                    'Uwagi Org',
                    'Ścieżka Obrazu',
                    'Status',
                    'ROI (JSON)'
                ];
                
                // Konwertuj rekordy na wiersze CSV
                const rows = records.map(rec => [
                    rec.id || '',
                    rec.rok || '',
                    rec.nr || '',
                    rec.nazwisko || '',
                    rec.imie || '',
                    rec.miejscowosc || '',
                    rec.imieO || '',
                    rec.nazwiskoO || '',
                    rec.wO || '',
                    rec.im || '',
                    rec.nm || '',
                    rec.wM || '',
                    (rec.uwagi || '').replace(/"/g, '""'),  // Escapuj cytaty
                    (rec.uwagiOrg || '').replace(/"/g, '""'),
                    rec.imagePath || '',
                    rec.status || '',
                    (rec.roiJson || '').replace(/"/g, '""')
                ]);
                
                // Buduj CSV string
                let csv = headers.join('\t') + '\n';  // Użyj TAB dla Excel compatibility
                rows.forEach(row => {
                    csv += row.map(cell => {
                        // Quotuj pola z przecinkami/cudzysłowami
                        if (typeof cell === 'string' && (cell.includes('\t') || cell.includes('"') || cell.includes('\n'))) {
                            return `"${cell.replace(/"/g, '""')}"`;
                        }
                        return cell;
                    }).join('\t') + '\n';
                });
                
                // Stwórz blob i download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const timestamp = new Date().toISOString().slice(0, 10);
                link.href = url;
                link.download = `genealogia_${timestamp}.csv`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                notify(`✅ Eksportowano ${records.length} rekordów do CSV`, 'success');
                console.log('📊 CSV Export:', records.length, 'rekordów');
            } catch (err) {
                console.error('❌ Błąd eksportu CSV:', err);
                notify('❌ Błąd eksportu: ' + err.message, 'error');
            }
        }

        // 🆕 Wczytaj konfigurację pól z fields-config.json
        let fieldsConfig = null;

        async function loadFieldsConfig() {
            try {
                // 🔧 NAPRAWIONO: Użyj bezwzględnej ścieżki dla serwera HTTP
                const configPath = '/fields-config.json';
                console.log('📥 Loading fields config from:', configPath);
                
                const response = await fetch(configPath);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                fieldsConfig = await response.json();
                console.log('✅ Konfiguracja pól załadowana:', fieldsConfig.documentTypes.length, 'typów dokumentów');
                return fieldsConfig;
            } catch (error) {
                console.error('❌ Błąd wczytywania fields-config.json:', error);
                
                // Fallback: Spróbuj załadować z ścieżki względnej
                try {
                    console.log('⏳ Próbuje fallback: ./fields-config.json');
                    const response = await fetch('./fields-config.json');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    fieldsConfig = await response.json();
                    console.log('✅ Fallback: Konfiguracja pól załadowana');
                    return fieldsConfig;
                } catch (fallbackError) {
                    console.error('❌ Fallback również nie zadziałał:', fallbackError);
                    
                    // Fallback 2: Użyj wbudowanej domyślnej konfiguracji
                    console.log('⏳ Używam wbudowanej domyślnej konfiguracji');
                    fieldsConfig = {
                        "documentTypes": [
                            {
                                "id": "christening",
                                "name": "Akt Chrztu",
                                "description": "Formularz dla chrztów",
                                "fields": [
                                    {"name": "rok", "label": "Rok", "type": "text", "enabled": 1, "required": true},
                                    {"name": "nr", "label": "Nr aktu", "type": "text", "enabled": 1, "required": true},
                                    {"name": "child_first_name", "label": "Imię dziecka", "type": "text", "enabled": 1, "required": true},
                                    {"name": "child_last_name", "label": "Nazwisko dziecka", "type": "text", "enabled": 1, "required": true},
                                    {"name": "father_first_name", "label": "Imię ojca", "type": "text", "enabled": 1, "required": false},
                                    {"name": "father_last_name", "label": "Nazwisko ojca", "type": "text", "enabled": 1, "required": false},
                                    {"name": "mother_first_name", "label": "Imię matki", "type": "text", "enabled": 1, "required": false},
                                    {"name": "mother_last_name", "label": "Nazwisko matki", "type": "text", "enabled": 1, "required": false},
                                    {"name": "notes", "label": "Uwagi", "type": "textarea", "enabled": 1, "required": false}
                                ]
                            }
                        ]
                    };
                    console.log('✅ Fallback 2: Wbudowana konfiguracja załadowana');
                    notify('ℹ️ Używam domyślnej konfiguracji (fields-config.json niedostępny)', 'info');
                    return fieldsConfig;
                }
            }
        }

        // 🆕 Renderuj formularz dynamiczny na podstawie configu
        function renderDynamicForm(documentTypeId) {
            if (!fieldsConfig) {
                notify('⚠️ Config nie załadowany', 'error');
                return;
            }

            const docType = fieldsConfig.documentTypes.find(d => d.id === documentTypeId);
            if (!docType) {
                notify('⚠️ Nieznany typ dokumentu: ' + documentTypeId, 'error');
                return;
            }

            const enabledFields = docType.fields.filter(f => f.enabled === 1);
            const disabledFields = docType.fields.filter(f => f.enabled === 0);

            // Sortuj włączone pola po line/column
            enabledFields.sort((a, b) => {
                if (a.line !== b.line) return a.line - b.line;
                return a.column - b.column;
            });

            // Generuj HTML formularza
            let formHtml = `<div class="dynamic-form" data-doc-type="${documentTypeId}">
                <h3>📋 ${docType.name}</h3>
                <p style="font-size: 0.9em; color: #666;">${docType.description}</p>
                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">`;

            enabledFields.forEach(field => {
                const fieldId = `field_${field.name}`;
                formHtml += `<div class="form-group">
                    <label for="${fieldId}" style="display: block; font-weight: 500; margin-bottom: 4px;">
                        ${field.label} ${field.required ? '<span style="color: red;">*</span>' : ''}
                    </label>`;

                if (field.type === 'select') {
                    formHtml += `<select id="${fieldId}" name="${field.name}" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">-- Wybierz --</option>`;
                    field.options.forEach(opt => {
                        formHtml += `<option value="${opt}">${opt}</option>`;
                    });
                    formHtml += `</select>`;
                } else if (field.type === 'textarea') {
                    formHtml += `<textarea id="${fieldId}" name="${field.name}" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; height: 80px; font-family: monospace; resize: vertical;"></textarea>`;
                } else {
                    formHtml += `<input type="${field.type}" id="${fieldId}" name="${field.name}" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" />`;
                }

                formHtml += `</div>`;
            });

            formHtml += `</div>`;

            // Dodaj pola wyłączone jako opcje
            if (disabledFields.length > 0) {
                formHtml += `<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <label for="addFieldSelect" style="font-weight: 500;">➕ Dodaj pole:</label>
                    <select id="addFieldSelect" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; margin-top: 6px;">
                        <option value="">-- Wybierz pole do dodania --</option>`;
                
                disabledFields.forEach(field => {
                    formHtml += `<option value="${field.name}">${field.label}</option>`;
                });

                formHtml += `</select>
                    <button onclick="addDynamicField(this)" class="btn" style="margin-top: 6px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">✓ Dodaj</button>
                </div>`;
            }

            formHtml += `<div style="margin-top: 20px;">
                <button onclick="saveDynamicFormData()" class="btn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">💾 Zapisz</button>
                <button onclick="downloadFieldsConfig()" class="btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">⬇️ Pobierz konfigurację</button>
            </div>
            </div>`;

            return formHtml;
        }

        // 🆕 Wyświetl selector typów dokumentów
        function showDocumentTypeSelector() {
            if (!fieldsConfig) {
                loadFieldsConfig().then(() => {
                    showDocumentTypeSelector();
                });
                return;
            }

            let selectorHtml = `<div class="doc-type-selector" style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <h3>📚 Wybierz typ dokumentu</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">`;

            fieldsConfig.documentTypes.forEach(docType => {
                selectorHtml += `<div class="doc-type-card" style="padding: 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;" onclick="selectDocumentType('${docType.id}')">
                    <strong>${docType.name}</strong>
                    <p style="font-size: 0.85em; color: #666; margin: 6px 0 0 0;">${docType.description}</p>
                </div>`;
            });

            selectorHtml += `</div></div>`;

            // Wyświetl w modalnym oknie
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 10000; max-width: 600px; max-height: 80vh; overflow-y: auto;';
            modal.innerHTML = selectorHtml + `<button onclick="this.parentElement.remove()" style="margin-top: 20px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">✕ Zamknij</button>`;

            const backdrop = document.createElement('div');
            backdrop.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;';
            backdrop.onclick = () => {
                backdrop.remove();
                modal.remove();
            };

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }

        // 🆕 Zaznacz typ dokumentu i pokaż formularz
        function selectDocumentType(documentTypeId) {
            const formContainer = document.getElementById('dynamicFormContainer');
            if (!formContainer) {
                const newContainer = document.createElement('div');
                newContainer.id = 'dynamicFormContainer';
                newContainer.style.cssText = 'margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;';
                document.body.appendChild(newContainer);
            }

            const formHtml = renderDynamicForm(documentTypeId);
            document.getElementById('dynamicFormContainer').innerHTML = formHtml;

            // Zamknij modal
            document.querySelectorAll('.doc-type-selector').forEach(el => {
                el.closest('[style*="fixed"]')?.remove();
            });
            document.querySelectorAll('[style*="position: fixed"][style*="background: rgba"]').forEach(el => el.remove());

            notify(`✅ Załadowany formularz: ${documentTypeId}`, 'success');
        }

        // 🆕 Dodaj pole do formularza
        function addDynamicField(button) {
            const select = button.parentElement.querySelector('#addFieldSelect');
            const fieldName = select.value;
            if (!fieldName) {
                notify('⚠️ Wybierz pole', 'warning');
                return;
            }

            const form = button.closest('.dynamic-form');
            if (!form) return;

            const docTypeId = form.getAttribute('data-doc-type');
            const docType = fieldsConfig.documentTypes.find(d => d.id === docTypeId);
            const field = docType.fields.find(f => f.name === fieldName);

            if (!field) return;

            const fieldId = `field_${field.name}`;
            const grid = form.querySelector('.form-grid');

            // Utwórz div dla nowego pola
            let fieldHtml = `<div class="form-group">
                <label for="${fieldId}" style="display: block; font-weight: 500; margin-bottom: 4px;">
                    ${field.label} ${field.required ? '<span style="color: red;">*</span>' : ''}
                </label>`;

            if (field.type === 'select') {
                fieldHtml += `<select id="${fieldId}" name="${field.name}" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Wybierz --</option>`;
                field.options.forEach(opt => {
                    fieldHtml += `<option value="${opt}">${opt}</option>`;
                });
                fieldHtml += `</select>`;
            } else if (field.type === 'textarea') {
                fieldHtml += `<textarea id="${fieldId}" name="${field.name}" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; height: 80px; font-family: monospace; resize: vertical;"></textarea>`;
            } else {
                fieldHtml += `<input type="${field.type}" id="${fieldId}" name="${field.name}" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" />`;
            }

            fieldHtml += `</div>`;

            grid.insertAdjacentHTML('beforeend', fieldHtml);
            select.value = '';
            notify(`✅ Dodano pole: ${field.label}`, 'success');
        }

        // 🆕 Zapisz dane z formularza dynamicznego
        function saveDynamicFormData() {
            const form = document.querySelector('.dynamic-form');
            if (!form) {
                notify('⚠️ Brak formularza', 'error');
                return;
            }

            const formData = {};
            form.querySelectorAll('.form-control').forEach(input => {
                formData[input.name] = input.value;
            });

            console.log('📋 Dane formularza:', formData);
            console.log('✅ Gotowe do zapisania w bazie (pole do implementacji w następnym kroku)');
            
            // To będzie zintegrowane z importedRecords w następnej wersji
            notify('✅ Dane formularza przygotowane (integracja z bazą w v8.21)', 'success');
        }

        // 🆕 Pobierz (eksportuj) konfigurację pól
        function downloadFieldsConfig() {
            if (!fieldsConfig) {
                notify('⚠️ Config nie załadowany', 'error');
                return;
            }

            const json = JSON.stringify(fieldsConfig, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.href = url;
            link.download = `fields-config_${new Date().toISOString().slice(0, 10)}.json`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            notify('✅ Konfiguracja pobrana', 'success');
        }

        // 🧪 TEST DIAGNOSTYKI: Sprawdź mapowanie kolumn między Supabase a app.imageActs
        function testMappingDiagnostics() {
            if (!app.imageActs || app.imageActs.length === 0) {
                notify('❌ Brak załadowanych aktów. Załaduj najpierw dane (Ładuj Supabase).', 'error');
                return;
            }

            console.clear();
            console.log('🧪 ===== TEST MAPOWANIA KOLUMN SUPABASE =====\n');

            // Weź pierwszy akt
            const firstAct = app.imageActs[0];
            console.log('📊 PIERWSZY AKT:', firstAct.id || firstAct.original_id);
            console.log('─'.repeat(60));

            // Sprawdź jakie pola są załadowane
            console.log('\n✅ ZAŁADOWANE POLA Z SUPABASE:');
            console.log(`  id: ${firstAct.id}`);
            console.log(`  original_id: ${firstAct.original_id}`);
            console.log(`  imageIdx: ${firstAct.imageIdx}`);
            console.log(`  image_path: ${firstAct.image_path}`);

            console.log('\n✅ DZIECKO:');
            console.log(`  child_first_name: ${firstAct.child_first_name}`);
            console.log(`  child_last_name: ${firstAct.child_last_name}`);
            console.log(`  fieldValues.child_first_name: ${firstAct.fieldValues?.child_first_name}`);

            console.log('\n✅ OJCIEC:');
            console.log(`  father_first_name: ${firstAct.father_first_name}`);
            console.log(`  father_last_name: ${firstAct.father_last_name}`);
            console.log(`  fieldValues.father_first_name: ${firstAct.fieldValues?.father_first_name}`);

            console.log('\n✅ MATKA:');
            console.log(`  mother_first_name: ${firstAct.mother_first_name}`);
            console.log(`  mother_last_name: ${firstAct.mother_last_name}`);
            console.log(`  fieldValues.mother_first_name: ${firstAct.fieldValues?.mother_first_name}`);

            console.log('\n✅ NOTATKI:');
            console.log(`  notes: ${firstAct.notes}`);
            console.log(`  notes_org: ${firstAct.notes_org}`);
            console.log(`  fieldValues.notes: ${firstAct.fieldValues?.notes}`);

            console.log('\n✅ WSZYSTKIE POLA W fieldValues:');
            console.log(firstAct.fieldValues);

            console.log('\n─'.repeat(60));
            console.log('📊 ŁĄCZNIE AKTÓW ZAŁADOWANYCH:', app.imageActs.length);

            // Sprawdź ile aktów ma imageIdx
            const withImage = app.imageActs.filter(a => a.imageIdx !== null && a.imageIdx !== undefined).length;
            const withoutImage = app.imageActs.filter(a => a.imageIdx === null || a.imageIdx === undefined).length;
            console.log(`  Z przypisanym obrazem: ${withImage}`);
            console.log(`  Bez przypisanego obrazu: ${withoutImage}`);

            console.log('\n✅ CO BĘDZIE WYSŁANE DO SUPABASE:');
            console.log('  imageidx:', firstAct.imageIdx);
            console.log('  image_path:', firstAct.image_path);
            console.log('  child_first_name:', firstAct.fieldValues?.child_first_name);
            console.log('  father_first_name:', firstAct.fieldValues?.father_first_name);
            console.log('  mother_first_name:', firstAct.fieldValues?.mother_first_name);

            notify('🧪 Test wykonany - sprawdź konsolę (F12) dla detali', 'info');
            console.log('\n✅ TEST ZAKOŃCZONY\n');
        }

        function checkLocalStorage() {
            try {
                const data = localStorage.getItem('genealog_data');
                if (data) {
                    const parsed = JSON.parse(data);
                    const actsCount = parsed.imageActs?.length || 0;
                    const imagesCount = parsed.images?.length || 0;
                    console.log('📊 localStorage data:', { acts: actsCount, images: imagesCount, size: data.length });
                    alert(`Dane w localStorage:\nAkty: ${actsCount}\nObrazy: ${imagesCount}\nRozmiar: ${(data.length/1024).toFixed(1)} KB`);
                } else {
                    console.log('❌ No data in localStorage');
                    alert('Brak danych w localStorage');
                }
            } catch (error) {
                console.error('❌ Error checking localStorage:', error);
                alert('Błąd sprawdzania localStorage: ' + error.message);
            }
        }

        function addImages() {
            console.log('📁 addImages clicked - opening folder picker');
            document.getElementById('folderInput').click();
        }

        function handleFiles(files) {
            console.log('📁 handleFiles called with', files.length, 'files');
            const imageFiles = Array.from(files).filter(f => f.type?.startsWith('image/'));
            console.log('🖼️ Found', imageFiles.length, 'image files');
            let loaded = 0;

            imageFiles.forEach(file => {
                console.log('📄 Processing file:', file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    console.log('✅ File loaded:', file.name, 'data length:', e.target.result.length);
                    app.images.push({
                        name: file.name,
                        relativePath: file.webkitRelativePath || '', // Zachowuje ścieżkę z folderu
                        data: e.target.result
                    });
                    loaded++;
                    if (loaded === imageFiles.length) {
                        console.log('🎉 All images loaded, sorting and updating UI');
                        // Autosort po nazwie po wczytaniu wszystkich plików
                        app.images.sort(naturalSort);
                        updateThumbs();
                        selectImage(0, true); // Wybierz pierwszy (posortowany) - auto
                        notify(`Wczytano ${imageFiles.length} obraz(y) (posortowane)`, 'success');
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // 🆕 FUNKCJE DO INSPEKTOWANIA SCHEMATU BAZY DANYCH
        async function getSupabaseColumns() {
            try {
                console.log('🔍 Pobieranie schematu kolumn z Supabase...');
                
                // Pobierz jeden rekord aby zobaczyć dostępne kolumny
                const { data, error } = await supabase
                    .from('public_imports')
                    .select()
                    .limit(1);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    console.warn('⚠️ Baza jest pusta, nie można sprawdzić kolumn');
                    return [];
                }
                
                const columns = Object.keys(data[0]).sort();
                const timestamp = new Date().toLocaleString('pl-PL', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Zahaszuj w localStorage
                const schemaCache = {
                    columns: columns,
                    count: columns.length,
                    timestamp: timestamp,
                    lastCheck: new Date().getTime()
                };
                localStorage.setItem('supabaseSchema', JSON.stringify(schemaCache));
                
                console.log('✅ Schemat zapisany w cache');
                return { columns, timestamp };
            } catch (err) {
                console.error('❌ Błąd przy pobieraniu schematu:', err);
                return null;
            }
        }

        function showSupabaseSchema() {
            // Sprawdź cache (ważny 24 godziny)
            const cached = localStorage.getItem('supabaseSchema');
            let schemaData = null;
            let isCached = false;
            
            if (cached) {
                schemaData = JSON.parse(cached);
                const age = (new Date().getTime() - schemaData.lastCheck) / 1000 / 60; // minuty
                isCached = age < 1440; // 24h w minutach
            }
            
            if (schemaData && isCached) {
                // Pokaż z cache
                displaySchemaModal(schemaData.columns, schemaData.timestamp, true);
            } else {
                // Pobierz na nowo
                getSupabaseColumns().then(result => {
                    if (result) {
                        displaySchemaModal(result.columns, result.timestamp, false);
                    } else {
                        alert('❌ Nie udało się pobrać schematu bazy. Sprawdź konsolę.');
                    }
                });
            }
        }

        function displaySchemaModal(columns, timestamp, isCached) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.style.zIndex = '10000';
            
            const width = Math.min(800, window.innerWidth - 40);
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.style.width = width + 'px';
            content.style.maxHeight = '80vh';
            content.style.overflowY = 'auto';
            content.style.backgroundColor = '#1e1e1e';
            content.style.color = '#e0e0e0';
            content.style.borderRadius = '8px';
            content.style.padding = '20px';
            content.style.border = '2px solid #9b59b6';
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                    <h2 style="margin: 0; color: #9b59b6;">📋 Schemat Bazy: public_imports</h2>
                    <button onclick="this.closest('.modal').remove()" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">✕</button>
                </div>
                
                <div style="margin-bottom: 15px; font-size: 12px; color: #aaa;">
                    <strong>Ostatnia aktualizacja:</strong> ${timestamp}
                    ${isCached ? '<br><strong style="color: #27ae60;">✓ Z cache (24h)</strong>' : '<br><strong style="color: #3498db;">Świeżo pobrane</strong>'}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong style="font-size: 14px; color: #3498db;">Łącznie kolumn: ${columns.length}</strong>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; margin-top: 15px;">
            `;
            
            columns.forEach((col, idx) => {
                const isImportant = ['child_first_name', 'child_last_name', 'father_first_name', 'father_last_name', 'mother_first_name', 'mother_last_name', 'witnesses', 'imageidx', 'image_path'].includes(col);
                const bgColor = isImportant ? '#27ae60' : '#2c3e50';
                const borderColor = isImportant ? '#2ecc71' : '#444';
                
                html += `
                    <div style="background: ${bgColor}; padding: 10px; border-left: 3px solid ${borderColor}; border-radius: 3px; font-family: monospace; font-size: 12px;">
                        ${isImportant ? '⭐ ' : ''}${col}
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #444; font-size: 12px; color: #aaa;">
                    <p><strong>⭐ Ważne kolumny:</strong> Zaznaczone gwiazdką</p>
                    <p style="margin: 5px 0;">Aby odświeżyć schemat, kliknij guzik ponownie lub wyczyść cache:</p>
                    <button onclick="localStorage.removeItem('supabaseSchema'); alert('✅ Cache wyczyszczony!'); this.closest('.modal').remove();" 
                        style="background: #e67e22; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 3px; font-size: 12px;">
                        🔄 Wyczyść cache i odśwież
                    </button>
                </div>
            `;
            
            content.innerHTML = html;
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            console.log('✅ Schemat wyświetlony:', { columns: columns.length, timestamp, cached: isCached });
        }

        function naturalSort(a, b) {
            return a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'});
        }

        function updateThumbs() {
            const bar = document.getElementById('thumbsBar');
            if (!bar) {
                console.error('❌ thumbsBar element not found!');
                return;
            }
            console.log('🎬 updateThumbs: Creating', app.images.length, 'thumbnails');
            bar.innerHTML = '';
            app.images.forEach((img, i) => {
                const div = document.createElement('div');
                div.className = 'thumbnail' + (i === app.currentImageIdx ? ' active' : '');
                div.dataset.idx = i; // Dodaj index dla tooltipa
                div.onclick = () => selectImage(i);
                const imgEl = document.createElement('img');
                imgEl.src = img.data;
                div.appendChild(imgEl);
                bar.appendChild(div);
            });
            console.log('✅ Thumbnails created:', app.images.length);
            // Dodaj eventy hover do każdej miniaturki
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.addEventListener('mouseenter', (e) => {
                    const idx = e.target.closest('.thumbnail')?.dataset.idx;
                    if (idx === undefined) return;
                    const image = app.images[idx];
                    const filePath = image.relativePath || ''; // Jeśli masz webkitRelativePath z inputu plików
                    const fileName = image.name || 'brak nazwy';
                    const fullInfo = `${filePath ? filePath + '/' : ''}${fileName}`;

                    let tooltip = document.getElementById('fileTooltip');
                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.id = 'fileTooltip';
                        tooltip.className = 'tooltip';
                        document.body.appendChild(tooltip);
                    }
                    tooltip.textContent = fullInfo;
                    tooltip.style.display = 'block';
                    tooltip.style.left = `${e.pageX + 10}px`;
                    tooltip.style.top = `${e.pageY + 10}px`;
                });

                thumb.addEventListener('mousemove', (e) => {
                    const tooltip = document.getElementById('fileTooltip');
                    if (tooltip) {
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY + 10}px`;
                    }
                });

                thumb.addEventListener('mouseleave', () => {
                    const tooltip = document.getElementById('fileTooltip');
                    if (tooltip) tooltip.style.display = 'none';
                });
            });
            updateImageCounter();
        }

        function updateImageCounter() {
            const counter = document.getElementById('imageCounter');
            if (!counter || !app.images.length) return;
            const current = app.currentImageIdx + 1;
            const total = app.images.length;
            const actsCount = app.imageActs.length;
            // Pokaż również liczbę aktów w pamięci
            counter.textContent = `${current}/${total} obrazów • ${actsCount} aktów`;
            
            // Loguj rozmiar pamięci (dla debugowania)
            if (window.performance && window.performance.memory) {
                const memMB = (window.performance.memory.usedJSHeapSize / 1048576).toFixed(1);
                console.log(`💾 Pamięć: ${memMB}MB`);
            }
        }

        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (Array.isArray(data)) {
                            app.imageActs = data;
                            saveStorage();
                            renderUI();
                            notify(`Zaimportowano ${data.length} aktów`, 'success');
                        }
                    } catch (err) {
                        notify(`Błąd importu: ${err.message}`, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function notify(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // ===== LOAD FROM SUPABASE =====
        async function loadFromSupabase() {
            let supabase = window.supabase_client;
            
            // 🆕 Jeśli Supabase nie jest zainicjalizowany, zrób to teraz
            if (!supabase) {
                console.log('🔌 Inicjalizuję Supabase na żądanie...');
                notify('⏳ Inicjalizuję Supabase...', 'info');
                
                // Czekaj na załadowanie biblioteki
                let attempts = 0;
                while (!window.createSupabaseClient && attempts < 100) {
                    await new Promise(r => setTimeout(r, 100));
                    attempts++;
                }
                
                if (window.createSupabaseClient && typeof window.createSupabaseClient === 'function') {
                    window.supabase_client = window.createSupabaseClient(SUPABASE_URL, SUPABASE_KEY);
                    supabase = window.supabase_client;
                    console.log('✅ Supabase zaincjalizowany');
                } else {
                    console.error('❌ Nie udało się załadować Supabase');
                    notify('❌ Nie udało się załadować Supabase', 'error');
                    return;
                }
            }
            
            try {
                notify('⏳ Ładowanie z Supabase...', 'info');
                
                // Licznik postępu
                let counter = document.getElementById('imageCounter');
                if (counter) counter.innerHTML = '⏳ Ładuję z Supabase...';
                
                // Ładuj z public_imports (nowe dane z importera) - z paginacją
                console.log('📥 Loading from public_imports (Supabase)...');
                
                // Najpierw znajdź całkowitą liczbę rekordów
                const { count: totalCount, error: countError } = await supabase
                    .from('public_imports')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    console.error('❌ Count error:', countError);
                    notify(`⚠️ ${countError.message}`, 'error');
                    return;
                }
                
                console.log(`📊 Total records in Supabase: ${totalCount}`);
                
                // Ładuj w batches po 1000 (offset-based pagination)
                let allData = [];
                const pageSize = 1000;
                
                for (let offset = 0; offset < totalCount; offset += pageSize) {
                    const { data, error } = await supabase
                        .from('public_imports')
                        .select('*')
                        .range(offset, offset + pageSize - 1);
                    
                    if (error) {
                        console.error(`❌ Błąd przy offset ${offset}:`, error);
                        break;
                    }
                    
                    if (data && data.length > 0) {
                        allData.push(...data);
                        console.log(`✅ Loaded batch ${offset}-${offset + data.length} (total: ${allData.length}/${totalCount})`);
                        
                        // Update licznik
                        if (counter) {
                            counter.innerHTML = `⏳ Ładuję ${allData.length}/${totalCount}...`;
                        }
                    } else {
                        break;
                    }
                }
                
                console.log(`📂 Załadowano łącznie: ${allData.length} records`);
                
                // FILTER: Tylko prawidłowe rekordy z original_id w formacie CH.LUB.BLIN.*
                let validData = allData.filter(r => r.original_id && r.original_id.startsWith('CH.LUB.BLIN.'));
                console.log(`✅ Prawidłowych rekordów: ${validData.length}/${allData.length}`);
                
                // DEDUPLICATE: Zostawić tylko PIERWSZY rekord dla każdego unique original_id
                const seenOriginalIds = new Set();
                const dedupedData = validData.filter(r => {
                    if (seenOriginalIds.has(r.original_id)) {
                        return false;  // Odrzuć duplikat
                    }
                    seenOriginalIds.add(r.original_id);
                    return true;  // Zachowaj pierwszy
                });
                
                if (dedupedData.length < validData.length) {
                    const removed = validData.length - dedupedData.length;
                    console.log(`🗑️ Usunięto ${removed} duplikatów - zostało ${dedupedData.length} unikalnych aktów`);
                }
                
                validData = dedupedData;  // Zastąp validData przefiltrowaną wersją
                
                if (validData.length === 0) {
                    notify('⚠️ Brak prawidłowych danych w Supabase', 'warning');
                    console.warn('Brak rekordów z original_id w formacie CH.LUB.BLIN.*');
                    return;
                }
                
                // SORT po original_id aby mieć prawidłowy porządek
                validData.sort((a, b) => {
                    const aId = a.original_id || '';
                    const bId = b.original_id || '';
                    return aId.localeCompare(bId, undefined, { numeric: true });
                });
                
                console.log('✅ Posortowano po original_id (format CH.LUB.BLIN.*)');
                
                // Loguj pierwsze 3 akty aby sprawdzić co się załadowało
                if (validData.length > 0) {
                    console.log('📍 Pierwsze 3 akty z bazy (po filtrowaniu):');
                    for (let i = 0; i < Math.min(3, validData.length); i++) {
                        const row = validData[i];
                        console.log(`  [${i}] original_id: ${row.original_id}, child: ${row.child_first_name || 'brak'}`);
                    }
                }
                
                const data = validData;  // Użyj przefiltrowanych i posortowanych danych
                const error = null;
                
                if (error) {
                    console.error('❌ Supabase error:', error);
                    notify(`⚠️ ${error.message}`, 'error');
                    return;
                }

                if (!data || data.length === 0) {
                    notify('⚠️ Brak danych w Supabase', 'warning');
                    console.warn('Brak rekordów w public_imports');
                    return;
                }

                // Przygotuj dane do załadowania - mapowanie FLAT STRUCTURE z Supabase na internal app format
                const imageActs = data.map((row, idx) => {
                    // Zawsze używaj original_id (CH.LUB.BLIN.YEAR.NR format) - to jest główny ID
                    const id = row.original_id || row.id || `CH.LUB.BLIN.${row.christening_year || '????'}.${row.christening_act_number || (idx + 1).toString().padStart(3, '0')}`;
                    
                    // ===== FIX: Ensure originalId exists (UUID) =====
                    // Jeśli baza nie ma UUID, generujemy nowy dla każdego aktu
                    let originalId = row.original_id_uuid || row.originalId;
                    if (!originalId || originalId.includes('CH.LUB.BLIN')) {
                        // original_id w bazie zawiera CH.LUB.BLIN - to jest displayId, nie UUID
                        // Generujemy nowy UUID dla tego aktu
                        originalId = crypto.randomUUID();
                        console.log(`📝 Generated new UUID for ${row.original_id}: ${originalId}`);
                    }
                    
                    // 🔧 FIX: Przechowaj oryginalne actNum z bazy - nie regeneruj sekwencyjnie!
                    // actNum to unikalny ID aktu w systemie, zmienia się go BARDZO rzadko (praktycznie nigdy)
                    // Jeśli baza ma act_number, używaj go; jeśli nie, wtedy dopiero przypisuj idx+1
                    const originalActNum = row.act_number || row.actNum;
                    const sequentialActNum = originalActNum ? parseInt(originalActNum, 10) : (idx + 1);
                    
                    return {
                        id: id,
                        originalId: originalId,  // ===== UUID (nowy) =====
                        displayId: id,           // ===== CH.LUB.BLIN.1783.002 (z bazy) =====
                        original_id: row.original_id,  // Keep for compatibility
                        type: 'christening', // Wszystkie importowane to chrzty
                        source: row.source || 'Supabase',
                        imageIdx: row.imageidx !== undefined && row.imageidx !== null ? row.imageidx : null,  // 🔧 FIX: null zamiast 0, aby użytkownik sam wybrał obraz!
                        image_path: row.image_path || '',  // Załaduj ścieżkę obrazu z bazy!
                        actNum: sequentialActNum, // ⭐ Przechowaj z bazy jeśli istnieje, inaczej użyj idx+1
                        
                        // fieldValues object - MAPUJ pola z Supabase na nazwy które formularz oczekuje
                        fieldValues: {
                            // Podstawowe pola (rok, nr_aktu, data_zgłoszenia są parsowane z ID)
                            rok: row.christening_year || '',
                            nr_aktu: row.christening_act_number || '',
                            data_zgloszenia: row.christening_year + '.**.--.',  // Placeholder format
                            
                            // Dziecko
                            child_first_name: row.child_first_name || '',
                            child_last_name: row.child_last_name || '',
                            child_birth_date: row.child_birth_date || '',
                            
                            // Ojciec
                            father_first_name: row.father_first_name || '',
                            father_last_name: row.father_last_name || '',
                            father_age: row.father_age || '',
                            
                            // Matka
                            mother_first_name: row.mother_first_name || '',
                            mother_last_name: row.mother_last_name || '',
                            mother_maiden_name: row.mother_maiden_name || '',
                            mother_age: row.mother_age || '',
                            
                            // Osoba zgłaszająca i świadkowie
                            witnesses: row.witnesses || '',
                            
                            // Notatki
                            notes: row.notes || '',
                            notes_org: row.notes_org || '',
                            location: row.location || '',
                            
                            // Oryginalne pola Supabase (zachowaj też dla kompatybilności)
                            christening_year: row.christening_year || '',
                            christening_act_number: row.christening_act_number || ''
                        },
                        
                        // Flat fields too (dla wyświetlania)
                        christening_year: row.christening_year || '',
                        christening_act_number: row.christening_act_number || '',
                        child_first_name: row.child_first_name || '',
                        child_last_name: row.child_last_name || '',
                        child_birth_date: row.child_birth_date || '',
                        father_first_name: row.father_first_name || '',
                        father_last_name: row.father_last_name || '',
                        father_age: row.father_age || '',
                        mother_first_name: row.mother_first_name || '',
                        mother_last_name: row.mother_last_name || '',
                        mother_age: row.mother_age || '',
                        notes: row.notes || '',
                        notes_org: row.notes_org || '',
                        location: row.location || ''
                    };
                });

                // Załaduj do app
                app.imageActs = imageActs;
                console.log('📂 Loaded from Supabase:', imageActs.length, 'records');
                
                // Aktualizuj licznik w toolbar
                counter = document.getElementById('imageCounter');
                if (counter) {
                    counter.innerHTML = `📊 <strong>${imageActs.length} aktów</strong> / 6040 (${Math.round(imageActs.length/6040*100)}%)`;
                    counter.style.color = imageActs.length === 6040 ? '#0f0' : (imageActs.length > 5000 ? '#ff0' : '#f00');
                }
                
                updateThumbs();
                renderRecordsTable(); // Wyświetl dane w tabeli
                if (app.images.length > 0) selectImage(0, true);
                
                notify(`✅ Załadowano ${imageActs.length} aktów z Supabase (BEZ LIMITÓW!)`, 'success');
                
            } catch (error) {
                console.error('❌ Error loading from Supabase:', error);
                notify(`❌ Błąd: ${error.message}`, 'error');
            }
        }

        // Stara funkcja - dla kompatybilności
        async function loadFromFirestore() {
            return loadFromSupabase();
        }
        
        // 🆕 Udostępnij loadFromSupabase dla kodu z F12
        window.loadFromSupabase = loadFromSupabase;

        // Funkcja migracji danych - nieużywana (baza na dysku)
        async function exportFromLocalStorageToSupabase() {
            const supabase = window.supabase_client;
            if (!supabase) {
                console.error('❌ Supabase nie jest zainicjalizowany');
                notify('❌ Supabase nie jest dostępny', 'error');
                return;
            }

            const stored = localStorage.getItem('genealog_data');
            if (!stored) {
                console.log('ℹ️ Brak danych w localStorage do migracji');
                notify('ℹ️ Brak danych do zapisania', 'info');
                return;
            }
            
            try {
                notify('⏳ Zapisywanie do Supabase...', 'info');
                const data = JSON.parse(stored);
                console.log('🔄 Migruję dane do Supabase');
                
                // Migruj imageActs do tabeli public_imports
                let imported = 0;
                for (const act of data.imageActs || []) {
                    try {
                        const { error } = await supabase.from('public_imports').insert({
                            id: act.id || crypto.randomUUID(),
                            christening_year: parseInt(act.rok || act.year || 0),
                            christening_act_number: act.nr || act.number || '',
                            image_path: act.imagePath || act.image_path || '',
                            imageidx: parseInt(act.imageIndex || 0)
                        });
                        
                        if (!error) {
                            imported++;
                            console.log(`✅ Zmigrowano: ${act.id}`);
                        } else {
                            console.warn(`⚠️ Błąd przy rekordzie ${act.id}:`, error.message);
                        }
                    } catch (e) {
                        console.warn('⚠️ Pominięto rekord:', e.message);
                    }
                }
                
                console.log(`✅ Zmigrowano ${imported} rekordów do Supabase`);
                notify(`✅ Zmigrowano ${imported} rekordów`, 'success');
            } catch (error) {
                console.error('❌ Błąd migracji:', error);
                notify('❌ Błąd migracji do Supabase', 'error');
            }
        }

        async function checkActInSupabase(actId) {
            const supabase = window.supabase_client;
            if (!supabase || !actId) {
                console.log('[Diagnostyka] Brak Supabase lub ID');
                return;
            }
            
            const { data, error } = await supabase.from('public_imports').select('id, image_path, imageidx, christening_year, christening_act_number').eq('id', actId);
            
            if (error) {
                console.error('[Diagnostyka] Błąd:', error);
            } else if (data && data.length > 0) {
                const act = data[0];
                console.log(`[Diagnostyka] Akt ${actId}:`, {
                    image_path: act.image_path || '(brak)',
                    imageidx: act.imageidx,
                    rok: act.christening_year,
                    nr: act.christening_act_number
                });
            } else {
                console.log(`[Diagnostyka] Akt ${actId} nie znaleziony w bazie Supabase`);
                console.log(`[Diagnostyka] Sprawdzam localStorage...`);
                
                // Sprawdź localStorage
                const stored = localStorage.getItem('genealog_data');
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        const actInStorage = data.imageActs?.find(a => a.id === actId || a.original_id === actId);
                        if (actInStorage) {
                            console.log(`[Diagnostyka] Znaleźliśmy w localStorage:`, actInStorage.fieldValues || actInStorage);
                            console.log(`[Diagnostyka] Możesz uruchomić: migrateLocalStorageToSupabase()`);
                        } else {
                            console.log(`[Diagnostyka] Nie ma w localStorage`);
                        }
                    } catch (e) {
                        console.error('[Diagnostyka] Błąd przy czytaniu localStorage:', e);
                    }
                } else {
                    console.log('[Diagnostyka] Brak localStorage');
                }
            }
        }
        
        async function migrateLocalStorageToSupabase() {
            const supabase = window.supabase_client;
            const stored = localStorage.getItem('genealog_data');
            
            if (!stored) {
                console.log('[Migracja] Brak danych w localStorage');
                return;
            }
            
            try {
                const data = JSON.parse(stored);
                const acts = data.imageActs || [];
                console.log(`[Migracja] Znaleziono ${acts.length} aktów w localStorage`);
                
                let count = 0;
                for (const act of acts) {
                    if (!act.id) continue;
                    
                    // Przygotuj dane do wysłania
                    const fieldValues = act.fieldValues || {};
                    const actData = {
                        id: act.id,
                        christening_year: fieldValues.rok || act.christening_year,
                        christening_act_number: fieldValues.nr_aktu || act.christening_act_number,
                        child_first_name: fieldValues.dziecko_imie || act.child_first_name,
                        child_last_name: fieldValues.dziecko_nazwisko || act.child_last_name,
                        child_birth_date: fieldValues.dziecko_data_ur || act.child_birth_date,
                        father_first_name: fieldValues.ojciec_imie || act.father_first_name,
                        father_last_name: fieldValues.ojciec_nazwisko || act.father_last_name,
                        father_age: fieldValues.ojciec_wiek || act.father_age,
                        mother_first_name: fieldValues.matka_imie || act.mother_first_name,
                        mother_last_name: fieldValues.matka_nazwisko || act.mother_last_name,
                        mother_maiden_name: fieldValues.matka_panienskie || act.mother_maiden_name,
                        mother_age: fieldValues.matka_lata || act.mother_age,
                        location: fieldValues.matka_miejsce || act.location,
                        notes: fieldValues.custom_note || act.notes,
                        notes_org: fieldValues.notes_org || act.notes_org,
                        imageidx: act.imageIdx || 0,
                        image_path: act.image_path || ''
                    };
                    
                    const { error } = await supabase.from('public_imports').upsert(actData, { onConflict: 'id' });
                    if (!error) count++;
                    if (error) console.error(`[Migracja] Błąd dla ${act.id}:`, error);
                }
                
                console.log(`[Migracja] Przesłano ${count}/${acts.length} aktów do Supabase`);
                notify(`Przesłano ${count} aktów do bazy`, 'success');
            } catch (e) {
                console.error('[Migracja] Błąd:', e);
                notify(`Błąd migracji: ${e.message}`, 'error');
            }
        }
        
        
        async function migrateBrowserMemoryToSupabase() {
            const supabase = window.supabase_client;
            const acts = app.imageActs || [];
            
            if (!acts.length) {
                console.log('[Migracja RAM] Brak aktów w app.imageActs');
                return;
            }
            
            console.log(`[Migracja RAM] Znaleziono ${acts.length} aktów w RAM (app.imageActs)`);
            
            let count = 0;
            let errors = 0;
            const batchSize = 50;  // Wysyłaj po 50 aktów na raz
            const delayMs = 500;   // Czekaj 500ms między batches
            
            for (let i = 0; i < acts.length; i += batchSize) {
                const batch = acts.slice(i, i + batchSize);
                console.log(`[Migracja RAM] Batch ${Math.floor(i/batchSize)+1}: wysyłam ${batch.length} aktów...`);
                
                for (const act of batch) {
                    if (!act.id) continue;
                    
                    const fieldValues = act.fieldValues || {};
                    const actData = {
                        id: act.id,
                        christening_year: fieldValues.rok || act.christening_year,
                        christening_act_number: fieldValues.nr_aktu || act.christening_act_number,
                        child_first_name: fieldValues.dziecko_imie || act.child_first_name,
                        child_last_name: fieldValues.dziecko_nazwisko || act.child_last_name,
                        child_birth_date: fieldValues.dziecko_data_ur || act.child_birth_date,
                        father_first_name: fieldValues.ojciec_imie || act.father_first_name,
                        father_last_name: fieldValues.ojciec_nazwisko || act.father_last_name,
                        father_age: fieldValues.ojciec_wiek || act.father_age,
                        mother_first_name: fieldValues.matka_imie || act.mother_first_name,
                        mother_last_name: fieldValues.matka_nazwisko || act.mother_last_name,
                        mother_maiden_name: fieldValues.matka_panienskie || act.mother_maiden_name,
                        mother_age: fieldValues.matka_lata || act.mother_age,
                        location: fieldValues.matka_miejsce || act.location,
                        notes: fieldValues.custom_note || act.notes,
                        notes_org: fieldValues.notes_org || act.notes_org,
                        imageidx: act.imageIdx || 0,
                        image_path: act.image_path || ''
                    };
                    
                    try {
                        const { error } = await supabase.from('public_imports').upsert(actData, { onConflict: 'id' });
                        if (!error) {
                            count++;
                        } else {
                            errors++;
                            if (errors <= 5) console.error(`[Migracja RAM] Błąd dla ${act.id}:`, error.message);
                        }
                    } catch (e) {
                        errors++;
                        if (errors <= 5) console.error(`[Migracja RAM] Exception dla ${act.id}:`, e.message);
                    }
                }
                
                // Czekaj między batches aby nie przeciążyć serwera
                if (i + batchSize < acts.length) {
                    console.log(`[Migracja RAM] Czekam ${delayMs}ms...`);
                    await new Promise(r => setTimeout(r, delayMs));
                }
            }
            
            console.log(`[Migracja RAM] GOTOWE - OK: ${count}, Błędy: ${errors}/${acts.length}`);
            notify(`Przesłano ${count}/${acts.length} aktów (błędy: ${errors})`, count > 0 ? 'success' : 'warning');
        }

        // 🆕 NOWA FUNKCJA: Zapisz zmiany do Supabase (UPDATE istniejących rekordów)
        async function saveChangesToSupabase() {
            const supabase = window.supabase_client;
            if (!supabase) {
                console.warn('⚠️ Supabase nie dostępny - zapisuję tylko do localStorage');
                return;
            }

            if (!app.imageActs || app.imageActs.length === 0) {
                console.log('ℹ️ Brak aktów do zapisania');
                return;
            }

            console.log('💾 Wysyłam zmiany do Supabase...');
            let updatedCount = 0;
            let errors = 0;

            for (const act of app.imageActs) {
                try {
                    const actId = act.id || act.original_id;
                    if (!actId) continue;

                    // 🆕 MAPUJ fieldValues na kolumny Supabase (matching loadFromSupabase())
                    const fv = act.fieldValues || {};
                    const updateData = {
                        // Podstawowe pola
                        imageidx: act.imageIdx !== undefined && act.imageIdx !== null ? parseInt(act.imageIdx) : null,
                        image_path: act.image_path || null,
                        christening_year: parseInt(act.rok || act.year || fv.rok || 0),
                        christening_act_number: act.nr || act.christening_act_number || fv.nr_aktu || fv.nr || '',
                        
                        // 🆕 Dziecko (z fieldValues)
                        child_first_name: fv.child_first_name || fv.dziecko_imie || '',
                        child_last_name: fv.child_last_name || fv.dziecko_nazwisko || '',
                        child_birth_date: fv.child_birth_date || '',
                        
                        // 🆕 Ojciec (z fieldValues)
                        father_first_name: fv.father_first_name || fv.ojciec_imie || '',
                        father_last_name: fv.father_last_name || fv.ojciec_nazwisko || '',
                        father_age: fv.father_age || fv.ojciec_wiek || '',
                        
                        // 🆕 Matka (z fieldValues)
                        mother_first_name: fv.mother_first_name || fv.matka_imie || '',
                        mother_last_name: fv.mother_last_name || fv.matka_nazwisko || '',
                        mother_maiden_name: fv.mother_maiden_name || '',
                        mother_age: fv.mother_age || fv.matka_lata || '',
                        
                        // 🆕 Notatki i świadkowie (z fieldValues)
                        notes: fv.notes || fv.uwagi || '',
                        notes_org: fv.notes_org || fv.uwagi_org || '',
                        witnesses: fv.witnesses || '',
                        location: fv.location || fv.miejscowosc || ''
                    };

                    console.log(`📤 Wysyłam do Supabase (${actId}):`, {
                        imageidx: updateData.imageidx,
                        image_path: updateData.image_path,
                        child: updateData.child_first_name,
                        father: updateData.father_first_name
                    });

                    // 🔧 FIX: UPDATE w Supabase używając proper klucza (original_id lub id)
                    let updateResult = await supabase
                        .from('public_imports')
                        .update(updateData)
                        .eq('original_id', actId);  // 🆕 Spróbuj original_id pierwszy

                    // Jeśli nie znaleziono - spróbuj id
                    if (updateResult.error && updateResult.error.message.includes('no rows')) {
                        console.log(`⚠️ original_id nie znalezione, próbuję id...`);
                        updateResult = await supabase
                            .from('public_imports')
                            .update(updateData)
                            .eq('id', actId);
                    }

                    const { error } = updateResult;

                    if (!error) {
                        updatedCount++;
                        console.log(`✅ Zaktualizowano akt: ${actId} (imageIdx: ${act.imageIdx}, obraz: ${act.image_path})`);
                    } else {
                        console.warn(`⚠️ Błąd przy akcie ${actId}:`, error.message);
                        errors++;
                    }
                } catch (e) {
                    console.error('❌ Wyjątek:', e.message);
                    errors++;
                }
            }

            console.log(`💾 Zapisano do Supabase: ${updatedCount}/${app.imageActs.length} (błędy: ${errors})`);
            notify(`💾 Zapisano ${updatedCount} zmian do Supabase`, updatedCount > 0 ? 'success' : 'warning');
            return updatedCount > 0;
        }

        function saveStorage() {
            // Zapisuj akt do LOKALNEJ BAZY (sql.js), nie do Supabase
            console.log('💾 saveStorage() called, currentActNum:', app.currentActNum);
            const currentAct = app.imageActs.find(a => a.actNum === app.currentActNum);
            console.log('💾 currentAct found:', !!currentAct);
            if (!currentAct) {
                console.warn('⚠️ Nie znaleziono bieżącego aktu');
                return;
            }
            
            // ===== FIX: Ensure original_id exists =====
            if (!currentAct.originalId) {
                currentAct.originalId = crypto.randomUUID();
                console.log('📝 Generated new originalId:', currentAct.originalId);
            }
            if (!currentAct.displayId) {
                currentAct.displayId = currentAct.id || 'UNKNOWN';
                console.log('📝 Set displayId:', currentAct.displayId);
            }
            
            // ===== ZAPISZ DO LOKALNEJ BAZY (sql.js) =====
            console.log('💾 Zapisuję do lokalnej bazy SQL...');
            saveActToLocalDB(currentAct);
            
            notify(`Akt ${currentAct.displayId} zapisany do lokalnej bazy`, 'success');
            renderRecordsTable();
            console.log('✅ Tabela odświeżona po zapisie');
        }

        async function loadStorage() {
            // Ładuj z lokalnej bazy SQL
            console.log('🔄 Loading storage from local SQL.js...');
            app.imageActs = []; // Clear old data FIRST
            const localActs = loadActsFromLocalDB(); // Ładuj z sql.js
            
            if (localActs && localActs.length > 0) {
                app.imageActs = localActs;
                console.log(`✅ Wczytano ${localActs.length} aktów z lokalnej bazy`);
            } else {
                console.warn('⚠️ Brak aktów w lokalnej bazie');
            }
            
            updateThumbs();
            renderRecordsTable(); // Wyświetl dane w tabeli
            if (app.images.length > 0) selectImage(0, true);
        }
        
        function toggleFloatingForm(show = null) {
            const form = document.getElementById('floatingForm');
            const current = form.classList.contains('visible');
            const target = show === null ? !current : show;
            
            if (target) {
                form.classList.add('visible');
                document.getElementById('floatingActNum').textContent = app.currentActNum || '?';
                renderFloatingForm();
                positionFloatingFormNearAct();
            } else {
                form.classList.remove('visible');
            }
        }
        function renderFloatingForm() {
            const container = document.getElementById('floatingFormContent');
            if (!container) {
                console.warn('❌ floatingFormContent not found in DOM');
                return;
            }
            container.innerHTML = '';

            const act = getCurrentAct();
            if (!act) {
                container.innerHTML = '<p>Brak wybranego aktu</p>';
                return;
            }
            
            console.log('📋 renderFloatingForm - act:', act);
            console.log('📋 act.type:', act.type);
            console.log('📋 app.templates:', app.templates ? app.templates.map(t => t.id) : 'UNDEFINED');

            // ===== SELECTOR TYPU AKTU – DROPDOWN W HEADERZE =====
            const header = document.createElement('div');
            header.style.cssText = 'padding: 12px; background: #252525; border-bottom: 1px solid #3a3a3a; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center; gap: 12px;';
            
            const titleSpan = document.createElement('span');
            // Pokaż skrót do indeksacji (CH.1783.No.1) z pełnym ID w tooltip
            titleSpan.textContent = 'Akt: ' + act.actNum + ' (' + (act.original_id || act.id) + ')';
            titleSpan.style.cssText = 'color: #0078d4; font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
            titleSpan.title = 'ID źródłowe: ' + (act.original_id || act.id);
            
            const typeSelect = document.createElement('select');
            typeSelect.style.cssText = 'padding: 4px 6px; background: #1a1a1a; border: 1px solid #0078d4; color: #ddd; border-radius: 3px; font-size: 11px; flex: 1;';
            typeSelect.innerHTML = app.templates.map(t => 
                `<option value="${t.id}" ${t.id === act.type ? 'selected' : ''}>${t.name}</option>`
            ).join('');
            
            typeSelect.addEventListener('change', (e) => {
                console.log('✅ Select change event - new type:', e.target.value);
                act.type = e.target.value;
                saveStorage();
                renderFloatingForm();
            });
            
            header.appendChild(titleSpan);
            header.appendChild(typeSelect);
            container.appendChild(header);

            // ===== ŁADUJEMY SZABLON DLA AKTUALNEGO TYPU =====
            const template = app.templates.find(t => t.id === act.type);
            if (!template) {
                console.error('❌ Template not found for type:', act.type);
                console.error('Available templates:', app.templates.map(t => t.id));
                container.innerHTML += '<p style="color: #888;">Brak szablonu dla tego typu: ' + act.type + '</p>';
                return;
            }
            console.log('✅ Template loaded:', template.name);

            // ===== RENDERUJ SEKCJE I POLA =====
            template.sections.forEach(sec => {
                const secDiv = document.createElement('div');
                secDiv.style.marginBottom = '12px';
                
                const secTitle = document.createElement('div');
                secTitle.innerHTML = sec.title || sec.id;
                secTitle.style.cssText = 'color: #0078d4; font-weight: 600; font-size: 11px; margin-bottom: 6px; border-bottom: 1px solid #2a2a2a; padding-bottom: 4px;';
                secDiv.appendChild(secTitle);

                sec.fields.forEach(f => {
                    // Filtrujemy pola – jeśli mają applicableTypes, sprawdzamy czy pasują
                    if (f.applicableTypes && !f.applicableTypes.includes(act.type)) {
                        return;  // Pomiń pole jeśli nie pasuje do typu
                    }

                    const group = document.createElement('div');
                    group.className = 'form-group';
                    group.style.marginBottom = '8px';
                    
                    const label = document.createElement('label');
                    label.textContent = f.label;
                    label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 3px;';
                    group.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = f.type || 'text';
                    input.className = 'field-input';
                    input.dataset.field = f.id;
                    input.placeholder = f.label;
                    input.value = act.fieldValues[f.id] || '';
                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                    
                    if (act.fieldROIs && act.fieldROIs[f.id]) {
                        input.classList.add('has-roi');
                        input.style.borderLeft = '4px solid #10b981';
                    }
                    
                    input.addEventListener('input', (e) => {
                        act.fieldValues[f.id] = e.target.value;
                        updateCurrentRowInTable(); // Aktualizuj tabelę na żywo
                        saveStorage();
                    });
                    
                    // Enter zatwierdza edycję i cofa focus
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            input.blur();
                        }
                    });
                    
                    group.appendChild(input);
                    secDiv.appendChild(group);
                });

                container.appendChild(secDiv);
            });

            // ===== PRZYCISK "DODAJ NIESTANDARDOWE POLE" =====
            const addFieldDiv = document.createElement('div');
            addFieldDiv.style.marginTop = '12px';
            addFieldDiv.style.paddingTop = '12px';
            addFieldDiv.style.borderTop = '1px solid #2a2a2a';

            const addBtn = document.createElement('button');
            addBtn.textContent = '+ Dodaj pole';
            addBtn.style.cssText = 'background: #252525; border: 1px solid #3a3a3a; color: #ddd; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 10px; width: 100%;';
            
            addBtn.addEventListener('click', () => {
                const fieldId = prompt('ID pola (np. custom_note):');
                if (!fieldId) return;
                
                const fieldLabel = prompt('Nazwa pola:', fieldId);
                if (!fieldLabel) return;
                
                // Dodaj pole do aktualnego aktu
                if (!act.fieldValues) act.fieldValues = {};
                act.fieldValues[fieldId] = '';
                
                saveStorage();
                renderFloatingForm();  // Odśwież z nowym polem
            });

            addFieldDiv.appendChild(addBtn);
            container.appendChild(addFieldDiv);

            // Focus na pierwsze pole
            container.querySelector('.field-input')?.focus();
        }
        function positionFloatingFormNearAct() {
            const form = document.getElementById('floatingForm');
            const act = getCurrentAct();
            if (!act?.actROI || !app.viewer) {
                form.style.top = '50px';
                form.style.left = '50px';
                return;
            }
            
            const item = app.viewer.world.getItemAt(0);
            if (!item) return;
            
            try {
                const size = item.getContentSize();
                const centerX = (act.actROI.x + act.actROI.w / 2) * size.x;
                const centerY = (act.actROI.y + act.actROI.h / 2) * size.y;
                
                const point = item.imageToViewportCoordinates(centerX, centerY);
                const pixel = app.viewer.viewport.viewportToViewerElementCoordinates(point);
                
                form.style.top = `${Math.max(20, pixel.y - 200)}px`;
                form.style.left = `${Math.max(20, pixel.x + 20)}px`;
            } catch (err) {
                // Fallback do domyślnej pozycji
                form.style.top = '50px';
                form.style.left = '50px';
            }
        }
        
        function createPinupForField(fieldId) {
            const act = getCurrentAct();
            if (!act?.fieldROIs || !act.fieldROIs[fieldId]) return;

            const roi = act.fieldROIs[fieldId];
            const item = app.viewer.world.getItemAt(0);
            if (!item) return;

            try {
                const size = item.getContentSize();
                // Środek dolnej krawędzi ROI – najlepsze miejsce na pin-up
                const centerX = (roi.x + roi.w / 2) * size.x;
                const bottomY = (roi.y + roi.h) * size.y;

                const point = item.imageToViewportCoordinates(centerX, bottomY);
                const pixel = app.viewer.viewport.viewportToViewerElementCoordinates(point);

                // Szukaj labela pola - normalizuj fieldId (zamień kropki na podkreślenia)
                const normalizedFieldId = fieldId.replace(/\./g, '_');
                let fieldLabel = null;
                
                // Szukaj w bieżącym szablonie
                const template = app.templates.find(t => t.id === app.currentTemplate);
                if (template) {
                    for (let sec of template.sections) {
                        const f = sec.fields.find(fld => fld.id === normalizedFieldId);
                        if (f) { fieldLabel = f.label; break; }
                    }
                }
                
                // Jeśli nie znaleziono, szukaj we wszystkich szablonach
                if (!fieldLabel) {
                    for (let tpl of app.templates) {
                        for (let sec of tpl.sections) {
                            const f = sec.fields.find(fld => fld.id === normalizedFieldId);
                            if (f) { fieldLabel = f.label; break; }
                        }
                        if (fieldLabel) break;
                    }
                }
                
                // Fallback - pokaż normalizedFieldId jeśli nie znaleziono labela
                if (!fieldLabel) {
                    fieldLabel = normalizedFieldId;
                }
                
                // Pobierz nazwę aktu
                const actDisplayName = formatActDisplayName(act);

                const container = document.getElementById('fieldPinupsContainer');
                let pinup = container.querySelector(`[data-field="${fieldId}"]`);
                
                if (pinup) {
                    // Jeśli już istnieje – tylko przesuń i zaznacz
                    pinup.style.top = `${pixel.y + 15}px`;
                    pinup.style.left = `${Math.max(10, pixel.x - 130)}px`;
                    pinup.querySelector('input').focus();
                    pinup.querySelector('input').select();
                    return;
                }

                pinup = document.createElement('div');
                pinup.className = 'field-pinup';
                pinup.dataset.field = fieldId;

                // Pozycjonowanie: pod ROI, wyśrodkowany
                pinup.style.top = `${pixel.y + 15}px`;
                pinup.style.left = `${Math.max(10, pixel.x - 130)}px`;

                pinup.innerHTML = `
                    <div class="field-pinup-header" style="background: #0078d4; color: white; padding: 6px 8px; border-radius: 3px 3px 0 0; font-weight: bold; font-size: 12px; margin-bottom: 4px;">
                        ${actDisplayName}
                    </div>
                    <div style="padding: 4px 6px; background: #1a1a1a; border-bottom: 1px solid #3a3a3a; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #aaa; font-size: 10px;">${fieldLabel}</span>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <button class="ocr-btn" title="OCR – spróbuj odczytać tekst z ROI" 
                                    onclick="runOCRForPinup(this.closest('.field-pinup'))"
                                    style="padding: 2px 4px; font-size: 10px;">
                                <i class="fas fa-wand-magic-sparkles"></i>
                            </button>
                            <button class="field-pinup-close" onclick="this.closest('.field-pinup').remove()" style="padding: 0 2px;">&times;</button>
                        </div>
                    </div>
                    <input type="text" 
                           value="${(act.fieldValues[fieldId] || '').replace(/"/g, '&quot;')}" 
                           placeholder="${fieldLabel}"
                           data-field="${fieldId}"
                           style="width: 100%; padding: 4px; background: #1a1a1a; color: #ddd; border: 1px solid #3a3a3a; border-radius: 2px; font-size: 11px;"
                           ${act.fieldROIs[fieldId] ? 'class="has-roi"' : ''}>
                    <div class="ocr-suggestions" style="margin-top:6px; font-size:11px; color:#aaa; display:none;"></div>
                `;

                makeElementDraggable(pinup);

                const input = pinup.querySelector('input');
                input.addEventListener('blur', (e) => {
                    act.fieldValues[fieldId] = e.target.value.trim();
                    updateCurrentRowInTable(); // Aktualizuj tabelę na żywo
                    saveStorage();

                    // Aktualizuj pole w prawym panelu i floating form
                    document.querySelectorAll(`.field-input[data-field="${fieldId}"]`).forEach(inp => {
                        inp.value = e.target.value;
                    });
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur(); // Blur zamiast notify
                    }
                });

                container.appendChild(pinup);
                input.focus();
                input.select(); // zaznacz całą treść
            } catch (err) {
                console.error('Błąd pin-up:', err);
            }
        }
        
        function makeElementDraggable(element) {
            let offsetX = 0, offsetY = 0;
            
            element.addEventListener('mousedown', (e) => {
                // Nie przeciągaj jeśli klikasz na input
                if (e.target.tagName === 'INPUT') return;
                
                offsetX = e.clientX - element.offsetLeft;
                offsetY = e.clientY - element.offsetTop;
                
                const moveFn = (moveEvent) => {
                    element.style.left = `${moveEvent.clientX - offsetX}px`;
                    element.style.top = `${moveEvent.clientY - offsetY}px`;
                };
                
                const upFn = () => {
                    document.removeEventListener('mousemove', moveFn);
                    document.removeEventListener('mouseup', upFn);
                };
                
                document.addEventListener('mousemove', moveFn);
                document.addEventListener('mouseup', upFn);
            });
        }
        
        function clearPinups() {
            const container = document.getElementById('fieldPinupsContainer');
            container.innerHTML = '';
        }
        
        function startWizard() {
            if (!app.currentActNum || app.wizardActive) return;

            const template = app.templates.find(t => t.id === app.currentTemplate);
            if (!template) return;

            // Zbierz wszystkie pola z szablonu
            app.wizardFields = template.sections.flatMap(sec => sec.fields);
            app.wizardCurrentFieldIdx = 0;
            app.wizardActive = true;

            // Pokaż progress bar
            const progress = document.getElementById('wizardProgress');
            progress.classList.add('visible');
            document.getElementById('wizardTotal').textContent = app.wizardFields.length;

            clearPinups();
            processNextField();
        }
        
        function processNextField() {
            if (app.wizardCurrentFieldIdx >= app.wizardFields.length) {
                endWizard();
                return;
            }

            const field = app.wizardFields[app.wizardCurrentFieldIdx];
            app.activeField = { dataset: { field: field.id } };

            // Włącz tryb ROI jeśli wyłączony
            if (!app.roiMode) toggleROI();

            // Pokaż prompt
            const prompt = document.getElementById('wizardPrompt');
            document.getElementById('wizardMessage').textContent = `Zaznacz ROI dla: ${field.label}`;
            prompt.classList.add('visible');

            // Aktualizuj progress
            document.getElementById('wizardStep').textContent = app.wizardCurrentFieldIdx + 1;
            const progress = (app.wizardCurrentFieldIdx + 1) / app.wizardFields.length * 100;
            document.getElementById('wizardProgressFill').style.width = `${progress}%`;

            // Czekaj na zaznaczenie ROI - użyj addEventListener zamiast nadpisywania onmouseup
            const waitForROI = (e) => {
                if (app.drawingROI) return; // jeszcze rysuje

                const act = getCurrentAct();
                if (!act || !act.fieldROIs || !act.fieldROIs[field.id]) return;

                // Usuń listener - już mamy ROI
                app.drawingCanvas.removeEventListener('mouseup', waitForROI);

                prompt.classList.remove('visible');

                // Otwórz pin-up do wpisania danych
                setTimeout(() => {
                    createPinupForField(field.id);
                    
                    const pinupInput = document.querySelector(`.field-pinup[data-field="${field.id}"] input`);
                    if (pinupInput) {
                        // Przejdź do następnego pola po blur (opuszczeniu input)
                        pinupInput.addEventListener('blur', () => {
                            app.wizardCurrentFieldIdx++;
                            processNextField();
                        }, { once: true });
                    }
                }, 100);
            };

            // Dodaj listener dla tego pola
            app.drawingCanvas.addEventListener('mouseup', waitForROI);
        }
        
        function skipCurrentField() {
            document.getElementById('wizardPrompt').classList.remove('visible');
            app.wizardCurrentFieldIdx++;
            processNextField();
            notify('Pole pominięte', 'info');
        }

        function endWizard() {
            app.wizardActive = false;
            
            // Wyłącz ROI i progress bar
            if (app.roiMode) toggleROI();
            document.getElementById('wizardPrompt').classList.remove('visible');
            document.getElementById('wizardProgress').classList.remove('visible');
            
            saveRecord();
            notify(`Wizard zakończony – ${app.wizardFields.length} pól zindeksowane!`, 'success');
        }
        
        function showAllPinups() {
            const act = getCurrentAct();
            if (!act?.fieldROIs || Object.keys(act.fieldROIs).length === 0) {
                notify('Brak pól z ROI', 'error');
                return;
            }

            clearPinups();
            Object.keys(act.fieldROIs).forEach(fieldId => {
                createPinupForField(fieldId);
            });
            notify(`Otworzono ${Object.keys(act.fieldROIs).length} pin-upów`, 'success');
        }

        async function runOCRForPinup(pinupEl) {
            const fieldId = pinupEl.dataset.field;
            const act = getCurrentAct();
            if (!act || !act.fieldROIs || !act.fieldROIs[fieldId]) {
                notify('Brak ROI dla tego pola', 'error');
                return;
            }

            const btn = pinupEl.querySelector('.ocr-btn');
            const suggestionsDiv = pinupEl.querySelector('.ocr-suggestions');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            suggestionsDiv.style.display = 'none';
            suggestionsDiv.innerHTML = '';

            try {
                // Ładujemy Tesseract tylko przy pierwszym użyciu
                if (!window.tesseractWorker) {
                    notify('Ładuję moduł OCR (tylko raz)...', 'info');
                    const { createWorker } = Tesseract;
                    const worker = await createWorker({
                        workerPath: 'https://unpkg.com/tesseract.js@5.1.0/dist/worker.min.js',
                        corePath: 'https://unpkg.com/tesseract.js-core@5.1.0/tesseract-core.wasm.js',
                        langPath: 'https://tessdata.projectnaptha.com/4.0.0_best',
                        logger: m => console.log('🔍 OCR:', m.progress)
                    });
                    await worker.load();
                    await worker.loadLanguage('pol+eng');
                    await worker.initialize('pol+eng');
                    window.tesseractWorker = worker;
                    notify('OCR gotowy!', 'success');
                }

                // Pobieramy fragment obrazu z ROI
                const roi = act.fieldROIs[fieldId];
                const item = app.viewer.world.getItemAt(0);
                if (!item) throw new Error('Brak obrazu');

                const canvas = document.createElement('canvas');
                const size = item.getContentSize();
                canvas.width = roi.w * size.x;
                canvas.height = roi.h * size.y;

                const ctx = canvas.getContext('2d');
                const imageObj = new Image();
                imageObj.src = app.images[app.currentImageIdx].data;
                imageObj.crossOrigin = 'anonymous';

                await new Promise(resolve => { imageObj.onload = resolve; });

                ctx.drawImage(
                    imageObj,
                    roi.x * size.x, roi.y * size.y,
                    roi.w * size.x, roi.h * size.y,
                    0, 0, canvas.width, canvas.height
                );

                // OCR
                const { data: { text, confidence } } = await window.tesseractWorker.recognize(canvas);
                const cleanedText = text.trim().replace(/\s+/g, ' ');

                if (cleanedText && confidence > 30) {
                    suggestionsDiv.style.display = 'block';
                    suggestionsDiv.innerHTML = `
                        <div style="margin-bottom:4px; color:#10b981; font-weight:bold;">OCR (${Math.round(confidence)}%): <span>${cleanedText}</span></div>
                        <button style="font-size:10px; padding:3px 8px; margin-right:4px; background:#10b981; color:white; border:none; border-radius:3px; cursor:pointer;" 
                                onclick="applyOCRToField('${fieldId}', '${cleanedText.replace(/'/g, "\\'")}')">\u2713 Użyj</button>
                        <button style="font-size:10px; padding:3px 8px; background:#3a3a3a; color:#ddd; border:none; border-radius:3px; cursor:pointer;" 
                                onclick="this.parentElement.style.display='none'">\u2715 Zamknij</button>
                    `;
                } else {
                    suggestionsDiv.style.display = 'block';
                    suggestionsDiv.innerHTML = '<div style="color:#c42b1c;">\u26a0 OCR nie rozpoznał tekstu (za niskie zaufanie)</div>';
                }

            } catch (err) {
                console.error('OCR Error:', err);
                notify('Błąd OCR: ' + err.message, 'error');
                suggestionsDiv.innerHTML = '<div style="color:#c42b1c;">❌ Błąd OCR</div>';
                suggestionsDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i>';
            }
        }

        function applyOCRToField(fieldId, text) {
            const act = getCurrentAct();
            if (!act) return;

            act.fieldValues[fieldId] = text;
            saveStorage();

            // Aktualizuj wszystkie inputy i pin-upy
            document.querySelectorAll(`.field-input[data-field="${fieldId}"], .field-pinup[data-field="${fieldId}"] input`).forEach(inp => {
                inp.value = text;
            });

            const suggestionsDiv = document.querySelector(`.field-pinup[data-field="${fieldId}"] .ocr-suggestions`);
            if (suggestionsDiv) suggestionsDiv.style.display = 'none';

            notify('\u2713 OCR zastosowany', 'success');
        }
        
        // ===== POSTPROCESSING PANEL FUNCTIONS =====
        function togglePostprocessPanel() {
            console.log('🎨 togglePostprocessPanel called');
            const panel = document.getElementById('postprocessPanel');
            panel.classList.toggle('visible');
            console.log('🎨 Panel visibility:', panel.classList.contains('visible'));
        }
        
        function toggleThumbsPanel() {
            const thumbsBar = document.getElementById('thumbsBar');
            const mainContent = document.querySelector('.main-content');
            thumbsBar.classList.toggle('collapsed');
            mainContent.classList.toggle('thumbs-collapsed');
        }
        
        function toggleActsPanel() {
            const actsPanel = document.getElementById('actsPanel');
            actsPanel.classList.toggle('collapsed');
        }
        
        function formatActDisplayName(act) {
            // Zwróć skrócona nazwę aktu do wyświetlania w lewym panelu
            // Pełne ID (CH.LUB.BLIN.YEAR.NR) jest przechowywane w act.id
            // Ta funkcja generuje tylko skrót dla wyświetlenia
            
            if (!act.id) {
                console.warn('❌ No ID for act', act.actNum, '- using fallback');
                return `Akt ${act.actNum}`;
            }
            
            const parts = act.id.split('.');
            
            // Format: CH.LUB.BLIN.1908.00.038.00 -> CH.1908.038
            if (parts.length >= 5) {
                const typ = parts[0];      // CH
                const rok = parts[3];       // 1908
                const nr = parseInt(parts[5] || parts[4], 10); // numer aktu - bez wiodących zer
                return `${typ}.${rok}.${nr.toString().padStart(3, '0')}`;
            }
            
            // Format: CH.BLIN.1908.038 (fallback)
            if (parts.length === 4) {
                const typ = parts[0];      // CH
                const rok = parts[2];       // 1908
                const nr = parseInt(parts[3], 10); // 38
                return `${typ}.${rok}.${nr.toString().padStart(3, '0')}`;
            }
            
            // Dla innych formatów zwróć ID jak jest
            return act.id;
        }
        
        function renderActsList() {
            const actsList = document.getElementById('actsList');
            if (!actsList) return;
            
            actsList.innerHTML = '';
            
            // Grupuj wszystkie akty po imageIdx
            const groupedByImage = {};
            app.imageActs.forEach(act => {
                if (!groupedByImage[act.imageIdx]) {
                    groupedByImage[act.imageIdx] = [];
                }
                groupedByImage[act.imageIdx].push(act);
            });
            
            console.log('🎯 renderActsList: rendering all acts grouped by image', Object.keys(groupedByImage).length, 'images');
            
            // Sortuj imageIdx i iteruj po nich (pomiń null - akty bez przypisanego obrazu)
            const sortedImageIndices = Object.keys(groupedByImage)
                .filter(idx => idx !== 'null')  // Pomiń akty bez obrazu
                .map(Number)
                .sort((a, b) => a - b);
            
            sortedImageIndices.forEach((imageIdx, groupIndex) => {
                const acts = groupedByImage[imageIdx];
                
                // 🔧 FIX: Pomiń akty bez przypisanego obrazu (imageIdx === null)
                if (!acts || acts.length === 0) {
                    console.log(`⏭️ Skipping group ${imageIdx} - no acts`);
                    return;
                }
                
                // ===== HEADER OBRAZU (lewe okno - lista aktów) =====
                // Nagłówek wyświetla nazwę pliku obrazu np. "8098.jpg"
                // Lewy klik: otwiera cały obraz
                // Prawy klik: menu kontekstowe do operacji na całym obrazie (usuń wszystkie akty, usuń ROI itp.)
                const header = document.createElement('div');
                header.className = 'acts-group-header';
                const imageName = app.images[imageIdx]?.name || `Obraz ${imageIdx + 1}`;
                header.textContent = imageName;
                header.style.cssText = `
                    padding: 8px 6px;
                    font-size: 11px;
                    font-weight: 600;
                    color: #aaa;
                    background: ${groupIndex % 2 === 0 ? '#1a1a1a' : '#0f0f0f'};
                    border-bottom: 1px solid #3a3a3a;
                    margin-top: ${groupIndex > 0 ? '4px' : '0'};
                    cursor: pointer;
                `;
                
                // Lewy klik na header - pokaż cały obraz
                header.onclick = () => selectImage(imageIdx);
                header.title = `Lewy klik: otwórz obraz\nPrawy klik: menu dla całego obrazu`;
                
                // Prawy klik - menu kontekstowe dla całego obrazu
                header.oncontextmenu = (e) => {
                    e.preventDefault();
                    showImageHeaderContextMenu(imageIdx, e, header);
                };
                
                actsList.appendChild(header);
                
                // ===== PRZYCISKI AKTÓW (poniżej headera) =====
                // Każdy przycisk reprezentuje jeden akt w danym obrazie
                // Lewy klik: wybierz akt i otwórz go (jeśli inny obraz - przełącz obraz)
                // Prawy klik: menu kontekstowe dla konkretnego aktu (zmień nazwę, usuń granice, usuń akt itp.)
                acts.forEach(act => {
                    const btn = document.createElement('button');
                    btn.className = 'act-button' + (app.currentActNum === act.actNum ? ' active' : '');
                    
                    // Main display name
                    const displayName = formatActDisplayName(act);
                    btn.textContent = displayName;
                    
                    // Show full ID on hover or when active
                    btn.title = act.id || `Akt ${act.actNum}`;
                    
                    // Lewy klik - wybierz akt (jeśli jest z innego obrazu, przełącz obraz)
                    btn.onclick = () => {
                        if (app.currentImageIdx !== imageIdx) {
                            selectImage(imageIdx);
                        }
                        selectAct(act.actNum);
                    };
                    
                    // Prawy klik - kontekstowe menu
                    btn.oncontextmenu = (e) => {
                        e.preventDefault();
                        showActContextMenuPanel(act.actNum, e, btn);
                    };
                    
                    actsList.appendChild(btn);
                });
            });
        }
        
        function showImageHeaderContextMenu(imageIdx, event, headerElement) {
            // Menu kontekstowe dla headera obrazu (np. "8098.jpg")
            // Opcje: Usuń wszystkie akty na obrazie, Usuń wszystkie ROI na obrazie
            const menu = document.createElement('div');
            menu.id = 'imageHeaderContextMenu';
            menu.style.cssText = `
                position: fixed;
                top: ${event.pageY}px;
                left: ${event.pageX}px;
                background: #2a2a2a;
                border: 1px solid #10b981;
                border-radius: 4px;
                padding: 4px 0;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                min-width: 200px;
            `;

            const options = [
                { label: 'Usuń wszystkie akty na obrazie', action: () => deleteAllActsOnImageFromPanel(imageIdx), color: '#ff6b6b' },
                { label: 'Usuń wszystkie ROI na obrazie', action: () => deleteAllROIsOnImageFromPanel(imageIdx), color: '#ff9800' }
            ];

            options.forEach(opt => {
                const item = document.createElement('div');
                item.textContent = opt.label;
                item.style.cssText = `
                    padding: 8px 12px;
                    cursor: pointer;
                    color: ${opt.color};
                    font-size: 12px;
                    transition: background 0.15s;
                    border-bottom: 1px solid #1a1a1a;
                `;
                item.onmouseover = () => item.style.background = 'rgba(255,107,107,0.1)';
                item.onmouseout = () => item.style.background = 'transparent';
                item.onclick = () => {
                    opt.action();
                    menu.remove();
                };
                menu.appendChild(item);
            });

            document.body.appendChild(menu);

            // Zamknij menu przy kliknięciu poza
            const closeMenu = (e) => {
                if (!menu.contains(e.target) && e.target !== headerElement) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 10);
        }

        function deleteAllActsOnImageFromPanel(imageIdx) {
            if (!confirm('Czy na pewno usunąć WSZYSTKIE akty na tym obrazie?')) return;
            app.imageActs = app.imageActs.filter(a => a.imageIdx !== imageIdx);
            renderActsList();
            redrawROIs();
            saveStorage();
            notify('Wszystkie akty na obrazie usunięte', 'success');
        }

        function deleteAllROIsOnImageFromPanel(imageIdx) {
            const acts = app.imageActs.filter(act => act.imageIdx === imageIdx);
            acts.forEach(act => {
                act.actROI = null;
                act.fieldROIs = {};
            });
            redrawROIs();
            saveStorage();
            notify('Wszystkie ROI na obrazie usunięte', 'success');
        }
        
        function updateCurrentRowInTable() {
            // Aktualizuj tylko bieżący wiersz w tabeli (szybkie, bez re-rendu całej tabeli)
            const currentAct = app.imageActs.find(a => a.actNum === app.currentActNum);
            if (!currentAct) return;
            
            const tableBody = document.getElementById('dataTableBody');
            if (!tableBody) return;
            
            // Szukaj wiersza dla bieżącego aktu po rowIndex (atrybut data-act-num)
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const currentRow = rows.find(row => row.dataset.actNum === currentAct.actNum);
            
            if (!currentRow) return; // Wiersz nie znaleziony
            
            // Aktualizuj poszczególne komórki bez re-rendu całego DOM
            const cells = currentRow.querySelectorAll('td');
            if (cells.length < 4) return;
            
            // Kolumna 0: checkbox (skippujem)
            // Kolumna 1: ID źródłowe - użyj original_id (krótkie) zamiast id (pełne)
            cells[1].textContent = currentAct.original_id || currentAct.id || '';
            
            // Kolumna 2: Księga (nr)
            cells[2].textContent = currentAct.fieldValues?.ksiega_nr || currentAct.fieldValues?.book_number || '';
            
            // Kolumna 3: Strona (nr)
            cells[3].textContent = currentAct.fieldValues?.strona_nr || currentAct.fieldValues?.page_number || '';
            
            // Kolumna 4: Numer aktu
            cells[4].textContent = currentAct.fieldValues?.christening_act_number || '';
            
            // Kolumna 5: Data chrztu
            cells[5].textContent = currentAct.fieldValues?.christening_date || '';
            
            // Kolumna 6: Data zgłoszenia
            cells[6].textContent = currentAct.fieldValues?.report_date || '';
            
            // Kolumna 7: Parafia
            cells[7].textContent = currentAct.fieldValues?.parafia || currentAct.fieldValues?.parish || '';
            
            // Kolumna 8: Imię dziecka
            cells[8].textContent = currentAct.fieldValues?.dziecko_imie || currentAct.fieldValues?.child_first_name || '';
            
            // Kolumna 9: Nazwisko dziecka
            cells[9].textContent = currentAct.fieldValues?.dziecko_nazwisko || currentAct.fieldValues?.child_last_name || '';
            
            // Kolumna 10: Data ur. dziecka
            cells[10].textContent = currentAct.fieldValues?.dziecko_data_ur || currentAct.fieldValues?.child_birth_date || '';
            
            // Kolumna 11: Płeć dziecka
            cells[11].textContent = currentAct.fieldValues?.dziecko_plec || currentAct.fieldValues?.child_gender || '';
            
            // Kolumna 12: Status dziecka
            cells[12].textContent = currentAct.fieldValues?.dziecko_status || currentAct.fieldValues?.child_legitimacy_status || '';
            
            // Kolumna 13: Ojciec (imię)
            cells[13].textContent = currentAct.fieldValues?.ojciec_imie || currentAct.fieldValues?.father_first_name || '';
            
            // Kolumna 14: Ojciec (nazwisko)
            cells[14].textContent = currentAct.fieldValues?.ojciec_nazwisko || currentAct.fieldValues?.father_last_name || '';
            
            // Kolumna 15: Ojciec (wiek)
            cells[15].textContent = currentAct.fieldValues?.ojciec_wiek || currentAct.fieldValues?.father_age || '';
            
            // Kolumna 16: Ojciec (zawód)
            cells[16].textContent = currentAct.fieldValues?.ojciec_zawod || currentAct.fieldValues?.father_occupation || '';
            
            // Kolumna 17: Ojciec (stan cywilny)
            cells[17].textContent = currentAct.fieldValues?.ojciec_stan_cywilny || currentAct.fieldValues?.father_civil_status || '';
            
            // Kolumna 18: Matka (imię)
            cells[18].textContent = currentAct.fieldValues?.matka_imie || currentAct.fieldValues?.mother_first_name || '';
            
            // Kolumna 19: Matka (nazwisko)
            cells[19].textContent = currentAct.fieldValues?.matka_nazwisko || currentAct.fieldValues?.mother_last_name || '';
            
            // Kolumna 20: Matka (panieńskie)
            cells[20].textContent = currentAct.fieldValues?.matka_panienskie || currentAct.fieldValues?.mother_maiden_name || '';
            
            // Kolumna 21: Matka (wiek)
            cells[21].textContent = currentAct.fieldValues?.matka_lata || currentAct.fieldValues?.mother_age || '';
            
            // Kolumna 22: Matka (zawód)
            cells[22].textContent = currentAct.fieldValues?.matka_zawod || currentAct.fieldValues?.mother_occupation || '';
            
            // Kolumna 23: Matka (stan cywilny)
            cells[23].textContent = currentAct.fieldValues?.matka_stan_cywilny || currentAct.fieldValues?.mother_civil_status || '';
            
            // Kolumna 24: Matka (miejsce)
            cells[24].textContent = currentAct.fieldValues?.matka_miejsce || currentAct.fieldValues?.location || '';
            
            // Kolumna 25: Ojciec chrzestny (imię)
            cells[25].textContent = currentAct.fieldValues?.ojciec_chrzestny_imie || currentAct.fieldValues?.godfather_first_name || '';
            
            // Kolumna 26: Ojciec chrzestny (nazwisko)
            cells[26].textContent = currentAct.fieldValues?.ojciec_chrzestny_nazwisko || currentAct.fieldValues?.godfather_last_name || '';
            
            // Kolumna 27: Ojciec chrzestny (miejsce)
            cells[27].textContent = currentAct.fieldValues?.ojciec_chrzestny_miejsce || currentAct.fieldValues?.godfather_place || '';
            
            // Kolumna 28: Matka chrzestna (imię)
            cells[28].textContent = currentAct.fieldValues?.matka_chrzestna_imie || currentAct.fieldValues?.godmother_first_name || '';
            
            // Kolumna 29: Matka chrzestna (nazwisko)
            cells[29].textContent = currentAct.fieldValues?.matka_chrzestna_nazwisko || currentAct.fieldValues?.godmother_last_name || '';
            
            // Kolumna 30: Matka chrzestna (miejsce)
            cells[30].textContent = currentAct.fieldValues?.matka_chrzestna_miejsce || currentAct.fieldValues?.godmother_place || '';
            
            // Kolumna 31: Ksiądz (imię)
            cells[31].textContent = currentAct.fieldValues?.ksiadz_imie || currentAct.fieldValues?.priest_first_name || '';
            
            // Kolumna 32: Ksiądz (nazwisko)
            cells[32].textContent = currentAct.fieldValues?.ksiadz_nazwisko || currentAct.fieldValues?.priest_last_name || '';
            
            // Kolumna 33: Ksiądz (zawód)
            cells[33].textContent = currentAct.fieldValues?.ksiadz_zawod || currentAct.fieldValues?.priest_occupation || '';
            
            // Kolumna 34: Zgłaszający (imię)
            cells[34].textContent = currentAct.fieldValues?.zglaszajacy_imie || currentAct.fieldValues?.reporting_person_first_name || '';
            
            // Kolumna 35: Zgłaszający (nazwisko)
            cells[35].textContent = currentAct.fieldValues?.zglaszajacy_nazwisko || currentAct.fieldValues?.reporting_person_last_name || '';
            
            // Kolumna 36: Zgłaszający (zawód)
            cells[36].textContent = currentAct.fieldValues?.zglaszajacy_zawod || currentAct.fieldValues?.reporting_person_occupation || '';
            
            // Kolumna 37: Zgłaszający (wiek)
            cells[37].textContent = currentAct.fieldValues?.zglaszajacy_wiek || currentAct.fieldValues?.reporting_person_age || '';
            
            // Kolumna 38: Zgłaszający (miejsce)
            cells[38].textContent = currentAct.fieldValues?.zglaszajacy_miejsce || currentAct.fieldValues?.reporting_person_place || '';
            
            // Kolumna 39: Świadek 1 (imię)
            cells[39].textContent = currentAct.fieldValues?.swiadek_1_imie || currentAct.fieldValues?.witness_1_first_name || '';
            
            // Kolumna 40: Świadek 1 (nazwisko)
            cells[40].textContent = currentAct.fieldValues?.swiadek_1_nazwisko || currentAct.fieldValues?.witness_1_last_name || '';
            
            // Kolumna 41: Świadek 1 (zawód)
            cells[41].textContent = currentAct.fieldValues?.swiadek_1_zawod || currentAct.fieldValues?.witness_1_occupation || '';
            
            // Kolumna 42: Świadek 1 (miejsce)
            cells[42].textContent = currentAct.fieldValues?.swiadek_1_miejsce || currentAct.fieldValues?.witness_1_place || '';
            
            // Kolumna 43: Świadek 2 (imię)
            cells[43].textContent = currentAct.fieldValues?.swiadek_2_imie || currentAct.fieldValues?.witness_2_first_name || '';
            
            // Kolumna 44: Świadek 2 (nazwisko)
            cells[44].textContent = currentAct.fieldValues?.swiadek_2_nazwisko || currentAct.fieldValues?.witness_2_last_name || '';
            
            // Kolumna 45: Świadek 2 (zawód)
            cells[45].textContent = currentAct.fieldValues?.swiadek_2_zawod || currentAct.fieldValues?.witness_2_occupation || '';
            
            // Kolumna 46: Świadek 2 (miejsce)
            cells[46].textContent = currentAct.fieldValues?.swiadek_2_miejsce || currentAct.fieldValues?.witness_2_place || '';
            
            // Kolumna 47: Świadek 3 (imię)
            cells[47].textContent = currentAct.fieldValues?.swiadek_3_imie || currentAct.fieldValues?.witness_3_first_name || '';
            
            // Kolumna 48: Świadek 3 (nazwisko)
            cells[48].textContent = currentAct.fieldValues?.swiadek_3_nazwisko || currentAct.fieldValues?.witness_3_last_name || '';
            
            // Kolumna 49: Świadek 3 (zawód)
            cells[49].textContent = currentAct.fieldValues?.swiadek_3_zawod || currentAct.fieldValues?.witness_3_occupation || '';
            
            // Kolumna 50: Świadek 3 (miejsce)
            cells[50].textContent = currentAct.fieldValues?.swiadek_3_miejsce || currentAct.fieldValues?.witness_3_place || '';
            
            // Kolumna 51: Uwagi
            cells[51].textContent = currentAct.fieldValues?.custom_note || currentAct.fieldValues?.notes || '';
            
            // Kolumna 52: Opis źródła
            cells[52].textContent = currentAct.fieldValues?.notes_org || '';
        }
        
        function renderRecordsTable() {
            const perfStart = performance.now();
            const tableBody = document.getElementById('dataTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // 🔥 NOWE: Filtruj tylko akty dla obecnego obrazu - drastycznie zmniejszy liczbę wierszy!
            // Zamast renderować 5512 aktów, renderuj ~30-100 z danego obrazu
            const currentImageIdx = app.currentImageIdx !== undefined ? app.currentImageIdx : 0;
            
            // 🔧 FIX: Jeśli brak wybranego obrazu ale są akty bez obrazu, pokaż wszystkie akty
            let allActsForImage;
            if (currentImageIdx === 0 || currentImageIdx === null || currentImageIdx === undefined) {
                const unassignedActs = app.imageActs.filter(a => a.imageIdx === null || a.imageIdx === undefined);
                if (unassignedActs.length > 0) {
                    // Są akty bez obrazu - pokaż wszystkie
                    allActsForImage = app.imageActs;
                    console.log(`📊 Showing all ${app.imageActs.length} acts (no image selected, unassigned acts found)`);
                } else {
                    // Brak aktów bez obrazu - pokaż akty dla obrazu 0
                    allActsForImage = app.imageActs.filter(a => a.imageIdx === currentImageIdx);
                }
            } else {
                // Jest wybrany obraz - pokaż akty dla niego
                allActsForImage = app.imageActs.filter(a => a.imageIdx === currentImageIdx);
            }
            
            // 📄 PAGINACJA: Renderuj tylko stronę (max 100 aktów naraz)
            const pageSize = app.tablePageSize || 100;
            const pageIndex = app.tablePageIndex || 0;
            const startIdx = pageIndex * pageSize;
            const endIdx = startIdx + pageSize;
            const currentActs = allActsForImage.slice(startIdx, endIdx);
            
            // Info o ilości aktów i stronie
            const totalForImage = allActsForImage.length;
            const totalPages = Math.ceil(totalForImage / pageSize);
            console.log(`📊 Rendering page ${pageIndex + 1}/${totalPages}: ${currentActs.length} acts (total for image: ${totalForImage})`);
            
            currentActs.forEach((act, index) => {
                const row = tableBody.insertRow();
                row.dataset.actNum = act.actNum; // Dodaj atrybut aby móc znaleźć wiersz później
                
                // Checkbox
                const checkboxCell = row.insertCell();
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'row-checkbox';
                checkboxCell.appendChild(checkbox);
                
                // 🔧 NAPRAWIONO: Wyrównaj do nagłówków tabeli
                // Nagłówki: ID | ROK | Nr. | Nazwisko | Imię | Miejscowość | ImięO | NazwiskoO | wO | IM | NM | wM | Uwagi | UWAGI ORG | Ścieżka Obrazu | ROI | Akcje
                
                // ID
                row.insertCell().textContent = act.original_id || act.id || `#${index}`;
                
                // ROK (parsuj z original_id np CH.LUB.BLIN.1783.002 -> rok = 1783)
                let rok = '';
                if (act.original_id) {
                    const match = act.original_id.match(/\.(\d{4})\./);
                    if (match) rok = match[1];
                }
                if (!rok && act.fieldValues?.christening_year) rok = act.fieldValues.christening_year;
                if (!rok && act.fieldValues?.rok) rok = act.fieldValues.rok;
                row.insertCell().textContent = rok;
                
                // Nr. (numer aktu - tylko liczba z original_id)
                let nr = '';
                if (act.original_id) {
                    const match = act.original_id.match(/\.(\d+)([a-z]?)$/i);
                    if (match) nr = parseInt(match[1], 10) + (match[2] || '');
                }
                if (!nr && act.fieldValues?.nr) nr = act.fieldValues.nr;
                if (!nr && act.fieldValues?.christening_act_number) nr = act.fieldValues.christening_act_number;
                row.insertCell().textContent = nr;
                
                // Nazwisko (DZIECKA - primarne!)
                const nazwisko = act.fieldValues?.child_last_name || act.fieldValues?.dziecko_nazwisko || 
                               act.fieldValues?.father_last_name || act.fieldValues?.ojciec_nazwisko || '';
                row.insertCell().textContent = nazwisko;
                
                // Imię (DZIECKA - primarne!)
                const imie = act.fieldValues?.child_first_name || act.fieldValues?.dziecko_imie || 
                           act.fieldValues?.father_first_name || act.fieldValues?.ojciec_imie || '';
                row.insertCell().textContent = imie;
                
                // Miejscowość (lokacja/parafia)
                const miejscowosc = act.fieldValues?.matka_miejsce || act.fieldValues?.location || 
                                  act.fieldValues?.parafia || act.fieldValues?.parish || '';
                row.insertCell().textContent = miejscowosc;
                
                // ImięO (imię ojca - alternatywnie)
                const imieO = act.fieldValues?.ojciec_imie || act.fieldValues?.father_first_name || '';
                row.insertCell().textContent = imieO;
                
                // NazwiskoO (nazwisko ojca - alternatywnie)
                const nazwiskoO = act.fieldValues?.ojciec_nazwisko || act.fieldValues?.father_last_name || '';
                row.insertCell().textContent = nazwiskoO;
                
                // wO (wiek ojca)
                const wO = act.fieldValues?.ojciec_wiek || act.fieldValues?.father_age || '';
                row.insertCell().textContent = wO;
                
                // IM (imię matki)
                const IM = act.fieldValues?.matka_imie || act.fieldValues?.mother_first_name || '';
                row.insertCell().textContent = IM;
                
                // NM (nazwisko matki)
                const NM = act.fieldValues?.matka_nazwisko || act.fieldValues?.mother_last_name || '';
                row.insertCell().textContent = NM;
                
                // wM (wiek matki)
                const wM = act.fieldValues?.matka_lata || act.fieldValues?.mother_age || '';
                row.insertCell().textContent = wM;
                
                // Uwagi
                const uwagi = act.fieldValues?.uwagi || act.fieldValues?.notes || '';
                row.insertCell().textContent = uwagi;
                
                // UWAGI ORG
                const uwagiOrg = act.fieldValues?.uwagi_org || act.fieldValues?.notes_org || '';
                row.insertCell().textContent = uwagiOrg;
                
                // Ścieżka Obrazu
                const imageName = act.image_path ? act.image_path.split('/').pop().split('\\').pop() : '(brak)';
                const imageCell = row.insertCell();
                imageCell.textContent = imageName;
                imageCell.style.fontSize = '10px';
                imageCell.style.color = act.image_path ? '#10b981' : '#888';
                
                // ROI (JSON)
                const roiCell = row.insertCell();
                const hasROI = act.fieldROIs && Object.keys(act.fieldROIs).length > 0;
                roiCell.textContent = hasROI ? '📍 ROI' : '(brak)';
                roiCell.style.fontSize = '10px';
                roiCell.style.color = hasROI ? '#f59e0b' : '#888';
                
                // Akcje (edit)
                const actionsCell = row.insertCell();
                const editBtn = document.createElement('button');
                editBtn.textContent = '✏️';
                editBtn.style.padding = '2px 6px';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    app.currentActNum = act.actNum;
                    renderFormSections();
                };
                actionsCell.appendChild(editBtn);
                
                // ===== ADD CLICK HANDLER - ładuj akt do panelu po prawej =====
                row.style.cursor = 'pointer';
                row.addEventListener('click', (e) => {
                    // Nie reaguj na klik na checkbox
                    if (e.target.type === 'checkbox') return;
                    
                    console.log('🖱️ Row clicked - act:', act);
                    console.log('🖱️ act.actNum:', act.actNum);
                    console.log('🖱️ app.currentActNum before:', app.currentActNum);
                    
                    // Ustaw bieżący akt
                    app.currentActNum = act.actNum;
                    app.currentImageIdx = act.imageIdx || 0;
                    
                    console.log('🖱️ app.currentActNum after:', app.currentActNum);
                    console.log(`✅ Row clicked: ${act.original_id || act.id || act.actNum}`);
                    
                    // ✅ NOWE: Jeśli akt ma przypisany obraz, załaduj go
                    if (act.imageIdx !== undefined && act.imageIdx !== null && act.imageIdx >= 0) {
                        if (act.imageIdx < app.images.length) {
                            console.log(`📸 Ładowanie obrazu ${act.imageIdx} dla aktu ${act.original_id || act.actNum}`);
                            selectImage(act.imageIdx, true);  // true = autoSelect, nie pokazuj modala
                        } else {
                            console.warn(`⚠️ imageIdx ${act.imageIdx} out of range (max: ${app.images.length}). Wskazówka: Załaduj folder z obrazami.`);
                            notify(`⚠️ Obraz ${act.image_path || 'nieznany'} nie jest załadowany. Załaduj folder z obrazami.`, 'warning');
                        }
                    } else if (act.image_path) {
                        console.warn(`⚠️ Akt nie ma przypisanego imageIdx, ale ma ścieżkę: ${act.image_path}`);
                        notify(`⚠️ Wskazówka: Załaduj folder z obrazami aby automatycznie powiązać akty z plikami.`, 'info');
                    }
                    
                    // Odśwież panel po prawej z danymi aktu
                    console.log('🖱️ Calling renderFormSections...');
                    renderFormSections();
                    
                    // Zaznacz wiersz
                    document.querySelectorAll('#dataTableBody tr').forEach(r => r.style.backgroundColor = '');
                    row.style.backgroundColor = '#2a4a4a';
                });
            });
            
            const perfDuration = (performance.now() - perfStart).toFixed(2);
            if (perfDuration > 500) {
                console.warn(`⏱️ renderRecordsTable: ${perfDuration}ms (SLOW! ${currentActs.length} acts)`);
            } else {
                console.log(`⏱️ renderRecordsTable: ${perfDuration}ms (${currentActs.length} acts)`);
            }
            
            // 📄 DODAJ PRZYCISK "Załaduj więcej" jeśli ma jeszcze stron
            if (pageIndex + 1 < totalPages) {
                const footerRow = tableBody.insertRow();
                footerRow.style.backgroundColor = '#1a3a3a';
                footerRow.style.cursor = 'pointer';
                footerRow.style.hover = 'background-color: #0f2a2a';
                const cell = footerRow.insertCell();
                cell.colSpan = 100;
                cell.style.textAlign = 'center';
                cell.style.padding = '10px';
                cell.style.color = '#10b981';
                cell.style.fontWeight = 'bold';
                cell.innerHTML = `📥 Załaduj więcej aktów (${totalForImage - endIdx} pozostałych)`;
                footerRow.addEventListener('click', () => {
                    app.tablePageIndex = (app.tablePageIndex || 0) + 1;
                    renderRecordsTable();
                    // Scroll do tabeli
                    document.getElementById('dataTableBody').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
            }
        }
        
        function setupPostprocessSliders() {
            // Helper function to safely attach listeners
            const attachSliderListener = (id, key, valueId, suffix = '') => {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`⚠️ Slider element not found: ${id}`);
                    return;
                }
                el.addEventListener('input', (e) => {
                    postprocessState[key] = parseInt(e.target.value);
                    const valEl = document.getElementById(valueId);
                    if (valEl) valEl.textContent = e.target.value + suffix;
                    debouncePreview();
                });
            };
            
            const attachCheckboxListener = (id, key, valueId) => {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`⚠️ Checkbox element not found: ${id}`);
                    return;
                }
                el.addEventListener('change', (e) => {
                    postprocessState[key] = e.target.checked;
                    const valEl = document.getElementById(valueId);
                    if (valEl) valEl.textContent = e.target.checked ? 'ON' : 'OFF';
                    debouncePreview();
                });
            };
            
            // === CORE FILTERS ===
            attachSliderListener('contrastSlider', 'levels', 'contrastValue', '');
            attachSliderListener('brightnessSlider', 'archival', 'brightnessValue', '%');
            attachSliderListener('sharpenSlider', 'descreen', 'sharpenValue', '%');
            attachCheckboxListener('saturationSlider', 'autoContrast', 'saturationValue');
            
            // === ADVANCED FILTERS ===
            attachSliderListener('sepiaSlider', 'sepia', 'sepiaValue', '%');
            attachSliderListener('hueSlider', 'hue', 'hueValue', '°');
            attachSliderListener('saturSlider', 'saturation', 'saturValue', '%');
            attachSliderListener('invertSlider', 'invert', 'invertValue', '%');
            
            // === OPENCV ADVANCED FILTERS ===
            const adaptiveEl = document.getElementById('adaptiveThresholdSlider');
            if (adaptiveEl) {
                adaptiveEl.addEventListener('input', (e) => {
                    postprocessState.adaptiveThreshold = parseInt(e.target.value);
                    const valEl = document.getElementById('adaptiveThresholdValue');
                    if (valEl) valEl.textContent = e.target.value > 0 ? 'ON (' + e.target.value + '%)' : 'OFF';
                    debouncePreview();
                });
            }
            
            attachSliderListener('gaussianBlurSlider', 'gaussianBlur', 'gaussianBlurValue', '');
            attachSliderListener('medianBlurSlider', 'medianBlur', 'medianBlurValue', '');
            attachCheckboxListener('histogramEqCheckbox', 'histogramEq', 'histogramEqValue');
            
            // Presets - dodaj przycisk dla każdego presetu
            const presetsContainer = document.querySelector('.postprocess-buttons');
            if (presetsContainer && !presetsContainer.querySelector('.preset-buttons')) {
                const presetsDiv = document.createElement('div');
                presetsDiv.className = 'preset-buttons';
                presetsDiv.style.gridColumn = 'span 2';
                presetsDiv.style.display = 'grid';
                presetsDiv.style.gridTemplateColumns = '1fr 1fr';
                presetsDiv.style.gap = '6px';
                presetsDiv.style.marginBottom = '10px';
                
                const presetTooltips = {
                    'heavy-duty': '🔧 Dla najtrudniejszych: wyrównanie tła + morfologia + auto-invert'
                };
                
                Object.keys(presets).forEach(name => {
                    const btn = document.createElement('button');
                    btn.className = 'postprocess-btn preset-btn';
                    btn.textContent = name.charAt(0).toUpperCase() + name.slice(1);
                    btn.style.fontSize = '10px';
                    if (presetTooltips[name]) {
                        btn.title = presetTooltips[name];
                    }
                    btn.onclick = () => applyPreset(name);
                    presetsDiv.appendChild(btn);
                });
                
                presetsContainer.insertBefore(presetsDiv, presetsContainer.firstChild);
                console.log('✅ Preset buttons added:', Object.keys(presets).length, 'presets');
            } else {
                console.log('ℹ️ Presets container not found or already has preset buttons');
            }
        }
        
        function debouncePreview() {
            if (previewTimeout) clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                updateProcessedPreview();
            }, 300);
        }
        
        function updateProcessedPreview() {
            try {
                if (isProcessing || !app.images[app.currentImageIdx] || !app.images[app.currentImageIdx].data) {
                    console.warn('⚠️ Preview: Missing image data or already processing');
                    return;
                }
                if (!app.viewer) {
                    console.warn('⚠️ Preview: Viewer not initialized');
                    return;
                }
                
                isProcessing = true;
                const original = app.images[app.currentImageIdx];
                const img = new Image();
                img.src = original.data;
                
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        applyPostprocessFilters(canvas, postprocessState);
                        const processed = canvas.toDataURL('image/jpeg', 0.95);
                        
                        app.viewer.open({
                            type: 'image',
                            url: processed
                        });
                        console.log('✅ Live preview updated');
                    } catch (e) {
                        console.error('❌ Preview processing error:', e);
                    } finally {
                        isProcessing = false;
                    }
                };
                
                img.onerror = (err) => {
                    console.error('❌ Failed to load preview image:', err);
                    isProcessing = false;
                };
                
                // Timeout safety: if image doesn't load in 5s, cancel
                setTimeout(() => {
                    if (isProcessing) {
                        console.warn('⚠️ Preview timeout - image too large or slow connection');
                        isProcessing = false;
                    }
                }, 5000);
                
            } catch (e) {
                console.error('❌ updateProcessedPreview exception:', e);
                isProcessing = false;
            }
        }
        
        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;
            
            postprocessState.levels = preset.levels;
            postprocessState.autoContrast = preset.autoContrast;
            postprocessState.archival = preset.archival;
            postprocessState.descreen = preset.descreen;
            postprocessState.sepia = preset.sepia || 0;
            postprocessState.hue = preset.hue || 0;
            postprocessState.saturation = preset.saturation || 100;
            postprocessState.invert = preset.invert || 0;
            postprocessState.adaptiveThreshold = preset.adaptiveThreshold || 0;
            postprocessState.gaussianBlur = preset.gaussianBlur || 0;
            postprocessState.medianBlur = preset.medianBlur || 0;
            postprocessState.histogramEq = preset.histogramEq || false;
            postprocessState.backgroundSubtraction = preset.backgroundSubtraction || 0;
            postprocessState.morphologyClose = preset.morphologyClose || 0;
            postprocessState.autoInvert = preset.autoInvert || false;
            
            // Update sliders
            document.getElementById('contrastSlider').value = preset.levels;
            document.getElementById('contrastValue').textContent = preset.levels;
            document.getElementById('brightnessSlider').value = preset.archival;
            document.getElementById('brightnessValue').textContent = preset.archival + '%';
            document.getElementById('sharpenSlider').value = preset.descreen;
            document.getElementById('sharpenValue').textContent = preset.descreen + '%';
            document.getElementById('saturationSlider').checked = preset.autoContrast;
            document.getElementById('saturationValue').textContent = preset.autoContrast ? 'ON' : 'OFF';
            
            // Update advanced filters
            document.getElementById('sepiaSlider').value = preset.sepia || 0;
            document.getElementById('sepiaValue').textContent = (preset.sepia || 0) + '%';
            document.getElementById('hueSlider').value = preset.hue || 0;
            document.getElementById('hueValue').textContent = (preset.hue || 0) + '°';
            document.getElementById('saturSlider').value = preset.saturation || 100;
            document.getElementById('saturValue').textContent = (preset.saturation || 100) + '%';
            document.getElementById('invertSlider').value = preset.invert || 0;
            document.getElementById('invertValue').textContent = (preset.invert || 0) + '%';
            
            // Update OpenCV filters
            document.getElementById('adaptiveThresholdSlider').value = preset.adaptiveThreshold || 0;
            document.getElementById('adaptiveThresholdValue').textContent = (preset.adaptiveThreshold || 0) > 0 ? 'ON (' + (preset.adaptiveThreshold || 0) + '%)' : 'OFF';
            document.getElementById('gaussianBlurSlider').value = preset.gaussianBlur || 0;
            document.getElementById('gaussianBlurValue').textContent = (preset.gaussianBlur || 0);
            document.getElementById('medianBlurSlider').value = preset.medianBlur || 0;
            document.getElementById('medianBlurValue').textContent = (preset.medianBlur || 0);
            document.getElementById('histogramEqCheckbox').checked = preset.histogramEq || false;
            document.getElementById('histogramEqValue').textContent = (preset.histogramEq || false) ? 'ON' : 'OFF';
            
            debouncePreview();
            notify(`📋 Preset: ${presetName}`, 'success');
        }
        
        function applyPostprocessFilters(canvas, state) {
            const ctx = canvas.getContext('2d');
            console.log('🎨 applyPostprocessFilters START with state:', {
                levels: state.levels,
                archival: state.archival,
                descreen: state.descreen,
                adaptiveThreshold: state.adaptiveThreshold,
                gaussianBlur: state.gaussianBlur
            });
            let filterString = '';
            
            // Levels (shadows/highlights)
            const levels = state.levels || 0;
            if (levels > 0) {
                filterString += `brightness(${1 + (levels / 100)}) `;
            } else if (levels < 0) {
                filterString += `brightness(${1 + (levels / 100)}) `;
            }
            
            // Auto-contrast using brightness adjustment
            if (state.autoContrast) {
                filterString += 'contrast(1.3) ';
            }
            
            // Sepia filter
            if (state.sepia > 0) {
                filterString += `sepia(${state.sepia / 100}) `;
            }
            
            // Hue rotation
            if (state.hue !== 0) {
                filterString += `hue-rotate(${state.hue}deg) `;
            }
            
            // Saturation
            if (state.saturation !== 100) {
                filterString += `saturate(${state.saturation}%) `;
            }
            
            // Invert
            if (state.invert > 0) {
                filterString += `invert(${state.invert / 100}) `;
            }
            
            // Apply Canvas filters (szybkie, GPU-accelerated)
            if (filterString) {
                ctx.filter = filterString;
                ctx.drawImage(canvas, 0, 0);
                ctx.filter = 'none';
            }
            
            // === STEP 2: Histogram Equalization (OpenCV) ===
            if (state.histogramEq) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                imageData = histogramEqualization(imageData);
                ctx.putImageData(imageData, 0, 0);
                console.log('✅ Histogram Equalization applied');
            }
            
            // === STEP 3: Background Subtraction (Wyrównanie tła) - NOWE ===
            if (state.backgroundSubtraction > 0) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const kernelSize = Math.floor(state.backgroundSubtraction / 10) * 2 + 11;  // 0-100 → 11-111
                imageData = backgroundSubtraction(imageData, kernelSize);
                ctx.putImageData(imageData, 0, 0);
                console.log('✅ Background Subtraction applied (kernel: ' + kernelSize + ')');
            }
            
            // === STEP 4: Gaussian Blur (OpenCV - denoising) ===
            if (state.gaussianBlur > 0) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const kernelSize = state.gaussianBlur * 2 + 1;  // Konwersja 0-10 na kernel size
                imageData = gaussianBlurFilter(imageData, kernelSize, 1.0);
                ctx.putImageData(imageData, 0, 0);
                console.log('✅ Gaussian Blur applied (kernel: ' + kernelSize + ')');
            }
            
            // === STEP 5: Median Blur (OpenCV - denoising) ===
            if (state.medianBlur > 0) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const kernelSize = state.medianBlur * 2 + 1;
                imageData = medianBlurFilter(imageData, kernelSize);
                ctx.putImageData(imageData, 0, 0);
                console.log('✅ Median Blur applied (kernel: ' + kernelSize + ')');
            }
            
            // === STEP 6: Archival document enhancement (pixel-level, ale szybszy) ===
            if (state.archival > 0) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const strength = state.archival / 100;
                
                for (let i = 0; i < data.length; i += 4) {
                    let r = data[i], g = data[i+1], b = data[i+2];
                    
                    // Boost contrast dla wyblakłych dokumentów
                    const avg = (r + g + b) / 3;
                    const factor = 1 + strength * 0.5;
                    
                    r = Math.max(0, Math.min(255, (r - avg) * factor + avg));
                    g = Math.max(0, Math.min(255, (g - avg) * factor + avg));
                    b = Math.max(0, Math.min(255, (b - avg) * factor + avg));
                    
                    data[i] = r;
                    data[i+1] = g;
                    data[i+2] = b;
                }
                
                ctx.putImageData(imageData, 0, 0);
            }
            
            // === STEP 7: Descreen (removes halftone) ===
            if (state.descreen > 0) {
                const strength = state.descreen / 100 * 0.3;
                if (state.descreen > 30) {
                    ctx.filter = `blur(${strength}px)`;
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                }
            }
            
            // === STEP 8: Adaptive Threshold (OpenCV - binaryzacja) ===
            if (state.adaptiveThreshold > 0) {
                if (opencvReady) {
                    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const blockSize = Math.max(3, Math.floor(state.adaptiveThreshold / 20) * 2 + 1);  // Konwersja 0-100 na blockSize
                    const constant = Math.max(-50, Math.min(50, Math.floor((state.adaptiveThreshold - 50) / 2)));
                    
                    imageData = adaptiveThresholdFilter(imageData, blockSize, constant);
                    ctx.putImageData(imageData, 0, 0);
                    console.log('✅ Adaptive Threshold applied (blockSize: ' + blockSize + ', constant: ' + constant + ')');
                } else {
                    console.warn('⚠️ OpenCV.js nie jest jeszcze załadowany - Adaptive Threshold pominięty');
                }
            }
            
            // === STEP 9: Morphology Close (OpenCV - Połączenie przerwanych kresek) - NOWE ===
            if (state.morphologyClose > 0) {
                if (opencvReady) {
                    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const kernelSize = Math.floor(state.morphologyClose / 20) * 2 + 1;  // 0-100 → 1-11
                    imageData = morphologyClose(imageData, kernelSize);
                    ctx.putImageData(imageData, 0, 0);
                    console.log('✅ Morphology Close applied (kernel: ' + kernelSize + ')');
                } else {
                    console.warn('⚠️ OpenCV.js nie jest jeszcze załadowany - Morphology Close pominięty');
                }
            }
            
            // === STEP 10: Auto-Invert (Detekcja i inwersja tekstu białego) - NOWE ===
            if (state.autoInvert) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const shouldInvert = autoInvert(imageData);
                if (shouldInvert) {
                    imageData = invertColors(imageData);
                    ctx.putImageData(imageData, 0, 0);
                    console.log('✅ Auto-Invert applied (tekst był biały na czarnym)');
                } else {
                    console.log('ℹ️ Auto-Invert: Nie trzeba - tekst jest czarny');
                }
            }
            
            console.log('✅ applyPostprocessFilters COMPLETE');
        }
        
        function saveProcessedAsNew() {
            if (!app.images[app.currentImageIdx]) {
                notify('Załaduj obraz', 'error');
                return;
            }
            
            const hasChanges = postprocessState.levels !== 0 || 
                               postprocessState.autoContrast !== false || 
                               postprocessState.archival !== 0 || 
                               postprocessState.descreen !== 0 ||
                               postprocessState.sepia !== 0 ||
                               postprocessState.hue !== 0 ||
                               postprocessState.saturation !== 100 ||
                               postprocessState.invert !== 0 ||
                               postprocessState.adaptiveThreshold !== 0 ||
                               postprocessState.gaussianBlur !== 0 ||
                               postprocessState.medianBlur !== 0 ||
                               postprocessState.histogramEq !== false;
            
            if (!hasChanges) {
                notify('⚠️ Nie ma zmian do zapisania', 'warning');
                return;
            }
            
            const original = app.images[app.currentImageIdx];
            notify('⏳ Przetwarzanie...', 'info');
            
            setTimeout(() => {
                const img = new Image();
                img.src = original.data;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    applyPostprocessFilters(canvas, postprocessState);
                    const processedDataUrl = canvas.toDataURL('image/jpeg', 0.95);
                    
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/T/, '_').replace(/:/g, '');
                    const newImage = {
                        name: original.name.replace(/\\.[^/.]+$/, '') + '_processed_' + timestamp,
                        data: processedDataUrl
                    };
                    
                    app.images.push(newImage);
                    saveStorage();
                    updateThumbs();
                    
                    notify('✅ Zapisano: ' + newImage.name, 'success');
                    selectImage(app.images.length - 1);
                };
            }, 100);
        }
        
        function resetPostprocessing() {
            document.getElementById('contrastSlider').value = 0;
            document.getElementById('brightnessSlider').value = 0;
            document.getElementById('sharpenSlider').value = 0;
            document.getElementById('saturationSlider').checked = false;
            
            // Reset advanced filters
            document.getElementById('sepiaSlider').value = 0;
            document.getElementById('hueSlider').value = 0;
            document.getElementById('saturSlider').value = 100;
            document.getElementById('invertSlider').value = 0;
            
            // Reset OpenCV filters
            document.getElementById('adaptiveThresholdSlider').value = 0;
            document.getElementById('gaussianBlurSlider').value = 0;
            document.getElementById('medianBlurSlider').value = 0;
            document.getElementById('histogramEqCheckbox').checked = false;
            
            postprocessState.levels = 0;
            postprocessState.autoContrast = false;
            postprocessState.archival = 0;
            postprocessState.descreen = 0;
            postprocessState.sepia = 0;
            postprocessState.hue = 0;
            postprocessState.saturation = 100;
            postprocessState.invert = 0;
            postprocessState.adaptiveThreshold = 0;
            postprocessState.gaussianBlur = 0;
            postprocessState.medianBlur = 0;
            postprocessState.histogramEq = false;
            postprocessState.backgroundSubtraction = 0;
            postprocessState.morphologyClose = 0;
            postprocessState.autoInvert = false;
            
            document.getElementById('contrastValue').textContent = '0';
            document.getElementById('brightnessValue').textContent = '0%';
            document.getElementById('sharpenValue').textContent = '0%';
            document.getElementById('saturationValue').textContent = 'OFF';
            document.getElementById('sepiaValue').textContent = '0%';
            document.getElementById('hueValue').textContent = '0°';
            document.getElementById('saturValue').textContent = '100%';
            document.getElementById('invertValue').textContent = '0%';
            document.getElementById('adaptiveThresholdValue').textContent = 'OFF';
            document.getElementById('gaussianBlurValue').textContent = '0';
            document.getElementById('medianBlurValue').textContent = '0';
            document.getElementById('histogramEqValue').textContent = 'OFF';
            
            if (app.images[app.currentImageIdx] && app.images[app.currentImageIdx].data) {
                const original = app.images[app.currentImageIdx];
                if (app.viewer) {
                    app.viewer.open({
                        type: 'image',
                        url: original.data
                    });
                }
            }
            
            notify('↻ Reset - oryginalny obraz', 'info');
        }
        
        // ===== ADVANCED FILTERS WITH OPENCV.JS =====
        
        function onOpenCvReady() {
            opencvReady = true;
            console.log('✅ OpenCV.js załadowany i gotowy');
        }
        
        function adaptiveThresholdFilter(imageData, blockSize = 11, constant = 2) {
            if (!opencvReady) {
                console.warn('⚠️ OpenCV.js nie jest jeszcze załadowany');
                return imageData;
            }
            
            try {
                let src = cv.matFromImageData(imageData);
                let dst = new cv.Mat();
                let gray = new cv.Mat();
                
                // Konwersja do skali szarości
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // Adaptive Thresholding
                cv.adaptiveThreshold(gray, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, blockSize, constant);
                
                // Konwersja z powrotem do RGBA
                cv.cvtColor(dst, src, cv.COLOR_GRAY2RGBA);
                
                // Kopiowanie wyników do ImageData
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(src.data),
                    src.cols,
                    src.rows
                );
                
                // Czyszczenie pamięci
                src.delete();
                dst.delete();
                gray.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Adaptive Threshold:', e);
                return imageData;
            }
        }
        
        function gaussianBlurFilter(imageData, kernelSize = 5, sigma = 1.0) {
            if (!opencvReady) return imageData;
            
            try {
                let src = cv.matFromImageData(imageData);
                let dst = new cv.Mat();
                
                // Gaussian Blur
                let ksize = new cv.Size(kernelSize, kernelSize);
                cv.GaussianBlur(src, dst, ksize, sigma, sigma, cv.BORDER_DEFAULT);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(dst.data),
                    dst.cols,
                    dst.rows
                );
                
                src.delete();
                dst.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Gaussian Blur:', e);
                return imageData;
            }
        }
        
        function medianBlurFilter(imageData, kernelSize = 5) {
            if (!opencvReady) return imageData;
            
            try {
                let src = cv.matFromImageData(imageData);
                let dst = new cv.Mat();
                
                // Median Blur (dla denoising)
                cv.medianBlur(src, dst, kernelSize);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(dst.data),
                    dst.cols,
                    dst.rows
                );
                
                src.delete();
                dst.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Median Blur:', e);
                return imageData;
            }
        }
        
        function histogramEqualization(imageData) {
            if (!opencvReady) return imageData;
            
            try {
                let src = cv.matFromImageData(imageData);
                let gray = new cv.Mat();
                let dst = new cv.Mat();
                
                // Konwersja do szarości
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // Equalization
                cv.equalizeHist(gray, dst);
                
                // Konwersja z powrotem
                cv.cvtColor(dst, src, cv.COLOR_GRAY2RGBA);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(src.data),
                    src.cols,
                    src.rows
                );
                
                src.delete();
                gray.delete();
                dst.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Histogram Equalization:', e);
                return imageData;
            }
        }
        
        // ===== HEAVY-DUTY FILTER FUNCTIONS =====
        
        function backgroundSubtraction(imageData, kernelSize = 21) {
            if (!opencvReady) return imageData;
            
            try {
                console.log('🎨 Background Subtraction: Wyrównanie nierównego tła...');
                let src = cv.matFromImageData(imageData);
                let gray = new cv.Mat();
                let background = new cv.Mat();
                let result = new cv.Mat();
                
                // 1. Konwersja do szarości
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // 2. Estimacja tła za pomocą morphology (opening)
                let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(kernelSize, kernelSize));
                cv.morphologyEx(gray, background, cv.MORPH_OPEN, kernel);
                
                // 3. Odejmij tło od oryginału (contrast boost)
                cv.subtract(gray, background, result);
                
                // 4. Normalizuj wynik
                let minVal = new cv.Mat();
                let maxVal = new cv.Mat();
                cv.normalize(result, result, 0, 255, cv.NORM_MINMAX);
                
                // 5. Konwersja z powrotem na RGBA
                cv.cvtColor(result, src, cv.COLOR_GRAY2RGBA);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(src.data),
                    src.cols,
                    src.rows
                );
                
                kernel.delete();
                src.delete();
                gray.delete();
                background.delete();
                result.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Background Subtraction:', e);
                return imageData;
            }
        }
        
        function morphologyClose(imageData, kernelSize = 5) {
            if (!opencvReady) return imageData;
            
            try {
                console.log('🎨 Morphology Close: Połączenie przerwanych kresek...');
                let src = cv.matFromImageData(imageData);
                let gray = new cv.Mat();
                let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(kernelSize, kernelSize));
                let result = new cv.Mat();
                
                // Konwersja do szarości
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // Morphology Close: dylatacja + erozja (zamyka małe otwory)
                cv.morphologyEx(gray, result, cv.MORPH_CLOSE, kernel);
                
                // Konwersja z powrotem
                cv.cvtColor(result, src, cv.COLOR_GRAY2RGBA);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(src.data),
                    src.cols,
                    src.rows
                );
                
                kernel.delete();
                src.delete();
                gray.delete();
                result.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Morphology Close:', e);
                return imageData;
            }
        }
        
        function autoInvert(imageData) {
            // Detekuj czy tekst jest jasny na ciemnym tle
            const ctx = document.createElement('canvas').getContext('2d');
            const data = imageData.data;
            let darkPixels = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
                if (brightness < 128) darkPixels++;
            }
            
            const darkRatio = darkPixels / (data.length / 4);
            console.log(`🎨 Auto-Invert: ${(darkRatio * 100).toFixed(1)}% ciemnych pikseli - ${darkRatio > 0.7 ? 'INWERTUJ' : 'pozostaw'}`);
            
            // Jeśli >70% pikseli jest ciemnych, obrócić (tekst biały na czarnym)
            return darkRatio > 0.7;
        }
        
        function invertColors(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                data[i] = 255 - data[i];        // R
                data[i+1] = 255 - data[i+1];    // G
                data[i+2] = 255 - data[i+2];    // B
                // A nie zmieniamy
            }
            return imageData;
        }
        
        // ═════════════════════════════════════════════════════════════════
        // 🚀 V7.1 ENHANCEMENTS - Features A, B, C, D, E
        // ═════════════════════════════════════════════════════════════════
        
        // 💡 A: SUGGESTIONS FAN (Wachlarz podpowiedzi)
        function showSuggestionsForField(inputEl) {
            const fieldId = inputEl.dataset.field;
            const currentValue = inputEl.value.toLowerCase().trim();
            
            // Jeśli mniej niż 2 znaki, ukryj sugestie
            if (currentValue.length < 2) {
                hideSuggestions();
                return;
            }
            
            // Zbierz wszystkie wartości tego pola z aktów tej strony
            const suggestions = new Set();
            const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
            
            currentActList.forEach(act => {
                if (act.fieldValues && act.fieldValues[fieldId]) {
                    const val = act.fieldValues[fieldId].toString().toLowerCase();
                    // Jeśli zawiera to co piszt i nie jest identyczne
                    if (val.includes(currentValue) && val !== currentValue) {
                        suggestions.add(act.fieldValues[fieldId]);
                    }
                }
            });
            
            if (suggestions.size === 0) {
                hideSuggestions();
                return;
            }
            
            // Pozycjonuj wachlarz wokół input'a
            const rect = inputEl.getBoundingClientRect();
            const container = document.querySelector('.viewer-container');
            const containerRect = container.getBoundingClientRect();
            const wachlarz = document.getElementById('suggestionsWachlarz');
            
            wachlarz.style.left = (rect.left - containerRect.left - 220) + 'px';
            wachlarz.style.top = (rect.top - containerRect.top + rect.height + 5) + 'px';
            wachlarz.innerHTML = '';
            
            // Dodaj sugestie (max 5)
            Array.from(suggestions).slice(0, 5).forEach((suggestion, idx) => {
                const div = document.createElement('div');
                div.className = 'suggestion';
                div.textContent = suggestion.substring(0, 30);
                div.title = suggestion;
                div.style.animation = `fanRotate 0.4s ease-out ${idx * 0.08}s backwards`;
                div.onclick = (e) => {
                    e.stopPropagation();
                    inputEl.value = suggestion;
                    inputEl.focus();
                    hideSuggestions();
                    updateFieldStatus();
                    updateProgressBar();
                    inputEl.dispatchEvent(new Event('change'));
                };
                div.onmouseenter = () => {
                    div.style.transform = 'translateX(10px) rotate(0deg) scale(1.05)';
                    div.style.color = '#00ff88';
                };
                div.onmouseleave = () => {
                    div.style.transform = 'translateX(-10px) rotate(-3deg) scale(1)';
                    div.style.color = 'inherit';
                };
                wachlarz.appendChild(div);
            });
            
            wachlarz.classList.add('visible');
            console.log(`💡 A: Wachlarz ${suggestions.size} sugestii dla "${fieldId}"`);
        }
        
        function hideSuggestions() {
            const wachlarz = document.getElementById('suggestionsWachlarz');
            wachlarz.classList.remove('visible');
            setTimeout(() => { wachlarz.innerHTML = ''; }, 300);
        }
        
        // 📊 C: STATISTICS - Aktualizuj pasek postępu
        function updateProgressBar() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const inputs = activeForm.querySelectorAll('.field-input');
            const completed = Array.from(inputs).filter(input => 
                input.value?.trim().length > 0
            ).length;
            
            const total = inputs.length;
            const percent = total > 0 ? (completed / total) * 100 : 0;
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressFill) {
                progressFill.style.width = percent + '%';
                progressFill.style.backgroundColor = percent === 100 ? '#10b981' : '#0078d4';
            }
            if (progressText) progressText.textContent = `${completed}/${total}`;
            
            // 📊 Pokaż statystyki w toolbar'u
            updateActStatistics();
        }
        
        function updateActStatistics() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const act = getCurrentAct();
            if (!act) return;
            
            const inputs = activeForm.querySelectorAll('.field-input');
            const filledCount = Array.from(inputs).filter(inp => inp.value?.trim().length > 0).length;
            const roiCount = Object.keys(act.fieldROIs || {}).length;
            
            // Pokaż w statusu
            const stats = `📊 ${filledCount}/${inputs.length} pól | 🎨 ${roiCount} ROI`;
            const existingStats = document.getElementById('actStatistics');
            if (existingStats) {
                existingStats.textContent = stats;
            }
        }
        
        // E: AUTO-FOCUS pierwszy input gdy wybieramy akt
        function focusFirstField() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const firstInput = activeForm.querySelector('.field-input');
            if (firstInput) {
                setTimeout(() => {
                    firstInput.focus();
                    firstInput.select?.();
                }, 100);
            }
        }
        
        // B: KEYBOARD SHORTCUTS (Skróty klawiszowe)
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignoruj jeśli wpisujemy w textaree (chyba że Ctrl/Cmd)
                const isTextarea = e.target.tagName === 'TEXTAREA';
                const isInput = e.target.tagName === 'INPUT';
                const hasCtrlCmd = e.ctrlKey || e.metaKey;
                
                // Ctrl+S = Zapisz akt
                if (e.key === 's' || e.key === 'S') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        saveRecord();
                        console.log('⌨️ B: Ctrl+S → Zapisz');
                        return;
                    }
                }
                
                // Ctrl+D = Usuń akt
                if (e.key === 'd' || e.key === 'D') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        if (confirm('🗑️  Usunąć bieżący akt?')) {
                            deleteCurrentRecord();
                        }
                        console.log('⌨️ B: Ctrl+D → Usuń');
                        return;
                    }
                }
                
                // Ctrl+C = Duplikuj poprzedni (przy focus na input, pamiętaj!)
                if (e.key === 'c' || e.key === 'C') {
                    if (hasCtrlCmd && !isTextarea) { // W textarea, Ctrl+C to zwykły copy
                        e.preventDefault();
                        copyPreviousActEnhanced();
                        console.log('⌨️ B: Ctrl+C → Copy Previous');
                        return;
                    }
                }
                
                // Ctrl+A = Toggle Act ROI drawing mode (TASK #1)
                if (e.key === 'a' || e.key === 'A') {
                    if (hasCtrlCmd && !isInput && !isTextarea) {
                        e.preventDefault();
                        toggleActMode();
                        console.log('⌨️ B: Ctrl+A → Act Mode Toggle');
                        return;
                    }
                }
                
                // Ctrl+N = Nowy akt
                if (e.key === 'n' || e.key === 'N') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        const count = prompt('📋 Ile aktów dodać?', '1');
                        if (!count) return;
                        
                        const numToAdd = Math.max(1, parseInt(count) || 1);
                        for (let i = 0; i < numToAdd; i++) {
                            const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                            const newActNum = (currentActList.length || 0) + 1 + i;
                            
                            const newAct = {
                                actNum: newActNum,
                                imageIdx: app.currentImageIdx,
                                type: 'birth',  // Domyślny typ
                                fieldValues: {},
                                fieldROIs: {},
                                actROI: null,
                                timestamp: new Date().toISOString()
                            };
                            app.imageActs.push(newAct);
                        }
                        
                        saveStorage();
                        renderActButtons();
                        
                        // Zaznacz ostatnio dodany
                        const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                        selectAct(currentActList[currentActList.length - numToAdd].actNum);
                        
                        notify(`✨ Dodano ${numToAdd} aktów`, 'success');
                        console.log(`⌨️ B: Ctrl+N → +${numToAdd} aktów`);
                    }
                }
                
                // Arrow Left/Right = poprzedni/następny akt
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    if (isInput || isTextarea) return; // Nie w polu tekstowym
                    
                    const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                    const currentAct = getCurrentAct();
                    if (!currentAct) return;
                    
                    const currentIdx = currentActList.findIndex(a => a.actNum === currentAct.actNum);
                    let nextIdx = currentIdx;
                    
                    if (e.key === 'ArrowLeft' && currentIdx > 0) {
                        nextIdx = currentIdx - 1;
                    } else if (e.key === 'ArrowRight' && currentIdx < currentActList.length - 1) {
                        nextIdx = currentIdx + 1;
                    }
                    
                    if (nextIdx !== currentIdx) {
                        selectAct(currentActList[nextIdx].actNum);
                        console.log(`⌨️ Nawigacja: Akt ${currentActList[nextIdx].actNum}`);
                    }
                }
                
                // Ctrl+M = Toggle thumbnails panel
                if (e.key === 'm' || e.key === 'M') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        toggleThumbsPanel();
                        console.log('⌨️ B: Ctrl+M → Toggle Thumbs');
                        return;
                    }
                }
                
                // Ctrl+L = Toggle acts panel
                if (e.key === 'l' || e.key === 'L') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        toggleActsPanel();
                        console.log('⌨️ B: Ctrl+L → Toggle Acts');
                        return;
                    }
                }
                
                // TASK #3: Ctrl+J = Import JSON
                if (e.key === 'j' || e.key === 'J') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        importJSON();
                        console.log('⌨️ B: Ctrl+J → JSON Import');
                        return;
                    }
                }
            });
        }
        
        // D: ENHANCED COPY PREVIOUS
        function copyPreviousActEnhanced() {
            if (app.currentActNum === null || app.currentActNum === undefined) {
                notify('❌ Najpierw wybierz akt', 'error');
                return;
            }
            
            const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
            const currentIdx = currentActList.findIndex(a => a.actNum === app.currentActNum);
            
            if (currentIdx === 0) {
                notify('ℹ️ Brak poprzedniego aktu do skopiowania', 'info');
                return;
            }
            
            const previousAct = currentActList[currentIdx - 1];
            const currentAct = getCurrentAct();
            if (!currentAct) return;
            
            // Kopiuj wartości pól
            currentAct.fieldValues = { ...previousAct.fieldValues };
            renderFormSections();
            
            // Kopiuj ROI'e jeśli istnieją
            if (previousAct.fieldROIs && Object.keys(previousAct.fieldROIs).length > 0) {
                currentAct.fieldROIs = JSON.parse(JSON.stringify(previousAct.fieldROIs));
                redrawROIs();
            }
            
            saveStorage();
            updateProgressBar();
            updateFieldStatus();
            focusFirstField();
            
            notify(`✨ Skopiowano z Aktu ${previousAct.actNum}`, 'success');
            console.log(`📋 D: Copy Previous - Akt ${app.currentActNum} ← Akt ${previousAct.actNum}`);
        }
        
        // ===== PASTE DIALOG FUNCTIONS =====
        function showPasteDialog() {
            const pasteOverlay = document.getElementById('pasteOverlay');
            if (pasteOverlay) {
                pasteOverlay.classList.add('visible');
                const textarea = document.getElementById('pasteTextarea');
                if (textarea) {
                    textarea.value = '';
                    textarea.focus();
                }
            }
        }
        
        function closePasteDialog() {
            const pasteOverlay = document.getElementById('pasteOverlay');
            if (pasteOverlay) {
                pasteOverlay.classList.remove('visible');
            }
        }
        
        function processPastedData() {
            const textarea = document.getElementById('pasteTextarea');
            if (!textarea || !textarea.value.trim()) {
                notify('⚠️ Wklejone pole jest puste', 'warning');
                return;
            }
            
            const pastedData = textarea.value;
            const lines = pastedData.split('\n').filter(line => line.trim());
            
            if (lines.length === 0) {
                notify('⚠️ Brak danych do wklejenia', 'warning');
                return;
            }
            
            // Parsuj nagłówki (pierwszy wiersz) lub użyj default headers
            let headers = [];
            let dataLines = lines;
            
            // Spróbuj rozpoznać czy pierwszy wiersz to nagłówki (zawiera słowa jak "Imię", "Nazwisko", itp)
            const firstLineColumns = lines[0].split('\t');
            const headerKeywords = ['imię', 'nazwisko', 'data', 'wiek', 'zawód', 'status', 'parafia', 'księga', 'strona', 'miejsce', 'należy'];
            const isHeader = firstLineColumns.some(col => headerKeywords.some(kw => col.toLowerCase().includes(kw)));
            
            if (isHeader) {
                headers = firstLineColumns.map(h => h.trim().toLowerCase());
                dataLines = lines.slice(1);
            } else {
                // Default headers w kolejności jak w tabeli (bez checkboxa)
                headers = [
                    'id źródłowe', 'księga (nr)', 'strona (nr)', 'numer aktu', 'data chrztu', 'data zgłoszenia', 'parafia',
                    'imię dziecka', 'nazwisko dziecka', 'data ur. dziecka', 'płeć dziecka', 'status dziecka',
                    'ojciec (imię)', 'ojciec (nazwisko)', 'ojciec (wiek)', 'ojciec (zawód)', 'ojciec (stan cywilny)',
                    'matka (imię)', 'matka (nazwisko)', 'matka (panieńskie)', 'matka (wiek)', 'matka (zawód)', 'matka (stan cywilny)', 'matka (miejsce)',
                    'ojciec chrzestny (imię)', 'ojciec chrzestny (nazwisko)', 'ojciec chrzestny (miejsce)',
                    'matka chrzestna (imię)', 'matka chrzestna (nazwisko)', 'matka chrzestna (miejsce)',
                    'ksiądz (imię)', 'ksiądz (nazwisko)', 'ksiądz (zawód)',
                    'zgł. (imię)', 'zgł. (nazwisko)', 'zgł. (zawód)', 'zgł. (wiek)', 'zgł. (miejsce)',
                    'świadek 1 (imię)', 'świadek 1 (nazwisko)', 'świadek 1 (zawód)', 'świadek 1 (miejsce)',
                    'świadek 2 (imię)', 'świadek 2 (nazwisko)', 'świadek 2 (zawód)', 'świadek 2 (miejsce)',
                    'świadek 3 (imię)', 'świadek 3 (nazwisko)', 'świadek 3 (zawód)', 'świadek 3 (miejsce)',
                    'uwagi', 'opis źródła'
                ];
            }
            
            // Mapowanie kolumn na fieldValues keys
            const columnMap = {
                'id źródłowe': 'original_id',
                'księga (nr)': 'ksiega_nr',
                'strona (nr)': 'strona_nr',
                'numer aktu': 'nr_aktu',
                'data chrztu': 'christening_date',
                'data zgłoszenia': 'report_date',
                'parafia': 'parafia',
                'imię dziecka': 'dziecko_imie',
                'nazwisko dziecka': 'dziecko_nazwisko',
                'data ur. dziecka': 'dziecko_data_ur',
                'płeć dziecka': 'dziecko_plec',
                'status dziecka': 'dziecko_status',
                'ojciec (imię)': 'ojciec_imie',
                'ojciec (nazwisko)': 'ojciec_nazwisko',
                'ojciec (wiek)': 'ojciec_wiek',
                'ojciec (zawód)': 'ojciec_zawod',
                'ojciec (stan cywilny)': 'ojciec_stan_cywilny',
                'matka (imię)': 'matka_imie',
                'matka (nazwisko)': 'matka_nazwisko',
                'matka (panieńskie)': 'matka_panienskie',
                'matka (wiek)': 'matka_lata',
                'matka (zawód)': 'matka_zawod',
                'matka (stan cywilny)': 'matka_stan_cywilny',
                'matka (miejsce)': 'matka_miejsce',
                'ojciec chrzestny (imię)': 'ojciec_chrzestny_imie',
                'ojciec chrzestny (nazwisko)': 'ojciec_chrzestny_nazwisko',
                'ojciec chrzestny (miejsce)': 'ojciec_chrzestny_miejsce',
                'matka chrzestna (imię)': 'matka_chrzestna_imie',
                'matka chrzestna (nazwisko)': 'matka_chrzestna_nazwisko',
                'matka chrzestna (miejsce)': 'matka_chrzestna_miejsce',
                'ksiądz (imię)': 'ksiadz_imie',
                'ksiądz (nazwisko)': 'ksiadz_nazwisko',
                'ksiądz (zawód)': 'ksiadz_zawod',
                'zgł. (imię)': 'zglaszajacy_imie',
                'zgł. (nazwisko)': 'zglaszajacy_nazwisko',
                'zgł. (zawód)': 'zglaszajacy_zawod',
                'zgł. (wiek)': 'zglaszajacy_wiek',
                'zgł. (miejsce)': 'zglaszajacy_miejsce',
                'świadek 1 (imię)': 'swiadek_1_imie',
                'świadek 1 (nazwisko)': 'swiadek_1_nazwisko',
                'świadek 1 (zawód)': 'swiadek_1_zawod',
                'świadek 1 (miejsce)': 'swiadek_1_miejsce',
                'świadek 2 (imię)': 'swiadek_2_imie',
                'świadek 2 (nazwisko)': 'swiadek_2_nazwisko',
                'świadek 2 (zawód)': 'swiadek_2_zawod',
                'świadek 2 (miejsce)': 'swiadek_2_miejsce',
                'świadek 3 (imię)': 'swiadek_3_imie',
                'świadek 3 (nazwisko)': 'swiadek_3_nazwisko',
                'świadek 3 (zawód)': 'swiadek_3_zawod',
                'świadek 3 (miejsce)': 'swiadek_3_miejsce',
                'uwagi': 'custom_note',
                'opis źródła': 'notes_org'
            };
            
            // Przetwarzaj wiersze danych
            let importedCount = 0;
            dataLines.forEach((line, lineIdx) => {
                const columns = line.split('\t');
                const act = app.imageActs[lineIdx];
                
                if (!act) {
                    console.warn(`⚠️ Brak aktu dla wiersza ${lineIdx + 1}`);
                    return;
                }
                
                if (!act.fieldValues) {
                    act.fieldValues = {};
                }
                
                // Mapuj kolumny na fieldValues
                columns.forEach((value, colIdx) => {
                    if (value.trim()) {
                        const header = headers[colIdx]?.toLowerCase().trim() || '';
                        const fieldKey = columnMap[header];
                        
                        if (fieldKey) {
                            act.fieldValues[fieldKey] = value.trim();
                        }
                    }
                });
                
                importedCount++;
                updateCurrentRowInTable();
            });
            
            // Zapisz i odśwież
            saveStorage();
            renderRecordsTable();
            closePasteDialog();
            
            notify(`✅ Wklejono ${importedCount} wierszy danych`, 'success');
            console.log(`📋 Imported ${importedCount} rows from paste data`);
        }
        
        // ===== EXPOSE FUNCTIONS TO WINDOW =====
        window.showPasteDialog = showPasteDialog;
        window.closePasteDialog = closePasteDialog;
        window.processPastedData = processPastedData;
    </script>
    
    <!-- OpenCV.js - Asynchroniczne załadowanie -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>
    <script>
        // Callback gdy OpenCV jest gotowy
        if (typeof cv !== 'undefined') {
            cv.onRuntimeInitialized = onOpenCvReady;
        }
    </script>
</body>
</html>
