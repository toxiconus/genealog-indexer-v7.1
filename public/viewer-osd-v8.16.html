<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genealog Indexer v8.12 - Zaawansowany Indekser Akt z OCR</title>
    <script src="https://openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
    <!-- Supabase Client - import map + ESM module -->
    <script type="importmap">
    {
      "imports": {
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
    </script>
    <script type="module">
      import { createClient } from '@supabase/supabase-js'
      window.createSupabaseClient = createClient
    </script>
    <script>
        // Supabase configuration - czekaj aż biblioteka się załaduje
        const SUPABASE_URL = 'https://jbwkrconzozhgzikabmv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_X0Qm9TSqq0nOOtCo8RycMQ_PeirqbMt';
        let supabase = null;

        // Czekaj aż createSupabaseClient będzie dostępne (z importmap)
        async function initSupabaseClient() {
            let attempts = 0;
            while (!window.createSupabaseClient && attempts < 100) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }
            
            if (window.createSupabaseClient && typeof window.createSupabaseClient === 'function') {
                console.log('✅ Supabase createClient loaded');
                window.supabase_client = window.createSupabaseClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('✅ Supabase initialized');
                window.dispatchEvent(new Event('supabaseReady'));
            } else {
                console.error('❌ Supabase library failed to load');
            }
        }

        // Inicjalizuj na DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSupabaseClient);
        } else {
            initSupabaseClient();
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #0a0a0a;
            color: #ddd;
            overflow: hidden;
        }
        #app {
            display: grid;
            grid-template-rows: auto 1fr 25%;
            height: 100vh;
        }
        .toolbar {
            background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
            border-bottom: 1px solid #2a2a2a;
            padding: 5px 8px;
            display: flex;
            align-items: flex-start;
            align-content: flex-start;
            gap: 3px;
            min-height: auto;
            height: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 100;
            flex-wrap: wrap;
            overflow-x: visible;
            overflow-y: visible;
            grid-row: 1;
        }
        .toolbar-title {
            font-size: 11px;
            color: #0078d4;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: auto;
        }
        .toolbar-btn {
            background: #252525;
            border: 1px solid #3a3a3a;
            color: #bbb;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .toolbar-btn:hover {
            background: #2d2d2d;
            border-color: #0078d4;
            color: #0078d4;
            transform: translateY(-1px);
        }
        .toolbar-btn.active {
            background: #0078d4;
            border-color: #0078d4;
            color: white;
            box-shadow: 0 0 12px rgba(0,120,212,0.4);
        }
        .toolbar-btn.disabled {
            background: #1a1a1a;
            border-color: #333;
            color: #555;
            opacity: 0.5;
        }
        .toolbar-btn.disabled:hover {
            background: #1a1a1a;
            border-color: #333;
            color: #555;
            transform: none;
        }
        #actBtn {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        .toolbar-sep {
            width: 1px;
            height: 18px;
            background: #2a2a2a;
            margin: 0 1px;
            flex-shrink: 0;
        }
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 100px 140px 1fr 300px;
            gap: 0;
            overflow: hidden;
            grid-row: 2;
        }
        .main-content.thumbs-collapsed {
            grid-template-columns: 0px 140px 1fr 300px;
        }
        .viewer-panel {
            flex: 1;
            background: #000;
            position: relative;
            display: flex;
            flex-direction: column;
            grid-column: 3;
        }
        .viewer-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #viewer {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #imageFallback {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        #imageFallback.active {
            display: block;
        }
        .viewer-container.drag-over {
            border: 4px dashed #0078d4 !important;
            background-color: rgba(0, 120, 212, 0.05) !important;
        }
        .rotate-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            gap: 6px;
            z-index: 60;
        }
        .rotate-btn {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            color: #ddd;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .rotate-btn:hover {
            background: #252525;
            border-color: #0078d4;
            color: #0078d4;
        }
        .roi-info-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            color: #0078d4;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 60;
            display: none;
            border: 1px solid #0078d4;
        }
        .roi-info-overlay.visible {
            display: block;
        }
        .roi-overlay {
            border: 2px dashed #0078d4;
            background: rgba(0,120,212,0.15);
            pointer-events: none;
            z-index: 100;
        }
        .roi-overlay.active {
            border-color: #ff9800;
            border-width: 3px;
            background: rgba(255,152,0,0.2);
        }
        .act-overlay {
            border: 2px solid #10b981;
            background: none;
            pointer-events: none;
            z-index: 100;
        }
        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair !important;
            z-index: 50;
            pointer-events: none;
        }
        .context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #10b981;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            min-width: 200px;
        }
        .context-menu.active {
            display: block;
        }
        .context-menu-item {
            padding: 10px 15px;
            color: #fff;
            cursor: pointer;
            border-bottom: 1px solid #1a1a1a;
            font-size: 13px;
            transition: background 0.2s;
        }
        .context-menu-item:hover {
            background: rgba(16,185,129,0.2);
            color: #10b981;
        }
        .context-menu-item:last-child {
            border-bottom: none;
        }
        .context-menu-item.danger {
            color: #ff6b6b;
        }
        .context-menu-item.danger:hover {
            background: rgba(255,107,107,0.1);
            color: #ff8888;
        }
        .right-panel {
            background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
            border-left: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            grid-column: 4;
            min-width: 300px;
            max-height: 100%;
        }
        .right-panel.collapsed {
            min-width: 0;
            border: none;
        }
        .acts-panel {
            background: #0f0f0f;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
            overflow-y: auto;
            min-width: 140px;
            grid-column: 2;
        }
        .acts-panel.collapsed {
            min-width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }
        .act-button {
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .act-button:hover {
            background: #252525;
            border-color: #0078d4;
        }
        .act-button.active {
            background: #0078d4;
            border-color: #0078d4;
            color: white;
            font-weight: bold;
        }
        
        .acts-group-header {
            padding: 8px 6px;
            font-size: 11px;
            font-weight: 600;
            color: #aaa;
            background: #1a1a1a;
            border-bottom: 1px solid #3a3a3a;
            margin-top: 4px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        
        .acts-group-header:hover {
            background: #252525;
            color: #ddd;
        }
        
        .act-control-btn {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            padding: 1px 3px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .act-control-btn:hover {
            opacity: 0.8;
        }
        
        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 4px;
        }
        .panel-content::-webkit-scrollbar {
            width: 8px;
        }
        .panel-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .panel-content::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }
        .panel-content::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }
        #formsContainer {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 8px;
            padding: 0;
        }
        .records-sidebar {
            width: 50px;
            background: #151515;
            border-right: 1px solid #2a2a2a;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 8px;
        }
        .form-section {
            padding: 12px;
            border-bottom: 1px solid #2a2a2a;
            display: none;
            flex: 1;
            overflow-y: auto;
        }
        .form-section.active {
            display: block;
        }
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .form-header h3 {
            font-size: 13px;
            color: #ddd;
            font-weight: 600;
        }
        .record-counter {
            font-size: 10px;
            color: #888;
            background: #252525;
            padding: 3px 8px;
            border-radius: 10px;
        }
        .form-group {
            margin-bottom: 4px;
        }
        .form-group label {
            display: block;
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            background: #0f0f0f;
            border: 1px solid #3a3a3a;
            color: #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.15s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #0078d4;
            outline: none;
            background: #1a1a1a;
            box-shadow: 0 0 0 3px rgba(0,120,212,0.1);
        }
        .form-group input.has-roi {
            border-left: 4px solid #10b981;
            box-shadow: 0 0 8px rgba(16,185,129,0.3);
        }
        /* 🟢 P0: Color-Coded Fields - 3 status indicators */
        .form-group input.field-complete {
            border-left: 4px solid #10b981;  /* 🟢 Green - filled */
            box-shadow: 0 0 8px rgba(16,185,129,0.3);
        }
        .form-group input.field-roi-only {
            border-left: 4px solid #fbbf24;  /* 🟡 Yellow - ROI marked but no value */
            box-shadow: 0 0 8px rgba(251,191,36,0.3);
        }
        .form-group input.field-empty {
            border-left: 4px solid #ef4444;  /* 🔴 Red - empty & no ROI */
            box-shadow: 0 0 8px rgba(239,68,68,0.3);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
            font-family: 'Courier New', monospace;
        }
        .accordion-item {
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            background: #0f0f0f;
            margin-bottom: 4px;
        }
        .accordion-header {
            background: #1a1a1a;
            border: none;
            color: #ddd;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            width: 100%;
            text-align: left;
        }
        .accordion-header:hover {
            background: #252525;
        }
        .accordion-header.active {
            background: #0078d4;
            color: white;
        }
        .accordion-content {
            display: none;
            padding: 12px;
            background: #0f0f0f;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .accordion-content.active {
            display: block;
            max-height: 500px;
        }
        .form-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 12px;
        }
        .form-btn {
            background: #107c10;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .form-btn:hover {
            background: #0d6a0d;
        }
        .form-btn.danger {
            background: #c42b1c;
        }
        .form-btn.danger:hover {
            background: #a02318;
        }
        .thumbnails-bar {
            background: #0f0f0f;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            gap: 8px;
            overflow-y: auto;
            min-width: 100px;
        }
        .thumbnails-bar.collapsed {
            min-width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }
        /* 💡 Suggestions Fan - Wachlarz podpowiedzi */
        #suggestionsWachlarz {
            pointer-events: none;
            display: none;
        }
        #suggestionsWachlarz.visible {
            display: block;
            pointer-events: auto;
        }
        #suggestionsWachlarz .suggestion {
            background: rgba(20, 20, 40, 0.95);
            border: 1px solid #0078d4;
            color: #0078d4;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.15s ease;
            transform: translateX(-10px) rotate(-3deg);
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 8px rgba(0,120,212,0.2);
        }
        #suggestionsWachlarz .suggestion:hover {
            background: rgba(0, 120, 212, 0.2);
            border-color: #00ff88;
            color: #00ff88;
            transform: translateX(0) rotate(0deg);
            box-shadow: 0 4px 16px rgba(0,255,136,0.3);
        }
        @keyframes fanRotate {
            from {
                transform: translateX(-30px) rotate(-15deg) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(-10px) rotate(-3deg) scale(1);
                opacity: 1;
            }
        }
        .thumbnail {
            width: 100px;
            height: 75px;
            border: 2px solid #333;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            background: #1a1a1a;
            flex-shrink: 0;
            transition: all 0.2s ease;
            margin-bottom: 4px;
        }
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .thumbnail:hover {
            border-color: #0078d4;
        }
        .thumbnail.active {
            border-color: #0078d4;
            box-shadow: 0 0 16px rgba(0,120,212,0.6);
        }
        /* Custom tooltip dla miniaturki */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        /* Miniaturka hover efekt */
        .thumbnail:hover {
            border: 2px solid #0078d4;
            cursor: pointer;
        }
        .notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            background: #0078d4;
            color: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .notification.error {
            background: #c42b1c;
        }
        .notification.success {
            background: #107c10;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f0f0f;
        }
        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }
        /* Floating formularz nad obrazem */
        .floating-form {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 380px;
            max-height: 80vh;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            flex-direction: column;
            backdrop-filter: blur(4px);
            padding: 12px;
        }
        .floating-form.visible {
            display: flex;
        }
        .floating-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            color: #0078d4;
            font-weight: 600;
        }
        .floating-form-close {
            background: none;
            border: none;
            color: #ddd;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
        }
        .floating-form-close:hover {
            color: #0078d4;
        }
        .floating-form-content {
            flex: 1;
            overflow-y: auto;
        }
        .floating-form-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }
        /* Lepsze pin-upy – małe, eleganckie, przesuwalne */
        .field-pinup {
            display: none; /* 🔒 Hidden in v7.1 - act-only mode */
            position: absolute;
            width: 260px;
            background: rgba(15, 15, 20, 0.95);
            border: 1px solid rgba(0, 120, 212, 0.8);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.8);
            z-index: 101;
            padding: 10px;
            cursor: move;
            user-select: none;
            backdrop-filter: blur(12px);
            transition: all 0.2s ease;
            font-size: 12px;
        }
        .field-pinup:hover {
            box-shadow: 0 12px 32px rgba(0,120,212,0.3);
            border-color: #0099ff;
        }
        .field-pinup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: #0078d4;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .field-pinup-close {
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        .field-pinup-close:hover {
            color: #ff6b6b;
            background: rgba(255,107,107,0.15);
        }
        /* Panel z kartami aktów - przezroczysty i przesuwalny */
        #actsContainer {
            background: rgba(30, 30, 40, 0.6) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            pointer-events: none !important;
            transition: all 0.3s ease;
        }
        /* Ale same karty niech reagują na kliknięcia i hover */
        .act-card {
            pointer-events: auto !important;
            background: rgba(50, 50, 70, 0.8);
            border: 1px solid #555;
        }
        .ocr-btn {
            background: none;
            border: none;
            color: #00ccff;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ocr-btn:hover {
            color: #00ff88;
            background: rgba(0,204,255,0.15);
            transform: scale(1.15);
        }
        .ocr-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .field-pinup input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(10,10,10,0.8);
            border: 1px solid #3a3a3a;
            color: #ddd;
            border-radius: 6px;
            font-size: 13px;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        .field-pinup input:focus {
            border-color: #0078d4;
            background: rgba(20,20,30,0.9);
            box-shadow: 0 0 0 3px rgba(0,120,212,0.2);
            outline: none;
        }
        .field-pinup input.has-roi {
            border-left: 4px solid #10b981;
        }
        /* Wizard prompt – instrukcja dla bieżącego pola */
        .wizard-prompt {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,120,212,0.92);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 99;
            display: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(4px);
        }
        .wizard-prompt.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        .wizard-prompt button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.15s;
            font-size: 12px;
        }
        .wizard-prompt button:hover {
            background: rgba(255,255,255,0.3);
        }
        .wizard-progress {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,120,212,0.85);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 99;
            display: none;
            backdrop-filter: blur(4px);
        }
        .wizard-progress.visible {
            display: block;
        }
        .wizard-progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .wizard-progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }
        
        /* ===== POSTPROCESSING PANEL ===== */
        .postprocess-panel {
            position: fixed;
            right: 0;
            top: 40px;
            width: 320px;
            background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
            border-left: 1px solid #2a2a2a;
            border-radius: 6px 0 0 6px;
            padding: 12px;
            box-shadow: -4px 4px 16px rgba(0,0,0,0.6);
            z-index: 95;
            display: none;
            flex-direction: column;
            gap: 10px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .postprocess-panel.visible {
            display: flex;
        }
        .postprocess-title {
            font-size: 12px;
            color: #0078d4;
            font-weight: 600;
            text-transform: uppercase;
        }
        .postprocess-slider {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .postprocess-slider label {
            font-size: 11px;
            color: #888;
            font-weight: 500;
        }
        .postprocess-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #2a2a2a;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        .postprocess-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0078d4;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,120,212,0.5);
        }
        .postprocess-slider input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0078d4;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 8px rgba(0,120,212,0.5);
        }
        .postprocess-value {
            font-size: 10px;
            color: #0078d4;
            text-align: center;
        }
        .postprocess-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 10px;
        }
        .postprocess-btn {
            background: #0078d4;
            border: none;
            color: white;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.15s;
        }
        .postprocess-btn:hover {
            background: #0099ff;
        }
        .postprocess-btn.reset {
            background: #3a3a3a;
        }
        .postprocess-btn.reset:hover {
            background: #454545;
        }
        /* ⭐ P0: Progress Bar - Show field completion status */
        #progressBar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
            padding: 0 8px;
            height: 24px;
        }
        .progress-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .progress-bar {
            width: 100px;
            height: 6px;
            background: #1a1a1a;
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid #3a3a3a;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #0078d4 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(16,185,129,0.4);
        }
        .progress-text {
            font-size: 11px;
            color: #888;
            min-width: 35px;
            text-align: right;
        }
        
        /* ===== TABLE SECTION (25% height) ===== */
        .table-section {
            background: #0f0f0f;
            border-top: 2px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            grid-row: 3;
        }
        .table-header {
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            gap: 8px;
        }
        .table-header-title {
            font-size: 12px;
            font-weight: 600;
            color: #0078d4;
            text-transform: uppercase;
        }
        .table-header-actions {
            display: flex;
            gap: 6px;
        }
        .table-action-btn {
            background: #252525;
            border: 1px solid #3a3a3a;
            color: #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .table-action-btn:hover {
            background: #2d2d2d;
            border-color: #0078d4;
            color: #0078d4;
        }
        .table-container {
            flex: 1;
            overflow: auto;
            position: relative;
            overflow-x: auto;
            overflow-y: auto;
            height: 100%;
        }
        #dataTable {
            width: 100%;
            min-width: 1400px;
            border-collapse: collapse;
            font-size: 11px;
            color: #ddd;
            user-select: text;
        }
        #dataTable thead {
            background: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #dataTable thead th {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            color: #0078d4;
            white-space: nowrap;
            user-select: none;
        }
        #dataTable tbody tr {
            border-bottom: 1px solid #1a1a1a;
            transition: background 0.15s ease;
        }
        #dataTable tbody tr:hover {
            background: #1a1a1a;
        }
        #dataTable tbody tr.selected {
            background: rgba(0, 120, 212, 0.2);
        }
        #dataTable td {
            border: 1px solid #2a2a2a;
            padding: 6px 10px;
            background: #0f0f0f;
            position: relative;
        }
        #dataTable td:hover {
            background: #151515;
        }
        .cell-editable {
            cursor: text;
            user-select: text;
        }
        .cell-editable:hover {
            background: #252525 !important;
            border-color: #0078d4 !important;
            outline: 1px solid rgba(0, 120, 212, 0.3);
        }
        .cell-input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #0078d4;
            color: #ddd;
            padding: 4px 6px;
            font-size: 11px;
            font-family: inherit;
            border-radius: 2px;
        }
        .cell-input:focus {
            outline: none;
            box-shadow: 0 0 8px rgba(0, 120, 212, 0.5);
        }
        #dataTable th:first-child,
        #dataTable td:first-child {
            background: #141414;
            color: #888;
            font-weight: 500;
            width: 40px;
            text-align: center;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        .row-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #0078d4;
        }
        .paste-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #0078d4;
            border-radius: 8px;
            padding: 20px;
            z-index: 2000;
            display: none;
            flex-direction: column;
            gap: 12px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        }
        .paste-overlay.visible {
            display: flex;
        }
        .paste-overlay textarea {
            width: 100%;
            height: 150px;
            background: #0f0f0f;
            border: 1px solid #3a3a3a;
            color: #ddd;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        .paste-overlay-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .paste-overlay-btn {
            background: #0078d4;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.15s ease;
        }
        .paste-overlay-btn:hover {
            background: #0099ff;
        }
        .paste-overlay-btn.cancel {
            background: #3a3a3a;
        }
        .paste-overlay-btn.cancel:hover {
            background: #454545;
        }

        /* === PRAWA BELKA – główne poprawki === */
        #right-panel {
            width: 368px;               /* trochę więcej niż 360 – lepiej na większości ekranów */
            min-width: 340px;           /* bezpieczeństwo przed zbyt wąskim panelem */
            padding: 20px 16px 24px;    /* więcej powietrza na dole */
            box-sizing: border-box;
        }

        /* Grupy pól – wyraźniejsze oddzielenie */
        .field-group {
            background: #f9fafb;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px 14px 14px;
            margin-bottom: 20px;        /* ← większy odstęp między grupami */
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }

        .field-group > h3, 
        .field-group > .group-title {
            margin: -20px 0 14px -12px;
            padding: 4px 10px;
            background: white;
            display: inline-block;
            font-size: 1.05rem;
            font-weight: 600;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* Checkbox "to ojciec" – ładniej wygląda jako pierwszy element */
        .field-group .checkbox-wrapper {
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Pojedyncze pola – lepsza czytelność */
        .form-row,
        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px 18px;             /* ← lepsze proporcje odstępów */
            margin-bottom: 8px;
        }

        .form-row label,
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.86rem;
            color: #4b5563;
            white-space: nowrap;        /* ← najważniejsze – długie etykiety się nie łamią */
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 9px 11px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.96rem;
            box-sizing: border-box;
        }

        /* Przyciski na dole – bardziej odporne na małe ekrany */
        .form-actions,
        #form-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .form-actions button,
        #form-buttons button {
            flex: 1 1 110px;            /* nie pozwolą przyciskom stać się za małe */
            min-width: 100px;
            padding: 10px 14px;
        }

        /* Responsywność – kiedy panel robi się naprawdę wąski */
        @media (max-width: 460px) {
            #right-panel {
                width: 100%;
                min-width: unset;
                padding: 16px 12px;
            }
            
            .form-row,
            .form-group {
                grid-template-columns: 1fr;     /* wszystko jeden pod drugim */
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="toolbar">
            <span id="imageCounter" style="color: #999; font-size: 11px; margin-right: 10px;"></span>
            
            <!-- Progress Bar -->
            <div id="progressBar">
                <span class="progress-text">Pola:</span>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <span class="progress-text" id="progressText">0/0</span>
                </div>
            </div>
            
            <div class="toolbar-sep"></div>
            
            <!-- AUTH: Google Login -->
            <button class="toolbar-btn" id="authBtn" title="Zaloguj się z Google">
                <i class="fab fa-google"></i> Login
            </button>
            
            <!-- SUPABASE: Load/Save -->
            <button class="toolbar-btn" onclick="loadFromSupabase()" title="Załaduj dane z Supabase (baza PostgreSQL, bez limitów)">
                <i class="fas fa-database"></i> Ładuj Supabase
            </button>
            <button class="toolbar-btn" onclick="exportFromLocalStorageToSupabase()" title="Zapisz dane do Supabase" id="saveSupabaseBtn" style="display: none;">
                <i class="fas fa-database"></i> Zapisz Supabase
            </button>
            <button class="toolbar-btn" onclick="checkLocalStorage()" title="Sprawdź localStorage">
                <i class="fas fa-database"></i> Debug
            </button>
            
            <div class="toolbar-sep"></div>
            <button class="toolbar-btn" id="openBtn" title="Dodaj obrazy (Ctrl+O)">
                <i class="fas fa-folder-open"></i> Otwórz
            </button>
            <button class="toolbar-btn" id="sortBtn" title="Sortuj obrazy po nazwie">
                <i class="fas fa-sort-alpha-down"></i> Sort
            </button>
            <button class="toolbar-btn" onclick="exportData('simple')" title="Eksport CSV">
                <i class="fas fa-download"></i> Export
            </button>
            <button class="toolbar-btn" onclick="importCSV()" title="Import CSV">
                <i class="fas fa-upload"></i> CSV
            </button>
            <button class="toolbar-btn" onclick="importJSON()" title="Import JSON">
                <i class="fas fa-file-import"></i> JSON
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- EDIT: Zaznacz akt, Zaznacz pola, Clear -->
            <button class="toolbar-btn" id="roiBtn" title="Zaznacz granice całego aktu na obrazie (Ctrl+R)">
                <i class="fas fa-expand"></i> Granice aktu
            </button>
            <button class="toolbar-btn" id="toggleBoundariesBtn" title="Włącz/wyłącz widoczność granic aktów">
                <i class="fas fa-eye"></i> Widoczność granic
            </button>
            <button class="toolbar-btn" onclick="clearAllROIs()" title="Usuń wszystkie zaznaczenia">
                <i class="fas fa-trash-alt"></i> Clear
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- PANELS: Thumbs, Acts -->
            <button class="toolbar-btn" onclick="toggleThumbsPanel()" title="Miniatury">
                <i class="fas fa-images"></i> Thumbs
            </button>
            <button class="toolbar-btn" id="toggleActsBtn" title="Akty">
                <i class="fas fa-list"></i> Acts
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- VIEW: Fit, FS -->
            <button class="toolbar-btn" onclick="zoomReset()" title="Dopasuj">
                <i class="fas fa-expand-arrows-alt"></i> Fit
            </button>
            <button class="toolbar-btn" onclick="toggleFullscreen()" title="Fullscreen">
                <i class="fas fa-expand"></i> FS
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- FORMS: Pinupy, Clear -->
            <button class="toolbar-btn" onclick="showAllPinups()" title="Pinupy">
                <i class="fas fa-thumbtack"></i> PIN
            </button>
            <button class="toolbar-btn" onclick="clearPinups()" title="Zamknij PIN">
                <i class="fas fa-times"></i> ✕PIN
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- PROCESS: Filtry -->
            <button class="toolbar-btn" id="postprocessBtn" title="Filtry">
                <i class="fas fa-sliders-h"></i> Filtry
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- ADVANCED: Supabase, Clear -->
            <button class="toolbar-btn" onclick="loadFromSupabase()" title="Załaduj z Supabase (PostgreSQL, bez limitów)">
                <i class="fas fa-database"></i> Ładuj DB
            </button>
            <button class="toolbar-btn" onclick="exportFromLocalStorageToSupabase()" title="Eksportuj do Supabase">
                <i class="fas fa-database"></i> Zapisz DB
            </button>
            <button class="toolbar-btn" id="clearStorageBtn" title="Wyczyść" style="color: #e74c3c;">
                <i class="fas fa-trash-alt"></i> Wyczyść
            </button>
            
            <div class="toolbar-sep"></div>
            
            <!-- SEARCH (prawy koniec) -->
            <input type="text" id="searchInput" placeholder="🔍 Szukaj..." title="Szukaj aktów" style="margin-left: auto; padding: 6px 10px; border: 1px solid #3a3a3a; background: #1a1a1a; color: #ddd; border-radius: 4px; font-size: 11px; width: 160px; flex-shrink: 0;">
        </div>
        <div id="advancedActModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.1); z-index:1000; justify-content:center; align-items:center; pointer-events:none;">
            <div id="advancedActModalContent" style="background:rgba(20,20,30,0.95); padding:20px; border-radius:8px; width:400px; pointer-events:auto; cursor:move; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
                <div style="background:#0078d4; padding:8px 12px; margin:-20px -20px 12px -20px; border-radius:8px 8px 0 0; cursor:move; user-select:none; color:white; font-weight:bold; font-size:14px;">Dodaj akty do strony</div>
                <label>Rok: <input id="modalYear" type="number" value="1900"></label><br>
                <label>Parafia: <input id="modalParish" type="text" value="Brak"></label><br>
                <label>Województwo: <input id="modalWoj" type="text" value="LUB"></label><br>
                <label>Typ aktu: 
                    <select id="modalType">
                        <option value="christening">Akt Chrztu</option>
                        <option value="birth">Akt Urodzenia</option>
                        <option value="marriage">Akt Małżeństwa</option>
                        <option value="death">Akt Zgonu</option>
                    </select>
                </label><br>
                <label>Nr pierwszego aktu: <input id="modalFirstNr" type="number" value="1"></label><br>
                <label>Nr ostatniego aktu: <input id="modalLastNr" type="number" value="10"></label><br>
                <label><input id="modalIncomplete" type="checkbox"> Ostatni akt niepełny</label><br>
                <label><input id="modalPlusIndex" type="checkbox"> Dodaj pole indeksu</label><br>
                <button id="modalOK">OK</button>
                <button id="modalCopyPrev">Kopiuj z poprzedniej</button>
                <button id="modalCancel">Anuluj</button>
            </div>
        </div>
        <div class="main-content">
            <div class="thumbnails-bar" id="thumbsBar"></div>
            
            <div class="acts-panel" id="actsPanel">
                <div style="display: flex; align-items: center; justify-content: space-between; font-size: 10px; font-weight: bold; color: #0078d4; padding: 4px 0; border-bottom: 1px solid #2a2a2a; margin-bottom: 4px;">
                    <span>AKTY</span>
                    <div style="display: flex; gap: 2px;">
                        <button class="act-control-btn" title="Dodaj nowy akt" style="font-size: 10px; padding: 2px 4px; background: #10b981; color: white; border: none; border-radius: 2px; cursor: pointer;">+</button>
                        <button class="act-control-btn" title="Usuń wybrany akt" style="font-size: 10px; padding: 2px 4px; background: #f59e0b; color: white; border: none; border-radius: 2px; cursor: pointer;">−</button>
                        <button class="act-control-btn" title="Usuń wszystkie akty" style="font-size: 10px; padding: 2px 4px; background: #ef4444; color: white; border: none; border-radius: 2px; cursor: pointer;">×</button>
                    </div>
                </div>
                <div id="actsList" style="display: flex; flex-direction: column; gap: 4px; flex: 1;"></div>
                <button class="toolbar-btn" title="Ukryj/Pokaż panel aktów" style="width: 100%; margin-top: 4px; padding: 4px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="viewer-panel">
                <div class="viewer-container" id="viewerContainer">
                    <div id="viewer"></div>
                    <img id="imageFallback" />
                    <canvas id="drawingCanvas"></canvas>
                    <div class="roi-info-overlay" id="roiInfo">Tryb zaznaczania</div>
                    <!-- Menu kontekstowe dla aktów -->
                    <div class="context-menu" id="actContextMenu">
                        <div class="context-menu-item" data-action="rename">Zmień nazwę aktu</div>
                        <div class="context-menu-item" data-action="delete-roi">Usuń granice aktu</div>
                        <div class="context-menu-item" data-action="delete-fields">Usuń pola w akcie</div>
                        <div class="context-menu-item danger" data-action="delete-act">Usuń akt</div>
                    </div>
                    <!-- Menu kontekstowe dla obrazu -->
                    <div class="context-menu" id="imageContextMenu">
                        <div class="context-menu-item" data-action="delete-all-acts">Usuń wszystkie akty</div>
                        <div class="context-menu-item" data-action="delete-all-rois">Usuń wszystkie granice</div>
                    </div>
                    <!-- 💡 Suggestions Fan - Wachlarz podpowiedzi -->
                    <div id="suggestionsWachlarz" style="position: absolute; z-index: 200; pointer-events: none; display: none;"></div>
                    <div class="rotate-controls">
                        <button class="rotate-btn" onclick="rotateImage(-90)" title="Obróć w lewo">
                            <i class="fas fa-undo-alt"></i>
                        </button>
                        <button class="rotate-btn" onclick="rotateImage(90)" title="Obróć w prawo">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </div>
                    <div class="floating-form" id="floatingForm">
                        <div class="floating-form-header">
                            <span id="floatingTitle">Akt <span id="floatingActNum">1</span></span>
                            <button class="floating-form-close" onclick="toggleFloatingForm(false)"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="floating-form-content" id="floatingFormContent"></div>
                        <div class="floating-form-actions">
                            <button class="form-btn" onclick="saveRecord(); toggleFloatingForm(false)" style="flex: 1;"><i class="fas fa-save"></i> Zapisz</button>
                            <button class="form-btn" onclick="toggleFloatingForm(false)" style="flex: 1; background: #3a3a3a; color: #ddd;">Anuluj</button>
                        </div>
                    </div>
                    <div id="fieldPinupsContainer"></div>
                    <div class="wizard-prompt" id="wizardPrompt">
                        <span id="wizardMessage">Zaznacz ROI dla: Imię dziecka</span>
                        <button onclick="skipCurrentField()"><i class="fas fa-forward"></i> Pomiń</button>
                    </div>
                    <div class="wizard-progress" id="wizardProgress">
                        <div>Wizard: <span id="wizardStep">1</span>/<span id="wizardTotal">5</span></div>
                        <div class="wizard-progress-bar">
                            <div class="wizard-progress-fill" id="wizardProgressFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-panel" id="rightPanel">
                <div class="panel-content">
                    <div id="formsContainer"></div>
                </div>
            </div>
        </div>
        
        <!-- ===== TABLE SECTION (25% height) ===== -->
        <div class="table-section" id="tableSection">
            <div class="table-header">
                <span class="table-header-title">📊 Dane (Excel-like)</span>
                <div class="table-header-actions">
                    <button class="table-action-btn" onclick="addTableRow()" title="Dodaj wiersz">
                        <i class="fas fa-plus"></i> Wiersz
                    </button>
                    <button class="table-action-btn" onclick="deleteSelectedRows()" title="Usuń zaznaczone">
                        <i class="fas fa-trash-alt"></i> Usuń
                    </button>
                    <button class="table-action-btn" onclick="showPasteDialog()" title="Wklej dane (Ctrl+V)">
                        <i class="fas fa-paste"></i> Wklej
                    </button>
                    <button class="table-action-btn" onclick="exportTableData()" title="Eksportuj tabelę">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" title="Zaznacz wszystko"></th>
                            <th>ID źródłowe</th>
                            <th>Księga (nr)</th>
                            <th>Strona (nr)</th>
                            <th>Numer aktu</th>
                            <th>Data chrztu</th>
                            <th>Data zgłoszenia</th>
                            <th>Parafia</th>
                            <th>Imię dziecka</th>
                            <th>Nazwisko dziecka</th>
                            <th>Data ur. dziecka</th>
                            <th>Płeć dziecka</th>
                            <th>Status dziecka</th>
                            <th>Ojciec (imię)</th>
                            <th>Ojciec (nazwisko)</th>
                            <th>Ojciec (wiek)</th>
                            <th>Ojciec (zawód)</th>
                            <th>Ojciec (stan cywilny)</th>
                            <th>Matka (imię)</th>
                            <th>Matka (nazwisko)</th>
                            <th>Matka (panieńskie)</th>
                            <th>Matka (wiek)</th>
                            <th>Matka (zawód)</th>
                            <th>Matka (stan cywilny)</th>
                            <th>Matka (miejsce)</th>
                            <th>Ojciec chrzestny (imię)</th>
                            <th>Ojciec chrzestny (nazwisko)</th>
                            <th>Ojciec chrzestny (miejsce)</th>
                            <th>Matka chrzestna (imię)</th>
                            <th>Matka chrzestna (nazwisko)</th>
                            <th>Matka chrzestna (miejsce)</th>
                            <th>Ksiądz (imię)</th>
                            <th>Ksiądz (nazwisko)</th>
                            <th>Ksiądz (zawód)</th>
                            <th>Zgł. (imię)</th>
                            <th>Zgł. (nazwisko)</th>
                            <th>Zgł. (zawód)</th>
                            <th>Zgł. (wiek)</th>
                            <th>Zgł. (miejsce)</th>
                            <th>Świadek 1 (imię)</th>
                            <th>Świadek 1 (nazwisko)</th>
                            <th>Świadek 1 (zawód)</th>
                            <th>Świadek 1 (miejsce)</th>
                            <th>Świadek 2 (imię)</th>
                            <th>Świadek 2 (nazwisko)</th>
                            <th>Świadek 2 (zawód)</th>
                            <th>Świadek 2 (miejsce)</th>
                            <th>Świadek 3 (imię)</th>
                            <th>Świadek 3 (nazwisko)</th>
                            <th>Świadek 3 (zawód)</th>
                            <th>Świadek 3 (miejsce)</th>
                            <th>Uwagi</th>
                            <th>Opis źródła</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Paste Dialog -->
        <div class="paste-overlay" id="pasteOverlay">
            <div style="font-size: 12px; font-weight: 600; color: #0078d4;">Wklej dane (TSV/CSV)</div>
            <textarea id="pasteTextarea" placeholder="Wklej dane z Excela lub CSV..."></textarea>
            <div class="paste-overlay-actions">
                <button class="paste-overlay-btn" onclick="processPastedData()">OK</button>
                <button class="paste-overlay-btn cancel" onclick="closePasteDialog()">Anuluj</button>
            </div>
        </div>
        <div class="thumbnails-bar" id="thumbsBar"></div>
        
        <!-- Postprocessing Panel -->
        <div class="postprocess-panel" id="postprocessPanel">
            <div class="postprocess-title">🎨 Postprocessing</div>
            
            <!-- CORE FILTERS -->
            <div class="postprocess-slider">
                <label>Poziomy (cień/światło)</label>
                <input type="range" id="contrastSlider" min="-100" max="100" value="0" step="5">
                <div class="postprocess-value" id="contrastValue">0</div>
            </div>
            
            <div class="postprocess-slider">
                <label>Dla starych aktów</label>
                <input type="range" id="brightnessSlider" min="0" max="100" value="0" step="5">
                <div class="postprocess-value" id="brightnessValue">0%</div>
            </div>
            
            <div class="postprocess-slider">
                <label>Usuwanie sitowia</label>
                <input type="range" id="sharpenSlider" min="0" max="100" value="0" step="5">
                <div class="postprocess-value" id="sharpenValue">0%</div>
            </div>
            
            <div class="postprocess-slider" style="flex-direction: row; align-items: center;">
                <label style="flex: 1;">Auto-kontrast</label>
                <input type="checkbox" id="saturationSlider" style="width: 20px; height: 20px; cursor: pointer;">
                <div class="postprocess-value" id="saturationValue" style="flex: 0;">OFF</div>
            </div>
            
            <!-- ADVANCED FILTERS -->
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 9px; text-transform: uppercase; color: #0078d4; margin-bottom: 10px;">Filtry zaawansowane</div>
                
                <div class="postprocess-slider">
                    <label>Żółty/Sepia</label>
                    <input type="range" id="sepiaSlider" min="0" max="100" value="0" step="5">
                    <div class="postprocess-value" id="sepiaValue">0%</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Odcień (Hue)</label>
                    <input type="range" id="hueSlider" min="-180" max="180" value="0" step="5">
                    <div class="postprocess-value" id="hueValue">0°</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Nasycenie</label>
                    <input type="range" id="saturSlider" min="0" max="200" value="100" step="5">
                    <div class="postprocess-value" id="saturValue">100%</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Inwersja (odwrócenie)</label>
                    <input type="range" id="invertSlider" min="0" max="100" value="0" step="5">
                    <div class="postprocess-value" id="invertValue">0%</div>
                </div>
            </div>
            
            <!-- OPENCV ADVANCED FILTERS -->
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 9px; text-transform: uppercase; color: #10b981; margin-bottom: 10px;">🔬 Filtry OpenCV (zaawansowane)</div>
                
                <div class="postprocess-slider">
                    <label>Adaptive Threshold</label>
                    <input type="range" id="adaptiveThresholdSlider" min="0" max="100" value="0" step="5">
                    <div class="postprocess-value" id="adaptiveThresholdValue">OFF</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Gaussian Blur (denoise)</label>
                    <input type="range" id="gaussianBlurSlider" min="0" max="10" value="0" step="1">
                    <div class="postprocess-value" id="gaussianBlurValue">0</div>
                </div>
                
                <div class="postprocess-slider">
                    <label>Median Filter (denoise)</label>
                    <input type="range" id="medianBlurSlider" min="0" max="10" value="0" step="1">
                    <div class="postprocess-value" id="medianBlurValue">0</div>
                </div>
                
                <div class="postprocess-slider" style="flex-direction: row; align-items: center;">
                    <label style="flex: 1;">Histogram Equalization</label>
                    <input type="checkbox" id="histogramEqCheckbox" style="width: 20px; height: 20px; cursor: pointer;">
                    <div class="postprocess-value" id="histogramEqValue" style="flex: 0;">OFF</div>
                </div>
            </div>
            
            <div class="postprocess-buttons">
                <button class="postprocess-btn" onclick="saveProcessedAsNew()" style="grid-column: span 2;">💾 Zapisz przetworzony</button>
                <button class="postprocess-btn reset" onclick="resetPostprocessing()">↻ Reset</button>
            </div>
        </div>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    <input type="file" id="folderInput" webkitdirectory multiple accept="image/*" style="display: none;">
    <script>
        const app = {
            images: [],
            imageActs: [],
            currentImageIdx: 0,
            currentActNum: null,
            currentTemplate: null,
            templates: [],
            viewer: null,
            roiMode: false,
            actMode: false,
            drawingCanvas: null,
            drawingCtx: null,
            activeField: null,
            drawingROI: false,
            roiStartX: 0,
            roiStartY: 0,
            roiOverlays: [],
            overlayMap: new Map(),
            needsFullRedraw: true,
            wizardActive: false,
            wizardCurrentFieldIdx: 0,
            wizardFields: [],
            autoLoadFolder: true,  // Włącz automatyczne ładowanie folderu przy starcie
            showActBoundaries: true  // Włącz/wyłącz widoczność granic aktów
        };
        
        // ===== POSTPROCESSING STATE & PRESETS (MUST BE BEFORE setupPostprocessSliders) =====
        const postprocessState = {
            levels: 0,               // -100 to 100 (shadows/highlights)
            autoContrast: false,     // Auto histogram equalization
            archival: 0,             // 0-100 (dedykowany dla wyblakłych dokumentów)
            descreen: 0,             // 0-100 (removes halftone patterns)
            sepia: 0,                // 0-100 (żółty/sepia filtr dla starych aktów)
            hue: 0,                  // -180 to 180 (rotacja barwy)
            saturation: 100,         // 0-200 (nasycenie kolorów)
            invert: 0,               // 0-100 (inwersja, pomaga przy ciemnym tle)
            adaptiveThreshold: 0,    // 0-100 (adaptive thresholding strength)
            gaussianBlur: 0,         // 0-10 (Gaussian blur kernel)
            medianBlur: 0,           // 0-10 (Median denoise)
            histogramEq: false,      // boolean (histogram equalization)
            backgroundSubtraction: 0,// 0-100 (background leveling - NOWE!)
            morphologyClose: 0,      // 0-100 (connecting broken strokes - NOWE!)
            autoInvert: false        // boolean (auto-detect and invert - NOWE!)
        };
        
        // Presets dla typowych genealogicznych dokumentów - rozszerzone
        const presets = {
            'archival': { 
                levels: 20, autoContrast: true, archival: 80, descreen: 20, sepia: 0, hue: 0, saturation: 80, invert: 0,
                adaptiveThreshold: 0, gaussianBlur: 0, medianBlur: 0, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'faded': { 
                levels: 30, autoContrast: true, archival: 100, descreen: 10, sepia: 0, hue: 0, saturation: 70, invert: 0,
                adaptiveThreshold: 0, gaussianBlur: 0, medianBlur: 0, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'dark': { 
                levels: -20, autoContrast: false, archival: 0, descreen: 0, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 0, gaussianBlur: 0, medianBlur: 0, histogramEq: false,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'bright': { 
                levels: 20, autoContrast: true, archival: 0, descreen: 0, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 0, gaussianBlur: 0, medianBlur: 0, histogramEq: false,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'typewriter': { 
                levels: 10, autoContrast: true, archival: 0, descreen: 5, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 50, gaussianBlur: 0, medianBlur: 0, histogramEq: false,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'ink': {
                levels: 5, autoContrast: false, archival: 0, descreen: 30, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 60, gaussianBlur: 1, medianBlur: 1, histogramEq: false,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'genealogy-pro': {
                levels: 15, autoContrast: true, archival: 50, descreen: 15, sepia: 5, hue: 0, saturation: 85, invert: 0,
                adaptiveThreshold: 40, gaussianBlur: 1, medianBlur: 0, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'faded-advanced': {
                levels: 35, autoContrast: true, archival: 90, descreen: 20, sepia: 10, hue: 0, saturation: 75, invert: 0,
                adaptiveThreshold: 50, gaussianBlur: 2, medianBlur: 1, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'text-extraction': {
                levels: 25, autoContrast: true, archival: 60, descreen: 25, sepia: 0, hue: 0, saturation: 100, invert: 0,
                adaptiveThreshold: 80, gaussianBlur: 0, medianBlur: 0, histogramEq: true,
                backgroundSubtraction: 0, morphologyClose: 0, autoInvert: false
            },
            'heavy-duty': {
                levels: 40, autoContrast: true, archival: 100, descreen: 50, sepia: 10, hue: 0, saturation: 70, invert: 0,
                adaptiveThreshold: 80, gaussianBlur: 1, medianBlur: 3, histogramEq: true,
                backgroundSubtraction: 50, morphologyClose: 50, autoInvert: true
            }
        };
        
        // Global flags for preview
        let previewTimeout = null;
        let isProcessing = false;
        let opencvReady = false;
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Poczekaj max 10 sekund na Supabase inicjalizację
            await Promise.race([
                new Promise(r => window.addEventListener('supabaseReady', r, { once: true })),
                new Promise(r => setTimeout(r, 10000))
            ]);
            // Initialize app directly
            await initApp();
        });

        async function initApp() {
            console.log('📍 DOMContentLoaded start');
            
            // ===== AGGRESSIVE CLEANUP FOR OLD SCHEMA =====
            try {
                const stored = localStorage.getItem('genealog_data');
                if (stored) {
                    const data = JSON.parse(stored);
                    // Detect if this is old schema (has 'chrzest' type)
                    const hasOldSchema = data.imageActs?.some(act => 
                        act.type === 'chrzest' || act.type === 'urodzenia' || act.type === 'malzenstwa' || act.type === 'zgony'
                    );
                    if (hasOldSchema) {
                        console.warn('⚠️ Old schema detected - clearing localStorage');
                        localStorage.clear();
                    }
                }
            } catch(e) {}
            
            // ===== VERSION CHECK - RESET OLD DATA =====
            const currentVersion = '8.7-dynamic-forms';
            const storedVersion = localStorage.getItem('genealog_version');
            if (storedVersion !== currentVersion) {
                console.warn(`⚠️ Version change detected (${storedVersion} → ${currentVersion}) - clearing localStorage`);
                localStorage.clear();
                localStorage.setItem('genealog_version', currentVersion);
            } else {
                localStorage.setItem('genealog_version', currentVersion);
            }
            
            // Initialize Firebase Auth State Listener (legacy - kept for compatibility)
            if (window.auth) {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        // User is signed in
                        console.log('🔥 User signed in:', user.displayName);
                        
                        // Update UI
                        const authBtn = document.getElementById('authBtn');
                        if (authBtn) {
                            authBtn.innerHTML = '<i class="fas fa-user-check"></i> ' + user.displayName.split(' ')[0];
                            authBtn.title = 'Wyloguj się';
                            authBtn.onclick = signOut;
                        }
                        
                        // Enable Supabase (no auth required)
                        app.storageMode = 'supabase';
                        
                    } else {
                        // User is signed out
                        console.log('💤 User signed out');
                        
                        // Update UI
                        const authBtn = document.getElementById('authBtn');
                        if (authBtn) {
                            authBtn.innerHTML = '<i class="fab fa-google"></i> Login';
                            authBtn.title = 'Zaloguj się z Google (opcjonalnie)';
                            authBtn.onclick = signInWithGoogle;
                        }
                        
                        // Supabase works without auth (public table)
                        app.storageMode = 'supabase';
                    }
                });
            } else {
                // No Firebase - use Supabase directly
                console.log('✅ Using Supabase directly (no auth required)');
                app.storageMode = 'supabase';
            }
            
            // Clear old oversized data from localStorage
            try {
                const oldData = localStorage.getItem('genealog_data');
                if (oldData && oldData.length > 5000000) { // Zwiększono limit z 1MB na 5MB
                    console.log('🧹 Clearing oversized localStorage data');
                    localStorage.removeItem('genealog_data');
                }
            } catch(e) {}
            
            loadFallbackTemplates();
            console.log('📍 Templates loaded:', app.templates.length);
            initViewer();
            console.log('📍 Viewer initialized');
            setupDrawingCanvas();
            console.log('📍 Canvas setup complete');
            await loadStorage();
            console.log('📍 Storage loaded, images:', app.images.length);
            renderUI();
            console.log('📍 UI rendered');
            setupPostprocessSliders();
            console.log('📍 Postprocess sliders setup');
            setupEvents();
            console.log('📍 Events setup complete');
            
            // Auto-load folder if enabled
            if (app.autoLoadFolder) {
                setTimeout(() => document.getElementById('folderInput').click(), 500);
            }
            
            notify('v7.0 gotowy!', 'success');
        }
        
        function loadFallbackTemplates() {
            app.templates = [
                {
                    id: "christening",
                    name: "Akt Chrztu",
                    sections: [
                        {
                            id: "meta",
                            title: "<i class='fas fa-book'></i> Metadane",
                            expanded: true,
                            fields: [
                                {id: "christening_year", label: "Rok", type: "text"},
                                {id: "christening_act_number", label: "Numer aktu", type: "text"}
                            ]
                        },
                        {
                            id: "registration",
                            title: "<i class='fas fa-calendar'></i> Zgłoszenie",
                            expanded: true,
                            fields: [
                                {id: "christening_registration_date", label: "Data zgłoszenia (zwykle = data chrztu)", type: "text"}
                            ]
                        },
                        {
                            id: "child",
                            title: "<i class='fas fa-baby'></i> Dziecko",
                            expanded: true,
                            fields: [
                                {id: "child_first_name", label: "Imię dziecka", type: "text"},
                                {id: "child_last_name", label: "Nazwisko dziecka", type: "text"},
                                {id: "child_birth_date", label: "Dziecko urodzone dnia", type: "text"}
                            ]
                        },
                        {
                            id: "reporter",
                            title: "<i class='fas fa-user'></i> Osoba zgłaszająca",
                            expanded: false,
                            fields: [
                                {id: "reporter_info", label: "Imię, nazwisko, zawód, wiek, miejsce", type: "text"}
                            ]
                        },
                        {
                            id: "witnesses",
                            title: "<i class='fas fa-users'></i> Świadkowie",
                            expanded: false,
                            fields: [
                                {id: "witness1_info", label: "Świadek 1 (imię, nazwisko, wiek, zawód, miejsce)", type: "text"},
                                {id: "witness2_info", label: "Świadek 2 (imię, nazwisko, wiek, zawód, miejsce)", type: "text"}
                            ]
                        },
                        {
                            id: "mother",
                            title: "<i class='fas fa-woman'></i> Matka",
                            expanded: false,
                            fields: [
                                {id: "mother_first_name", label: "Imię matki", type: "text"},
                                {id: "mother_last_name", label: "Nazwisko matki", type: "text"},
                                {id: "mother_maiden_name", label: "Nazwisko panieńskie matki", type: "text"},
                                {id: "mother_info", label: "Matka – lata, miejsce zamieszkania, zawód", type: "text"}
                            ]
                        },
                        {
                            id: "confirmation",
                            title: "<i class='fas fa-check'></i> Potwierdzenie",
                            expanded: false,
                            fields: [
                                {id: "christening_name", label: "Nadano imię na chrzcie (potwierdzenie)", type: "text"}
                            ]
                        }
                    ]
                },
                {
                    id: "birth",
                    name: "Akt Urodzenia",
                    sections: [
                        {
                            id: "basic",
                            title: "<i class='fas fa-info-circle'></i> Podstawowe",
                            expanded: true,
                            fields: [
                                {id: "child_first_name", label: "Imię dziecka", type: "text"},
                                {id: "child_last_name", label: "Nazwisko dziecka", type: "text"}
                            ]
                        },
                        {
                            id: "parents",
                            title: "<i class='fas fa-users'></i> Rodzice",
                            expanded: false,
                            fields: [
                                {id: "father_name", label: "Ojciec", type: "text"},
                                {id: "mother_name", label: "Matka", type: "text"}
                            ]
                        }
                    ]
                },
                {
                    id: "marriage",
                    name: "Akt Małżeństwa",
                    sections: [
                        {
                            id: "basic",
                            title: "<i class='fas fa-info-circle'></i> Podstawowe",
                            expanded: true,
                            fields: [
                                {id: "groom_first_name", label: "Imię pana młodego", type: "text"},
                                {id: "groom_last_name", label: "Nazwisko pana młodego", type: "text"},
                                {id: "bride_first_name", label: "Imię panny młodej", type: "text"},
                                {id: "bride_last_name", label: "Nazwisko panny młodej (przed)", type: "text"}
                            ]
                        },
                        {
                            id: "parents",
                            title: "<i class='fas fa-users'></i> Rodzice",
                            expanded: false,
                            fields: [
                                {id: "groom_father", label: "Ojciec pana młodego", type: "text"},
                                {id: "groom_mother", label: "Matka pana młodego", type: "text"},
                                {id: "bride_father", label: "Ojciec panny młodej", type: "text"},
                                {id: "bride_mother", label: "Matka panny młodej", type: "text"}
                            ]
                        }
                    ]
                },
                {
                    id: "death",
                    name: "Akt Zgonu",
                    sections: [
                        {
                            id: "basic",
                            title: "<i class='fas fa-info-circle'></i> Podstawowe",
                            expanded: true,
                            fields: [
                                {id: "deceased_first_name", label: "Imię zmarłego", type: "text"},
                                {id: "deceased_last_name", label: "Nazwisko zmarłego", type: "text"},
                                {id: "age", label: "Wiek", type: "text"},
                                {id: "death_place", label: "Miejsce zgonu", type: "text"}
                            ]
                        },
                        {
                            id: "family",
                            title: "<i class='fas fa-users'></i> Rodzina",
                            expanded: false,
                            fields: [
                                {id: "spouse", label: "Małżonek/małżonka", type: "text"},
                                {id: "father", label: "Ojciec", type: "text"},
                                {id: "mother", label: "Matka", type: "text"}
                            ]
                        }
                    ]
                }
            ];
            app.currentTemplate = "christening";
        }
        
        function renderFormSections() {
            // ===== Right panel - renders form for selected act =====
            const container = document.getElementById('formsContainer');
            if (!container) return;
            container.innerHTML = '';
            
            // Sprawdź czy mamy wybrany akt
            if (!app.currentActNum) {
                container.innerHTML = '<div style="padding: 12px; color: #666; font-size: 11px;">Wybierz akt z lewego panelu</div>';
                return;
            }
            
            // Szukaj aktu po actNum (ten zawsze istnieje)
            const act = app.imageActs.find(a => a.actNum === app.currentActNum);
            
            if (!act) {
                container.innerHTML = '<div style="padding: 12px; color: #888;">Akt nie znaleziony - szukaj po: ' + app.currentActNum + '</div>';
                return;
            }
            
            console.log('📋 renderFormSections - act:', act);
            console.log('📋 act.type:', act.type);

            // ===== SELECTOR TYPU AKTU – DROPDOWN W HEADERZE =====
            const header = document.createElement('div');
            header.style.cssText = 'padding: 12px; background: #252525; border-bottom: 1px solid #3a3a3a; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center; gap: 12px;';
            
            const titleSpan = document.createElement('span');
            // Pokaż skrót do indeksacji (CH.1783.No.1) z pełnym ID w tooltip
            titleSpan.textContent = 'Akt: ' + act.actNum + ' (' + (act.original_id || act.id) + ')';
            titleSpan.style.cssText = 'color: #0078d4; font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
            titleSpan.title = 'ID źródłowe: ' + (act.original_id || act.id);
            
            const typeSelect = document.createElement('select');
            typeSelect.style.cssText = 'padding: 4px 6px; background: #1a1a1a; border: 1px solid #0078d4; color: #ddd; border-radius: 3px; font-size: 11px; flex: 1;';
            typeSelect.innerHTML = app.templates.map(t => 
                `<option value="${t.id}" ${t.id === act.type ? 'selected' : ''}>${t.name}</option>`
            ).join('');
            
            typeSelect.addEventListener('change', async (e) => {
                console.log('✅ Select change event - new type:', e.target.value);
                act.type = e.target.value;
                
                // Regenerate ID based on new type
                const actData = {
                    typ: act.type,
                    woj: act.woj || 'WAR',
                    parafia: act.parish || 'NEZNANE',
                    data_zgl: `${act.year || 1900}-00-01`,
                    nr_aktu: act.nr || 1,
                    is_copy: false
                };
                act.id = await autoGenerateID(actData);
                console.log('🔄 Regenerated ID to:', act.id);
                
                saveStorage();
                renderActsList(); // Update left panel with new ID
                renderFormSections();
            });
            
            header.appendChild(titleSpan);
            header.appendChild(typeSelect);
            container.appendChild(header);

            // ===== SPECIALIZED FORM FOR CHRISTENING (CHRZEST) =====
            if (act.type === 'christening') {
                renderChrzestForm(container, act);
                return;
            }

            // ===== GENERIC FORM FOR OTHER TYPES =====
            const template = app.templates.find(t => t.id === act.type);
            if (!template) {
                console.error('❌ Template not found for type:', act.type);
                container.innerHTML += '<p style="color: #888; padding: 12px;">Brak szablonu dla tego typu: ' + act.type + '</p>';
                return;
            }
            console.log('✅ Template loaded:', template.name);

            // Render sections
            template.sections.forEach(sec => {
                const secDiv = document.createElement('div');
                secDiv.style.marginBottom = '12px';
                
                const secTitle = document.createElement('div');
                secTitle.innerHTML = sec.title || sec.id;
                secTitle.style.cssText = 'color: #0078d4; font-weight: 600; font-size: 11px; margin-bottom: 6px; border-bottom: 1px solid #2a2a2a; padding-bottom: 4px;';
                secDiv.appendChild(secTitle);

                sec.fields.forEach(f => {
                    if (f.applicableTypes && !f.applicableTypes.includes(act.type)) {
                        return;
                    }

                    const group = document.createElement('div');
                    group.className = 'form-group';
                    group.style.marginBottom = '8px';
                    
                    const label = document.createElement('label');
                    label.textContent = f.label;
                    label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 3px;';
                    group.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = f.type || 'text';
                    input.className = 'field-input';
                    input.dataset.field = f.id;
                    input.placeholder = f.label;
                    input.value = act.fieldValues[f.id] || '';
                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                    
                    if (act.fieldROIs && act.fieldROIs[f.id]) {
                        input.classList.add('has-roi');
                        input.style.borderLeft = '4px solid #10b981';
                    }
                    
                    input.addEventListener('blur', (e) => {
                        act.fieldValues[f.id] = e.target.value;
                        updateCurrentRowInTable(); // Aktualizuj tabelę na żywo
                        saveStorage();
                    });
                    
                    // Enter zatwierdza edycję i cofa focus
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            input.blur();
                        }
                    });
                    
                    group.appendChild(input);
                    secDiv.appendChild(group);
                });

                container.appendChild(secDiv);
            });

            // ===== ADD CUSTOM FIELD BUTTON =====
            const addFieldDiv = document.createElement('div');
            addFieldDiv.style.marginTop = '12px';
            addFieldDiv.style.paddingTop = '12px';
            addFieldDiv.style.borderTop = '1px solid #2a2a2a';

            const addBtn = document.createElement('button');
            addBtn.textContent = '+ Dodaj pole';
            addBtn.style.cssText = 'background: #252525; border: 1px solid #3a3a3a; color: #ddd; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 10px; width: 100%;';
            
            addBtn.addEventListener('click', () => {
                const fieldId = prompt('ID pola (np. custom_note):');
                if (!fieldId) return;
                
                const fieldLabel = prompt('Nazwa pola:', fieldId);
                if (!fieldLabel) return;
                
                if (!act.fieldValues) act.fieldValues = {};
                act.fieldValues[fieldId] = '';
                
                saveStorage();
                renderFormSections();
            });

            addFieldDiv.appendChild(addBtn);
            container.appendChild(addFieldDiv);

            container.querySelector('.field-input')?.focus();
        }

        // ===== DEBOUNCE HELPER =====
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function renderChrzestForm(container, act) {
            // ===== SPECIALIZED FORM FOR CHRISTENING (CHRZEST) =====
            // Dodaj padding-left żeby formularz był dalej od lewej krawędzi
            container.style.paddingLeft = '8px';
            
            console.log('📋 renderChrzestForm - act.fieldValues:', act.fieldValues);
            console.log('📋 renderChrzestForm - act.original_id:', act.original_id);
            console.log('📋 renderChrzestForm - act.id:', act.id);
            console.log('📋 fieldValues keys:', Object.keys(act.fieldValues || {}));
            console.log('📋 child_first_name:', act.fieldValues?.child_first_name);
            console.log('📋 father_first_name:', act.fieldValues?.father_first_name);
            console.log('📋 mother_first_name:', act.fieldValues?.mother_first_name);
            
            if (!act.fieldValues) act.fieldValues = {};
            
            // ===== MAPUJ NAZWY PÓL Z SUPABASE NA FORMULARZA =====
            // Supabase -> Formularz
            const fieldMapping = {
                'book_number': 'ksiega_nr',
                'page_number': 'strona_nr',
                'parish': 'parafia',
                'child_first_name': 'dziecko_imie',
                'child_last_name': 'dziecko_nazwisko',
                'child_birth_date': 'dziecko_data_ur',
                'child_gender': 'dziecko_plec',
                'child_legitimacy_status': 'dziecko_status',
                'father_first_name': 'ojciec_imie',
                'father_last_name': 'ojciec_nazwisko',
                'father_age': 'ojciec_wiek',
                'father_occupation': 'ojciec_zawod',
                'father_civil_status': 'ojciec_stan_cywilny',
                'mother_first_name': 'matka_imie',
                'mother_last_name': 'matka_nazwisko',
                'mother_maiden_name': 'matka_panienskie',
                'mother_age': 'matka_lata',
                'mother_occupation': 'matka_zawod',
                'mother_civil_status': 'matka_stan_cywilny',
                'location': 'matka_miejsce',
                'godfather_first_name': 'ojciec_chrzestny_imie',
                'godfather_last_name': 'ojciec_chrzestny_nazwisko',
                'godfather_place': 'ojciec_chrzestny_miejsce',
                'godmother_first_name': 'matka_chrzestna_imie',
                'godmother_last_name': 'matka_chrzestna_nazwisko',
                'godmother_place': 'matka_chrzestna_miejsce',
                'priest_first_name': 'ksiadz_imie',
                'priest_last_name': 'ksiadz_nazwisko',
                'priest_occupation': 'ksiadz_zawod',
                'christening_date': 'data_chrztu',
                'report_date': 'data_zgloszenia',
                'reporting_person_first_name': 'zglaszajacy_imie',
                'reporting_person_last_name': 'zglaszajacy_nazwisko',
                'reporting_person_occupation': 'zglaszajacy_zawod',
                'reporting_person_age': 'zglaszajacy_wiek',
                'reporting_person_place': 'zglaszajacy_miejsce',
                'witness_1_first_name': 'swiadek_1_imie',
                'witness_1_last_name': 'swiadek_1_nazwisko',
                'witness_1_occupation': 'swiadek_1_zawod',
                'witness_1_place': 'swiadek_1_miejsce',
                'witness_2_first_name': 'swiadek_2_imie',
                'witness_2_last_name': 'swiadek_2_nazwisko',
                'witness_2_occupation': 'swiadek_2_zawod',
                'witness_2_place': 'swiadek_2_miejsce',
                'witness_3_first_name': 'swiadek_3_imie',
                'witness_3_last_name': 'swiadek_3_nazwisko',
                'witness_3_occupation': 'swiadek_3_zawod',
                'witness_3_place': 'swiadek_3_miejsce',
                'witnesses': 'swiadkowie',
                'notes': 'custom_note',
                'notes_org': 'custom_note'
            };
            
            // Zrób kopię fieldValues z mapowaniem
            Object.keys(fieldMapping).forEach(supabaseField => {
                const formField = fieldMapping[supabaseField];
                if (act.fieldValues[supabaseField] && !act.fieldValues[formField]) {
                    act.fieldValues[formField] = act.fieldValues[supabaseField];
                    console.log(`📋 Mapuję ${supabaseField} -> ${formField} = ${act.fieldValues[formField]}`);
                }
            });

            // ===== PARSE DANYCH Z ID AKTU =====
            // Format ID: CH.WAR.PARAFIA.1890.00.00001.00
            let initialRok = act.fieldValues['rok'] || '';
            let initialNrAktu = act.fieldValues['nr_aktu'] || '';
            let initialDataZgloszenia = act.fieldValues['data_zgloszenia'] || '';
            
            if (act.id && !initialRok) {
                const idParts = act.id.split('.');
                if (idParts.length >= 4) {
                    initialRok = idParts[3]; // Rok z pozycji 3
                    act.fieldValues['rok'] = initialRok;
                }
                if (idParts.length >= 6) {
                    initialNrAktu = idParts[5].replace(/^0+/, '') || idParts[5]; // Nr aktu z pozycji 5, usuń wiodące 0
                    act.fieldValues['nr_aktu'] = initialNrAktu;
                }
                if (!initialDataZgloszenia && initialRok) {
                    initialDataZgloszenia = initialRok + '.**.--.';
                    act.fieldValues['data_zgloszenia'] = initialDataZgloszenia;
                }
            }

            // Lista pól w idealnej kolejności
            const baseFields = [
                // Nieużywane w v8.11 - wszystkie pola są w fieldGroups
            ];

            const extraFields = [
                // Nieużywane w v8.11 - wszystkie pola są w fieldGroups
            ];

            // ===== ROK, NR AKTU, DATA ZGŁOSZENIA (Z 4 POLAMI) W JEDNEJ LINII =====
            const headerWrapper = document.createElement('div');
            headerWrapper.style.cssText = 'display: grid; grid-template-columns: 80px 90px 1fr; gap: 6px; margin-bottom: 6px;';

            // PRE-DEFINE spinnerInputs i updateDateSpinner (będą używane w rokInput listener)
            const spinnerInputs = {};
            
            // Tablica dni tygodnia - zdefiniuj TUTAJ żeby była dostępna wszędzie
            const daysOfWeek = ['__', 'Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'So', 'Nd'];
            
            // Algorytm Zellera - zdefiniuj TUTAJ zanim updateDateSpinner
            // POLSKA: Reforma gregoriańska wdrożona 4/15 października 1582 r. (papież Grzegorz XIII)
            // Przed 1582-10-15: kalendarz juliański
            // Od 1582-10-15: kalendarz gregoriański
            // Testowe daty historyczne Polski:
            // - 15 lipca 1410: Bitwa pod Grunwaldem (wtorek)
            // - 3 maja 1791: Konstytucja 3 Maja (piątek)
            // - 29 listopada 1830: Powstanie Listopadowe (poniedziałek)
            // - 16 stycznia 2026: dzisiejsza data (piątek)
            const getDayOfWeekZeller = (rok, mies, dzien) => {
                let m = mies;
                let y = rok;
                if (m < 3) {
                    m += 12;
                    y -= 1;
                }
                const q = dzien;
                const K = y % 100;
                const J = Math.floor(y / 100);
                
                let h;
                // Dla dat PRZED reformą gregoriańską w Polsce (przed 1582-10-15), użyj kalendarza juliańskiego
                if (rok < 1582 || (rok === 1582 && (mies < 10 || (mies === 10 && dzien < 15)))) {
                    // Kalendarz juliański: h = (q + ⌊13(m+1)/5⌋ + K + ⌊K/4⌋ + 5 - J) mod 7
                    h = (q + Math.floor(13 * (m + 1) / 5) + K + Math.floor(K / 4) + 5 - J) % 7;
                } else {
                    // Kalendarz gregoriański (wersja najpopularniejsza i najbezpieczniejsza)
                    // h = (dzien + ⌊13(m+1)/5⌋ + K + ⌊K/4⌋ + ⌊J/4⌋ + 5*J) mod 7
                    h = (q + Math.floor(13 * (m + 1) / 5) + K + Math.floor(K / 4) + Math.floor(J / 4) + 5 * J) % 7;
                }
                
                // Standardowe mapowanie Zellera (dla obu kalendarzy)
                // h: 0=Sobota, 1=Niedziela, 2=Poniedziałek, 3=Wtorek, 4=Środa, 5=Czwartek, 6=Piątek
                const daysZeller = [6, 7, 1, 2, 3, 4, 5]; // mapowanie na indeksy w daysOfWeek
                return daysOfWeek[daysZeller[h]];
            };
            
            // Definiuj updateDateSpinner TUTAJ, zanim będzie używana w listenerach
            const updateDateSpinner = () => {
                const rok = spinnerInputs['rok_spinner']?.value || '----';
                const mies = spinnerInputs['mies_spinner']?.value || '';
                const dzien = spinnerInputs['dzien_spinner']?.value || '';
                
                // Format: RRRR.**.-- gdzie ** = miesiąc, -- = dzień (puste = nieznane)
                let dateStr = rok + '.';
                
                if (mies && mies !== '--' && mies !== '**') {
                    dateStr += mies.padStart(2, '0');
                } else {
                    dateStr += '**'; // Miesiąc nieznany
                }
                
                dateStr += '.';
                
                if (dzien && dzien !== '--' && dzien !== '**') {
                    dateStr += dzien.padStart(2, '0');
                } else {
                    dateStr += '--'; // Dzień nieznany
                }
                
                act.fieldValues['data_zgloszenia'] = dateStr;
                
                // ===== WALIDACJA DATY =====
                // Jeśli mamy pełną datę, sprawdź czy jest prawidłowa
                const dzienInput = spinnerInputs['dzien_spinner'];
                if (dzienInput && rok !== '----' && mies && mies !== '**' && mies !== '00' && dzien && dzien !== '--' && dzien !== '00') {
                    const maxDays = getMaxDaysInMonth(rok, mies);
                    const dzienVal = parseInt(dzien);
                    
                    if (dzienVal > maxDays) {
                        // Data nieprawidłowa - zaznacz na czerwono
                        dzienInput.style.borderColor = '#ef4444';
                        dzienInput.style.color = '#ef4444';
                    } else {
                        // Data prawidłowa - przywróć zielony
                        dzienInput.style.borderColor = '#10b981';
                        dzienInput.style.color = '#10b981';
                    }
                } else if (dzienInput) {
                    // Brak pełnej daty - przywróć zielony
                    dzienInput.style.borderColor = '#10b981';
                    dzienInput.style.color = '#10b981';
                }
                
                // Auto-wylicz dzień tygodnia jeśli mamy pełną datę
                const dayOfWeekInput = document.getElementById('dayOfWeekInput');
                if (dayOfWeekInput && rok !== '----' && mies && mies !== '**' && dzien && dzien !== '--') {
                    const calculatedDay = getDayOfWeekZeller(parseInt(rok), parseInt(mies), parseInt(dzien));
                    // Tylko auto-wylicz jeśli dzień tygodnia jest __ (nieznany)
                    if (dayOfWeekInput.value === '__' || dayOfWeekInput.value === '') {
                        dayOfWeekInput.value = calculatedDay;
                        // Aktualizuj index i fieldValues
                        const idx = daysOfWeek.indexOf(calculatedDay);
                        if (idx !== -1) {
                            window.currentDayIndex = idx;
                            act.fieldValues['dzien_tygodnia'] = calculatedDay;
                        }
                    }
                    // Zawsze waliduj dzień tygodnia gdy zmieni się data
                    const validateDayOfWeek = window.validateDayOfWeekFn;
                    if (validateDayOfWeek) validateDayOfWeek();
                }
                
                saveStorage();
            };

            // ROK (XXXX lub XXXX/XX lub XXXX-XX)
            const rokGroup = document.createElement('div');
            rokGroup.style.cssText = 'display: flex; flex-direction: column; gap: 1px;';
            
            const rokLabel = document.createElement('label');
            rokLabel.textContent = 'Rok';
            rokLabel.style.cssText = 'font-size: 9px; color: #666; text-transform: uppercase;';
            
            // SPINNER ROKU (zamiast zwykłego input)
            const rokSpinnerBox = document.createElement('div');
            rokSpinnerBox.style.cssText = `display: flex; flex-direction: column; align-items: center; gap: 0px; width: 50px;`;
            
            // Button UP (▲)
            const rokBtnUp = document.createElement('button');
            rokBtnUp.innerHTML = '▲';
            rokBtnUp.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 50px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Input field
            const rokInput = document.createElement('input');
            rokInput.type = 'text';
            rokInput.className = 'field-input';
            rokInput.dataset.field = 'rok';
            rokInput.id = 'rok';
            rokInput.placeholder = 'XXXX';
            rokInput.maxLength = '4';
            rokInput.value = initialRok;
            rokInput.style.cssText = 'padding: 2px 1px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; font-size: 9px; font-family: monospace; font-weight: 500; width: 50px; text-align: center; height: 18px;';
            
            // Button DOWN (▼)
            const rokBtnDown = document.createElement('button');
            rokBtnDown.innerHTML = '▼';
            rokBtnDown.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 50px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Zapisz reference w spinnerInputs
            spinnerInputs['rok_spinner'] = rokInput;
            
            rokBtnUp.addEventListener('click', (e) => {
                e.preventDefault();
                let val = parseInt(rokInput.value) || 1700;
                val = Math.min(val + 1, 2100);
                rokInput.value = String(val);
                act.fieldValues['rok'] = rokInput.value;
                updateDateSpinner();
                saveStorage();
            });
            
            rokBtnDown.addEventListener('click', (e) => {
                e.preventDefault();
                let val = parseInt(rokInput.value) || 2100;
                val = Math.max(val - 1, 1700);
                rokInput.value = String(val);
                act.fieldValues['rok'] = rokInput.value;
                updateDateSpinner();
                saveStorage();
            });
            
            rokInput.addEventListener('input', (e) => {
                // Pozwól tylko na cyfry
                e.target.value = e.target.value.replace(/[^\d]/g, '').slice(0, 4);
                act.fieldValues['rok'] = e.target.value;
            });
            
            rokInput.addEventListener('change', (e) => {
                updateDateSpinner();
                saveStorage();
            });
            
            rokSpinnerBox.appendChild(rokBtnUp);
            rokSpinnerBox.appendChild(rokInput);
            rokSpinnerBox.appendChild(rokBtnDown);
            
            rokGroup.appendChild(rokLabel);
            rokGroup.appendChild(rokSpinnerBox);
            headerWrapper.appendChild(rokGroup);

            // NR AKTU (SPINNER)
            const nrGroup = document.createElement('div');
            nrGroup.style.cssText = 'display: flex; flex-direction: column; gap: 1px;';
            
            const nrLabel = document.createElement('label');
            nrLabel.textContent = 'Nr aktu';
            nrLabel.style.cssText = 'font-size: 9px; color: #666; text-transform: uppercase;';
            
            // SPINNER NR AKTU
            const nrSpinnerBox = document.createElement('div');
            nrSpinnerBox.style.cssText = `display: flex; flex-direction: column; align-items: center; gap: 0px; width: 60px;`;
            
            // Button UP (▲)
            const nrBtnUp = document.createElement('button');
            nrBtnUp.innerHTML = '▲';
            nrBtnUp.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 60px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Input field
            const nrInput = document.createElement('input');
            nrInput.type = 'text';
            nrInput.className = 'field-input';
            nrInput.dataset.field = 'nr_aktu';
            nrInput.id = 'nr_aktu';
            nrInput.placeholder = 'XXX';
            nrInput.maxLength = '3';
            nrInput.value = initialNrAktu;
            nrInput.style.cssText = 'padding: 2px 1px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; font-size: 9px; font-family: monospace; font-weight: 500; width: 60px; text-align: center; height: 18px;';
            
            // Button DOWN (▼)
            const nrBtnDown = document.createElement('button');
            nrBtnDown.innerHTML = '▼';
            nrBtnDown.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #ddd; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 60px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Zapisz reference w spinnerInputs
            spinnerInputs['nraktu_spinner'] = nrInput;
            
            nrBtnUp.addEventListener('click', (e) => {
                e.preventDefault();
                let val = parseInt(nrInput.value) || 0;
                val += 1;
                if (val > 999) val = 0; // Cyklicznie: 0-999
                nrInput.value = String(val).padStart(3, '0');
                act.fieldValues['nr_aktu'] = nrInput.value;
                saveStorage();
            });
            
            nrBtnDown.addEventListener('click', (e) => {
                e.preventDefault();
                let val = parseInt(nrInput.value) || 0;
                val -= 1;
                if (val < 0) val = 999; // Cyklicznie: 999-0
                nrInput.value = String(val).padStart(3, '0');
                act.fieldValues['nr_aktu'] = nrInput.value;
                saveStorage();
            });
            
            nrInput.addEventListener('input', (e) => {
                // Pozwól tylko na cyfry i max 3
                e.target.value = e.target.value.replace(/[^\d]/g, '').slice(0, 3);
                act.fieldValues['nr_aktu'] = e.target.value;
            });
            
            nrInput.addEventListener('change', (e) => {
                saveStorage();
            });
            
            nrSpinnerBox.appendChild(nrBtnUp);
            nrSpinnerBox.appendChild(nrInput);
            nrSpinnerBox.appendChild(nrBtnDown);
            
            nrGroup.appendChild(nrLabel);
            nrGroup.appendChild(nrSpinnerBox);
            headerWrapper.appendChild(nrGroup);

            // DATA ZGŁOSZENIA
            // Przykład: Data 1410.07.15 (Wtorek) = Bitwa pod Grunwaldem (1410-07-15)
            // Dla przyszłych zmian: testuj z rzeczywistymi datami historycznymi
            const dataZglGroup = document.createElement('div');
            dataZglGroup.style.cssText = 'display: flex; flex-direction: column; gap: 1px;';
            
            const dataZglLabel = document.createElement('label');
            dataZglLabel.textContent = 'Data zgł.';
            dataZglLabel.title = 'Dla dat przed 1582 r.: wyliczanie dnia tygodnia wg kalendarza juliańskiego';
            dataZglLabel.style.cssText = 'font-size: 9px; color: #10b981; text-transform: uppercase; font-weight: 600; cursor: help;';
            
            // ===== CUSTOM DATE SPINNER =====
            const dateSpinnerWrapper = document.createElement('div');
            dateSpinnerWrapper.style.cssText = 'display: flex; gap: 1px; align-items: center; justify-content: flex-start;';
            
            // Funkcja do wyliczenia max dni w miesiącu
            const getMaxDaysInMonth = (rok, mies) => {
                if (!rok || !mies || mies === '**' || mies === '00') return 31; // Brak roku/miesiąca - domyślnie 31
                rok = parseInt(rok);
                mies = parseInt(mies);
                if (mies === 2) {
                    // Luty - sprawdź rok przestępny
                    const isLeapYear = (rok % 4 === 0 && rok % 100 !== 0) || (rok % 400 === 0);
                    return isLeapYear ? 29 : 28;
                } else if ([4, 6, 9, 11].includes(mies)) {
                    return 30; // Kwiecień, czerwiec, wrzesień, listopad
                } else {
                    return 31; // Pozostałe miesiące
                }
            };
            
            // Utwórz 3 spinner pola dla Data zgł: YYYY / MM / DD
            const spinnerFields = [
                { id: 'rok_spinner', placeholder: 'YYYY', min: 1700, max: 2100, width: 30, cyclic: false },
                { id: 'mies_spinner', placeholder: '**', min: 0, max: 12, width: 22, cyclic: true, emptySymbol: '**' },
                { id: 'dzien_spinner', placeholder: '--', min: 1, max: 31, width: 22, cyclic: true, emptySymbol: '--' }
            ];
            
            spinnerFields.forEach((field, idx) => {
                const spinnerBox = document.createElement('div');
                spinnerBox.style.cssText = `display: flex; flex-direction: column; align-items: center; gap: 0px;`;
                
                // Button UP (▲)
                const btnUp = document.createElement('button');
                btnUp.innerHTML = '▲';
                btnUp.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #10b981; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: ${field.width}px; height: 12px; flex: 0; display: flex; align-items: center; justify-content: center;`;
                btnUp.addEventListener('click', (e) => {
                    e.preventDefault();
                    let val = spinnerInputs[field.id].value.trim();
                    
                    if (field.id === 'mies_spinner') {
                        // Miesiąc: **→1→2→...→12→**
                        if (val === field.emptySymbol || val === '00') {
                            val = 1;
                        } else {
                            val = parseInt(val) || 0;
                            val += 1;
                            if (val > 12) val = 0; // Wróć do **
                        }
                    } else if (field.id === 'dzien_spinner') {
                        // Dzień: --→1→2→...→maxDays→--
                        const maxDays = getMaxDaysInMonth(spinnerInputs['rok_spinner'].value, spinnerInputs['mies_spinner'].value);
                        if (val === field.emptySymbol || val === '00') {
                            val = 1;
                        } else {
                            val = parseInt(val) || 0;
                            val += 1;
                            if (val > maxDays) val = 0; // Wróć do --
                        }
                    } else {
                        // Rok: normalna inkrementacja
                        val = parseInt(val) || field.min;
                        val = Math.min(val + 1, field.max);
                    }
                    
                    // Wyświetl
                    if (val === 0 && field.emptySymbol) {
                        spinnerInputs[field.id].value = field.emptySymbol;
                    } else {
                        spinnerInputs[field.id].value = String(val).padStart(field.placeholder.length, '0');
                    }
                    updateDateSpinner();
                });
                
                // Input field
                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.placeholder = field.placeholder;
                inputField.className = 'field-input';
                inputField.style.cssText = `padding: 2px 1px; background: #0f0f0f; border: 1px solid #10b981; color: #10b981; border-radius: 1px; font-size: 9px; font-family: monospace; font-weight: 500; width: ${field.width}px; text-align: center; height: 18px;`;
                inputField.maxLength = field.placeholder.length;
                
                // Ustaw początkową wartość
                if (initialDataZgloszenia) {
                    // Obsłuż formaty: YYYY.MM.DD, YYYY.**.-- itd.
                    const dateParts = initialDataZgloszenia.split(/[-\.*]/);
                    if (field.id === 'rok_spinner' && dateParts[0] && dateParts[0] !== '----') {
                        inputField.value = dateParts[0];
                    } else if (field.id === 'mies_spinner') {
                        if (dateParts[1] && dateParts[1] !== '**' && dateParts[1] !== '00') {
                            inputField.value = dateParts[1];
                        } else {
                            inputField.value = field.emptySymbol; // ** = nieznany miesiąc
                        }
                    } else if (field.id === 'dzien_spinner') {
                        if (dateParts[2] && dateParts[2] !== '--' && dateParts[2] !== '00') {
                            inputField.value = dateParts[2];
                        } else {
                            inputField.value = field.emptySymbol; // -- = nieznany dzień
                        }
                    }
                } else if (field.id === 'rok_spinner' && initialRok) {
                    inputField.value = initialRok.split(/[-/]/)[0]; // Wyciągnij XXXX z XXXX/XX
                } else if (field.emptySymbol) {
                    inputField.value = field.emptySymbol; // Domyślnie ** lub --
                }
                
                spinnerInputs[field.id] = inputField;
                
                inputField.addEventListener('input', (e) => {
                    // Pozwól na cyfry lub symbole puste
                    if (field.emptySymbol && (e.target.value === field.emptySymbol || e.target.value === '')) {
                        e.target.value = field.emptySymbol;
                    } else {
                        e.target.value = e.target.value.replace(/[^\d]/g, '').slice(0, field.placeholder.length);
                    }
                });
                
                inputField.addEventListener('change', updateDateSpinner);
                
                // Button DOWN (▼)
                const btnDown = document.createElement('button');
                btnDown.innerHTML = '▼';
                btnDown.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #10b981; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: ${field.width}px; height: 12px; flex: 0; display: flex; align-items: center; justify-content: center;`;
                btnDown.addEventListener('click', (e) => {
                    e.preventDefault();
                    let val = inputField.value.trim();
                    
                    if (field.id === 'mies_spinner') {
                        // Miesiąc: **←12←11←...←1←**
                        if (val === field.emptySymbol || val === '00') {
                            val = 12; // Jak klikamy dół od **, to 12
                        } else {
                            val = parseInt(val) || 1;
                            val -= 1;
                            if (val < 1) val = 0; // Wróć do **
                        }
                    } else if (field.id === 'dzien_spinner') {
                        // Dzień: --←maxDays←...←1←--
                        const maxDays = getMaxDaysInMonth(spinnerInputs['rok_spinner'].value, spinnerInputs['mies_spinner'].value);
                        if (val === field.emptySymbol || val === '00') {
                            val = maxDays; // Jak klikamy dół od --, to maxDays
                        } else {
                            val = parseInt(val) || 1;
                            val -= 1;
                            if (val < 1) val = 0; // Wróć do --
                        }
                    } else {
                        // Rok: normalna dekrementacja
                        val = parseInt(val) || field.max;
                        val = Math.max(val - 1, field.min);
                    }
                    
                    // Wyświetl
                    if (val === 0 && field.emptySymbol) {
                        inputField.value = field.emptySymbol;
                    } else {
                        inputField.value = String(val).padStart(field.placeholder.length, '0');
                    }
                    updateDateSpinner();
                });
                
                spinnerBox.appendChild(btnUp);
                spinnerBox.appendChild(inputField);
                spinnerBox.appendChild(btnDown);
                dateSpinnerWrapper.appendChild(spinnerBox);
            });
            
            // ===== CZWARTY ELEMENT W DATA ZGL: DZIEŃ TYGODNIA (SPINNER Z PRZYCISKAMI) =====
            const dayOfWeekBox = document.createElement('div');
            dayOfWeekBox.style.cssText = `display: flex; flex-direction: column; align-items: center; gap: 0px;`;
            
            // Button UP (▲)
            const dayOfWeekBtnUp = document.createElement('button');
            dayOfWeekBtnUp.innerHTML = '▲';
            dayOfWeekBtnUp.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #10b981; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 30px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // Input field dnia tygodnia
            const dayOfWeekInput = document.createElement('input');
            dayOfWeekInput.type = 'text';
            dayOfWeekInput.id = 'dayOfWeekInput';
            dayOfWeekInput.placeholder = 'Pn';
            dayOfWeekInput.maxLength = '2';
            dayOfWeekInput.style.cssText = `padding: 2px 1px; background: #0f0f0f; border: 1px solid #10b981; color: #10b981; border-radius: 1px; font-size: 9px; font-family: monospace; font-weight: 500; width: 30px; text-align: center; height: 18px;`;
            dayOfWeekInput.value = 'Pn';
            
            // Button DOWN (▼)
            const dayOfWeekBtnDown = document.createElement('button');
            dayOfWeekBtnDown.innerHTML = '▼';
            dayOfWeekBtnDown.style.cssText = `padding: 1px 2px; background: #252525; border: 1px solid #3a3a3a; color: #10b981; border-radius: 1px; cursor: pointer; font-size: 7px; font-weight: bold; width: 30px; height: 12px; display: flex; align-items: center; justify-content: center;`;
            
            // currentDayIndex - przechowuj w window aby by\u0142a dost\u0119pna wszędzie
            if (!window.currentDayIndex) window.currentDayIndex = 0;
            let currentDayIndex = window.currentDayIndex;
            
            // Funkcja do walidacji dnia tygodnia
            const validateDayOfWeek = () => {
                const rok = spinnerInputs['rok_spinner']?.value || '----';
                const mies = spinnerInputs['mies_spinner']?.value || '';
                const dzien = spinnerInputs['dzien_spinner']?.value || '';
                const selectedDay = dayOfWeekInput.value;
                
                // Jeśli dzień tygodnia to __, nie walidujemy
                if (selectedDay === '__') {
                    dayOfWeekInput.style.borderColor = '#10b981';
                    dayOfWeekInput.style.color = '#10b981';
                    return;
                }
                
                // Jeśli mamy pełną datę, sprawdź czy dzień tygodnia się zgadza
                if (rok !== '----' && mies && mies !== '**' && dzien && dzien !== '--') {
                    const calculatedDay = getDayOfWeekZeller(parseInt(rok), parseInt(mies), parseInt(dzien));
                    
                    if (selectedDay === calculatedDay) {
                        // Dzień się zgadza - zielony
                        dayOfWeekInput.style.borderColor = '#10b981';
                        dayOfWeekInput.style.color = '#10b981';
                    } else {
                        // Dzień się nie zgadza - CZERWONY
                        dayOfWeekInput.style.borderColor = '#ef4444';
                        dayOfWeekInput.style.color = '#ef4444';
                    }
                } else {
                    // Brak pełnej daty - nie walidujemy, zielony
                    dayOfWeekInput.style.borderColor = '#10b981';
                    dayOfWeekInput.style.color = '#10b981';
                }
            };
            
            // Zapisz do window aby była dostępna z updateDateSpinner
            window.validateDayOfWeekFn = validateDayOfWeek;
            
            dayOfWeekBtnUp.addEventListener('click', (e) => {
                e.preventDefault();
                currentDayIndex = (currentDayIndex + 1) % daysOfWeek.length; // Cyklicznie
                dayOfWeekInput.value = daysOfWeek[currentDayIndex];
                act.fieldValues['dzien_tygodnia'] = daysOfWeek[currentDayIndex];
                validateDayOfWeek();
                saveStorage();
            });
            
            dayOfWeekBtnDown.addEventListener('click', (e) => {
                e.preventDefault();
                currentDayIndex = (currentDayIndex - 1 + daysOfWeek.length) % daysOfWeek.length; // Cyklicznie
                dayOfWeekInput.value = daysOfWeek[currentDayIndex];
                act.fieldValues['dzien_tygodnia'] = daysOfWeek[currentDayIndex];
                validateDayOfWeek();
                saveStorage();
            });
            
            dayOfWeekInput.addEventListener('input', (e) => {
                // Pozwól wybrać dzień z listy lub __ dla nieokreślonego
                let val = e.target.value.toUpperCase();
                
                // Sprawdź czy to __
                if (val === '__' || val === '') {
                    currentDayIndex = 0; // __
                    dayOfWeekInput.value = '__';
                    act.fieldValues['dzien_tygodnia'] = '__';
                } else {
                    const idx = daysOfWeek.findIndex(d => d.includes(val));
                    if (idx !== -1) {
                        currentDayIndex = idx;
                        dayOfWeekInput.value = daysOfWeek[idx];
                        act.fieldValues['dzien_tygodnia'] = daysOfWeek[idx];
                    } else {
                        dayOfWeekInput.value = daysOfWeek[currentDayIndex];
                    }
                }
                validateDayOfWeek();
            });
            
            dayOfWeekInput.addEventListener('change', (e) => {
                validateDayOfWeek();
                saveStorage();
            });
            
            // Załaduj zapisaną wartość jeśli istnieje
            if (act.fieldValues['dzien_tygodnia']) {
                const savedDay = act.fieldValues['dzien_tygodnia'];
                const idx = daysOfWeek.indexOf(savedDay);
                if (idx !== -1) {
                    currentDayIndex = idx;
                    dayOfWeekInput.value = savedDay;
                }
            } else {
                dayOfWeekInput.value = '__'; // Domyślnie __
                currentDayIndex = 0;
            }
            
            // Waliduj na starcie
            validateDayOfWeek();
            
            dayOfWeekBox.appendChild(dayOfWeekBtnUp);
            dayOfWeekBox.appendChild(dayOfWeekInput);
            dayOfWeekBox.appendChild(dayOfWeekBtnDown);
            dateSpinnerWrapper.appendChild(dayOfWeekBox);
            
            dataZglGroup.appendChild(dataZglLabel);
            dataZglGroup.appendChild(dateSpinnerWrapper);
            headerWrapper.appendChild(dataZglGroup);
            
            // Dla dat sprzed 1582 r.: wyliczanie dnia tygodnia wg kalendarza juliańskiego
            // Różnica między kalendarzem gregoriańskim a juliańskim (reformacja 1582)

            container.appendChild(headerWrapper);

            // ===== KOMPLETNA LISTA WSZYSTKICH MOŻLIWYCH PÓL Z AKTÓW METRYKALNYCH =====
            // Do użytku w "+ Dodaj dowolne dane" - pozwala dodać pola z innych typów aktów
            const allAvailableFields = [
                // WSPÓLNE DLA WSZYSTKICH TYPÓW
                { id: 'numer_aktu', label: 'Numer aktu', category: 'Wspólne' },
                { id: 'data_aktu', label: 'Data aktu', category: 'Wspólne' },
                { id: 'parafia', label: 'Parafia/Miejsce', category: 'Wspólne' },
                { id: 'ksiadz_urzednik', label: 'Ksiądz/Urzędnik', category: 'Wspólne' },
                { id: 'jezyk_aktu', label: 'Język aktu', category: 'Wspólne' },
                { id: 'uwagi_marginalne', label: 'Uwagi marginalne', category: 'Wspólne' },
                { id: 'zrodlo_ksiega', label: 'Źródło/Księga', category: 'Wspólne' },
                
                // URODZENIA/CHRZTY
                { id: 'data_urodzenia', label: 'Data urodzenia', category: 'Urodzenia/Chrzty' },
                { id: 'miejsce_urodzenia', label: 'Miejsce urodzenia', category: 'Urodzenia/Chrzty' },
                { id: 'dziecko_imie', label: 'Imię dziecka', category: 'Urodzenia/Chrzty' },
                { id: 'dziecko_plec', label: 'Płeć dziecka', category: 'Urodzenia/Chrzty' },
                { id: 'legitymizacja', label: 'Legitymizacja', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_imie', label: 'Imię ojca', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_nazwisko', label: 'Nazwisko ojca', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_wiek', label: 'Wiek ojca', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_zawod', label: 'Zawód ojca', category: 'Urodzenia/Chrzty' },
                { id: 'ojciec_miejsce', label: 'Miejsce zamieszkania ojca', category: 'Urodzenia/Chrzty' },
                { id: 'matka_imie', label: 'Imię matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_nazwisko', label: 'Nazwisko matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_panienskie', label: 'Nazwisko panieńskie matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_lata', label: 'Wiek matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_zawod', label: 'Zawód matki', category: 'Urodzenia/Chrzty' },
                { id: 'matka_miejsce', label: 'Miejsce zamieszkania matki', category: 'Urodzenia/Chrzty' },
                { id: 'data_chrztu', label: 'Data chrztu', category: 'Urodzenia/Chrzty' },
                { id: 'imie_nadane_chrzest', label: 'Imię nadane na chrzcie', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestny_ojciec_imie', label: 'Imię ojca chrzestnego', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestny_ojciec_nazwisko', label: 'Nazwisko ojca chrzestnego', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestny_ojciec_zawod', label: 'Zawód ojca chrzestnego', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestna_matka_imie', label: 'Imię matki chrzestnej', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestna_matka_nazwisko', label: 'Nazwisko matki chrzestnej', category: 'Urodzenia/Chrzty' },
                { id: 'chrzestna_matka_zawod', label: 'Zawód matki chrzestnej', category: 'Urodzenia/Chrzty' },
                { id: 'swiadek1_imie', label: 'Świadek 1 - Imię', category: 'Urodzenia/Chrzty' },
                { id: 'swiadek1_nazwisko', label: 'Świadek 1 - Nazwisko', category: 'Urodzenia/Chrzty' },
                { id: 'swiadek2_imie', label: 'Świadek 2 - Imię', category: 'Urodzenia/Chrzty' },
                { id: 'swiadek2_nazwisko', label: 'Świadek 2 - Nazwisko', category: 'Urodzenia/Chrzty' },
                
                // MAŁŻEŃSTWA/ŚLUBY
                { id: 'data_slubu', label: 'Data ślubu', category: 'Małżeństwa/Śluby' },
                { id: 'miejsce_slubu', label: 'Miejsce ślubu', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_imie', label: 'Imię pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_nazwisko', label: 'Nazwisko pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_wiek', label: 'Wiek pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_stan', label: 'Stan cywilny pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_zawod', label: 'Zawód pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_urodzenie', label: 'Miejsce urodzenia pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_zamieszkanie', label: 'Miejsce zamieszkania pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'pan_mlody_rodzice', label: 'Imiona rodziców pana młodego', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_imie', label: 'Imię panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_nazwisko_panienskie', label: 'Nazwisko panieńskie panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_wiek', label: 'Wiek panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_stan', label: 'Stan cywilny panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_zawod', label: 'Zawód panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_urodzenie', label: 'Miejsce urodzenia panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_zamieszkanie', label: 'Miejsce zamieszkania panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'panna_mloda_rodzice', label: 'Imiona rodziców panny młodej', category: 'Małżeństwa/Śluby' },
                { id: 'zapowiedzi_daty', label: 'Daty zapowiedzi', category: 'Małżeństwa/Śluby' },
                { id: 'dyspensa', label: 'Dyspensa', category: 'Małżeństwa/Śluby' },
                { id: 'swiadkowie_slubu', label: 'Świadkowie ślubu', category: 'Małżeństwa/Śluby' },
                
                // ZGONY/POGRZEBY
                { id: 'data_zgonu', label: 'Data zgonu', category: 'Zgony/Pogrzeby' },
                { id: 'miejsce_zgonu', label: 'Miejsce zgonu', category: 'Zgony/Pogrzeby' },
                { id: 'data_pogrzebu', label: 'Data pogrzebu', category: 'Zgony/Pogrzeby' },
                { id: 'miejsce_pogrzebu', label: 'Miejsce pogrzebu', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_imie', label: 'Imię zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_nazwisko', label: 'Nazwisko zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_wiek', label: 'Wiek zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_plec', label: 'Płeć zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_stan', label: 'Stan cywilny zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_zawod', label: 'Zawód zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_urodzenie', label: 'Miejsce urodzenia zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_zamieszkanie', label: 'Miejsce zamieszkania zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_rodzice', label: 'Imiona rodziców zmarłego', category: 'Zgony/Pogrzeby' },
                { id: 'zmarly_malzenyk', label: 'Imię małżonka', category: 'Zgony/Pogrzeby' },
                { id: 'przyczyna_zgonu', label: 'Przyczyna zgonu', category: 'Zgony/Pogrzeby' },
                { id: 'swiadkowie_zgonu', label: 'Świadkowie/informatorzy', category: 'Zgony/Pogrzeby' }
            ];

            // ===== RENDERUJ GRUPY PÓL (fieldGroups) - V8.11 STRUKTURA =====
            // Pola są zorganizowane w grupy z inteligentnym layoutem
            // Layout types: 'inline2' (2 pola obok siebie), 'grouped' (2-wierszowy: imie+nazwisko, zawód+wiek+miejsce), 'single' (jedno pole)
            
            const fieldGroups = [
                {
                    id: 'dziecko',
                    header: null,  // Brak nagłówka - dzieci nie mają grupy
                    layout: 'inline2',  // 2 pola w linii
                    fields: [
                        { id: "dziecko_imie", label: "Imię dziecka" },
                        { id: "dziecko_nazwisko", label: "Nazwisko dziecka" }
                    ]
                },
                {
                    id: 'zglaszajacy',
                    header: 'OSOBA ZGŁASZAJĄCA',
                    checkbox: { id: 'zglaszajacy_ojciec', label: 'to ojciec' },
                    layout: 'grouped',  // 2-wierszowy
                    fields: [
                        { id: "zglaszajacy_imie", label: "Imię" },
                        { id: "zglaszajacy_nazwisko", label: "Nazwisko" },
                        { id: "zglaszajacy_zawod", label: "Zawód" },
                        { id: "zglaszajacy_wiek", label: "Wiek" },
                        { id: "zglaszajacy_miejsce", label: "Miejsce" }
                    ]
                },
                {
                    id: 'swiadek1',
                    header: 'ŚWIADEK 1',
                    layout: 'grouped',
                    fields: [
                        { id: "swiadek1_imie", label: "Imię" },
                        { id: "swiadek1_nazwisko", label: "Nazwisko" },
                        { id: "swiadek1_zawod", label: "Zawód" },
                        { id: "swiadek1_wiek", label: "Wiek" },
                        { id: "swiadek1_miejsce", label: "Miejsce" }
                    ]
                },
                {
                    id: 'swiadek2',
                    header: 'ŚWIADEK 2',
                    layout: 'grouped',
                    fields: [
                        { id: "swiadek2_imie", label: "Imię" },
                        { id: "swiadek2_nazwisko", label: "Nazwisko" },
                        { id: "swiadek2_zawod", label: "Zawód" },
                        { id: "swiadek2_wiek", label: "Wiek" },
                        { id: "swiadek2_miejsce", label: "Miejsce" }
                    ]
                },
                {
                    id: 'dziecko_urodzenie',
                    header: null,
                    layout: 'single',
                    fields: [
                        { id: "dziecko_urodzone_dnia", label: "Dziecko urodzone dnia" }
                    ]
                },
                {
                    id: 'ojciec',
                    header: 'OJCIEC',
                    layout: 'grouped',
                    fields: [
                        { id: "ojciec_imie", label: "Imię" },
                        { id: "ojciec_nazwisko", label: "Nazwisko" },
                        { id: "ojciec_zawod", label: "Zawód" },
                        { id: "ojciec_wiek", label: "Wiek" },
                        { id: "ojciec_miejsce", label: "Miejsce" }
                    ]
                },
                {
                    id: 'matka',
                    header: 'MATKA',
                    layout: 'grouped',
                    fields: [
                        { id: "matka_imie", label: "Imię" },
                        { id: "matka_nazwisko", label: "Nazwisko" },
                        { id: "matka_panienskie", label: "Panieńskie" },
                        { id: "matka_lata", label: "Wiek" },
                        { id: "matka_miejsce", label: "Miejsce" },
                        { id: "matka_zawod", label: "Zawód" }
                    ]
                },
                {
                    id: 'imie_chrzest',
                    header: null,
                    layout: 'custom',
                    fields: [
                        { id: "imie_nadane_chrzest", label: "Ochrzczono jako:" }
                    ]
                },
                {
                    id: 'ksiadz',
                    header: 'KSIĘŻA (udzielający chrztu)',
                    layout: 'inline2',
                    fields: [
                        { id: "ksiadz_imie", label: "Imię" },
                        { id: "ksiadz_nazwisko", label: "Nazwisko" }
                    ]
                },
                {
                    id: 'notatki',
                    header: null,
                    layout: 'single',
                    fields: [
                        { id: "custom_note", label: "Dodatkowa notatka" },
                        { id: "extra_date", label: "Dodatkowa data" }
                    ]
                }
            ];
            
            // Renderuj grupy
            fieldGroups.forEach((group) => {
                // Nagłówek grupy (jeśli istnieje)
                if (group.header) {
                    const groupHeader = document.createElement('div');
                    groupHeader.style.cssText = 'font-size: 11px; color: #10b981; font-weight: 600; margin-top: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; white-space: nowrap;';
                    
                    const headerText = document.createElement('span');
                    headerText.textContent = group.header;
                    groupHeader.appendChild(headerText);
                    
                    // Checkbox (jeśli istnieje - dla "to ojciec")
                    if (group.checkbox) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = group.checkbox.id;
                        checkbox.title = group.checkbox.label;
                        checkbox.checked = act.fieldValues[group.checkbox.id] === true || act.fieldValues[group.checkbox.id] === 'true';
                        checkbox.style.cssText = 'cursor: pointer; width: 12px; height: 12px; flex-shrink: 0;';
                        checkbox.addEventListener('change', (e) => {
                            act.fieldValues[group.checkbox.id] = e.target.checked;
                            
                            // AUTO-COPY ojciec z zgłaszającego jeśli checkbox zaznaczony
                            if (group.checkbox.id === 'zglaszajacy_ojciec' && e.target.checked) {
                                act.fieldValues['ojciec_imie'] = act.fieldValues['zglaszajacy_imie'] || '';
                                act.fieldValues['ojciec_nazwisko'] = act.fieldValues['zglaszajacy_nazwisko'] || '';
                                act.fieldValues['ojciec_zawod'] = act.fieldValues['zglaszajacy_zawod'] || '';
                                act.fieldValues['ojciec_wiek'] = act.fieldValues['zglaszajacy_wiek'] || '';
                                act.fieldValues['ojciec_miejsce'] = act.fieldValues['zglaszajacy_miejsce'] || '';
                                console.log('📋 Skopiowano OSOBA ZGŁASZAJĄCA → OJCIEC');
                                // Odśwież formularz aby pokazać zakopiowane dane
                                setTimeout(() => renderFormSections(), 100);
                            }
                            
                            saveStorage();
                        });
                        groupHeader.appendChild(checkbox);
                        
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.textContent = group.checkbox.label;
                        checkboxLabel.style.cssText = 'font-size: 9px; color: #888; cursor: pointer; margin: 0; flex-shrink: 0;';
                        checkboxLabel.htmlFor = group.checkbox.id;
                        groupHeader.appendChild(checkboxLabel);
                    }
                    
                    container.appendChild(groupHeader);
                }
                
                // Renderuj pola wg layoutu
                if (group.layout === 'inline2') {
                    // Dwa pola obok siebie
                    const row = document.createElement('div');
                    row.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;';
                    
                    group.fields.forEach(field => {
                        const fieldDiv = document.createElement('div');
                        const label = document.createElement('label');
                        label.textContent = field.label;
                        label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                        fieldDiv.appendChild(label);
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.dataset.field = field.id;
                        input.id = field.id;
                        input.className = 'field-input';
                        input.placeholder = field.label;
                        input.value = act.fieldValues[field.id] || '';
                        input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                        input.addEventListener('blur', (e) => { 
                            act.fieldValues[field.id] = e.target.value.trim(); 
                            updateCurrentRowInTable(); // Aktualizuj tabelę
                            saveStorage(); 
                        });
                        fieldDiv.appendChild(input);
                        row.appendChild(fieldDiv);
                    });
                    
                    container.appendChild(row);
                    
                } else if (group.layout === 'grouped') {
                    // Grouped: Dynamiczny layout
                    // - Jeśli 4 pola: 2 + 2
                    // - Jeśli 6 pól: 3 + 3
                    // - Jeśli 4 pola ale grupa MATKA: 3 + 1 (dla złych definicji)
                    
                    const fieldCount = group.fields.length;
                    let fieldsPerRow1, fieldsPerRow2;
                    
                    if (fieldCount === 4) {
                        fieldsPerRow1 = 2;
                        fieldsPerRow2 = 2;
                    } else if (fieldCount === 6) {
                        fieldsPerRow1 = 3;
                        fieldsPerRow2 = 3;
                    } else if (fieldCount === 3) {
                        fieldsPerRow1 = 3;
                        fieldsPerRow2 = 0;
                    } else {
                        fieldsPerRow1 = 2;
                        fieldsPerRow2 = fieldCount - 2;
                    }
                    
                    // Wiersz 1
                    if (fieldsPerRow1 > 0) {
                        const row1 = document.createElement('div');
                        const gridCols1 = '1fr '.repeat(fieldsPerRow1).trim();
                        row1.style.cssText = `display: grid; grid-template-columns: ${gridCols1}; gap: 8px; margin-bottom: 4px;`;
                        
                        for (let i = 0; i < fieldsPerRow1 && i < group.fields.length; i++) {
                            const field = group.fields[i];
                            const fieldDiv = document.createElement('div');
                            
                            // Specjalna logika dla matka_nazwisko - cały napis + pole to przycisk
                            if (group.id === 'matka' && field.id === 'matka_nazwisko') {
                                fieldDiv.style.cssText = 'cursor: pointer;';
                                
                                const label = document.createElement('label');
                                label.innerHTML = 'Nazwisko <span style="font-weight: bold;">v</span>';
                                label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px; cursor: pointer;';
                                fieldDiv.appendChild(label);
                                
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.dataset.field = field.id;
                                input.id = field.id;
                                input.className = 'field-input';
                                input.placeholder = field.label;
                                
                                const childLastName = act.fieldValues['dziecko_nazwisko'] || '';
                                
                                // Flaga czy sugestia jest zatwierdzona
                                let isConfirmed = act.fieldValues[field.id + '_confirmed'] || false;
                                
                                // Jeśli jest wartość w fieldValues ale nie potwierdzona, to szara sugestia
                                if (act.fieldValues[field.id]) {
                                    input.value = act.fieldValues[field.id];
                                    if (!isConfirmed) {
                                        input.style.cssText = 'width: 100%; padding: 5px; background: #0a0a0a; border: 1px solid #2a2a2a; color: #666; border-radius: 3px; font-size: 11px; cursor: pointer;';
                                        input.title = 'Kliknij aby zatwierdzić';
                                    } else {
                                        input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                    }
                                } else if (childLastName && !isConfirmed) {
                                    // Jeśli pole puste, pokaż sugestię nazwiska dziecka na szaro
                                    input.value = childLastName;
                                    input.style.cssText = 'width: 100%; padding: 5px; background: #0a0a0a; border: 1px solid #2a2a2a; color: #666; border-radius: 3px; font-size: 11px; cursor: pointer;';
                                    input.title = 'Kliknij aby zatwierdzić';
                                } else {
                                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                }
                                
                                // Klik na przycisk zatwierdza/odtwierda sugestię
                                const toggleConfirm = () => {
                                    isConfirmed = !isConfirmed;
                                    act.fieldValues[field.id + '_confirmed'] = isConfirmed;
                                    
                                    if (isConfirmed) {
                                        // Zatwierdzone - normalny styl, zapisz do fieldValues
                                        input.style.color = '#ddd';
                                        input.style.background = '#0f0f0f';
                                        input.style.borderColor = '#3a3a3a';
                                        input.style.cursor = 'text';
                                        input.title = '';
                                        act.fieldValues[field.id] = input.value.trim();
                                    } else {
                                        // Odtwierdzono - szara sugestia, nie zapisuj
                                        input.style.color = '#666';
                                        input.style.background = '#0a0a0a';
                                        input.style.borderColor = '#2a2a2a';
                                        input.style.cursor = 'pointer';
                                        input.title = 'Kliknij aby zatwierdzić';
                                        // Nie zapisuj szarej sugestii do fieldValues
                                    }
                                    saveStorage();
                                };
                                
                                label.addEventListener('click', toggleConfirm);
                                input.addEventListener('click', toggleConfirm);
                                
                                input.addEventListener('input', (e) => {
                                    // Jeśli user wpisze, przywróć normalny styl
                                    if (!isConfirmed) {
                                        isConfirmed = true;
                                        act.fieldValues[field.id + '_confirmed'] = true;
                                        input.style.color = '#ddd';
                                        input.style.background = '#0f0f0f';
                                        input.style.borderColor = '#3a3a3a';
                                        input.style.cursor = 'text';
                                        input.title = '';
                                    }
                                    act.fieldValues[field.id] = e.target.value.trim();
                                    updateCurrentRowInTable(); // Aktualizuj tylko bieżący wiersz
                                    saveStorage(); // Wyślij do Supabase w tle
                                });
                                
                                fieldDiv.appendChild(input);
                            } else if (group.id === 'matka' && field.id === 'matka_panienskie') {
                                // Panieńskie - przycisk "Panieńskie p" toggle: kopiuje i kasuje
                                fieldDiv.style.cssText = 'cursor: pointer;';
                                
                                const label = document.createElement('label');
                                label.innerHTML = 'Panieńskie <span style="font-weight: bold;">p</span>';
                                label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px; cursor: pointer;';
                                fieldDiv.appendChild(label);
                                
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.dataset.field = field.id;
                                input.id = field.id;
                                input.className = 'field-input';
                                input.placeholder = field.label;
                                input.value = act.fieldValues[field.id] || '';
                                input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                
                                // Flaga czy wartość została skopiowana przez przycisk
                                let isCopiedByButton = act.fieldValues[field.id + '_copied_by_button'] || false;
                                
                                // Jeśli jest wartość skopiowana przez button, pokaż na szaro
                                if (input.value && isCopiedByButton) {
                                    input.style.cssText = 'width: 100%; padding: 5px; background: #0a0a0a; border: 1px solid #2a2a2a; color: #666; border-radius: 3px; font-size: 11px; cursor: pointer;';
                                    input.title = 'Skopiowano - kliknij aby usunąć';
                                }
                                
                                input.addEventListener('input', (e) => {
                                    // Jeśli user wpisze, przywróć normalny styl i nie kasuj
                                    isCopiedByButton = false;
                                    act.fieldValues[field.id + '_copied_by_button'] = false;
                                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                    input.title = '';
                                    act.fieldValues[field.id] = e.target.value.trim();
                                    updateCurrentRowInTable(); // Aktualizuj tylko bieżący wiersz
                                    saveStorage(); // Wyślij do Supabase w tle
                                });
                                
                                // Toggle: klik na przycisk kopiuje/kasuje
                                const toggleCopy = () => {
                                    const childLastName = act.fieldValues['dziecko_nazwisko'] || '';
                                    
                                    if (!isCopiedByButton && !input.value) {
                                        // Kliknięcie 1 - kopiuj
                                        input.value = childLastName;
                                        isCopiedByButton = true;
                                        act.fieldValues[field.id + '_copied_by_button'] = true;
                                        input.style.cssText = 'width: 100%; padding: 5px; background: #0a0a0a; border: 1px solid #2a2a2a; color: #666; border-radius: 3px; font-size: 11px; cursor: pointer;';
                                        input.title = 'Skopiowano - kliknij aby usunąć';
                                        act.fieldValues[field.id] = childLastName;
                                    } else if (isCopiedByButton && input.value === childLastName) {
                                        // Kliknięcie 2 - kasuj (tylko jeśli równa się skopiowanemu)
                                        input.value = '';
                                        isCopiedByButton = false;
                                        act.fieldValues[field.id + '_copied_by_button'] = false;
                                        input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                        input.title = '';
                                        act.fieldValues[field.id] = '';
                                    }
                                    updateCurrentRowInTable(); // Aktualizuj tylko bieżący wiersz
                                    saveStorage(); // Wyślij do Supabase w tle
                                };
                                
                                label.addEventListener('click', toggleCopy);
                                input.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    if (isCopiedByButton) {
                                        toggleCopy();
                                    }
                                });
                                
                                fieldDiv.appendChild(input);
                            } else {
                                // Normalne pola
                                const label = document.createElement('label');
                                label.textContent = field.label;
                                label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                                fieldDiv.appendChild(label);
                                
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.dataset.field = field.id;
                                input.id = field.id;
                                input.className = 'field-input';
                                input.placeholder = field.label;
                                input.value = act.fieldValues[field.id] || '';
                                input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                                input.addEventListener('input', (e) => { 
                                    act.fieldValues[field.id] = e.target.value.trim(); 
                                    updateCurrentRowInTable(); // Aktualizuj tylko bieżący wiersz
                                    saveStorage(); // Wyślij do Supabase w tle
                                });
                                fieldDiv.appendChild(input);
                            }
                            
                            row1.appendChild(fieldDiv);
                        }
                        container.appendChild(row1);
                    }
                    
                    // Wiersz 2
                    if (fieldsPerRow2 > 0) {
                        const row2 = document.createElement('div');
                        const gridCols2 = '1fr '.repeat(fieldsPerRow2).trim();
                        row2.style.cssText = `display: grid; grid-template-columns: ${gridCols2}; gap: 8px; margin-bottom: 8px;`;
                        
                        for (let i = fieldsPerRow1; i < fieldsPerRow1 + fieldsPerRow2 && i < group.fields.length; i++) {
                            const field = group.fields[i];
                            const fieldDiv = document.createElement('div');
                            const label = document.createElement('label');
                            label.textContent = field.label;
                            label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                            fieldDiv.appendChild(label);
                            
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.dataset.field = field.id;
                            input.id = field.id;
                            input.className = 'field-input';
                            input.placeholder = field.label;
                            input.value = act.fieldValues[field.id] || '';
                            input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                            input.addEventListener('blur', (e) => { 
                                act.fieldValues[field.id] = e.target.value.trim(); 
                                updateCurrentRowInTable(); // Aktualizuj tabelę
                                saveStorage(); 
                            });
                            fieldDiv.appendChild(input);
                            row2.appendChild(fieldDiv);
                        }
                        container.appendChild(row2);
                    }
                    
                } else if (group.layout === 'custom') {
                    // Custom layout - dla pola "Ochrzczono jako:"
                    if (group.id === 'imie_chrzest') {
                        group.fields.forEach(field => {
                            const fieldDiv = document.createElement('div');
                            fieldDiv.style.marginBottom = '8px';
                            
                            const label = document.createElement('label');
                            label.textContent = field.label;
                            label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                            fieldDiv.appendChild(label);
                            
                            // Container dla pola + przycisk
                            const inputContainer = document.createElement('div');
                            inputContainer.style.cssText = 'display: flex; gap: 6px; align-items: flex-start;';
                            
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.dataset.field = field.id;
                            input.id = field.id;
                            input.className = 'field-input';
                            input.placeholder = field.label;
                            input.value = act.fieldValues[field.id] || '';
                            
                            // Jeśli pole jest puste, automatycznie załaduj imię dziecka na żółto
                            const dzieckoImieDefault = act.fieldValues['dziecko_imie'] || '';
                            if (!input.value && dzieckoImieDefault) {
                                input.value = dzieckoImieDefault;
                                act.fieldValues[field.id] = dzieckoImieDefault;
                                act.fieldValues['imie_nadane_chrzest_suggested'] = true;
                            }
                            
                            input.style.cssText = 'flex: 1; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                            input.addEventListener('blur', (e) => { 
                                act.fieldValues[field.id] = e.target.value.trim(); 
                                updateCurrentRowInTable(); // Aktualizuj tabelę
                                saveStorage(); 
                            });
                            inputContainer.appendChild(input);
                            
                            // Przycisk "✓" - zatwierdza sugestię i zmienia na normalny widok
                            const confirmBtn = document.createElement('button');
                            confirmBtn.textContent = '✓';
                            confirmBtn.title = 'Potwierdź wartość i zmień kolor na normalny';
                            confirmBtn.style.cssText = 'padding: 5px 8px; background: #252525; border: 1px solid #3a3a3a; color: #fbbf24; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: bold; min-width: 32px; transition: all 0.2s;';
                            
                            confirmBtn.addEventListener('mouseover', (e) => {
                                e.target.style.background = '#2d2d2d';
                                e.target.style.borderColor = '#fbbf24';
                                e.target.style.color = '#ffdd57';
                            });
                            
                            confirmBtn.addEventListener('mouseout', (e) => {
                                e.target.style.background = '#252525';
                                e.target.style.borderColor = '#3a3a3a';
                                e.target.style.color = '#fbbf24';
                            });
                            
                            confirmBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                // Resetuj żółtą sugestię - przywróć normalny widok
                                input.style.borderLeft = '';
                                input.style.boxShadow = '';
                                input.style.backgroundColor = '';
                                input.style.background = '#0f0f0f';
                                input.style.color = '#ddd';
                                input.style.border = '1px solid #3a3a3a';
                                act.fieldValues['imie_nadane_chrzest_suggested'] = false;
                                saveStorage();
                            });
                            inputContainer.appendChild(confirmBtn);
                            fieldDiv.appendChild(inputContainer);
                            
                            // Jeśli jest sugestia, zaznacz na żółto od razu
                            if (act.fieldValues['imie_nadane_chrzest_suggested']) {
                                input.style.borderLeft = '4px solid #fbbf24';
                                input.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                                input.style.backgroundColor = 'rgba(251,191,36,0.05)';
                            }
                            
                            container.appendChild(fieldDiv);
                        });
                    }
                    
                } else {
                    // Layout 'single' - jedno pole na linię
                    
                    // Jeśli grupa ma checkbox ale bez headera, renderuj checkbox jako pole
                    if (group.checkbox && !group.header && group.fields.length === 0) {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.style.marginBottom = '8px';
                        checkboxDiv.style.paddingTop = '8px';
                        checkboxDiv.style.borderTop = '1px solid #2a2a2a';
                        checkboxDiv.style.display = 'flex';
                        checkboxDiv.style.alignItems = 'center';
                        checkboxDiv.style.gap = '8px';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = group.checkbox.id;
                        checkbox.checked = act.fieldValues[group.checkbox.id] === true || act.fieldValues[group.checkbox.id] === 'true';
                        checkbox.style.cssText = 'cursor: pointer; width: 16px; height: 16px;';
                        checkbox.addEventListener('change', (e) => {
                            act.fieldValues[group.checkbox.id] = e.target.checked;
                            
                            // AUTO-COPY ojciec z zgłaszającego jeśli checkbox zaznaczony
                            if (group.checkbox.id === 'zglaszajacy_ojciec' && e.target.checked) {
                                act.fieldValues['ojciec_imie'] = act.fieldValues['zglaszajacy_imie'] || '';
                                act.fieldValues['ojciec_nazwisko'] = act.fieldValues['zglaszajacy_nazwisko'] || '';
                                act.fieldValues['ojciec_zawod'] = act.fieldValues['zglaszajacy_zawod'] || '';
                                act.fieldValues['ojciec_wiek'] = act.fieldValues['zglaszajacy_wiek'] || '';
                                act.fieldValues['ojciec_miejsce'] = act.fieldValues['zglaszajacy_miejsce'] || '';
                                console.log('📋 Skopiowano OSOBA ZGŁASZAJĄCA → OJCIEC');
                                // Odśwież formularz aby pokazać zakopiowane dane
                                setTimeout(() => renderFormSections(), 100);
                            }
                            
                            saveStorage();
                        });
                        checkboxDiv.appendChild(checkbox);
                        
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.textContent = group.checkbox.label;
                        checkboxLabel.style.cssText = 'font-size: 11px; color: #ddd; cursor: pointer; margin: 0; flex: 1;';
                        checkboxLabel.htmlFor = group.checkbox.id;
                        checkboxDiv.appendChild(checkboxLabel);
                        
                        container.appendChild(checkboxDiv);
                    } else {
                        // Zwykłe pola single
                        group.fields.forEach(field => {
                            const fieldDiv = document.createElement('div');
                            fieldDiv.style.marginBottom = '4px';
                            const label = document.createElement('label');
                            label.textContent = field.label;
                            label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 2px;';
                            fieldDiv.appendChild(label);
                            
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.dataset.field = field.id;
                            input.id = field.id;
                            input.className = 'field-input';
                            input.placeholder = field.label;
                            input.value = act.fieldValues[field.id] || '';
                            input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                            input.addEventListener('blur', (e) => { 
                                act.fieldValues[field.id] = e.target.value.trim(); 
                                updateCurrentRowInTable(); // Aktualizuj tabelę
                                saveStorage(); 
                            });
                            fieldDiv.appendChild(input);
                            container.appendChild(fieldDiv);
                        });
                    }
                }
            });

            // ===== "DODAJ DOWOLNE DANE" BUTTON - ENABLED FOR CUSTOM DATA =====
            // Pozwala dodać dowolne dodatkowe dane (małżeństwo, zgon, inne informacje ze chrztu)
            const addFieldDiv = document.createElement('div');
            addFieldDiv.style.marginTop = '16px';
            addFieldDiv.style.paddingTop = '12px';
            addFieldDiv.style.borderTop = '1px solid #2a2a2a';
            
            // SAVE BUTTON
            const saveBtn = document.createElement('button');
            saveBtn.textContent = '💾 Zapisz zmiany';
            saveBtn.style.cssText = 'background: #0f4c1f; border: 1px solid #10b981; color: #10b981; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 11px; width: 100%; font-weight: 600; margin-bottom: 8px; transition: all 0.2s;';
            
            saveBtn.addEventListener('mouseover', (e) => {
                e.target.style.background = '#1a6d2e';
                e.target.style.color = '#34d399';
            });
            
            saveBtn.addEventListener('mouseout', (e) => {
                e.target.style.background = '#0f4c1f';
                e.target.style.color = '#10b981';
            });
            
            saveBtn.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('🔔 User clicked SAVE button');
                
                // Zapisz do Supabase i czekaj na obietnicę
                const currentAct = app.imageActs.find(a => a.actNum === app.currentActNum);
                if (!currentAct) {
                    console.warn('⚠️ Nie znaleziono bieżącego aktu');
                    return;
                }
                
                const supabase = window.supabase_client;
                if (supabase && currentAct.id) {
                    const supabaseId = currentAct.id;
                    const fieldValues = currentAct.fieldValues || {};
                    
                    // Mapowanie z powrotem do Supabase column names
                    const supabaseData = {
                        christening_year: fieldValues.rok,
                        christening_act_number: fieldValues.nr_aktu,
                        child_first_name: fieldValues.child_first_name || fieldValues.dziecko_imie,
                        child_last_name: fieldValues.child_last_name || fieldValues.dziecko_nazwisko,
                        father_first_name: fieldValues.father_first_name || fieldValues.ojciec_imie,
                        father_last_name: fieldValues.father_last_name || fieldValues.ojciec_nazwisko,
                        father_age: fieldValues.father_age || fieldValues.ojciec_wiek,
                        mother_first_name: fieldValues.mother_first_name || fieldValues.matka_imie,
                        mother_last_name: fieldValues.mother_last_name || fieldValues.matka_nazwisko,
                        mother_maiden_name: fieldValues.mother_maiden_name || fieldValues.matka_panienskie,
                        mother_age: fieldValues.mother_age || fieldValues.matka_lata,
                        witnesses: fieldValues.witnesses || fieldValues.swiadkowie,
                        location: fieldValues.location || fieldValues.matka_miejsce,
                        notes: fieldValues.notes || fieldValues.custom_note
                    };
                    
                    supabase.from('public_imports').update(supabaseData).eq('id', supabaseId).then(({ data, error }) => {
                        if (error) {
                            console.error('❌ Błąd zapisu do Supabase:', error.message);
                        } else {
                            console.log('✅ Zapisano do Supabase:', supabaseId);
                            // Po pomyślnym zapisie - odśwież tabelę (dane w pamięci już są aktualne)
                            renderRecordsTable();
                            console.log('✅ Tabela odświeżona - dane z pamięci');
                        }
                    });
                }
            });
            
            addFieldDiv.appendChild(saveBtn);

            const addBtn = document.createElement('button');
            addBtn.textContent = '+ Dodaj dowolne dane';
            addBtn.style.cssText = 'background: #252525; border: 1px solid #3a3a3a; color: #ddd; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 10px; width: 100%;';
            
            addBtn.addEventListener('click', () => {
                // Zbierz wszystkie dostępne pola z allAvailableFields
                const availableFieldsByCategory = {};
                
                allAvailableFields.forEach(field => {
                    // Sprawdź czy pole już istnieje w tym akcie
                    if (!act.fieldValues[field.id]) {
                        if (!availableFieldsByCategory[field.category]) {
                            availableFieldsByCategory[field.category] = [];
                        }
                        availableFieldsByCategory[field.category].push(field);
                    }
                });
                
                // Stwórz modal z listą pól pogrupowanych po kategoriach
                const modalOverlay = document.createElement('div');
                modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center;';
                
                const modal = document.createElement('div');
                modal.style.cssText = 'background: #1a1a1a; border: 1px solid #3a3a3a; border-radius: 6px; padding: 20px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.8); max-height: 80vh; overflow-y: auto;';
                
                const title = document.createElement('div');
                title.textContent = 'Dodaj pole';
                title.style.cssText = 'font-size: 13px; color: #0078d4; font-weight: 600; margin-bottom: 15px; text-transform: uppercase;';
                modal.appendChild(title);
                
                // Lista dostępnych pól pogrupowana po kategoriach
                if (Object.keys(availableFieldsByCategory).length > 0) {
                    const listLabel = document.createElement('label');
                    listLabel.textContent = 'Wszystkie dostępne pola:';
                    listLabel.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 10px; font-weight: 600; text-transform: uppercase;';
                    modal.appendChild(listLabel);
                    
                    const fieldSelect = document.createElement('select');
                    fieldSelect.style.cssText = 'width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 4px; font-size: 11px; margin-bottom: 15px; box-sizing: border-box;';
                    
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '-- Wybierz pole --';
                    fieldSelect.appendChild(emptyOption);
                    
                    // Dodaj pola pogrupowane po kategoriach
                    const categories = ['Wspólne', 'Urodzenia/Chrzty', 'Małżeństwa/Śluby', 'Zgony/Pogrzeby'];
                    categories.forEach(category => {
                        if (availableFieldsByCategory[category] && availableFieldsByCategory[category].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = category;
                            
                            availableFieldsByCategory[category].forEach(field => {
                                const option = document.createElement('option');
                                option.value = field.id;
                                option.textContent = field.label;
                                optgroup.appendChild(option);
                            });
                            
                            fieldSelect.appendChild(optgroup);
                        }
                    });
                    
                    modal.appendChild(fieldSelect);
                    
                    // Przycisk do dodania z listy
                    const addFromListBtn = document.createElement('button');
                    addFromListBtn.textContent = 'Dodaj z szablonu';
                    addFromListBtn.style.cssText = 'width: 100%; padding: 8px; background: #0078d4; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; margin-bottom: 12px; transition: all 0.2s;';
                    
                    addFromListBtn.addEventListener('mouseover', (e) => {
                        e.target.style.background = '#0099ff';
                    });
                    
                    addFromListBtn.addEventListener('mouseout', (e) => {
                        e.target.style.background = '#0078d4';
                    });
                    
                    addFromListBtn.addEventListener('click', () => {
                        const selectedId = fieldSelect.value;
                        if (!selectedId) {
                            alert('Wybierz pole z listy');
                            return;
                        }
                        
                        const selectedField = allAvailableFields.find(f => f.id === selectedId);
                        if (!selectedField) return;
                        
                        addCustomField(selectedField.id, selectedField.label);
                        document.body.removeChild(modalOverlay);
                    });
                    
                    modal.appendChild(addFromListBtn);
                    
                    // Separator
                    const separator = document.createElement('div');
                    separator.style.cssText = 'height: 1px; background: #3a3a3a; margin: 12px 0;';
                    modal.appendChild(separator);
                }
                
                // Pole do wpisania własnej nazwy pola
                const customLabel = document.createElement('label');
                customLabel.textContent = 'Lub wpisz własne pole:';
                customLabel.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 6px; font-weight: 600; text-transform: uppercase;';
                modal.appendChild(customLabel);
                
                const customInput = document.createElement('input');
                customInput.type = 'text';
                customInput.placeholder = 'np. Małżeństwo, Notatka...';
                customInput.style.cssText = 'width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 4px; font-size: 11px; margin-bottom: 12px; box-sizing: border-box;';
                modal.appendChild(customInput);
                
                // Przyciski
                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.cssText = 'display: flex; gap: 8px;';
                
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Dodaj';
                confirmBtn.style.cssText = 'flex: 1; padding: 8px; background: #107c10; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s;';
                
                confirmBtn.addEventListener('mouseover', (e) => {
                    e.target.style.background = '#0d6a0d';
                });
                
                confirmBtn.addEventListener('mouseout', (e) => {
                    e.target.style.background = '#107c10';
                });
                
                confirmBtn.addEventListener('click', () => {
                    const fieldLabel = customInput.value.trim();
                    if (!fieldLabel) {
                        alert('Wpisz nazwę pola');
                        return;
                    }
                    
                    const fieldId = fieldLabel.toLowerCase().replace(/\s+/g, '_');
                    addCustomField(fieldId, fieldLabel);
                    document.body.removeChild(modalOverlay);
                });
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Anuluj';
                cancelBtn.style.cssText = 'flex: 1; padding: 8px; background: #3a3a3a; border: none; color: #ddd; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s;';
                
                cancelBtn.addEventListener('mouseover', (e) => {
                    e.target.style.background = '#454545';
                });
                
                cancelBtn.addEventListener('mouseout', (e) => {
                    e.target.style.background = '#3a3a3a';
                });
                
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(modalOverlay);
                });
                
                buttonsDiv.appendChild(confirmBtn);
                buttonsDiv.appendChild(cancelBtn);
                modal.appendChild(buttonsDiv);
                
                modalOverlay.appendChild(modal);
                document.body.appendChild(modalOverlay);
                customInput.focus();
                
                // Helper function - dodaj pole do formularza
                function addCustomField(fieldId, fieldLabel) {
                    if (!act.fieldValues) act.fieldValues = {};
                    
                    // Twórz pole
                    const fieldDiv = document.createElement('div');
                    fieldDiv.style.marginBottom = '4px';
                    
                    const label = document.createElement('label');
                    label.textContent = fieldLabel;
                    label.style.cssText = 'display: block; font-size: 10px; color: #10b981; margin-bottom: 2px; font-weight: 600;';
                    fieldDiv.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'field-input';
                    input.id = fieldId;
                    input.placeholder = fieldLabel;
                    input.value = act.fieldValues[fieldId] || '';
                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                    
                    input.addEventListener('blur', (e) => {
                        act.fieldValues[fieldId] = e.target.value.trim();
                        updateCurrentRowInTable(); // Aktualizuj tabelę
                        saveStorage();
                    });
                    
                    fieldDiv.appendChild(input);
                    container.insertBefore(fieldDiv, addFieldDiv);
                    input.focus();
                    saveStorage();
                }
            });

            addFieldDiv.appendChild(addBtn);
            container.appendChild(addFieldDiv);

            // ===== LOGIC: Auto-suggest mother's surname from father =====
            // Dodaj listener do pola ojciec_nazwisko aby sugerować nazwisko matki
            const ojciecNazwiskoInput = document.getElementById('ojciec_nazwisko');
            const matkaNazwiskoInput = document.getElementById('matka_nazwisko');
            
            if (ojciecNazwiskoInput && matkaNazwiskoInput) {
                ojciecNazwiskoInput.addEventListener('blur', (e) => {
                    const ojciecNazwisko = e.target.value.trim();
                    
                    // Jeśli pole matki jest puste i wpisano nazwisko ojca
                    if (ojciecNazwisko && !matkaNazwiskoInput.value.trim()) {
                        // Zasugeruj nazwisko ojca dla matki ze wskaźnikiem niepewności (żółty kolor)
                        matkaNazwiskoInput.value = ojciecNazwisko;
                        matkaNazwiskoInput.style.borderLeft = '4px solid #fbbf24';  // 🟡 Żółty - sugestia
                        matkaNazwiskoInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                        matkaNazwiskoInput.title = 'Zasugerowane na podstawie nazwiska ojca - zmień jeśli nieprecyzyjne';
                        // Zaznacz w fieldValues aby wiedzieć, że to sugestia
                        act.fieldValues['matka_nazwisko_suggested'] = true;
                        updateCurrentRowInTable(); // Aktualizuj tabelę
                        saveStorage();
                    } else if (!ojciecNazwisko) {
                        // Jeśli usunięto nazwisko ojca, usuń sugestię jeśli była
                        if (act.fieldValues['matka_nazwisko_suggested']) {
                            matkaNazwiskoInput.value = '';
                            matkaNazwiskoInput.style.borderLeft = '';
                            matkaNazwiskoInput.style.boxShadow = '';
                            matkaNazwiskoInput.title = '';
                            act.fieldValues['matka_nazwisko_suggested'] = false;
                            updateCurrentRowInTable(); // Aktualizuj tabelę
                            saveStorage();
                        }
                    }
                });
            }
            
            // Jeśli już był wpisany ojciec przy otwarciu, zasugeruj nazwisko matki
            if (ojciecNazwiskoInput && matkaNazwiskoInput) {
                const ojciecNazwisko = ojciecNazwiskoInput.value.trim();
                if (ojciecNazwisko && !matkaNazwiskoInput.value.trim() && !act.fieldValues['matka_nazwisko']) {
                    matkaNazwiskoInput.value = ojciecNazwisko;
                    matkaNazwiskoInput.style.borderLeft = '4px solid #fbbf24';  // 🟡 Żółty - sugestia
                    matkaNazwiskoInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                    matkaNazwiskoInput.title = 'Zasugerowane na podstawie nazwiska ojca - zmień jeśli nieprecyzyjne';
                    act.fieldValues['matka_nazwisko_suggested'] = true;
                }
            }
            
            // ===== LOGIC: Add confirm button for matka_nazwisko when suggested =====
            if (matkaNazwiskoInput && act.fieldValues['matka_nazwisko_suggested']) {
                addConfirmButtonToField(matkaNazwiskoInput, 'matka_nazwisko_suggested');
            }
            
            // ===== LOGIC: Auto-suggest priest info from previous act =====
            const ksiadzImieInput = document.getElementById('ksiadz_imie');
            const ksiadzNazwiskoInput = document.getElementById('ksiadz_nazwisko');
            
            if (ksiadzImieInput && ksiadzNazwiskoInput) {
                // Szukaj poprzedniego aktu na tej samej lub poprzedniej stronie
                let previousAct = null;
                
                // Najpierw spróbuj znaleźć poprzedni akt na tej samej stronie
                if (app.currentActNum > 0 && app.imageActs[app.currentImageIdx]) {
                    previousAct = app.imageActs[app.currentImageIdx][app.currentActNum - 1];
                } else if (app.currentImageIdx > 0 && app.imageActs[app.currentImageIdx - 1]) {
                    // Jeśli brak poprzedniego na tej stronie, weź ostatni z poprzedniej strony
                    const prevImageActs = app.imageActs[app.currentImageIdx - 1];
                    if (prevImageActs && prevImageActs.length > 0) {
                        previousAct = prevImageActs[prevImageActs.length - 1];
                    }
                }
                
                if (previousAct && previousAct.fieldValues) {
                    const prevKsIm = previousAct.fieldValues['ksiadz_imie'] || '';
                    const prevKsNaz = previousAct.fieldValues['ksiadz_nazwisko'] || '';
                    
                    // Jeśli są dane księdza w poprzednim akcie i pola są puste
                    if ((prevKsIm || prevKsNaz) && !ksiadzImieInput.value.trim() && !ksiadzNazwiskoInput.value.trim()) {
                        // Zasugeruj dane księdza
                        if (prevKsIm) {
                            ksiadzImieInput.value = prevKsIm;
                            ksiadzImieInput.style.borderLeft = '4px solid #fbbf24';
                            ksiadzImieInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                            ksiadzImieInput.style.backgroundColor = 'rgba(251,191,36,0.05)';
                            act.fieldValues['ksiadz_imie_suggested'] = true;
                            addConfirmButtonToField(ksiadzImieInput, 'ksiadz_imie_suggested');
                        }
                        
                        if (prevKsNaz) {
                            ksiadzNazwiskoInput.value = prevKsNaz;
                            ksiadzNazwiskoInput.style.borderLeft = '4px solid #fbbf24';
                            ksiadzNazwiskoInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                            ksiadzNazwiskoInput.style.backgroundColor = 'rgba(251,191,36,0.05)';
                            act.fieldValues['ksiadz_nazwisko_suggested'] = true;
                            addConfirmButtonToField(ksiadzNazwiskoInput, 'ksiadz_nazwisko_suggested');
                        }
                        
                        saveStorage();
                    }
                }
            }
            
            // ===== LOGIC: Highlight ksiadz fields if already filled from suggestion =====
            if (ksiadzImieInput && act.fieldValues['ksiadz_imie_suggested']) {
                ksiadzImieInput.style.borderLeft = '4px solid #fbbf24';
                ksiadzImieInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                ksiadzImieInput.style.backgroundColor = 'rgba(251,191,36,0.05)';
                addConfirmButtonToField(ksiadzImieInput, 'ksiadz_imie_suggested');
            }
            
            if (ksiadzNazwiskoInput && act.fieldValues['ksiadz_nazwisko_suggested']) {
                ksiadzNazwiskoInput.style.borderLeft = '4px solid #fbbf24';
                ksiadzNazwiskoInput.style.boxShadow = '0 0 8px rgba(251,191,36,0.3)';
                ksiadzNazwiskoInput.style.backgroundColor = 'rgba(251,191,36,0.05)';
                addConfirmButtonToField(ksiadzNazwiskoInput, 'ksiadz_nazwisko_suggested');
            }
            
            // Focus first field
            container.querySelector('.field-input')?.focus();
        }
        
        // ===== Helper function: Add confirm button next to input field =====
        function addConfirmButtonToField(inputElement, suggestionFlagKey) {
            // Sprawdź czy przycisk już istnieje
            let existingBtn = inputElement.nextElementSibling;
            if (existingBtn && existingBtn.dataset.confirmBtn === 'true') {
                return; // Przycisk już istnieje
            }
            
            // Stwórz container dla przycisku
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '✓';
            confirmBtn.title = 'Potwierdź wartość i zmień kolor na normalny';
            confirmBtn.dataset.confirmBtn = 'true';
            confirmBtn.style.cssText = 'padding: 5px 8px; background: #252525; border: 1px solid #3a3a3a; color: #fbbf24; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: bold; min-width: 32px; transition: all 0.2s; position: absolute; right: 0; top: 20px;';
            
            confirmBtn.addEventListener('mouseover', (e) => {
                e.target.style.background = '#2d2d2d';
                e.target.style.borderColor = '#fbbf24';
                e.target.style.color = '#ffdd57';
            });
            
            confirmBtn.addEventListener('mouseout', (e) => {
                e.target.style.background = '#252525';
                e.target.style.borderColor = '#3a3a3a';
                e.target.style.color = '#fbbf24';
            });
            
            confirmBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // Resetuj żółtą sugestię - przywróć normalny widok
                inputElement.style.borderLeft = '';
                inputElement.style.boxShadow = '';
                inputElement.style.backgroundColor = '';
                // Upewnij się że pole ma normalny styl
                inputElement.style.background = '#0f0f0f';
                inputElement.style.color = '#ddd';
                inputElement.style.border = '1px solid #3a3a3a';
                app.imageActs[app.currentActNum][suggestionFlagKey] = false;
                saveStorage();
                // Usuń przycisk
                confirmBtn.remove();
            });
            
            // Umieść przycisk obok pola
            inputElement.parentElement.style.position = 'relative';
            inputElement.parentElement.appendChild(confirmBtn);
        }
        
        function setupFormEvents() {
            // ===== DEPRECATED - old form events not needed =====
        }
        
        // ⭐ P0: Update Progress Bar - Show N/M fields complete
        function updateProgressBar() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const inputs = activeForm.querySelectorAll('.field-input');
            const completed = Array.from(inputs).filter(input => 
                input.value?.trim().length > 0
            ).length;
            
            const total = inputs.length;
            const percent = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${completed}/${total}`;
            
            console.log(`📊 Progress: ${completed}/${total} (${percent.toFixed(0)}%)`);
        }
        
        // TASK #2: Search Handler - Filter acts by field values
        function setupSearchInput() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                
                if (!query) {
                    // Reset: show all act buttons
                    renderActButtons();
                    return;
                }
                
                // Filter acts on current image by field values
                const currentImageActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                const filtered = currentImageActs.filter(act => {
                    return Object.values(act.fieldValues || {}).some(val =>
                        val?.toString().toLowerCase().includes(query)
                    );
                });
                
                // Highlight matching acts
                const actBtns = document.querySelectorAll('.act-btn');
                actBtns.forEach(btn => {
                    const actNum = parseInt(btn.dataset.actNum);
                    const isMatched = filtered.some(a => a.actNum === actNum);
                    btn.style.opacity = isMatched ? '1' : '0.4';
                    btn.style.borderColor = isMatched ? '#0078d4' : '#3a3a3a';
                });
                
                console.log(`🔍 Search: znaleźliśmy ${filtered.length}/${currentImageActs.length} aktów`);
            });
        }
        
        // TASK #3: JSON Import - Load records from file
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        
                        // Validate structure
                        if (!Array.isArray(data.imageActs)) throw new Error('Brak imageActs array');
                        
                        // Import
                        app.imageActs = data.imageActs || [];
                        app.images = data.images || app.images; // Keep existing images if not in file
                        
                        saveStorage();
                        renderActButtons();
                        renderFormSections();
                        updateProgressBar();
                        
                        const count = app.imageActs.length;
                        notify(`✅ Importowano ${count} aktów z JSON`, 'success');
                        console.log('📥 JSON Import: SUCCESS', data);
                    } catch (err) {
                        notify(`❌ Błąd importu JSON: ${err.message}`, 'error');
                        console.error('❌ JSON Import ERROR:', err);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // TASK #4: Tab Navigation - Enhanced with Shift+Tab
        function setupTabNavigation() {
            document.addEventListener('keydown', (e) => {
                // Tab = next field, Shift+Tab = prev field
                if (e.key === 'Tab') {
                    const activeForm = document.querySelector('.form-section.active');
                    if (!activeForm) return;
                    
                    const inputs = Array.from(activeForm.querySelectorAll('.field-input'));
                    const currentIdx = inputs.indexOf(document.activeElement);
                    
                    if (currentIdx === -1) return;
                    
                    let nextIdx = e.shiftKey ? currentIdx - 1 : currentIdx + 1;
                    
                    // Wrap around
                    if (nextIdx < 0) nextIdx = inputs.length - 1;
                    if (nextIdx >= inputs.length) nextIdx = 0;
                    
                    e.preventDefault();
                    inputs[nextIdx].focus();
                    inputs[nextIdx].select?.();
                    
                    console.log(`⌨️ Tab: field ${nextIdx + 1}/${inputs.length}`);
                }
            });
        }
        
        // 🟢 P0: Color-Coded Fields - Update visual status of all fields
        function updateFieldStatus() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const act = getCurrentAct();
            const inputs = activeForm.querySelectorAll('.field-input');
            
            inputs.forEach(input => {
                const fieldId = input.dataset.field;
                const hasValue = input.value?.trim().length > 0;
                const hasROI = act?.fieldROIs?.[fieldId];
                
                // Remove all status classes
                input.classList.remove('field-complete', 'field-roi-only', 'field-empty');
                
                // Assign new status
                if (hasValue) {
                    input.classList.add('field-complete');  // 🟢 Green
                } else if (hasROI) {
                    input.classList.add('field-roi-only');  // 🟡 Yellow
                } else {
                    input.classList.add('field-empty');     // 🔴 Red
                }
            });
        }
        
        // ⭐ P0: AUTO-ZOOM TO ROI/ACT
        function zoomToROI(roi) {
            if (!app.viewer || !roi) return;
            const item = app.viewer.world.getItemAt(0);
            if (!item) return;
            const itemSize = item.getContentSize();
            const rect = new OpenSeadragon.Rect(
                roi.x * itemSize.x,
                roi.y * itemSize.y,
                roi.w * itemSize.x,
                roi.h * itemSize.y
            );
            const viewportRect = app.viewer.viewport.imageToViewportRectangle(rect);
            app.viewer.viewport.fitBounds(viewportRect, true);
            console.log('🔍 AUTO-ZOOM to ROI:', { x: roi.x.toFixed(2), y: roi.y.toFixed(2), w: roi.w.toFixed(2), h: roi.h.toFixed(2) });
        }
        
        function initViewer() {
            return new Promise((resolve) => {
                console.log('📍 Creating OpenSeadragon instance...');
                app.viewer = OpenSeadragon({
                    id: 'viewer',
                    prefixUrl: 'https://openseadragon.github.io/openseadragon/images/',

                    // Kontrolki OSD
                    showNavigationControl: true,
                    showZoomControl: true,
                    showHomeControl: true,
                    showFullPageControl: true,
                    showRotationControl: true,

                    // Gesty myszą
                    gestureSettingsMouse: {
                        scrollToZoom: true,
                        dragToPan: true,
                        clickToZoom: true,
                        dblClickToZoom: false,
                        flickEnabled: false
                    },

                    // Zoom
                    minZoomLevel: 0.5,
                    maxZoomLevel: 20,
                    
                    // Rotacja
                    rotationIncrement: 90,

                    // Kontrolki UI - wbudowane przyciski OSD (prawy górny róg)
                    navigationControlAnchor: OpenSeadragon.ControlAnchor.TOP_RIGHT,
                    showNavigationControl: true,
                    showZoomControl: true,
                    showHomeControl: true,
                    showFullPageControl: false,
                    showRotationControl: true
                });

                console.log('📍 OpenSeadragon instance created, viewer:', !!app.viewer);
                resolve();
            });
        }
        
        function setupDrawingCanvas() {
            app.drawingCanvas = document.getElementById('drawingCanvas');
            app.drawingCtx = app.drawingCanvas.getContext('2d');
            const container = document.querySelector('.viewer-container');
            
            const resize = () => {
                app.drawingCanvas.width = container.offsetWidth;
                app.drawingCanvas.height = container.offsetHeight;
            };
            resize();
            window.addEventListener('resize', resize);
            
            // Funkcja do aktualizacji pointer-events
            const updateCanvasInteraction = () => {
                if (app.roiMode || app.actMode) {
                    app.drawingCanvas.style.pointerEvents = 'auto';
                    app.drawingCanvas.style.cursor = 'crosshair';
                } else {
                    app.drawingCanvas.style.pointerEvents = 'none';
                    app.drawingCanvas.style.cursor = 'default';
                }
            };
            
            updateCanvasInteraction();
            
            app.drawingCanvas.addEventListener('mousedown', (e) => {
                if (!app.actMode) return;
                // roiMode wyłączony
                if (!app.currentActNum) { notify('Zaznacz akt w oknie AKTY zanim zaznaczysz granice', 'error'); return; }
                
                e.preventDefault();
                app.drawingROI = true;
                app.roiStartX = e.offsetX;
                app.roiStartY = e.offsetY;
                updateCanvasInteraction();
            });
            
            app.drawingCanvas.addEventListener('mousemove', (e) => {
                if (!app.drawingROI) return;
                app.drawingCtx.clearRect(0, 0, app.drawingCanvas.width, app.drawingCanvas.height);
                redrawROIs();
                
                let x = app.roiStartX, y = app.roiStartY, w = e.offsetX - x, h = e.offsetY - y;
                if (w < 0) { x += w; w = -w; }
                if (h < 0) { y += h; h = -h; }
                
                app.drawingCtx.strokeStyle = app.roiMode ? '#0078d4' : '#10b981';
                app.drawingCtx.fillStyle = app.roiMode ? 'rgba(0,120,212,0.15)' : 'rgba(16,185,129,0.1)';
                app.drawingCtx.setLineDash([5, 5]);
                app.drawingCtx.strokeRect(x, y, w, h);
                app.drawingCtx.fillRect(x, y, w, h);
                app.drawingCtx.setLineDash([]);
            });
            
            app.drawingCanvas.addEventListener('mouseup', (e) => {
                if (!app.drawingROI) return;
                app.drawingROI = false;
                updateCanvasInteraction();
                
                let x = Math.min(app.roiStartX, e.offsetX);
                let y = Math.min(app.roiStartY, e.offsetY);
                let w = Math.abs(e.offsetX - app.roiStartX);
                let h = Math.abs(e.offsetY - app.roiStartY);
                
                if (w < 10 || h < 10) { app.drawingCtx.clearRect(0, 0, app.drawingCanvas.width, app.drawingCanvas.height); return; }
                
                const roi = screenToImageRect(x, y, w, h);
                if (!roi) return;
                
                const act = getCurrentAct();
                if (!act) return;
                
                // roiMode wyłączony
                /*
                if (app.roiMode) {
                    // Normalizuj fieldId - zamień kropki na podkreślenia
                    const normalizedFieldId = app.activeField.dataset.field.replace(/\./g, '_');
                    act.fieldROIs[normalizedFieldId] = roi;
                    app.activeField.classList.add('has-roi');
                    notify('Pole zaznaczone', 'success');
                    setTimeout(() => startWizard(), 200);
                } else */ if (app.actMode) {
                    act.actROI = roi;
                    notify('✓ Granice aktu zaznaczone', 'success');
                    // Tryb actMode pozostaje włączony - user wyłączy manualnie gdy skończy zaznaczać wszystkie akty
                }
                
                saveStorage();
                app.drawingCtx.clearRect(0, 0, app.drawingCanvas.width, app.drawingCanvas.height);
                setTimeout(redrawROIs, 50);
            });
            
            app.drawingCanvas.addEventListener('mouseleave', () => {
                if (app.drawingROI) {
                    app.drawingROI = false;
                    updateCanvasInteraction();
                    app.drawingCtx.clearRect(0, 0, app.drawingCanvas.width, app.drawingCanvas.height);
                }
            });
            
            // Zapamiętaj funkcję aby mogła być wywołana z toggleROI/toggleActMode
            app.updateCanvasInteraction = updateCanvasInteraction;
        }
        
        function screenToImageRect(x, y, w, h) {
            const viewer = app.viewer;
            const item = viewer.world.getItemAt(0);
            if (!item) return null;
            
            try {
                const p1 = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(x, y));
                const p2 = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(x + w, y + h));
                const img1 = item.viewportToImageCoordinates(p1);
                const img2 = item.viewportToImageCoordinates(p2);
                const size = item.getContentSize();
                
                return {
                    x: img1.x / size.x,
                    y: img1.y / size.y,
                    w: (img2.x - img1.x) / size.x,
                    h: (img2.y - img1.y) / size.y
                };
            } catch (err) {
                console.error('Błąd konwersji:', err);
                return null;
            }
        }
        
        function redrawROIs() {
            try {
                const viewer = app.viewer;
                const item = viewer.world.getItemAt(0);
                if (!item) return;
            
            if (app.needsFullRedraw) {
                app.roiOverlays.forEach(overlay => viewer.removeOverlay(overlay));
                app.roiOverlays = [];
                app.overlayMap.clear();
                
                // Usuwamy wszelkie pozostałe overlay aktu z DOM
                document.querySelectorAll('.act-overlay').forEach(el => {
                    try {
                        viewer.removeOverlay(el);
                    } catch (e) {
                        // Overlay może być już usunięty
                    }
                    el.remove();
                });
            }
            
            const size = item.getContentSize();
            
            // Draw field ROIs ONLY for the currently selected act
            const currentAct = app.imageActs.find(a => 
                a.imageIdx === app.currentImageIdx && a.actNum === app.currentActNum
            );
            
            // Draw act overlays for all acts on current image
            const currentActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
            
            console.log('currentActs length:', currentActs.length, 'currentImageIdx:', app.currentImageIdx);
            
            // ONLY draw act boundaries if showActBoundaries is true
            if (app.showActBoundaries) {
                currentActs.forEach(act => {
                if (!act.actROI) return;
                
                console.log('Drawing act overlay for act', act.actNum);
                
                const actTypeShort = act.type.toUpperCase().substring(0, 2);
                const actName = `${actTypeShort}.${act.year}.No.${act.nr.toString().padStart(2, '0')}`;
                
                const key = `act_${act.actNum}`;
                const imgRect = new OpenSeadragon.Rect(
                    act.actROI.x * size.x, act.actROI.y * size.y,
                    act.actROI.w * size.x, act.actROI.h * size.y
                );
                const viewportRect = viewer.viewport.imageToViewportRectangle(imgRect);
                
                if (viewportRect.width <= 0 || viewportRect.height <= 0) {
                    console.warn('Invalid viewportRect for act', act.actNum, viewportRect);
                    return;
                }
                
                let div = app.overlayMap.get(key);
                if (!div || app.needsFullRedraw) {
                    div = document.createElement('div');
                    div.className = 'act-overlay';
                    div.style.border = act.actNum === app.currentActNum ? '2px solid #10b981' : '2px dashed #999';
                    div.dataset.actNum = act.actNum;
                    const label = document.createElement('div');
                    label.textContent = actName;
                    label.style.cssText = 'color: #000000; font-size: 12px; font-weight: bold; padding: 4px 6px; background: none; text-decoration: none;';
                    div.appendChild(label);
                    
                    // Context menu dla aktu
                    div.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showActContextMenu(act.actNum, e.pageX, e.pageY);
                    });
                    
                    viewer.addOverlay({ element: div, location: viewportRect });
                    app.roiOverlays.push(div);
                    app.overlayMap.set(key, div);
                } else {
                    viewer.removeOverlay(div);
                    viewer.addOverlay({ element: div, location: viewportRect });
                }
                });
            }
            
            // Draw field ROIs ONLY for the currently selected act
            
            if (currentAct && currentAct.fieldROIs) {
                const actTypeShort = currentAct.type.toUpperCase().substring(0, 2);
                const actName = `${actTypeShort}.${currentAct.year}.No.${currentAct.nr.toString().padStart(2, '0')}`;
                
                Object.entries(currentAct.fieldROIs).forEach(([fieldId, roi]) => {
                    const key = `field_${currentAct.actNum}_${fieldId}`;
                    const imgRect = new OpenSeadragon.Rect(
                        roi.x * size.x, roi.y * size.y,
                        roi.w * size.x, roi.h * size.y
                    );
                    const viewportRect = viewer.viewport.imageToViewportRectangle(imgRect);
                    
                    if (viewportRect.width <= 0 || viewportRect.height <= 0) {
                        console.warn('Invalid viewportRect for field', fieldId, viewportRect);
                        return;
                    }
                    
                    console.log('Drawing field ROI for', fieldId, 'at', viewportRect);
                    
                    let div = app.overlayMap.get(key);
                    if (!div || app.needsFullRedraw) {
                        div = document.createElement('div');
                        div.className = 'roi-overlay';
                        const label = document.createElement('div');
                        label.textContent = actName;
                        label.style.cssText = 'color: white; font-size: 11px; padding: 4px; background: rgba(0,0,0,0.6); text-decoration: overline;';
                        div.appendChild(label);
                        
                        console.log('Adding overlay for', key, 'at', viewportRect);
                        viewer.addOverlay({ element: div, location: viewportRect });
                        app.roiOverlays.push(div);
                        app.overlayMap.set(key, div);
                    } else {
                        console.log('Updating overlay for', key);
                        viewer.removeOverlay(div);
                        viewer.addOverlay({ element: div, location: viewportRect });
                    }
                    
                    // Zawsze aktualizuj klasy
                    div.classList.remove('active');
                    if (app.activeField?.dataset.field === fieldId) {
                        div.classList.add('active');
                    }
                });
            }
            
            app.needsFullRedraw = true; // Reset flagi
            } catch (e) {
                console.error('Error in redrawROIs:', e);
            }
        }
        
        function setupEvents() {
            console.log('⚙️ setupEvents starting...');
            document.getElementById('fileInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
            
            document.getElementById('folderInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
            
            const viewerContainer = document.getElementById('viewerContainer');
            if (viewerContainer) {
                viewerContainer.addEventListener('dragover', (e) => { e.preventDefault(); viewerContainer.classList.add('drag-over'); });
                viewerContainer.addEventListener('dragleave', () => { viewerContainer.classList.remove('drag-over'); });
                viewerContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    viewerContainer.classList.remove('drag-over');
                    handleFiles(e.dataTransfer.files);
                });
            }
            
            // Toolbar button listeners (safe after DOM loaded)
            // Find by text content "Otwórz"
            let addImagesBtn = document.getElementById('openBtn');
            console.log('🔍 addImagesBtn found:', !!addImagesBtn, addImagesBtn?.title);
            if (addImagesBtn) addImagesBtn.addEventListener('click', addImages);
            
            const postprocessBtn = document.getElementById('postprocessBtn');
            if (postprocessBtn) postprocessBtn.addEventListener('click', togglePostprocessPanel);
            
            const actsBtn = document.getElementById('toggleActsBtn');
            if (actsBtn) actsBtn.addEventListener('click', toggleActsPanel);
            
            // Inne przyciski toolbar
            const sortBtn = document.getElementById('sortBtn');
            if (sortBtn) sortBtn.addEventListener('click', sortImages);
            
            const roiBtn = document.getElementById('roiBtn');
            if (roiBtn) roiBtn.addEventListener('click', toggleActMode);
            
            const toggleBoundariesBtn = document.getElementById('toggleBoundariesBtn');
            if (toggleBoundariesBtn) {
                toggleBoundariesBtn.addEventListener('click', toggleActBoundaries);
                // Ustaw stan początkowy przycisku
                toggleBoundariesBtn.classList.toggle('disabled', !app.showActBoundaries);
            }
            
            // Auth button
            const authBtn = document.getElementById('authBtn');
            if (authBtn) authBtn.addEventListener('click', signInWithGoogle);
            
            // const actBtn = document.getElementById('actBtn');
            // if (actBtn) actBtn.addEventListener('click', toggleROI);
            
            // Context menu dla viewerContainer (obraz)
            if (viewerContainer) {
                viewerContainer.addEventListener('contextmenu', (e) => {
                    const rect = viewerContainer.getBoundingClientRect();
                    const clickedOnOverlay = e.target.closest('.act-overlay');
                    if (!clickedOnOverlay) {
                        e.preventDefault();
                        showImageContextMenu(e.pageX, e.pageY);
                    }
                });
            }
            
            // Setup context menu handlers
            setupContextMenuHandlers();
            
            const clearStorageBtn = document.getElementById('clearStorageBtn');
            if (clearStorageBtn) {
                clearStorageBtn.addEventListener('click', () => {
                    if (confirm('⚠️ Wyczyść CAŁE localStorage? Wszystkie dane będą usunięte.')) {
                        localStorage.clear();
                        notify('✅ localStorage wyczyszczony. Odśwież stronę.', 'success');
                        setTimeout(() => location.reload(), 1500);
                    }
                });
            }
            
            // Close button in acts panel
            const actsPanel = document.getElementById('actsPanel');
            if (actsPanel) {
                const closeBtn = actsPanel.querySelector('button[title*="Ukryj"]');
                if (closeBtn) closeBtn.addEventListener('click', toggleActsPanel);
                
                // Act control buttons
                const addActBtn = actsPanel.querySelector('button[title*="Dodaj nowy akt"]');
                if (addActBtn) addActBtn.addEventListener('click', () => showAdvancedActModal());
                
                const removeActBtn = actsPanel.querySelector('button[title*="Usuń wybrany akt"]');
                if (removeActBtn) removeActBtn.addEventListener('click', () => {
                    if (app.currentActNum) {
                        deleteCurrentRecord();
                    } else {
                        notify('Najpierw wybierz akt do usunięcia', 'error');
                    }
                });
                
                const removeAllBtn = actsPanel.querySelector('button[title*="Usuń wszystkie akty"]');
                if (removeAllBtn) removeAllBtn.addEventListener('click', () => {
                    if (confirm('Czy na pewno chcesz usunąć wszystkie akty z tego obrazu?')) {
                        clearAllActsOnImage();
                    }
                });
            }
            
            document.addEventListener('keydown', (e) => {
                // ⭐ Arrow keys to navigate between acts
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    const currentActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                    if (currentActs.length === 0) return;
                    
                    const currentIdx = currentActs.findIndex(a => a.actNum === app.currentActNum);
                    let nextIdx = currentIdx;
                    
                    if (e.key === 'ArrowLeft') nextIdx = Math.max(0, currentIdx - 1);
                    if (e.key === 'ArrowRight') nextIdx = Math.min(currentActs.length - 1, currentIdx + 1);
                    
                    if (nextIdx !== currentIdx) {
                        selectAct(currentActs[nextIdx].actNum);
                        e.preventDefault();
                    }
                }
                
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'o') { e.preventDefault(); addImages(); }
                    if (e.key === 'r') { e.preventDefault(); toggleROI(); }
                    if (e.key === 'a') { e.preventDefault(); toggleActMode(); }
                    // ⌨️ P0: Ctrl+N = New Record
                    if (e.key === 'n') { 
                        e.preventDefault(); 
                        if (!app.currentImageIdx && app.currentImageIdx !== 0) {
                            notify('❌ Najpierw dodaj obrazy', 'error');
                            return;
                        }
                        showAdvancedActModal();
                        console.log('⌨️ Ctrl+N: New act');
                    }
                    // ⌨️ P0: Ctrl+S = Save Record
                    if (e.key === 's') { 
                        e.preventDefault(); 
                        saveRecord();
                        console.log('⌨️ Ctrl+S: Record saved');
                    }
                    // ⭐ P0: Ctrl+Shift+V = Copy Previous Record
                    if (e.key === 'V' && e.shiftKey) {
                        e.preventDefault();
                        copyPreviousRecord();
                        console.log('⌨️ Ctrl+Shift+V: Copy previous');
                    }
                }
                
                // Otwórz/zamknij duży floating formularz tylko po wciśnięciu Enter (gdy jest wybrany akt)
                // ALE: Jeśli focus jest w input field, nie otwieraj - pozwól wpisać normalnie
                if (e.key === 'Enter' && app.currentActNum && !document.querySelector('input:focus')) {
                    e.preventDefault();
                    toggleFloatingForm();
                }
                
                // ⭐ P0: Escape key - Close pinups / Close floating form
                if (e.key === 'Escape') {
                    const floatingForm = document.getElementById('floatingFormPanel');
                    if (floatingForm?.style.display === 'block') {
                        floatingForm.style.display = 'none';
                        console.log('🔌 Escape: Floating form closed');
                    } else if (app.pinupPositions && Object.keys(app.pinupPositions).length > 0) {
                        clearPinups();
                        console.log('🔌 Escape: All pinups cleared');
                    }
                }
            });
        }
        
        // Table editing listeners
        const dataTable = document.getElementById('dataTable');
        if (dataTable) {
            // Copy selected rows to clipboard (Ctrl+C)
            dataTable.addEventListener('copy', (e) => {
                const selectedRows = document.querySelectorAll('#dataTableBody tr');
                let textToCopy = [];
                
                selectedRows.forEach(row => {
                    if (row.querySelector('.row-checkbox')?.checked) {
                        const cells = row.querySelectorAll('td');
                        const rowData = [];
                        cells.forEach((cell, idx) => {
                            if (idx > 0) { // Skip checkbox
                                rowData.push(cell.textContent.trim());
                            }
                        });
                        textToCopy.push(rowData.join('\t'));
                    }
                });
                
                if (textToCopy.length > 0) {
                    e.preventDefault();
                    e.clipboardData.setData('text/plain', textToCopy.join('\n'));
                    notify(`📋 Skopiowano ${textToCopy.length} wierszy`, 'success');
                }
            });
            
            dataTable.addEventListener('click', (e) => {
                if (e.target.classList.contains('cell-editable')) {
                    const input = document.createElement('input');
                    input.value = e.target.textContent;
                    input.style.width = '100%';
                    e.target.innerHTML = '';
                    e.target.appendChild(input);
                    input.focus();
                    
                    input.addEventListener('blur', () => {
                        const newValue = input.value;
                        e.target.textContent = newValue;
                        
                        // Zapisz do aktu
                        const rowIdx = e.target.parentNode.rowIndex - 1; // -1 dla thead
                        const act = app.imageActs[rowIdx];
                        const cellIdx = e.target.cellIndex - 1; // -1 dla checkbox
                        
                        if (act && act.fieldValues) {
                            // Mapuj indeksy kolumn na fieldValues
                            // 0=checkbox, 1=ID, 2=Akt, 3=Imię dziecka, 4=Nazwisko dziecka, 5=Ojciec imię, 6=Ojciec nazwisko, 7=Matka imię, 8=Matka nazwisko, 9=Lokacja, 10=Uwagi, 11=Opis źródła
                            if (cellIdx === 1) act.id = newValue; // ID
                            else if (cellIdx === 3) act.fieldValues.child_first_name = newValue; // Imię dziecka
                            else if (cellIdx === 4) act.fieldValues.child_last_name = newValue; // Nazwisko dziecka
                            else if (cellIdx === 5) act.fieldValues.father_first_name = newValue; // Ojciec imię
                            else if (cellIdx === 6) act.fieldValues.father_last_name = newValue; // Ojciec nazwisko
                            else if (cellIdx === 7) act.fieldValues.mother_first_name = newValue; // Matka imię
                            else if (cellIdx === 8) act.fieldValues.mother_last_name = newValue; // Matka nazwisko
                            else if (cellIdx === 9) act.fieldValues.location = newValue; // Lokacja
                            else if (cellIdx === 10) act.fieldValues.notes = newValue; // Uwagi
                            else if (cellIdx === 11) act.fieldValues.notes_org = newValue; // Opis źródła
                            
                            // Zapisz do Firestore jeśli dostępny
                            if (window.db && act.id) {
                                db.collection('public_imports').doc(act.id).update(act).catch(err => console.error('❌ Error saving:', err));
                            }
                        }
                        
                        renderRecordsTable(); // Odśwież tabelę
                    });
                }
            });
            
            // Paste listener for table
            dataTable.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = (e.clipboardData || window.clipboardData).getData('text');
                const rows = pastedData.split('\n').map(row => row.split('\t'));
                
                const selectedRow = document.activeElement.closest('tr')?.rowIndex - 1 || 0;
                
                rows.forEach((rowData, i) => {
                    const act = app.imageActs[selectedRow + i];
                    if (act && act.fieldValues) {
                        // 0=ID, 1=Akt, 2=Imię dziecka, 3=Nazwisko dziecka, 4=Ojciec imię, 5=Ojciec nazwisko, 6=Matka imię, 7=Matka nazwisko, 8=Lokacja, 9=Uwagi, 10=Opis źródła
                        if (rowData[0]) act.id = rowData[0];
                        if (rowData[2]) act.fieldValues.child_first_name = rowData[2];
                        if (rowData[3]) act.fieldValues.child_last_name = rowData[3];
                        if (rowData[4]) act.fieldValues.father_first_name = rowData[4];
                        if (rowData[5]) act.fieldValues.father_last_name = rowData[5];
                        if (rowData[6]) act.fieldValues.mother_first_name = rowData[6];
                        if (rowData[7]) act.fieldValues.mother_last_name = rowData[7];
                        if (rowData[8]) act.fieldValues.location = rowData[8];
                        if (rowData[9]) act.fieldValues.notes = rowData[9];
                        if (rowData[10]) act.fieldValues.notes_org = rowData[10];
                        
                        // Zapisz do Firestore
                        if (window.db && act.id) {
                            db.collection('public_imports').doc(act.id).update(act).catch(err => console.error('❌ Error saving:', err));
                        }
                    }
                });
                
                renderRecordsTable();
                notify('📋 Wklejono dane', 'success');
            });
        }
        
        function saveRecord() {
            if (app.currentActNum === null) {
                notify('Zaznacz akt do zapisania', 'error');
                return;
            }
            const act = getCurrentAct();
            if (!act) return;

            const form = document.querySelector(`#form-${app.currentTemplate}`);
            if (!form) return;

            const data = {};
            form.querySelectorAll('.field-input').forEach(input => {
                const value = input.value.trim();
                if (value) {
                    data[input.dataset.field] = value;
                }
            });

            act.fieldValues = data;
            act.timestamp = new Date().toISOString();

            renderActButtons();
            updateRecordCounter();
            redrawROIs();
            saveStorage();

            notify('Akt zapisany', 'success');
        }

        // ⭐ P0: Copy Previous Record - Duplicate values from last record
        function copyPreviousRecord() {
            if (app.currentActNum === null) {
                notify('❌ Zaznacz akt najpierw', 'error');
                return;
            }
            
            const currentActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
            const currentIdx = currentActs.findIndex(a => a.actNum === app.currentActNum);
            
            if (currentIdx === 0) {
                notify('⚠️ Brak poprzedniego aktu do skopiowania', 'warning');
                return;
            }
            
            const previousAct = currentActs[currentIdx - 1];
            const currentAct = getCurrentAct();
            if (!currentAct) return;
            
            // Copy fieldValues from previous
            currentAct.fieldValues = { ...previousAct.fieldValues };
            
            // Render form with new data
            renderFormSections();
            saveStorage();
            
            notify(`✨ Skopiowano z Aktu ${previousAct.actNum}`, 'success');
            console.log(`📋 COPY: Akt ${app.currentActNum} copied from Akt ${previousAct.actNum}`);
        }

        function deleteCurrentRecord() {
            if (app.currentActNum === null) {
                notify('Brak wybranego aktu do usunięcia', 'error');
                return;
            }

            if (!confirm('Czy na pewno usunąć ten akt? Tej operacji nie można cofnąć.')) {
                return;
            }

            app.imageActs = app.imageActs.filter(a => 
                !(a.imageIdx === app.currentImageIdx && a.actNum === app.currentActNum)
            );

            const remainingActs = app.imageActs
                .filter(a => a.imageIdx === app.currentImageIdx)
                .sort((a, b) => a.actNum - b.actNum);

            remainingActs.forEach((act, idx) => {
                act.actNum = idx + 1;
            });

            app.currentActNum = null;
            clearForm();
            renderActButtons();
            redrawROIs();
            updateRecordCounter();
            saveStorage();

            notify('Akt usunięty', 'success');
        }

        function clearAllActsOnImage() {
            app.imageActs = app.imageActs.filter(a => a.imageIdx !== app.currentImageIdx);
            app.currentActNum = null;
            clearForm();
            renderActsList();
            redrawROIs();
            updateRecordCounter();
            saveStorage();
            notify('Wszystkie akty usunięte z tego obrazu', 'success');
        }

        function updateRecordCounter() {
            const counter = document.getElementById('recordCounter');
            if (!counter) return;

            const totalActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx).length;

            if (app.currentActNum !== null) {
                counter.textContent = `Akt: #${app.currentActNum} / ${totalActs}`;
            } else {
                counter.textContent = totalActs > 0 ? `Akty: ${totalActs}` : 'Brak aktów';
            }
        }

        async function autoGenerateID(actData) {
            // Generuj ID w formacie: TYP.WOJ.PARAFIA.ROK.MIES.NR.SUF
            const typeMap = {
                // New template names (v8.7)
                'christening': 'CH',
                'birth': 'UR',
                'marriage': 'MZ',
                'death': 'ZG',
                // Old Polish names (legacy support)
                'chrzest': 'CH',
                'urodzenie': 'UR',
                'małżeństwo': 'MZ',
                'zgon': 'ZG',
                'indeks': 'IN'
            };
            
            const wójMap = {
                'LUB': 'LUB',
                'MAZ': 'MAZ',
                'WAR': 'WAR',
                'KUJ': 'KUJ',
                'POD': 'POD',
                'MAL': 'MAL',
                'SLA': 'SLA',
                'POM': 'POM',
                'GDA': 'GDA'
            };
            
            const typ = typeMap[actData.typ] || 'UR';
            const woj = wójMap[actData.woj] || actData.woj.substring(0, 3).toUpperCase();
            const parafia = (actData.parafia || 'NEZNANE').substring(0, 6).toUpperCase();
            
            // Parse rok i miesiąc z data_zgl (format: YYYY-MM-DD)
            // Miesiąc tylko jeśli podany, inaczej 00
            let rok = '1900';
            let mies = '00';
            if (actData.data_zgl) {
                const parts = actData.data_zgl.split('-');
                rok = parts[0] || '1900';
                mies = (parts[1] && parts[1] !== '00') ? parts[1] : '00';
            }
            
            const nr = String(actData.nr_aktu || 0).padStart(5, '0');
            const suf = actData.is_copy ? '01' : '00';
            
            const id = `${typ}.${woj}.${parafia}.${rok}.${mies}.${nr}.${suf}`;
            console.log('📝 Generated ID:', id, 'from:', actData);
            return id;

            /*
            const response = await fetch('https://api.x.ai/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer YOUR_API_KEY' },
                body: JSON.stringify({
                    model: 'grok-beta',
                    messages: [{ role: 'user', content: prompt }]
                })
            });
            const result = await response.json();
            return result.choices[0].message.content.trim();
            */
        }

        function renderActButtons() {
            // Całość funkcjonalności przeniesiona do panelu aktów (renderActsList)
            // Ta funkcja pozostawiona dla kompatybilności, ale nic nie robi
            const oldButtons = document.getElementById('actsContainer');
            if (oldButtons) oldButtons.remove();
        }

        function showActContextMenuPanel(actNum, event, btnElement) {
            // Menu kontekstowe dla konkretnego aktu (prawy klik na przycisku aktu w lewym oknie)
            // Opcje: zmień nazwę, usuń granice, usuń pola, usuń akt
            const existingMenu = document.getElementById('actContextMenu');
            if (existingMenu) existingMenu.remove();

            const menu = document.createElement('div');
            menu.id = 'actContextMenu';
            
            // Pozycja przy przycisku
            const rect = btnElement.getBoundingClientRect();
            menu.style.cssText = `
                position: fixed;
                top: ${rect.bottom + 5}px;
                left: ${rect.left}px;
                background: #2a2a2a;
                border: 1px solid #10b981;
                border-radius: 4px;
                padding: 4px 0;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                min-width: 200px;
            `;

            const options = [
                { label: 'Zmień nazwę aktu', action: () => editActName(actNum), color: '#ddd' },
                { label: 'Usuń granice aktu', action: () => deleteActROIPanel(actNum), color: '#ff9800' },
                { label: 'Usuń pola w akcie', action: () => deleteActFieldsPanel(actNum), color: '#ff9800' },
                { label: 'Usuń akt', action: () => deleteActPanel(actNum), color: '#ff6b6b' }
            ];

            options.forEach((opt, idx) => {
                const item = document.createElement('div');
                item.textContent = opt.label;
                item.style.cssText = `
                    padding: 8px 12px;
                    cursor: pointer;
                    color: ${opt.color};
                    font-size: 12px;
                    transition: background 0.15s;
                    ${idx < options.length - 1 ? 'border-bottom: 1px solid #1a1a1a;' : ''}
                `;
                item.onmouseover = () => item.style.background = 'rgba(255,152,0,0.1)';
                item.onmouseout = () => item.style.background = 'transparent';
                item.onclick = () => {
                    opt.action();
                    menu.remove();
                };
                menu.appendChild(item);
            });

            document.body.appendChild(menu);

            // Zamknij menu przy kliknięciu poza
            const closeMenu = (e) => {
                if (!menu.contains(e.target) && e.target !== btnElement) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 10);
        }

        function deleteActROIPanel(actNum) {
            const act = app.imageActs.find(a => a.actNum === actNum && a.imageIdx === app.currentImageIdx);
            if (act) {
                act.actROI = null;
                redrawROIs();
                saveStorage();
                renderActsList();
                notify('Granice aktu usunięte', 'success');
            }
        }

        function deleteActFieldsPanel(actNum) {
            const act = app.imageActs.find(a => a.actNum === actNum && a.imageIdx === app.currentImageIdx);
            if (act) {
                act.fieldROIs = {};
                redrawROIs();
                saveStorage();
                renderActsList();
                notify('Pola w akcie usunięte', 'success');
            }
        }

        function deleteActPanel(actNum) {
            if (!confirm('Czy na pewno usunąć akt? Ta operacja nie może być cofnięta.')) return;
            app.imageActs = app.imageActs.filter(a => a.actNum !== actNum);
            renderActsList();
            redrawROIs();
            saveStorage();
            notify('Akt usunięty', 'success');
        }

        function editActName(actNum) {
            const act = app.imageActs.find(a => a.actNum === actNum && a.imageIdx === app.currentImageIdx);
            if (!act) return;
            
            const currentName = formatActDisplayName(act);
            const newName = prompt('Zmień nazwę aktu:\n(format: TYP.ROK.N͞o.NR np. CH.1908.N͞o.60)', currentName);
            
            if (newName && newName.trim()) {
                // Jeśli to jest pełny ID w formacie CH.LUB.BLIN.1908.05.00060.00
                if (newName.includes('.') && newName.split('.').length >= 6) {
                    act.id = newName;
                } else {
                    // Jeśli to tylko skrócona nazwa, zastąp ostatnie części ID
                    const parts = act.id.split('.');
                    if (parts.length >= 6) {
                        // Parse nowej nazwy
                        const newParts = newName.split('.');
                        if (newParts.length >= 3) {
                            // CH.1908.N͞o.60 -> CH.LUB.BLIN.1908.05.00060.00
                            const typ = newParts[0];
                            const rok = newParts[1];
                            const nr = newParts[newParts.length - 1].padStart(5, '0');
                            parts[0] = typ;
                            parts[3] = rok;
                            parts[5] = nr;
                            act.id = parts.join('.');
                        }
                    }
                }
                saveStorage();
                renderActsList();
                notify('✅ Nazwa aktu zmieniona', 'success');
            }
        }

        function getCurrentAct() {
            if (app.currentActNum === null) return null;
            return app.imageActs.find(a => 
                a.imageIdx === app.currentImageIdx && a.actNum === app.currentActNum
            );
        }

        function selectAct(actNum) {
            const act = app.imageActs.find(a => 
                a.imageIdx === app.currentImageIdx && a.actNum === actNum
            );

            if (!act) {
                notify('Akt nie istnieje', 'error');
                return;
            }

            clearPinups();
            app.currentActNum = actNum;
            // loadActToForm(act);  // ❌ DEPRECATED - renderFormSections renderuje dynamicznie
            renderFormSections();  // Renderuj formularz w prawym panelu
            renderActButtons();
            updateRecordCounter();
            redrawROIs();

            if (act.actROI) {
                zoomToAct(act.actROI);
            }
            
            // Automatycznie otwórz pin-upy dla wszystkich pól z ROI w tym akcie
            if (act.fieldROIs && Object.keys(act.fieldROIs).length > 0) {
                setTimeout(() => {
                    Object.keys(act.fieldROIs).forEach(fieldId => {
                        createPinupForField(fieldId);
                    });
                }, 300);
            }
            
            // E: Auto-focus pierwszy input w formularzu
            focusFirstField();
        }

        function loadActToForm(act) {
            clearForm();
            const form = document.querySelector(`#form-${app.currentTemplate}`);
            if (!form) return;

            form.querySelectorAll('.field-input').forEach(input => {
                const fieldId = input.dataset.field;
                const value = act.fieldValues[fieldId] || '';
                input.value = value;

                if (act.fieldROIs && act.fieldROIs[fieldId]) {
                    input.classList.add('has-roi');
                } else {
                    input.classList.remove('has-roi');
                }
            });
            
            updateFieldStatus();  // 🟢 Update colors when loading record
            updateProgressBar();  // ⭐ Update progress when loading record
            
            // ⭐ Auto-zoom to act ROI if exists
            if (act.actROI) {
                setTimeout(() => zoomToROI(act.actROI), 100);
            }
            
            // ⭐ Auto-focus first field
            const formEl = document.querySelector(`#form-${app.currentTemplate}`);
            const firstInput = formEl?.querySelector('.field-input');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 150);
                console.log('🎯 Auto-focus: first field focused');
            }
            
            // ⭐ Show summary notification
            const filledFields = Object.keys(act.fieldValues).length;
            const totalFields = formEl?.querySelectorAll('.field-input').length || 0;
            const roiCount = Object.keys(act.fieldROIs || {}).length;
            notify(`📋 Akt ${act.actNum} | ${filledFields}/${totalFields} pól | ${roiCount} ROI`, 'info');
        }

        function clearForm() {
            const activeForm = document.querySelector('.form-section.active');
            if (activeForm) {
                activeForm.querySelectorAll('.field-input').forEach(input => {
                    input.value = '';
                    input.classList.remove('has-roi');
                });
            }
            updateFieldStatus();  // 🟢 Update colors when clearing form
            updateProgressBar();  // ⭐ Update progress when clearing form
        }

        function showAdvancedActModal() {
            const modal = document.getElementById('advancedActModal');
            if (!modal) return;

            // Ładuj pamiętane wartości z localStorage
            const prevData = JSON.parse(localStorage.getItem('lastActSettings')) || {};
            document.getElementById('modalYear').value = prevData.year || new Date().getFullYear() - 100;
            document.getElementById('modalParish').value = prevData.parish || 'Brak';
            document.getElementById('modalWoj').value = prevData.woj || 'LUB';
            document.getElementById('modalType').value = prevData.type || 'christening';
            
            // Szukaj ostatniego aktu z POPRZEDNIEGO obrazu
            const prevActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx - 1).sort((a,b) => (a.nr || 0) - (b.nr || 0)) || [];
            const lastPrevNr = prevActs.length > 0 ? prevActs[prevActs.length - 1].nr || 0 : 0;
            const hasPrev = prevActs.length > 0;
            const defaultFirst = hasPrev ? lastPrevNr + 1 : 1;
            const defaultLast = defaultFirst + (prevActs.length || 10) - 1;

            document.getElementById('modalFirstNr').value = defaultFirst;
            document.getElementById('modalLastNr').value = defaultLast;
            document.getElementById('modalIncomplete').checked = !!prevData.incomplete;
            document.getElementById('modalPlusIndex').checked = !!prevData.plusIndex;

            modal.style.display = 'flex';
            
            // Uczynij modal przesuwnym
            const modalContent = document.getElementById('advancedActModalContent');
            makeElementDraggable(modalContent);

            document.getElementById('modalOK').onclick = async () => {
                const data = {
                    year: parseInt(document.getElementById('modalYear').value),
                    parish: document.getElementById('modalParish').value,
                    woj: document.getElementById('modalWoj').value,
                    type: document.getElementById('modalType').value,
                    firstNr: parseInt(document.getElementById('modalFirstNr').value),
                    lastNr: parseInt(document.getElementById('modalLastNr').value),
                    incomplete: document.getElementById('modalIncomplete').checked,
                    plusIndex: document.getElementById('modalPlusIndex').checked
                };
                localStorage.setItem('lastActSettings', JSON.stringify(data));

                const count = data.lastNr - data.firstNr + 1;
                const newActs = [];
                for (let i = 0; i < count; i++) {
                    const act = {
                        imageIdx: app.currentImageIdx,
                        actNum: i + 1, // actNum to numer aktu na stronie, nie globalny nr
                        nr: data.firstNr + i, // Globalny nr aktu
                        year: data.year,
                        parish: data.parish,
                        woj: data.woj,
                        type: data.type,
                        fieldValues: {},
                        fieldROIs: {},
                        actROI: null,
                        timestamp: new Date().toISOString()
                    };
                    if (data.plusIndex) act.index = ''; // Dodaj pole indeksu
                    if (i === count - 1 && data.incomplete) act.incomplete = true; // Flag
                    newActs.push(act);
                }

                // Generate IDs asynchronously
                for (const act of newActs) {
                    const actData = {
                        typ: act.type,
                        woj: act.woj,
                        parafia: act.parish,
                        data_zgl: `${act.year}-00-01`,
                        nr_aktu: act.nr,
                        is_copy: false
                    };
                    act.id = await autoGenerateID(actData);
                }

                app.imageActs.push(...newActs);

                saveStorage();
                renderActsList();
                renderRecordsTable();
                selectAct(1);
                updateRecordCounter();
                notify(`Utworzono ${count} aktów`, 'success');
                modal.style.display = 'none';
            };

            document.getElementById('modalCopyPrev').onclick = async () => {
                // Przelicz aktów z poprzedniego obrazu - mogły się zmienić!
                console.log('📋 copyPrev: currentImageIdx =', app.currentImageIdx, 'looking for imageIdx =', app.currentImageIdx - 1);
                const freshPrevActs = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx - 1).sort((a,b) => (a.nr || 0) - (b.nr || 0)) || [];
                console.log('📋 Found freshPrevActs:', freshPrevActs.length, 'acts with nr:', freshPrevActs.map(a => a.nr));
                if (freshPrevActs.length === 0) {
                    notify('Brak aktów na poprzedniej stronie', 'error');
                    return;
                }
                const freshLastPrevNr = freshPrevActs.length > 0 ? freshPrevActs[freshPrevActs.length - 1].nr || 0 : 0;
                console.log('📋 lastPrevNr =', freshLastPrevNr);
                
                const data = {
                    year: parseInt(document.getElementById('modalYear').value),
                    parish: document.getElementById('modalParish').value,
                    woj: document.getElementById('modalWoj').value,
                    type: document.getElementById('modalType').value,
                    incomplete: document.getElementById('modalIncomplete').checked,
                    plusIndex: document.getElementById('modalPlusIndex').checked
                };
                console.log('📋 copyPrev: kopiowanie poprzedniej strony');
                localStorage.setItem('lastActSettings', JSON.stringify(data));

                const lastPrevAct = freshPrevActs[freshPrevActs.length - 1]; // Bierz dane TYLKO z ostatniego aktu
                const copiedActs = [];
                freshPrevActs.forEach((prevAct, index) => {
                    const act = {
                        imageIdx: app.currentImageIdx,
                        actNum: index + 1,
                        nr: prevAct.nr, // KOPIUJ dokładny nr z poprzedniej strony!
                        year: data.year,
                        parish: data.parish,
                        woj: data.woj,
                        type: data.type,
                        fieldValues: JSON.parse(JSON.stringify(lastPrevAct.fieldValues)), // Dane TYLKO z ostatniego aktu!
                        fieldROIs: JSON.parse(JSON.stringify(lastPrevAct.fieldROIs)), // ROI TYLKO z ostatniego aktu!
                        actROI: lastPrevAct.actROI ? JSON.parse(JSON.stringify(lastPrevAct.actROI)) : null,
                        timestamp: new Date().toISOString()
                    };
                    if (data.plusIndex) act.index = lastPrevAct.index || '';
                    if (index === freshPrevActs.length - 1 && data.incomplete) act.incomplete = true;
                    copiedActs.push(act);
                });

                // Generate IDs asynchronously
                for (const act of copiedActs) {
                    const actData = {
                        typ: act.type,
                        woj: act.woj,
                        parafia: act.parish,
                        data_zgl: `${act.year}-00-01`,
                        nr_aktu: act.nr,
                        is_copy: false
                    };
                    act.id = await autoGenerateID(actData);
                }

                app.imageActs.push(...copiedActs);

                saveStorage();
                renderActsList();
                selectAct(1);
                updateRecordCounter();
                notify(`Skopiowano ${freshPrevActs.length} aktów z poprzedniej strony`, 'success');
                modal.style.display = 'none';
            };

            document.getElementById('modalCancel').onclick = () => modal.style.display = 'none';
        }

        function createActsForImage() {
            const input = document.getElementById('actCountInput');
            const count = Math.max(1, parseInt(input.value) || 1);

            closeActModal();

            for (let i = 1; i <= count; i++) {
                const act = {
                    imageIdx: app.currentImageIdx,
                    actNum: i,
                    type: 'christening',  // Domyślny typ - będzie można zmienić w selectorze
                    fieldValues: {},
                    fieldROIs: {},
                    actROI: null,
                    timestamp: new Date().toISOString()
                };
                app.imageActs.push(act);
            }

            saveStorage();
            renderActButtons();
            renderFormSections();  // Odśwież prawy panel - listę aktów
            selectAct(1);
            updateRecordCounter();
            notify(`Utworzono ${count} aktów`, 'success');
        }

        function exportData(type = 'full') {
            if (app.imageActs.length === 0) {
                notify('Brak aktów do eksportu', 'error');
                return;
            }

            const csv = generateCSV(type);
            const json = JSON.stringify(app.imageActs, null, 2);

            const suffix = type === 'full' ? '_z_ROI' : '_prosty';
            downloadFile(csv, `akty${suffix}.csv`, 'text/csv');
            downloadFile(json, 'akty.json', 'application/json');

            notify(`Eksportowano ${app.imageActs.length} aktów`, 'success');
        }

        function generateCSV(type = 'full') {
            let lines = [];
            const headers = ['Obraz', 'Akt', 'Typ', 'Data utworzenia'];
            const allFields = new Set();

            app.templates.forEach(t => {
                t.sections?.forEach(s => {
                    s.fields.forEach(f => allFields.add(f.label));
                });
            });

            allFields.forEach(label => {
                headers.push(label);
                if (type === 'full') {
                    headers.push(`ROI_${label}_X`);
                    headers.push(`ROI_${label}_Y`);
                    headers.push(`ROI_${label}_W`);
                    headers.push(`ROI_${label}_H`);
                }
            });

            if (type === 'full') {
                headers.push('Act_ROI_X', 'Act_ROI_Y', 'Act_ROI_W', 'Act_ROI_H');
            }

            lines.push(headers.join(','));

            app.imageActs.forEach(act => {
                const image = app.images[act.imageIdx];
                const imageName = image?.name || 'Nieznany';

                const row = [
                    imageName,
                    act.actNum,
                    app.currentTemplate,
                    new Date(act.timestamp).toLocaleString('pl-PL')
                ];

                allFields.forEach(label => {
                    const fieldId = [...app.templates.find(t => t.id === app.currentTemplate)?.sections || []]
                        .flatMap(s => s.fields)
                        .find(f => f.label === label)?.id || '';

                    const value = act.fieldValues[fieldId] || '';
                    row.push(value);

                    if (type === 'full') {
                        const roi = act.fieldROIs[fieldId];
                        row.push(roi?.x || '');
                        row.push(roi?.y || '');
                        row.push(roi?.w || '');
                        row.push(roi?.h || '');
                    }
                });

                if (type === 'full') {
                    const actROI = act.actROI;
                    row.push(actROI?.x || '');
                    row.push(actROI?.y || '');
                    row.push(actROI?.w || '');
                    row.push(actROI?.h || '');
                }

                lines.push(row.map(cell => `"${(cell + '').replace(/"/g, '""')}"`).join(','));
            });

            return '\uFEFF' + lines.join('\n');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type + ';charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function renderUI() {
            renderFormSections();
            renderActButtons();
            updateRecordCounter();
        }

        function selectImage(idx, autoSelect = false) {
            console.log('🖼️ selectImage called with idx:', idx);
            if (idx < 0 || idx >= app.images.length) {
                console.log('❌ Invalid image index:', idx, 'max:', app.images.length);
                return;
            }

            app.currentImageIdx = idx;
            app.currentActNum = null;
            console.log('✅ Set currentImageIdx to:', idx);

            updateThumbs();
            updateImageCounter();
            renderActsList(); // Update acts panel when image changes
            renderRecordsTable();

            const actsOnImage = app.imageActs.filter(a => a.imageIdx === idx);

            if (!autoSelect && actsOnImage.length === 0) {
                showAdvancedActModal();
            } else if (actsOnImage.length > 0) {
                selectAct(actsOnImage[0].actNum);
            }

            if (app.images[idx]) {
                const imageData = app.images[idx].data;
                console.log('📸 Opening image:', app.images[idx].name);
                console.log('📊 Image data length:', imageData ? imageData.length : 'null');
                
                // Zawsze otwieraj przez OpenSeadragon (obsługuje zarówno URL jak i data URL)
                if (app.viewer) {
                    app.viewer.open({
                        type: 'image',
                        url: imageData
                    });
                    console.log('✅ Image loaded in OSD');
                }
                
                // Ukryj fallback img (na wszelki wypadek)
                document.getElementById('imageFallback').classList.remove('active');
            } else {
                console.log('❌ No image data at index:', idx);
            }

            redrawROIs();
        }

        // function toggleROI() {
        //     app.roiMode = !app.roiMode;
        //     document.getElementById('actBtn').classList.toggle('active', app.roiMode);
        //     if (app.updateCanvasInteraction) app.updateCanvasInteraction();
        // }

        function toggleActMode() {
            app.actMode = !app.actMode;
            document.getElementById('roiBtn').classList.toggle('active', app.actMode);
            if (app.updateCanvasInteraction) app.updateCanvasInteraction();
        }

        function toggleActBoundaries() {
            app.showActBoundaries = !app.showActBoundaries;
            const btn = document.getElementById('toggleBoundariesBtn');
            if (btn) {
                btn.classList.toggle('disabled', !app.showActBoundaries);
            }
            // Natychmiastowo zmień widoczność wszystkich granic aktów
            document.querySelectorAll('.act-overlay').forEach(el => {
                el.style.display = app.showActBoundaries ? 'block' : 'none';
            });
        }

        // CONTEXT MENU - Menu kontekstowe dla aktów i obrazów
        let contextMenuState = {
            actNum: null,
            x: 0,
            y: 0
        };

        function showActContextMenu(actNum, x, y) {
            contextMenuState.actNum = actNum;
            contextMenuState.x = x;
            contextMenuState.y = y;
            const menu = document.getElementById('actContextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }

        function showImageContextMenu(x, y) {
            contextMenuState.actNum = null;
            contextMenuState.x = x;
            contextMenuState.y = y;
            const menu = document.getElementById('imageContextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }

        function hideContextMenus() {
            document.getElementById('actContextMenu').classList.remove('active');
            document.getElementById('imageContextMenu').classList.remove('active');
        }

        function deleteActROI() {
            if (contextMenuState.actNum === null) return;
            const act = app.imageActs.find(a => a.actNum === contextMenuState.actNum);
            if (act) {
                act.actROI = null;
                redrawROIs();
                saveStorage();
                notify('Granice aktu usunięte', 'success');
            }
            hideContextMenus();
        }

        function deleteActFields() {
            if (contextMenuState.actNum === null) return;
            const act = app.imageActs.find(a => a.actNum === contextMenuState.actNum);
            if (act) {
                act.fieldROIs = {};
                redrawROIs();
                saveStorage();
                notify('Pola w akcie usunięte', 'success');
            }
            hideContextMenus();
        }

        function deleteAct() {
            if (contextMenuState.actNum === null) return;
            if (!confirm('Czy na pewno usunąć akt? Ta operacja nie może być cofnięta.')) {
                hideContextMenus();
                return;
            }
            app.imageActs = app.imageActs.filter(a => a.actNum !== contextMenuState.actNum);
            renderActButtons();
            redrawROIs();
            saveStorage();
            notify('Akt usunięty', 'success');
            hideContextMenus();
        }

        function deleteAllActsOnImage() {
            if (!confirm('Czy na pewno usunąć WSZYSTKIE akty na tym obrazie? Ta operacja nie może być cofnięta.')) {
                hideContextMenus();
                return;
            }
            app.imageActs = app.imageActs.filter(a => a.imageIdx !== app.currentImageIdx);
            renderActButtons();
            redrawROIs();
            saveStorage();
            notify('Wszystkie akty na obrazie usunięte', 'success');
            hideContextMenus();
        }

        function deleteAllROIsOnImage() {
            const acts = app.imageActs.filter(act => act.imageIdx === app.currentImageIdx);
            acts.forEach(act => {
                act.actROI = null;
                act.fieldROIs = {};
            });
            redrawROIs();
            saveStorage();
            notify('Wszystkie granice na obrazie usunięte', 'success');
            hideContextMenus();
        }

        function setupContextMenuHandlers() {
            // Ukryj menu przy kliknieciu poza
            document.addEventListener('click', hideContextMenus);
            document.addEventListener('contextmenu', (e) => {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenus();
                }
            });
            
            // Handlery dla menu aktów
            const actMenu = document.getElementById('actContextMenu');
            actMenu.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                switch(action) {
                    case 'delete-roi': deleteActROI(); break;
                    case 'delete-fields': deleteActFields(); break;
                    case 'delete-act': deleteAct(); break;
                    case 'rename': {
                        const act = app.imageActs.find(a => a.actNum === contextMenuState.actNum);
                        if (act) {
                            const newName = prompt('Nowa nazwa aktu:', act.name || '');
                            if (newName !== null) {
                                act.name = newName;
                                saveStorage();
                                renderActButtons();
                                redrawROIs();
                                notify('✓ Nazwa zmieniona', 'success');
                            }
                        }
                        hideContextMenus();
                        break;
                    }
                }
            });
            
            // Handlery dla menu obrazu
            const imageMenu = document.getElementById('imageContextMenu');
            imageMenu.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                switch(action) {
                    case 'delete-all-acts': deleteAllActsOnImage(); break;
                    case 'delete-all-rois': deleteAllROIsOnImage(); break;
                }
            });
        }

        function clearAllROIs() {
            const acts = app.imageActs.filter(act => act.imageIdx === app.currentImageIdx);
            acts.forEach(act => {
                act.fieldROIs = {}; // Czyści ROI per-pole
                act.actROI = null; // Czyści główny ROI aktu
            });
            redrawROIs(); // Odśwież overlaye
            saveStorage(); // Zapisz zmiany
            notify('Wszystkie ROI usunięte z bieżącego skanu', 'success');
        }

        function sortImages() {
            app.images.sort(naturalSort);
            updateThumbs();
            // Zachowaj wybór bieżącego obrazu jeśli to możliwe
            const currentImageName = app.images[app.currentImageIdx]?.name;
            const newIndex = app.images.findIndex(img => img.name === currentImageName);
            app.currentImageIdx = newIndex >= 0 ? newIndex : 0;
            selectImage(app.currentImageIdx, true);
            notify('Obrazy posortowane po nazwie', 'success');
        }

        function zoomToAct(actROI) {
            if (!actROI) return;
            const item = app.viewer.world.getItemAt(0);
            if (!item) return;
            const itemSize = item.getContentSize();
            const rect = new OpenSeadragon.Rect(
                actROI.x * itemSize.x,
                actROI.y * itemSize.y,
                actROI.w * itemSize.x,
                actROI.h * itemSize.y
            );
            const viewportRect = app.viewer.viewport.imageToViewportRectangle(rect);
            app.viewer.viewport.fitBounds(viewportRect, true);
        }

        function rotateImage(degrees) {
            if (!app.viewer) return;
            const current = app.viewer.viewport.getRotation();
            app.viewer.viewport.setRotation((current + degrees + 360) % 360);
        }

        function zoomReset() {
            if (app.viewer && app.viewer.world.getItemAt(0)) {
                app.viewer.viewport.fitBounds(app.viewer.world.getItemAt(0).getBounds());
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    notify(`Błąd fullscreen: ${err.message}`, 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Google Authentication
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                const result = await firebase.auth().signInWithPopup(provider);
                const user = result.user;
                
                console.log('✅ Google sign-in successful:', user.displayName);
                notify(`Zalogowano jako: ${user.displayName}`, 'success');
                
                // Update UI to show user is logged in
                const authBtn = document.getElementById('authBtn');
                if (authBtn) {
                    authBtn.innerHTML = '<i class="fas fa-user-check"></i> ' + user.displayName.split(' ')[0];
                    authBtn.title = 'Wyloguj się';
                    authBtn.onclick = signOut;
                }
                
                // Enable Firebase features
                app.storageMode = 'firebase';
                console.log('🔥 Switched to Firebase storage mode');
                
            } catch (error) {
                console.error('❌ Google sign-in error:', error);
                notify(`Błąd logowania: ${error.message}`, 'error');
            }
        }

        async function signOut() {
            try {
                await firebase.auth().signOut();
                console.log('👋 Signed out');
                notify('Wylogowano', 'info');
                
                // Reset UI
                const authBtn = document.getElementById('authBtn');
                if (authBtn) {
                    authBtn.innerHTML = '<i class="fab fa-google"></i> Login';
                    authBtn.title = 'Zaloguj się z Google';
                    authBtn.onclick = signInWithGoogle;
                }
                
                // Switch back to local storage
                app.storageMode = 'local';
                console.log('💾 Switched to local storage mode');
                
            } catch (error) {
                console.error('❌ Sign out error:', error);
                notify(`Błąd wylogowania: ${error.message}`, 'error');
            }
        }

        function checkLocalStorage() {
            try {
                const data = localStorage.getItem('genealog_data');
                if (data) {
                    const parsed = JSON.parse(data);
                    const actsCount = parsed.imageActs?.length || 0;
                    const imagesCount = parsed.images?.length || 0;
                    console.log('📊 localStorage data:', { acts: actsCount, images: imagesCount, size: data.length });
                    alert(`Dane w localStorage:\nAkty: ${actsCount}\nObrazy: ${imagesCount}\nRozmiar: ${(data.length/1024).toFixed(1)} KB`);
                } else {
                    console.log('❌ No data in localStorage');
                    alert('Brak danych w localStorage');
                }
            } catch (error) {
                console.error('❌ Error checking localStorage:', error);
                alert('Błąd sprawdzania localStorage: ' + error.message);
            }
        }

        function addImages() {
            console.log('📁 addImages clicked');
            document.getElementById('fileInput').click();
        }

        function handleFiles(files) {
            console.log('📁 handleFiles called with', files.length, 'files');
            const imageFiles = Array.from(files).filter(f => f.type?.startsWith('image/'));
            console.log('🖼️ Found', imageFiles.length, 'image files');
            let loaded = 0;

            imageFiles.forEach(file => {
                console.log('📄 Processing file:', file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    console.log('✅ File loaded:', file.name, 'data length:', e.target.result.length);
                    app.images.push({
                        name: file.name,
                        relativePath: file.webkitRelativePath || '', // Zachowuje ścieżkę z folderu
                        data: e.target.result
                    });
                    loaded++;
                    if (loaded === imageFiles.length) {
                        console.log('🎉 All images loaded, sorting and updating UI');
                        // Autosort po nazwie po wczytaniu wszystkich plików
                        app.images.sort(naturalSort);
                        updateThumbs();
                        selectImage(0, true); // Wybierz pierwszy (posortowany) - auto
                        notify(`Wczytano ${imageFiles.length} obraz(y) (posortowane)`, 'success');
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function naturalSort(a, b) {
            return a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'});
        }

        function updateThumbs() {
            const bar = document.getElementById('thumbsBar');
            bar.innerHTML = '';
            app.images.forEach((img, i) => {
                const div = document.createElement('div');
                div.className = 'thumbnail' + (i === app.currentImageIdx ? ' active' : '');
                div.dataset.idx = i; // Dodaj index dla tooltipa
                div.onclick = () => selectImage(i);
                const imgEl = document.createElement('img');
                imgEl.src = img.data;
                div.appendChild(imgEl);
                bar.appendChild(div);
            });
            // Dodaj eventy hover do każdej miniaturki
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.addEventListener('mouseenter', (e) => {
                    const idx = e.target.closest('.thumbnail').dataset.idx;
                    const image = app.images[idx];
                    const filePath = image.relativePath || ''; // Jeśli masz webkitRelativePath z inputu plików
                    const fileName = image.name || 'brak nazwy';
                    const fullInfo = `${filePath ? filePath + '/' : ''}${fileName}`;

                    let tooltip = document.getElementById('fileTooltip');
                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.id = 'fileTooltip';
                        tooltip.className = 'tooltip';
                        document.body.appendChild(tooltip);
                    }
                    tooltip.textContent = fullInfo;
                    tooltip.style.display = 'block';
                    tooltip.style.left = `${e.pageX + 10}px`;
                    tooltip.style.top = `${e.pageY + 10}px`;
                });

                thumb.addEventListener('mousemove', (e) => {
                    const tooltip = document.getElementById('fileTooltip');
                    if (tooltip) {
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY + 10}px`;
                    }
                });

                thumb.addEventListener('mouseleave', () => {
                    const tooltip = document.getElementById('fileTooltip');
                    if (tooltip) tooltip.style.display = 'none';
                });
            });
            updateImageCounter();
        }

        function updateImageCounter() {
            const counter = document.getElementById('imageCounter');
            if (!counter || !app.images.length) return;
            const current = app.currentImageIdx + 1;
            const total = app.images.length;
            counter.textContent = `${current}/${total} obrazów`;
        }

        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (Array.isArray(data)) {
                            app.imageActs = data;
                            saveStorage();
                            renderUI();
                            notify(`Zaimportowano ${data.length} aktów`, 'success');
                        }
                    } catch (err) {
                        notify(`Błąd importu: ${err.message}`, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function notify(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // ===== LOAD FROM SUPABASE =====
        async function loadFromSupabase() {
            const supabase = window.supabase_client;
            if (!supabase) {
                console.error('❌ Supabase nie jest zainicjalizowany');
                notify('❌ Supabase nie skonfigurowany', 'error');
                return;
            }
            
            try {
                notify('⏳ Ładowanie z Supabase...', 'info');
                
                // Licznik postępu
                let counter = document.getElementById('imageCounter');
                if (counter) counter.innerHTML = '⏳ Ładuję z Supabase...';
                
                // Ładuj z public_imports (nowe dane z importera) - z paginacją
                console.log('📥 Loading from public_imports (Supabase)...');
                
                // Najpierw znajdź całkowitą liczbę rekordów
                const { count: totalCount, error: countError } = await supabase
                    .from('public_imports')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    console.error('❌ Count error:', countError);
                    notify(`⚠️ ${countError.message}`, 'error');
                    return;
                }
                
                console.log(`📊 Total records in Supabase: ${totalCount}`);
                
                // Ładuj w batches po 1000 (offset-based pagination)
                let allData = [];
                const pageSize = 1000;
                
                for (let offset = 0; offset < totalCount; offset += pageSize) {
                    const { data, error } = await supabase
                        .from('public_imports')
                        .select('*')
                        .range(offset, offset + pageSize - 1);
                    
                    if (error) {
                        console.error(`❌ Błąd przy offset ${offset}:`, error);
                        break;
                    }
                    
                    if (data && data.length > 0) {
                        allData.push(...data);
                        console.log(`✅ Loaded batch ${offset}-${offset + data.length} (total: ${allData.length}/${totalCount})`);
                        
                        // Update licznik
                        if (counter) {
                            counter.innerHTML = `⏳ Ładuję ${allData.length}/${totalCount}...`;
                        }
                    } else {
                        break;
                    }
                }
                
                console.log(`📂 Załadowano łącznie: ${allData.length} records`);
                
                // FILTER: Tylko prawidłowe rekordy z original_id w formacie CH.LUB.BLIN.*
                let validData = allData.filter(r => r.original_id && r.original_id.startsWith('CH.LUB.BLIN.'));
                console.log(`✅ Prawidłowych rekordów: ${validData.length}/${allData.length}`);
                
                // DEDUPLICATE: Zostawić tylko PIERWSZY rekord dla każdego unique original_id
                const seenOriginalIds = new Set();
                const dedupedData = validData.filter(r => {
                    if (seenOriginalIds.has(r.original_id)) {
                        return false;  // Odrzuć duplikat
                    }
                    seenOriginalIds.add(r.original_id);
                    return true;  // Zachowaj pierwszy
                });
                
                if (dedupedData.length < validData.length) {
                    const removed = validData.length - dedupedData.length;
                    console.log(`🗑️ Usunięto ${removed} duplikatów - zostało ${dedupedData.length} unikalnych aktów`);
                }
                
                validData = dedupedData;  // Zastąp validData przefiltrowaną wersją
                
                if (validData.length === 0) {
                    notify('⚠️ Brak prawidłowych danych w Supabase', 'warning');
                    console.warn('Brak rekordów z original_id w formacie CH.LUB.BLIN.*');
                    return;
                }
                
                // SORT po original_id aby mieć prawidłowy porządek
                validData.sort((a, b) => {
                    const aId = a.original_id || '';
                    const bId = b.original_id || '';
                    return aId.localeCompare(bId, undefined, { numeric: true });
                });
                
                console.log('✅ Posortowano po original_id (format CH.LUB.BLIN.*)');
                
                // Loguj pierwsze 3 akty aby sprawdzić co się załadowało
                if (validData.length > 0) {
                    console.log('📍 Pierwsze 3 akty z bazy (po filtrowaniu):');
                    for (let i = 0; i < Math.min(3, validData.length); i++) {
                        const row = validData[i];
                        console.log(`  [${i}] original_id: ${row.original_id}, child: ${row.child_first_name || 'brak'}`);
                    }
                }
                
                const data = validData;  // Użyj przefiltrowanych i posortowanych danych
                const error = null;
                
                if (error) {
                    console.error('❌ Supabase error:', error);
                    notify(`⚠️ ${error.message}`, 'error');
                    return;
                }

                if (!data || data.length === 0) {
                    notify('⚠️ Brak danych w Supabase', 'warning');
                    console.warn('Brak rekordów w public_imports');
                    return;
                }

                // Przygotuj dane do załadowania - mapowanie FLAT STRUCTURE z Supabase na internal app format
                const imageActs = data.map((row, idx) => {
                    // Parsuj original_id aby wyciągnąć akt number
                    // Format: "CH.LUB.BLIN.1783.001" -> "CH.1783.No.1"
                    let actNum = `#${idx + 1}`;
                    if (row.original_id) {
                        const match = row.original_id.match(/CH\.LUB\.BLIN\.(\d+)\.(\d+)([a-z]?)$/i);
                        if (match) {
                            const year = match[1];
                            const num = parseInt(match[2], 10); // Usunięcie wiodących zer
                            const suffix = match[3] || ''; // Zachowanie sufixu (a, b, itd)
                            actNum = `CH.${year}.No.${num}${suffix}`; // Format: CH.1410.No.1000
                        }
                    }
                    
                    return {
                        id: row.id || row.original_id || `act_${idx}`,
                        original_id: row.original_id,
                        type: 'christening', // Wszystkie importowane to chrzty
                        source: row.source || 'Supabase',
                        imageIdx: 0,
                        actNum: actNum, // Przerobiony numer aktu
                        
                        // fieldValues object - MAPUJ pola z Supabase na nazwy które formularz oczekuje
                        fieldValues: {
                            // Podstawowe pola (rok, nr_aktu, data_zgłoszenia są parsowane z ID)
                            rok: row.christening_year || '',
                            nr_aktu: row.christening_act_number || '',
                            data_zgloszenia: row.christening_year + '.**.--.',  // Placeholder format
                            
                            // Dziecko
                            child_first_name: row.child_first_name || '',
                            child_last_name: row.child_last_name || '',
                            child_birth_date: row.child_birth_date || '',
                            
                            // Ojciec
                            father_first_name: row.father_first_name || '',
                            father_last_name: row.father_last_name || '',
                            father_age: row.father_age || '',
                            
                            // Matka
                            mother_first_name: row.mother_first_name || '',
                            mother_last_name: row.mother_last_name || '',
                            mother_maiden_name: row.mother_maiden_name || '',
                            mother_age: row.mother_age || '',
                            
                            // Osoba zgłaszająca i świadkowie
                            witnesses: row.witnesses || '',
                            
                            // Notatki
                            notes: row.notes || '',
                            notes_org: row.notes_org || '',
                            location: row.location || '',
                            
                            // Oryginalne pola Supabase (zachowaj też dla kompatybilności)
                            christening_year: row.christening_year || '',
                            christening_act_number: row.christening_act_number || ''
                        },
                        
                        // Flat fields too (dla wyświetlania)
                        christening_year: row.christening_year || '',
                        christening_act_number: row.christening_act_number || '',
                        child_first_name: row.child_first_name || '',
                        child_last_name: row.child_last_name || '',
                        child_birth_date: row.child_birth_date || '',
                        father_first_name: row.father_first_name || '',
                        father_last_name: row.father_last_name || '',
                        father_age: row.father_age || '',
                        mother_first_name: row.mother_first_name || '',
                        mother_last_name: row.mother_last_name || '',
                        mother_age: row.mother_age || '',
                        notes: row.notes || '',
                        notes_org: row.notes_org || '',
                        location: row.location || ''
                    };
                });

                // Załaduj do app
                app.imageActs = imageActs;
                console.log('📂 Loaded from Supabase:', imageActs.length, 'records');
                
                // Aktualizuj licznik w toolbar
                counter = document.getElementById('imageCounter');
                if (counter) {
                    counter.innerHTML = `📊 <strong>${imageActs.length} aktów</strong> / 6040 (${Math.round(imageActs.length/6040*100)}%)`;
                    counter.style.color = imageActs.length === 6040 ? '#0f0' : (imageActs.length > 5000 ? '#ff0' : '#f00');
                }
                
                updateThumbs();
                renderRecordsTable(); // Wyświetl dane w tabeli
                if (app.images.length > 0) selectImage(0, true);
                
                notify(`✅ Załadowano ${imageActs.length} aktów z Supabase (BEZ LIMITÓW!)`, 'success');
                
            } catch (error) {
                console.error('❌ Error loading from Supabase:', error);
                notify(`❌ Błąd: ${error.message}`, 'error');
            }
        }

        // Stara funkcja - dla kompatybilności
        async function loadFromFirestore() {
            return loadFromSupabase();
        }

        // Funkcja migracji danych - nieużywana (baza na dysku)
        async function exportFromLocalStorageToSupabase() {

            const user = firebase.auth().currentUser;
            if (!user) {
                console.error('❌ Użytkownik nie jest zalogowany');
                notify('❌ Musisz się zalogować, aby zapisywać do Firebase', 'error');
                return;
            }

            const stored = localStorage.getItem('genealog_data');
            if (!stored) {
                console.log('ℹ️ Brak danych w localStorage do migracji');
                notify('ℹ️ Brak danych do zapisania', 'info');
                return;
            }
            const data = JSON.parse(stored);
            try {
                notify('⏳ Zapisywanie do Firestore...', 'info');
                console.log('🔄 Migruję dane do Firestore dla użytkownika:', user.email);
                // Migruj imageActs
                for (const act of data.imageActs || []) {
                    await db.collection('records').add(act);
                }
                // Migruj ustawienia
                await db.collection('settings').doc('currentTemplate').set({ value: data.currentTemplate || 'birth' });
                console.log('✅ Migracja do Firestore zakończona');
                notify('✅ Dane zmigrowane do Firestore', 'success');
            } catch (error) {
                console.error('❌ Błąd migracji:', error);
                notify('❌ Błąd migracji do Firestore', 'error');
            }
        }

        function saveStorage() {
            // Zapisuj tylko bieżący act do Supabase zamiast całego localStorage
            console.log('💾 saveStorage() called, currentActNum:', app.currentActNum);
            const currentAct = app.imageActs.find(a => a.actNum === app.currentActNum);
            console.log('💾 currentAct found:', !!currentAct);
            if (!currentAct) {
                console.warn('⚠️ Nie znaleziono bieżącego aktu');
                return;
            }
            
            // Jeśli mamy Supabase, zapisz tam
            const supabase = window.supabase_client;
            console.log('💾 supabase:', !!supabase, 'currentAct.id:', currentAct.id);
            if (supabase && currentAct.id) {
                const supabaseId = currentAct.id;
                const fieldValues = currentAct.fieldValues || {};
                
                // Mapowanie z powrotem do Supabase column names
                // Ważne: fieldValues zawiera POLSKIE klucze (dziecko_imie, ojciec_nazwisko, itp.)
                const supabaseData = {
                    christening_year: fieldValues.rok,
                    christening_act_number: fieldValues.nr_aktu,
                    book_number: fieldValues.ksiega_nr,
                    page_number: fieldValues.strona_nr,
                    parish: fieldValues.parafia,
                    christening_date: fieldValues.data_chrztu,
                    report_date: fieldValues.data_zgloszenia,
                    child_first_name: fieldValues.dziecko_imie,
                    child_last_name: fieldValues.dziecko_nazwisko,
                    child_birth_date: fieldValues.dziecko_data_ur,
                    child_gender: fieldValues.dziecko_plec,
                    child_legitimacy_status: fieldValues.dziecko_status,
                    father_first_name: fieldValues.ojciec_imie,
                    father_last_name: fieldValues.ojciec_nazwisko,
                    father_age: fieldValues.ojciec_wiek,
                    father_occupation: fieldValues.ojciec_zawod,
                    father_civil_status: fieldValues.ojciec_stan_cywilny,
                    mother_first_name: fieldValues.matka_imie,
                    mother_last_name: fieldValues.matka_nazwisko,
                    mother_maiden_name: fieldValues.matka_panienskie,
                    mother_age: fieldValues.matka_lata,
                    mother_occupation: fieldValues.matka_zawod,
                    mother_civil_status: fieldValues.matka_stan_cywilny,
                    location: fieldValues.matka_miejsce,
                    godfather_first_name: fieldValues.ojciec_chrzestny_imie,
                    godfather_last_name: fieldValues.ojciec_chrzestny_nazwisko,
                    godfather_place: fieldValues.ojciec_chrzestny_miejsce,
                    godmother_first_name: fieldValues.matka_chrzestna_imie,
                    godmother_last_name: fieldValues.matka_chrzestna_nazwisko,
                    godmother_place: fieldValues.matka_chrzestna_miejsce,
                    priest_first_name: fieldValues.ksiadz_imie,
                    priest_last_name: fieldValues.ksiadz_nazwisko,
                    priest_occupation: fieldValues.ksiadz_zawod,
                    reporting_person_first_name: fieldValues.zglaszajacy_imie,
                    reporting_person_last_name: fieldValues.zglaszajacy_nazwisko,
                    reporting_person_occupation: fieldValues.zglaszajacy_zawod,
                    reporting_person_age: fieldValues.zglaszajacy_wiek,
                    reporting_person_place: fieldValues.zglaszajacy_miejsce,
                    witness_1_first_name: fieldValues.swiadek_1_imie,
                    witness_1_last_name: fieldValues.swiadek_1_nazwisko,
                    witness_1_occupation: fieldValues.swiadek_1_zawod,
                    witness_1_place: fieldValues.swiadek_1_miejsce,
                    witness_2_first_name: fieldValues.swiadek_2_imie,
                    witness_2_last_name: fieldValues.swiadek_2_nazwisko,
                    witness_2_occupation: fieldValues.swiadek_2_zawod,
                    witness_2_place: fieldValues.swiadek_2_miejsce,
                    witness_3_first_name: fieldValues.swiadek_3_imie,
                    witness_3_last_name: fieldValues.swiadek_3_nazwisko,
                    witness_3_occupation: fieldValues.swiadek_3_zawod,
                    witness_3_place: fieldValues.swiadek_3_miejsce,
                    witnesses: fieldValues.swiadkowie,
                    notes: fieldValues.custom_note
                };
                
                console.log('💾 Wysyłam do Supabase:', JSON.stringify(supabaseData));
                supabase.from('public_imports').update(supabaseData).eq('id', supabaseId).select().then(({ data, error }) => {
                    if (error) {
                        console.error('❌ Błąd zapisu do Supabase:', error.message);
                        console.error('❌ Szczegóły:', error);
                    } else {
                        console.log('✅ Zapisano do Supabase:', supabaseId, 'data:', data);
                        // WAŻNE: Przeładuj fieldValues z nowych danych od Supabase
                        if (data && data.length > 0) {
                            const updatedRow = data[0];
                            currentAct.fieldValues = { ...updatedRow };
                            console.log('🔄 Przeładowałem fieldValues z Supabase:', currentAct.fieldValues);
                        }
                    }
                }).catch(err => {
                    console.error('❌ CATCH error:', err);
                });
            }
        }

        async function loadStorage() {
            // Ładuj z Supabase
            console.log('🔄 Loading storage from Supabase...');
            app.imageActs = []; // Clear old data FIRST
            await loadFromSupabase(); // Ładuj wszystkie akty
            updateThumbs();
            renderRecordsTable(); // Wyświetl dane w tabeli
            if (app.images.length > 0) selectImage(0, true);
        }
        
        function toggleFloatingForm(show = null) {
            const form = document.getElementById('floatingForm');
            const current = form.classList.contains('visible');
            const target = show === null ? !current : show;
            
            if (target) {
                form.classList.add('visible');
                document.getElementById('floatingActNum').textContent = app.currentActNum || '?';
                renderFloatingForm();
                positionFloatingFormNearAct();
            } else {
                form.classList.remove('visible');
            }
        }
        function renderFloatingForm() {
            const container = document.getElementById('floatingFormContent');
            if (!container) {
                console.warn('❌ floatingFormContent not found in DOM');
                return;
            }
            container.innerHTML = '';

            const act = getCurrentAct();
            if (!act) {
                container.innerHTML = '<p>Brak wybranego aktu</p>';
                return;
            }
            
            console.log('📋 renderFloatingForm - act:', act);
            console.log('📋 act.type:', act.type);
            console.log('📋 app.templates:', app.templates ? app.templates.map(t => t.id) : 'UNDEFINED');

            // ===== SELECTOR TYPU AKTU – DROPDOWN W HEADERZE =====
            const header = document.createElement('div');
            header.style.cssText = 'padding: 12px; background: #252525; border-bottom: 1px solid #3a3a3a; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center; gap: 12px;';
            
            const titleSpan = document.createElement('span');
            // Pokaż skrót do indeksacji (CH.1783.No.1) z pełnym ID w tooltip
            titleSpan.textContent = 'Akt: ' + act.actNum + ' (' + (act.original_id || act.id) + ')';
            titleSpan.style.cssText = 'color: #0078d4; font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
            titleSpan.title = 'ID źródłowe: ' + (act.original_id || act.id);
            
            const typeSelect = document.createElement('select');
            typeSelect.style.cssText = 'padding: 4px 6px; background: #1a1a1a; border: 1px solid #0078d4; color: #ddd; border-radius: 3px; font-size: 11px; flex: 1;';
            typeSelect.innerHTML = app.templates.map(t => 
                `<option value="${t.id}" ${t.id === act.type ? 'selected' : ''}>${t.name}</option>`
            ).join('');
            
            typeSelect.addEventListener('change', (e) => {
                console.log('✅ Select change event - new type:', e.target.value);
                act.type = e.target.value;
                saveStorage();
                renderFloatingForm();
            });
            
            header.appendChild(titleSpan);
            header.appendChild(typeSelect);
            container.appendChild(header);

            // ===== ŁADUJEMY SZABLON DLA AKTUALNEGO TYPU =====
            const template = app.templates.find(t => t.id === act.type);
            if (!template) {
                console.error('❌ Template not found for type:', act.type);
                console.error('Available templates:', app.templates.map(t => t.id));
                container.innerHTML += '<p style="color: #888;">Brak szablonu dla tego typu: ' + act.type + '</p>';
                return;
            }
            console.log('✅ Template loaded:', template.name);

            // ===== RENDERUJ SEKCJE I POLA =====
            template.sections.forEach(sec => {
                const secDiv = document.createElement('div');
                secDiv.style.marginBottom = '12px';
                
                const secTitle = document.createElement('div');
                secTitle.innerHTML = sec.title || sec.id;
                secTitle.style.cssText = 'color: #0078d4; font-weight: 600; font-size: 11px; margin-bottom: 6px; border-bottom: 1px solid #2a2a2a; padding-bottom: 4px;';
                secDiv.appendChild(secTitle);

                sec.fields.forEach(f => {
                    // Filtrujemy pola – jeśli mają applicableTypes, sprawdzamy czy pasują
                    if (f.applicableTypes && !f.applicableTypes.includes(act.type)) {
                        return;  // Pomiń pole jeśli nie pasuje do typu
                    }

                    const group = document.createElement('div');
                    group.className = 'form-group';
                    group.style.marginBottom = '8px';
                    
                    const label = document.createElement('label');
                    label.textContent = f.label;
                    label.style.cssText = 'display: block; font-size: 10px; color: #888; margin-bottom: 3px;';
                    group.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = f.type || 'text';
                    input.className = 'field-input';
                    input.dataset.field = f.id;
                    input.placeholder = f.label;
                    input.value = act.fieldValues[f.id] || '';
                    input.style.cssText = 'width: 100%; padding: 5px; background: #0f0f0f; border: 1px solid #3a3a3a; color: #ddd; border-radius: 3px; font-size: 11px;';
                    
                    if (act.fieldROIs && act.fieldROIs[f.id]) {
                        input.classList.add('has-roi');
                        input.style.borderLeft = '4px solid #10b981';
                    }
                    
                    input.addEventListener('input', (e) => {
                        act.fieldValues[f.id] = e.target.value;
                        updateCurrentRowInTable(); // Aktualizuj tabelę na żywo
                        saveStorage();
                    });
                    
                    // Enter zatwierdza edycję i cofa focus
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            input.blur();
                        }
                    });
                    
                    group.appendChild(input);
                    secDiv.appendChild(group);
                });

                container.appendChild(secDiv);
            });

            // ===== PRZYCISK "DODAJ NIESTANDARDOWE POLE" =====
            const addFieldDiv = document.createElement('div');
            addFieldDiv.style.marginTop = '12px';
            addFieldDiv.style.paddingTop = '12px';
            addFieldDiv.style.borderTop = '1px solid #2a2a2a';

            const addBtn = document.createElement('button');
            addBtn.textContent = '+ Dodaj pole';
            addBtn.style.cssText = 'background: #252525; border: 1px solid #3a3a3a; color: #ddd; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 10px; width: 100%;';
            
            addBtn.addEventListener('click', () => {
                const fieldId = prompt('ID pola (np. custom_note):');
                if (!fieldId) return;
                
                const fieldLabel = prompt('Nazwa pola:', fieldId);
                if (!fieldLabel) return;
                
                // Dodaj pole do aktualnego aktu
                if (!act.fieldValues) act.fieldValues = {};
                act.fieldValues[fieldId] = '';
                
                saveStorage();
                renderFloatingForm();  // Odśwież z nowym polem
            });

            addFieldDiv.appendChild(addBtn);
            container.appendChild(addFieldDiv);

            // Focus na pierwsze pole
            container.querySelector('.field-input')?.focus();
        }
        function positionFloatingFormNearAct() {
            const form = document.getElementById('floatingForm');
            const act = getCurrentAct();
            if (!act?.actROI || !app.viewer) {
                form.style.top = '50px';
                form.style.left = '50px';
                return;
            }
            
            const item = app.viewer.world.getItemAt(0);
            if (!item) return;
            
            try {
                const size = item.getContentSize();
                const centerX = (act.actROI.x + act.actROI.w / 2) * size.x;
                const centerY = (act.actROI.y + act.actROI.h / 2) * size.y;
                
                const point = item.imageToViewportCoordinates(centerX, centerY);
                const pixel = app.viewer.viewport.viewportToViewerElementCoordinates(point);
                
                form.style.top = `${Math.max(20, pixel.y - 200)}px`;
                form.style.left = `${Math.max(20, pixel.x + 20)}px`;
            } catch (err) {
                // Fallback do domyślnej pozycji
                form.style.top = '50px';
                form.style.left = '50px';
            }
        }
        
        function createPinupForField(fieldId) {
            const act = getCurrentAct();
            if (!act?.fieldROIs || !act.fieldROIs[fieldId]) return;

            const roi = act.fieldROIs[fieldId];
            const item = app.viewer.world.getItemAt(0);
            if (!item) return;

            try {
                const size = item.getContentSize();
                // Środek dolnej krawędzi ROI – najlepsze miejsce na pin-up
                const centerX = (roi.x + roi.w / 2) * size.x;
                const bottomY = (roi.y + roi.h) * size.y;

                const point = item.imageToViewportCoordinates(centerX, bottomY);
                const pixel = app.viewer.viewport.viewportToViewerElementCoordinates(point);

                // Szukaj labela pola - normalizuj fieldId (zamień kropki na podkreślenia)
                const normalizedFieldId = fieldId.replace(/\./g, '_');
                let fieldLabel = null;
                
                // Szukaj w bieżącym szablonie
                const template = app.templates.find(t => t.id === app.currentTemplate);
                if (template) {
                    for (let sec of template.sections) {
                        const f = sec.fields.find(fld => fld.id === normalizedFieldId);
                        if (f) { fieldLabel = f.label; break; }
                    }
                }
                
                // Jeśli nie znaleziono, szukaj we wszystkich szablonach
                if (!fieldLabel) {
                    for (let tpl of app.templates) {
                        for (let sec of tpl.sections) {
                            const f = sec.fields.find(fld => fld.id === normalizedFieldId);
                            if (f) { fieldLabel = f.label; break; }
                        }
                        if (fieldLabel) break;
                    }
                }
                
                // Fallback - pokaż normalizedFieldId jeśli nie znaleziono labela
                if (!fieldLabel) {
                    fieldLabel = normalizedFieldId;
                }
                
                // Pobierz nazwę aktu
                const actDisplayName = formatActDisplayName(act);

                const container = document.getElementById('fieldPinupsContainer');
                let pinup = container.querySelector(`[data-field="${fieldId}"]`);
                
                if (pinup) {
                    // Jeśli już istnieje – tylko przesuń i zaznacz
                    pinup.style.top = `${pixel.y + 15}px`;
                    pinup.style.left = `${Math.max(10, pixel.x - 130)}px`;
                    pinup.querySelector('input').focus();
                    pinup.querySelector('input').select();
                    return;
                }

                pinup = document.createElement('div');
                pinup.className = 'field-pinup';
                pinup.dataset.field = fieldId;

                // Pozycjonowanie: pod ROI, wyśrodkowany
                pinup.style.top = `${pixel.y + 15}px`;
                pinup.style.left = `${Math.max(10, pixel.x - 130)}px`;

                pinup.innerHTML = `
                    <div class="field-pinup-header" style="background: #0078d4; color: white; padding: 6px 8px; border-radius: 3px 3px 0 0; font-weight: bold; font-size: 12px; margin-bottom: 4px;">
                        ${actDisplayName}
                    </div>
                    <div style="padding: 4px 6px; background: #1a1a1a; border-bottom: 1px solid #3a3a3a; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #aaa; font-size: 10px;">${fieldLabel}</span>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <button class="ocr-btn" title="OCR – spróbuj odczytać tekst z ROI" 
                                    onclick="runOCRForPinup(this.closest('.field-pinup'))"
                                    style="padding: 2px 4px; font-size: 10px;">
                                <i class="fas fa-wand-magic-sparkles"></i>
                            </button>
                            <button class="field-pinup-close" onclick="this.closest('.field-pinup').remove()" style="padding: 0 2px;">&times;</button>
                        </div>
                    </div>
                    <input type="text" 
                           value="${(act.fieldValues[fieldId] || '').replace(/"/g, '&quot;')}" 
                           placeholder="${fieldLabel}"
                           data-field="${fieldId}"
                           style="width: 100%; padding: 4px; background: #1a1a1a; color: #ddd; border: 1px solid #3a3a3a; border-radius: 2px; font-size: 11px;"
                           ${act.fieldROIs[fieldId] ? 'class="has-roi"' : ''}>
                    <div class="ocr-suggestions" style="margin-top:6px; font-size:11px; color:#aaa; display:none;"></div>
                `;

                makeElementDraggable(pinup);

                const input = pinup.querySelector('input');
                input.addEventListener('blur', (e) => {
                    act.fieldValues[fieldId] = e.target.value.trim();
                    updateCurrentRowInTable(); // Aktualizuj tabelę na żywo
                    saveStorage();

                    // Aktualizuj pole w prawym panelu i floating form
                    document.querySelectorAll(`.field-input[data-field="${fieldId}"]`).forEach(inp => {
                        inp.value = e.target.value;
                    });
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur(); // Blur zamiast notify
                    }
                });

                container.appendChild(pinup);
                input.focus();
                input.select(); // zaznacz całą treść
            } catch (err) {
                console.error('Błąd pin-up:', err);
            }
        }
        
        function makeElementDraggable(element) {
            let offsetX = 0, offsetY = 0;
            
            element.addEventListener('mousedown', (e) => {
                // Nie przeciągaj jeśli klikasz na input
                if (e.target.tagName === 'INPUT') return;
                
                offsetX = e.clientX - element.offsetLeft;
                offsetY = e.clientY - element.offsetTop;
                
                const moveFn = (moveEvent) => {
                    element.style.left = `${moveEvent.clientX - offsetX}px`;
                    element.style.top = `${moveEvent.clientY - offsetY}px`;
                };
                
                const upFn = () => {
                    document.removeEventListener('mousemove', moveFn);
                    document.removeEventListener('mouseup', upFn);
                };
                
                document.addEventListener('mousemove', moveFn);
                document.addEventListener('mouseup', upFn);
            });
        }
        
        function clearPinups() {
            const container = document.getElementById('fieldPinupsContainer');
            container.innerHTML = '';
        }
        
        function startWizard() {
            if (!app.currentActNum || app.wizardActive) return;

            const template = app.templates.find(t => t.id === app.currentTemplate);
            if (!template) return;

            // Zbierz wszystkie pola z szablonu
            app.wizardFields = template.sections.flatMap(sec => sec.fields);
            app.wizardCurrentFieldIdx = 0;
            app.wizardActive = true;

            // Pokaż progress bar
            const progress = document.getElementById('wizardProgress');
            progress.classList.add('visible');
            document.getElementById('wizardTotal').textContent = app.wizardFields.length;

            clearPinups();
            processNextField();
        }
        
        function processNextField() {
            if (app.wizardCurrentFieldIdx >= app.wizardFields.length) {
                endWizard();
                return;
            }

            const field = app.wizardFields[app.wizardCurrentFieldIdx];
            app.activeField = { dataset: { field: field.id } };

            // Włącz tryb ROI jeśli wyłączony
            if (!app.roiMode) toggleROI();

            // Pokaż prompt
            const prompt = document.getElementById('wizardPrompt');
            document.getElementById('wizardMessage').textContent = `Zaznacz ROI dla: ${field.label}`;
            prompt.classList.add('visible');

            // Aktualizuj progress
            document.getElementById('wizardStep').textContent = app.wizardCurrentFieldIdx + 1;
            const progress = (app.wizardCurrentFieldIdx + 1) / app.wizardFields.length * 100;
            document.getElementById('wizardProgressFill').style.width = `${progress}%`;

            // Czekaj na zaznaczenie ROI - użyj addEventListener zamiast nadpisywania onmouseup
            const waitForROI = (e) => {
                if (app.drawingROI) return; // jeszcze rysuje

                const act = getCurrentAct();
                if (!act || !act.fieldROIs || !act.fieldROIs[field.id]) return;

                // Usuń listener - już mamy ROI
                app.drawingCanvas.removeEventListener('mouseup', waitForROI);

                prompt.classList.remove('visible');

                // Otwórz pin-up do wpisania danych
                setTimeout(() => {
                    createPinupForField(field.id);
                    
                    const pinupInput = document.querySelector(`.field-pinup[data-field="${field.id}"] input`);
                    if (pinupInput) {
                        // Przejdź do następnego pola po blur (opuszczeniu input)
                        pinupInput.addEventListener('blur', () => {
                            app.wizardCurrentFieldIdx++;
                            processNextField();
                        }, { once: true });
                    }
                }, 100);
            };

            // Dodaj listener dla tego pola
            app.drawingCanvas.addEventListener('mouseup', waitForROI);
        }
        
        function skipCurrentField() {
            document.getElementById('wizardPrompt').classList.remove('visible');
            app.wizardCurrentFieldIdx++;
            processNextField();
            notify('Pole pominięte', 'info');
        }

        function endWizard() {
            app.wizardActive = false;
            
            // Wyłącz ROI i progress bar
            if (app.roiMode) toggleROI();
            document.getElementById('wizardPrompt').classList.remove('visible');
            document.getElementById('wizardProgress').classList.remove('visible');
            
            saveRecord();
            notify(`Wizard zakończony – ${app.wizardFields.length} pól zindeksowane!`, 'success');
        }
        
        function showAllPinups() {
            const act = getCurrentAct();
            if (!act?.fieldROIs || Object.keys(act.fieldROIs).length === 0) {
                notify('Brak pól z ROI', 'error');
                return;
            }

            clearPinups();
            Object.keys(act.fieldROIs).forEach(fieldId => {
                createPinupForField(fieldId);
            });
            notify(`Otworzono ${Object.keys(act.fieldROIs).length} pin-upów`, 'success');
        }

        async function runOCRForPinup(pinupEl) {
            const fieldId = pinupEl.dataset.field;
            const act = getCurrentAct();
            if (!act || !act.fieldROIs || !act.fieldROIs[fieldId]) {
                notify('Brak ROI dla tego pola', 'error');
                return;
            }

            const btn = pinupEl.querySelector('.ocr-btn');
            const suggestionsDiv = pinupEl.querySelector('.ocr-suggestions');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            suggestionsDiv.style.display = 'none';
            suggestionsDiv.innerHTML = '';

            try {
                // Ładujemy Tesseract tylko przy pierwszym użyciu
                if (!window.tesseractWorker) {
                    notify('Ładuję moduł OCR (tylko raz)...', 'info');
                    const { createWorker } = Tesseract;
                    const worker = await createWorker({
                        workerPath: 'https://unpkg.com/tesseract.js@5.1.0/dist/worker.min.js',
                        corePath: 'https://unpkg.com/tesseract.js-core@5.1.0/tesseract-core.wasm.js',
                        langPath: 'https://tessdata.projectnaptha.com/4.0.0_best',
                        logger: m => console.log('🔍 OCR:', m.progress)
                    });
                    await worker.load();
                    await worker.loadLanguage('pol+eng');
                    await worker.initialize('pol+eng');
                    window.tesseractWorker = worker;
                    notify('OCR gotowy!', 'success');
                }

                // Pobieramy fragment obrazu z ROI
                const roi = act.fieldROIs[fieldId];
                const item = app.viewer.world.getItemAt(0);
                if (!item) throw new Error('Brak obrazu');

                const canvas = document.createElement('canvas');
                const size = item.getContentSize();
                canvas.width = roi.w * size.x;
                canvas.height = roi.h * size.y;

                const ctx = canvas.getContext('2d');
                const imageObj = new Image();
                imageObj.src = app.images[app.currentImageIdx].data;
                imageObj.crossOrigin = 'anonymous';

                await new Promise(resolve => { imageObj.onload = resolve; });

                ctx.drawImage(
                    imageObj,
                    roi.x * size.x, roi.y * size.y,
                    roi.w * size.x, roi.h * size.y,
                    0, 0, canvas.width, canvas.height
                );

                // OCR
                const { data: { text, confidence } } = await window.tesseractWorker.recognize(canvas);
                const cleanedText = text.trim().replace(/\s+/g, ' ');

                if (cleanedText && confidence > 30) {
                    suggestionsDiv.style.display = 'block';
                    suggestionsDiv.innerHTML = `
                        <div style="margin-bottom:4px; color:#10b981; font-weight:bold;">OCR (${Math.round(confidence)}%): <span>${cleanedText}</span></div>
                        <button style="font-size:10px; padding:3px 8px; margin-right:4px; background:#10b981; color:white; border:none; border-radius:3px; cursor:pointer;" 
                                onclick="applyOCRToField('${fieldId}', '${cleanedText.replace(/'/g, "\\'")}')">\u2713 Użyj</button>
                        <button style="font-size:10px; padding:3px 8px; background:#3a3a3a; color:#ddd; border:none; border-radius:3px; cursor:pointer;" 
                                onclick="this.parentElement.style.display='none'">\u2715 Zamknij</button>
                    `;
                } else {
                    suggestionsDiv.style.display = 'block';
                    suggestionsDiv.innerHTML = '<div style="color:#c42b1c;">\u26a0 OCR nie rozpoznał tekstu (za niskie zaufanie)</div>';
                }

            } catch (err) {
                console.error('OCR Error:', err);
                notify('Błąd OCR: ' + err.message, 'error');
                suggestionsDiv.innerHTML = '<div style="color:#c42b1c;">❌ Błąd OCR</div>';
                suggestionsDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i>';
            }
        }

        function applyOCRToField(fieldId, text) {
            const act = getCurrentAct();
            if (!act) return;

            act.fieldValues[fieldId] = text;
            saveStorage();

            // Aktualizuj wszystkie inputy i pin-upy
            document.querySelectorAll(`.field-input[data-field="${fieldId}"], .field-pinup[data-field="${fieldId}"] input`).forEach(inp => {
                inp.value = text;
            });

            const suggestionsDiv = document.querySelector(`.field-pinup[data-field="${fieldId}"] .ocr-suggestions`);
            if (suggestionsDiv) suggestionsDiv.style.display = 'none';

            notify('\u2713 OCR zastosowany', 'success');
        }
        
        // ===== POSTPROCESSING PANEL FUNCTIONS =====
        function togglePostprocessPanel() {
            console.log('🎨 togglePostprocessPanel called');
            const panel = document.getElementById('postprocessPanel');
            panel.classList.toggle('visible');
            console.log('🎨 Panel visibility:', panel.classList.contains('visible'));
        }
        
        function toggleThumbsPanel() {
            const thumbsBar = document.getElementById('thumbsBar');
            const mainContent = document.querySelector('.main-content');
            thumbsBar.classList.toggle('collapsed');
            mainContent.classList.toggle('thumbs-collapsed');
        }
        
        function toggleActsPanel() {
            const actsPanel = document.getElementById('actsPanel');
            actsPanel.classList.toggle('collapsed');
        }
        
        function formatActDisplayName(act) {
            // Parse ID like "CH.LUB.BLIN.1908.05.00060.00" to "CH.1908.N͞o.01"
            console.log('🎯 formatActDisplayName:', { actNum: act.actNum, id: act.id, imageIdx: act.imageIdx });
            if (!act.id) {
                console.warn('❌ No ID for act', act.actNum, '- using fallback');
                return `Akt ${act.actNum}`;
            }
            
            const parts = act.id.split('.');
            console.log('🎯 Parsing act ID:', act.id, 'parts:', parts);
            if (parts.length >= 6) {
                const typ = parts[0]; // CH, UR, MZ, ZG
                const rok = parts[3]; // 1908
                const nr = parts[5].replace(/^0+/, '') || '1'; // Remove leading zeros, default to 1
                const formatted = `${typ}.${rok}.N͞o.${nr.padStart(2, '0')}`;
                console.log('🎯 Formatted display name:', formatted);
                return formatted;
            }
            console.warn('❌ Invalid ID format:', act.id, 'parts.length:', parts.length);
            return `Akt ${act.actNum}`;
        }
        
        function renderActsList() {
            const actsList = document.getElementById('actsList');
            if (!actsList) return;
            
            actsList.innerHTML = '';
            
            // Grupuj wszystkie akty po imageIdx
            const groupedByImage = {};
            app.imageActs.forEach(act => {
                if (!groupedByImage[act.imageIdx]) {
                    groupedByImage[act.imageIdx] = [];
                }
                groupedByImage[act.imageIdx].push(act);
            });
            
            console.log('🎯 renderActsList: rendering all acts grouped by image', Object.keys(groupedByImage).length, 'images');
            
            // Sortuj imageIdx i iteruj po nich
            const sortedImageIndices = Object.keys(groupedByImage).map(Number).sort((a, b) => a - b);
            
            sortedImageIndices.forEach((imageIdx, groupIndex) => {
                const acts = groupedByImage[imageIdx];
                
                // ===== HEADER OBRAZU (lewe okno - lista aktów) =====
                // Nagłówek wyświetla nazwę pliku obrazu np. "8098.jpg"
                // Lewy klik: otwiera cały obraz
                // Prawy klik: menu kontekstowe do operacji na całym obrazie (usuń wszystkie akty, usuń ROI itp.)
                const header = document.createElement('div');
                header.className = 'acts-group-header';
                const imageName = app.images[imageIdx]?.name || `Obraz ${imageIdx + 1}`;
                header.textContent = imageName;
                header.style.cssText = `
                    padding: 8px 6px;
                    font-size: 11px;
                    font-weight: 600;
                    color: #aaa;
                    background: ${groupIndex % 2 === 0 ? '#1a1a1a' : '#0f0f0f'};
                    border-bottom: 1px solid #3a3a3a;
                    margin-top: ${groupIndex > 0 ? '4px' : '0'};
                    cursor: pointer;
                `;
                
                // Lewy klik na header - pokaż cały obraz
                header.onclick = () => selectImage(imageIdx);
                header.title = `Lewy klik: otwórz obraz\nPrawy klik: menu dla całego obrazu`;
                
                // Prawy klik - menu kontekstowe dla całego obrazu
                header.oncontextmenu = (e) => {
                    e.preventDefault();
                    showImageHeaderContextMenu(imageIdx, e, header);
                };
                
                actsList.appendChild(header);
                
                // ===== PRZYCISKI AKTÓW (poniżej headera) =====
                // Każdy przycisk reprezentuje jeden akt w danym obrazie
                // Lewy klik: wybierz akt i otwórz go (jeśli inny obraz - przełącz obraz)
                // Prawy klik: menu kontekstowe dla konkretnego aktu (zmień nazwę, usuń granice, usuń akt itp.)
                acts.forEach(act => {
                    const btn = document.createElement('button');
                    btn.className = 'act-button' + (app.currentActNum === act.actNum ? ' active' : '');
                    
                    // Main display name
                    const displayName = formatActDisplayName(act);
                    btn.textContent = displayName;
                    
                    // Show full ID on hover or when active
                    btn.title = act.id || `Akt ${act.actNum}`;
                    
                    // Lewy klik - wybierz akt (jeśli jest z innego obrazu, przełącz obraz)
                    btn.onclick = () => {
                        if (app.currentImageIdx !== imageIdx) {
                            selectImage(imageIdx);
                        }
                        selectAct(act.actNum);
                    };
                    
                    // Prawy klik - kontekstowe menu
                    btn.oncontextmenu = (e) => {
                        e.preventDefault();
                        showActContextMenuPanel(act.actNum, e, btn);
                    };
                    
                    actsList.appendChild(btn);
                });
            });
        }
        
        function showImageHeaderContextMenu(imageIdx, event, headerElement) {
            // Menu kontekstowe dla headera obrazu (np. "8098.jpg")
            // Opcje: Usuń wszystkie akty na obrazie, Usuń wszystkie ROI na obrazie
            const menu = document.createElement('div');
            menu.id = 'imageHeaderContextMenu';
            menu.style.cssText = `
                position: fixed;
                top: ${event.pageY}px;
                left: ${event.pageX}px;
                background: #2a2a2a;
                border: 1px solid #10b981;
                border-radius: 4px;
                padding: 4px 0;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                min-width: 200px;
            `;

            const options = [
                { label: 'Usuń wszystkie akty na obrazie', action: () => deleteAllActsOnImageFromPanel(imageIdx), color: '#ff6b6b' },
                { label: 'Usuń wszystkie ROI na obrazie', action: () => deleteAllROIsOnImageFromPanel(imageIdx), color: '#ff9800' }
            ];

            options.forEach(opt => {
                const item = document.createElement('div');
                item.textContent = opt.label;
                item.style.cssText = `
                    padding: 8px 12px;
                    cursor: pointer;
                    color: ${opt.color};
                    font-size: 12px;
                    transition: background 0.15s;
                    border-bottom: 1px solid #1a1a1a;
                `;
                item.onmouseover = () => item.style.background = 'rgba(255,107,107,0.1)';
                item.onmouseout = () => item.style.background = 'transparent';
                item.onclick = () => {
                    opt.action();
                    menu.remove();
                };
                menu.appendChild(item);
            });

            document.body.appendChild(menu);

            // Zamknij menu przy kliknięciu poza
            const closeMenu = (e) => {
                if (!menu.contains(e.target) && e.target !== headerElement) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 10);
        }

        function deleteAllActsOnImageFromPanel(imageIdx) {
            if (!confirm('Czy na pewno usunąć WSZYSTKIE akty na tym obrazie?')) return;
            app.imageActs = app.imageActs.filter(a => a.imageIdx !== imageIdx);
            renderActsList();
            redrawROIs();
            saveStorage();
            notify('Wszystkie akty na obrazie usunięte', 'success');
        }

        function deleteAllROIsOnImageFromPanel(imageIdx) {
            const acts = app.imageActs.filter(act => act.imageIdx === imageIdx);
            acts.forEach(act => {
                act.actROI = null;
                act.fieldROIs = {};
            });
            redrawROIs();
            saveStorage();
            notify('Wszystkie ROI na obrazie usunięte', 'success');
        }
        
        function updateCurrentRowInTable() {
            // Aktualizuj tylko bieżący wiersz w tabeli (szybkie, bez re-rendu całej tabeli)
            const currentAct = app.imageActs.find(a => a.actNum === app.currentActNum);
            if (!currentAct) return;
            
            const tableBody = document.getElementById('dataTableBody');
            if (!tableBody) return;
            
            // Szukaj wiersza dla bieżącego aktu po rowIndex (atrybut data-act-num)
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const currentRow = rows.find(row => row.dataset.actNum === currentAct.actNum);
            
            if (!currentRow) return; // Wiersz nie znaleziony
            
            // Aktualizuj poszczególne komórki bez re-rendu całego DOM
            const cells = currentRow.querySelectorAll('td');
            if (cells.length < 4) return;
            
            // Kolumna 0: checkbox (skippujem)
            // Kolumna 1: ID źródłowe
            cells[1].textContent = currentAct.original_id || '';
            
            // Kolumna 2: Księga (nr)
            cells[2].textContent = currentAct.fieldValues?.ksiega_nr || currentAct.fieldValues?.book_number || '';
            
            // Kolumna 3: Strona (nr)
            cells[3].textContent = currentAct.fieldValues?.strona_nr || currentAct.fieldValues?.page_number || '';
            
            // Kolumna 4: Numer aktu
            cells[4].textContent = currentAct.fieldValues?.christening_act_number || '';
            
            // Kolumna 5: Data chrztu
            cells[5].textContent = currentAct.fieldValues?.christening_date || '';
            
            // Kolumna 6: Data zgłoszenia
            cells[6].textContent = currentAct.fieldValues?.report_date || '';
            
            // Kolumna 7: Parafia
            cells[7].textContent = currentAct.fieldValues?.parafia || currentAct.fieldValues?.parish || '';
            
            // Kolumna 8: Imię dziecka
            cells[8].textContent = currentAct.fieldValues?.dziecko_imie || currentAct.fieldValues?.child_first_name || '';
            
            // Kolumna 9: Nazwisko dziecka
            cells[9].textContent = currentAct.fieldValues?.dziecko_nazwisko || currentAct.fieldValues?.child_last_name || '';
            
            // Kolumna 10: Data ur. dziecka
            cells[10].textContent = currentAct.fieldValues?.dziecko_data_ur || currentAct.fieldValues?.child_birth_date || '';
            
            // Kolumna 11: Płeć dziecka
            cells[11].textContent = currentAct.fieldValues?.dziecko_plec || currentAct.fieldValues?.child_gender || '';
            
            // Kolumna 12: Status dziecka
            cells[12].textContent = currentAct.fieldValues?.dziecko_status || currentAct.fieldValues?.child_legitimacy_status || '';
            
            // Kolumna 13: Ojciec (imię)
            cells[13].textContent = currentAct.fieldValues?.ojciec_imie || currentAct.fieldValues?.father_first_name || '';
            
            // Kolumna 14: Ojciec (nazwisko)
            cells[14].textContent = currentAct.fieldValues?.ojciec_nazwisko || currentAct.fieldValues?.father_last_name || '';
            
            // Kolumna 15: Ojciec (wiek)
            cells[15].textContent = currentAct.fieldValues?.ojciec_wiek || currentAct.fieldValues?.father_age || '';
            
            // Kolumna 16: Ojciec (zawód)
            cells[16].textContent = currentAct.fieldValues?.ojciec_zawod || currentAct.fieldValues?.father_occupation || '';
            
            // Kolumna 17: Ojciec (stan cywilny)
            cells[17].textContent = currentAct.fieldValues?.ojciec_stan_cywilny || currentAct.fieldValues?.father_civil_status || '';
            
            // Kolumna 18: Matka (imię)
            cells[18].textContent = currentAct.fieldValues?.matka_imie || currentAct.fieldValues?.mother_first_name || '';
            
            // Kolumna 19: Matka (nazwisko)
            cells[19].textContent = currentAct.fieldValues?.matka_nazwisko || currentAct.fieldValues?.mother_last_name || '';
            
            // Kolumna 20: Matka (panieńskie)
            cells[20].textContent = currentAct.fieldValues?.matka_panienskie || currentAct.fieldValues?.mother_maiden_name || '';
            
            // Kolumna 21: Matka (wiek)
            cells[21].textContent = currentAct.fieldValues?.matka_lata || currentAct.fieldValues?.mother_age || '';
            
            // Kolumna 22: Matka (zawód)
            cells[22].textContent = currentAct.fieldValues?.matka_zawod || currentAct.fieldValues?.mother_occupation || '';
            
            // Kolumna 23: Matka (stan cywilny)
            cells[23].textContent = currentAct.fieldValues?.matka_stan_cywilny || currentAct.fieldValues?.mother_civil_status || '';
            
            // Kolumna 24: Matka (miejsce)
            cells[24].textContent = currentAct.fieldValues?.matka_miejsce || currentAct.fieldValues?.location || '';
            
            // Kolumna 25: Ojciec chrzestny (imię)
            cells[25].textContent = currentAct.fieldValues?.ojciec_chrzestny_imie || currentAct.fieldValues?.godfather_first_name || '';
            
            // Kolumna 26: Ojciec chrzestny (nazwisko)
            cells[26].textContent = currentAct.fieldValues?.ojciec_chrzestny_nazwisko || currentAct.fieldValues?.godfather_last_name || '';
            
            // Kolumna 27: Ojciec chrzestny (miejsce)
            cells[27].textContent = currentAct.fieldValues?.ojciec_chrzestny_miejsce || currentAct.fieldValues?.godfather_place || '';
            
            // Kolumna 28: Matka chrzestna (imię)
            cells[28].textContent = currentAct.fieldValues?.matka_chrzestna_imie || currentAct.fieldValues?.godmother_first_name || '';
            
            // Kolumna 29: Matka chrzestna (nazwisko)
            cells[29].textContent = currentAct.fieldValues?.matka_chrzestna_nazwisko || currentAct.fieldValues?.godmother_last_name || '';
            
            // Kolumna 30: Matka chrzestna (miejsce)
            cells[30].textContent = currentAct.fieldValues?.matka_chrzestna_miejsce || currentAct.fieldValues?.godmother_place || '';
            
            // Kolumna 31: Ksiądz (imię)
            cells[31].textContent = currentAct.fieldValues?.ksiadz_imie || currentAct.fieldValues?.priest_first_name || '';
            
            // Kolumna 32: Ksiądz (nazwisko)
            cells[32].textContent = currentAct.fieldValues?.ksiadz_nazwisko || currentAct.fieldValues?.priest_last_name || '';
            
            // Kolumna 33: Ksiądz (zawód)
            cells[33].textContent = currentAct.fieldValues?.ksiadz_zawod || currentAct.fieldValues?.priest_occupation || '';
            
            // Kolumna 34: Zgłaszający (imię)
            cells[34].textContent = currentAct.fieldValues?.zglaszajacy_imie || currentAct.fieldValues?.reporting_person_first_name || '';
            
            // Kolumna 35: Zgłaszający (nazwisko)
            cells[35].textContent = currentAct.fieldValues?.zglaszajacy_nazwisko || currentAct.fieldValues?.reporting_person_last_name || '';
            
            // Kolumna 36: Zgłaszający (zawód)
            cells[36].textContent = currentAct.fieldValues?.zglaszajacy_zawod || currentAct.fieldValues?.reporting_person_occupation || '';
            
            // Kolumna 37: Zgłaszający (wiek)
            cells[37].textContent = currentAct.fieldValues?.zglaszajacy_wiek || currentAct.fieldValues?.reporting_person_age || '';
            
            // Kolumna 38: Zgłaszający (miejsce)
            cells[38].textContent = currentAct.fieldValues?.zglaszajacy_miejsce || currentAct.fieldValues?.reporting_person_place || '';
            
            // Kolumna 39: Świadek 1 (imię)
            cells[39].textContent = currentAct.fieldValues?.swiadek_1_imie || currentAct.fieldValues?.witness_1_first_name || '';
            
            // Kolumna 40: Świadek 1 (nazwisko)
            cells[40].textContent = currentAct.fieldValues?.swiadek_1_nazwisko || currentAct.fieldValues?.witness_1_last_name || '';
            
            // Kolumna 41: Świadek 1 (zawód)
            cells[41].textContent = currentAct.fieldValues?.swiadek_1_zawod || currentAct.fieldValues?.witness_1_occupation || '';
            
            // Kolumna 42: Świadek 1 (miejsce)
            cells[42].textContent = currentAct.fieldValues?.swiadek_1_miejsce || currentAct.fieldValues?.witness_1_place || '';
            
            // Kolumna 43: Świadek 2 (imię)
            cells[43].textContent = currentAct.fieldValues?.swiadek_2_imie || currentAct.fieldValues?.witness_2_first_name || '';
            
            // Kolumna 44: Świadek 2 (nazwisko)
            cells[44].textContent = currentAct.fieldValues?.swiadek_2_nazwisko || currentAct.fieldValues?.witness_2_last_name || '';
            
            // Kolumna 45: Świadek 2 (zawód)
            cells[45].textContent = currentAct.fieldValues?.swiadek_2_zawod || currentAct.fieldValues?.witness_2_occupation || '';
            
            // Kolumna 46: Świadek 2 (miejsce)
            cells[46].textContent = currentAct.fieldValues?.swiadek_2_miejsce || currentAct.fieldValues?.witness_2_place || '';
            
            // Kolumna 47: Świadek 3 (imię)
            cells[47].textContent = currentAct.fieldValues?.swiadek_3_imie || currentAct.fieldValues?.witness_3_first_name || '';
            
            // Kolumna 48: Świadek 3 (nazwisko)
            cells[48].textContent = currentAct.fieldValues?.swiadek_3_nazwisko || currentAct.fieldValues?.witness_3_last_name || '';
            
            // Kolumna 49: Świadek 3 (zawód)
            cells[49].textContent = currentAct.fieldValues?.swiadek_3_zawod || currentAct.fieldValues?.witness_3_occupation || '';
            
            // Kolumna 50: Świadek 3 (miejsce)
            cells[50].textContent = currentAct.fieldValues?.swiadek_3_miejsce || currentAct.fieldValues?.witness_3_place || '';
            
            // Kolumna 51: Uwagi
            cells[51].textContent = currentAct.fieldValues?.custom_note || currentAct.fieldValues?.notes || '';
            
            // Kolumna 52: Opis źródła
            cells[52].textContent = currentAct.fieldValues?.notes_org || '';
        }
        
        function renderRecordsTable() {
            const tableBody = document.getElementById('dataTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Pokazuj WSZYSTKIE akty (nie filtruj po obrazach)
            const currentActs = app.imageActs;
            
            console.log(`📊 Rendering ${currentActs.length} acts in table`);
            
            currentActs.forEach((act, index) => {
                const row = tableBody.insertRow();
                row.dataset.actNum = act.actNum; // Dodaj atrybut aby móc znaleźć wiersz później
                
                // Checkbox
                const checkboxCell = row.insertCell();
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'row-checkbox';
                checkboxCell.appendChild(checkbox);
                
                // ID - pełne, źródłowe (do powiązania osób) - CH.LUB.BLIN.1783.001
                row.insertCell().textContent = act.original_id || act.id || `#${index}`;
                
                // Księga (nr)
                const bookNumber = act.fieldValues?.ksiega_nr || act.fieldValues?.book_number || '';
                row.insertCell().textContent = bookNumber;
                
                // Strona (nr)
                const pageNumber = act.fieldValues?.strona_nr || act.fieldValues?.page_number || '';
                row.insertCell().textContent = pageNumber;
                
                // Numer aktu - tylko liczba/sufiks parsowany z original_id (1, 2, 3b itd)
                let actNum = '';
                if (act.original_id) {
                    const match = act.original_id.match(/\.(\d+)([a-z]?)$/i);
                    if (match) {
                        actNum = parseInt(match[1], 10) + (match[2] || ''); // Usunięcie zer, zachowanie suffiksu
                    }
                }
                row.insertCell().textContent = actNum || `#${index}`;
                
                // Data chrztu
                const christeningDate = act.fieldValues?.christening_date || '';
                row.insertCell().textContent = christeningDate;
                
                // Data zgłoszenia
                const reportDate = act.fieldValues?.report_date || '';
                row.insertCell().textContent = reportDate;
                
                // Parafia
                const parish = act.fieldValues?.parafia || act.fieldValues?.parish || '';
                row.insertCell().textContent = parish;
                
                // Imię dziecka
                const childFirstName = act.fieldValues?.dziecko_imie || act.fieldValues?.child_first_name || act.childName || '';
                row.insertCell().textContent = childFirstName;
                
                // Nazwisko dziecka - szukaj w różnych polach
                const childLastName = act.fieldValues?.dziecko_nazwisko || act.fieldValues?.child_last_name || 
                                     act.fieldValues?.christening_name ||
                                     act.childSurname || '';
                row.insertCell().textContent = childLastName;
                
                // Data ur. dziecka
                const childBirthDate = act.fieldValues?.dziecko_data_ur || act.fieldValues?.child_birth_date || '';
                row.insertCell().textContent = childBirthDate;
                
                // Płeć dziecka
                const childGender = act.fieldValues?.dziecko_plec || act.fieldValues?.child_gender || '';
                row.insertCell().textContent = childGender;
                
                // Status dziecka (ślubne/nieślubne)
                const childStatus = act.fieldValues?.dziecko_status || act.fieldValues?.child_legitimacy_status || '';
                row.insertCell().textContent = childStatus;
                
                // Ojciec - imię
                const fatherName = act.fieldValues?.ojciec_imie || act.fieldValues?.father_first_name || '';
                row.insertCell().textContent = fatherName;
                
                // Ojciec - nazwisko
                const fatherLastName = act.fieldValues?.ojciec_nazwisko || act.fieldValues?.father_last_name || '';
                row.insertCell().textContent = fatherLastName;
                
                // Ojciec - wiek
                const fatherAge = act.fieldValues?.ojciec_wiek || act.fieldValues?.father_age || '';
                row.insertCell().textContent = fatherAge;
                
                // Ojciec - zawód
                const fatherOccupation = act.fieldValues?.ojciec_zawod || act.fieldValues?.father_occupation || '';
                row.insertCell().textContent = fatherOccupation;
                
                // Ojciec - stan cywilny
                const fatherCivilStatus = act.fieldValues?.ojciec_stan_cywilny || act.fieldValues?.father_civil_status || '';
                row.insertCell().textContent = fatherCivilStatus;
                
                // Matka - imię
                const motherName = act.fieldValues?.matka_imie || act.fieldValues?.mother_first_name || '';
                row.insertCell().textContent = motherName;
                
                // Matka - nazwisko
                const motherLastName = act.fieldValues?.matka_nazwisko || act.fieldValues?.mother_last_name || '';
                row.insertCell().textContent = motherLastName;
                
                // Matka - nazwisko panieńskie
                const motherMaidenName = act.fieldValues?.matka_panienskie || act.fieldValues?.mother_maiden_name || '';
                row.insertCell().textContent = motherMaidenName;
                
                // Matka - wiek
                const motherAge = act.fieldValues?.matka_lata || act.fieldValues?.mother_age || '';
                row.insertCell().textContent = motherAge;
                
                // Matka - zawód
                const motherOccupation = act.fieldValues?.matka_zawod || act.fieldValues?.mother_occupation || '';
                row.insertCell().textContent = motherOccupation;
                
                // Matka - stan cywilny
                const motherCivilStatus = act.fieldValues?.matka_stan_cywilny || act.fieldValues?.mother_civil_status || '';
                row.insertCell().textContent = motherCivilStatus;
                
                // Lokacja - szukaj w różnych polach
                const location = act.fieldValues?.matka_miejsce || act.fieldValues?.location || 
                                act.fieldValues?.child_birth_date ||
                                act.location || '';
                row.insertCell().textContent = location;
                
                // Ojciec chrzestny - imię
                const godfatherFirstName = act.fieldValues?.ojciec_chrzestny_imie || act.fieldValues?.godfather_first_name || '';
                row.insertCell().textContent = godfatherFirstName;
                
                // Ojciec chrzestny - nazwisko
                const godfatherLastName = act.fieldValues?.ojciec_chrzestny_nazwisko || act.fieldValues?.godfather_last_name || '';
                row.insertCell().textContent = godfatherLastName;
                
                // Ojciec chrzestny - miejsce
                const godfatherPlace = act.fieldValues?.ojciec_chrzestny_miejsce || act.fieldValues?.godfather_place || '';
                row.insertCell().textContent = godfatherPlace;
                
                // Matka chrzestna - imię
                const godmotherFirstName = act.fieldValues?.matka_chrzestna_imie || act.fieldValues?.godmother_first_name || '';
                row.insertCell().textContent = godmotherFirstName;
                
                // Matka chrzestna - nazwisko
                const godmotherLastName = act.fieldValues?.matka_chrzestna_nazwisko || act.fieldValues?.godmother_last_name || '';
                row.insertCell().textContent = godmotherLastName;
                
                // Matka chrzestna - miejsce
                const godmotherPlace = act.fieldValues?.matka_chrzestna_miejsce || act.fieldValues?.godmother_place || '';
                row.insertCell().textContent = godmotherPlace;
                
                // Ksiądz - imię
                const priestFirstName = act.fieldValues?.ksiadz_imie || act.fieldValues?.priest_first_name || '';
                row.insertCell().textContent = priestFirstName;
                
                // Ksiądz - nazwisko
                const priestLastName = act.fieldValues?.ksiadz_nazwisko || act.fieldValues?.priest_last_name || '';
                row.insertCell().textContent = priestLastName;
                
                // Ksiądz - zawód
                const priestOccupation = act.fieldValues?.ksiadz_zawod || act.fieldValues?.priest_occupation || '';
                row.insertCell().textContent = priestOccupation;
                
                // Zgłaszający - imię
                const reportingFirstName = act.fieldValues?.zglaszajacy_imie || act.fieldValues?.reporting_person_first_name || '';
                row.insertCell().textContent = reportingFirstName;
                
                // Zgłaszający - nazwisko
                const reportingLastName = act.fieldValues?.zglaszajacy_nazwisko || act.fieldValues?.reporting_person_last_name || '';
                row.insertCell().textContent = reportingLastName;
                
                // Zgłaszający - zawód
                const reportingOccupation = act.fieldValues?.zglaszajacy_zawod || act.fieldValues?.reporting_person_occupation || '';
                row.insertCell().textContent = reportingOccupation;
                
                // Zgłaszający - wiek
                const reportingAge = act.fieldValues?.zglaszajacy_wiek || act.fieldValues?.reporting_person_age || '';
                row.insertCell().textContent = reportingAge;
                
                // Zgłaszający - miejsce
                const reportingPlace = act.fieldValues?.zglaszajacy_miejsce || act.fieldValues?.reporting_person_place || '';
                row.insertCell().textContent = reportingPlace;
                
                // Świadek 1 - imię
                const witness1FirstName = act.fieldValues?.swiadek_1_imie || act.fieldValues?.witness_1_first_name || '';
                row.insertCell().textContent = witness1FirstName;
                
                // Świadek 1 - nazwisko
                const witness1LastName = act.fieldValues?.swiadek_1_nazwisko || act.fieldValues?.witness_1_last_name || '';
                row.insertCell().textContent = witness1LastName;
                
                // Świadek 1 - zawód
                const witness1Occupation = act.fieldValues?.swiadek_1_zawod || act.fieldValues?.witness_1_occupation || '';
                row.insertCell().textContent = witness1Occupation;
                
                // Świadek 1 - miejsce
                const witness1Place = act.fieldValues?.swiadek_1_miejsce || act.fieldValues?.witness_1_place || '';
                row.insertCell().textContent = witness1Place;
                
                // Świadek 2 - imię
                const witness2FirstName = act.fieldValues?.swiadek_2_imie || act.fieldValues?.witness_2_first_name || '';
                row.insertCell().textContent = witness2FirstName;
                
                // Świadek 2 - nazwisko
                const witness2LastName = act.fieldValues?.swiadek_2_nazwisko || act.fieldValues?.witness_2_last_name || '';
                row.insertCell().textContent = witness2LastName;
                
                // Świadek 2 - zawód
                const witness2Occupation = act.fieldValues?.swiadek_2_zawod || act.fieldValues?.witness_2_occupation || '';
                row.insertCell().textContent = witness2Occupation;
                
                // Świadek 2 - miejsce
                const witness2Place = act.fieldValues?.swiadek_2_miejsce || act.fieldValues?.witness_2_place || '';
                row.insertCell().textContent = witness2Place;
                
                // Świadek 3 - imię
                const witness3FirstName = act.fieldValues?.swiadek_3_imie || act.fieldValues?.witness_3_first_name || '';
                row.insertCell().textContent = witness3FirstName;
                
                // Świadek 3 - nazwisko
                const witness3LastName = act.fieldValues?.swiadek_3_nazwisko || act.fieldValues?.witness_3_last_name || '';
                row.insertCell().textContent = witness3LastName;
                
                // Świadek 3 - zawód
                const witness3Occupation = act.fieldValues?.swiadek_3_zawod || act.fieldValues?.witness_3_occupation || '';
                row.insertCell().textContent = witness3Occupation;
                
                // Świadek 3 - miejsce
                const witness3Place = act.fieldValues?.swiadek_3_miejsce || act.fieldValues?.witness_3_place || '';
                row.insertCell().textContent = witness3Place;
                
                // Notatki (uwagi)
                const notes = act.fieldValues?.custom_note || act.fieldValues?.notes || act.notes || '';
                row.insertCell().textContent = notes;
                
                // Opis źródła (uwagi_org)
                const notesOrg = act.fieldValues?.notes_org || '';
                row.insertCell().textContent = notesOrg;
                
                // ===== ADD CLICK HANDLER - ładuj akt do panelu po prawej =====
                row.style.cursor = 'pointer';
                row.addEventListener('click', (e) => {
                    // Nie reaguj na klik na checkbox
                    if (e.target.type === 'checkbox') return;
                    
                    console.log('🖱️ Row clicked - act:', act);
                    console.log('🖱️ act.actNum:', act.actNum);
                    console.log('🖱️ app.imageActs length:', app.imageActs.length);
                    console.log('🖱️ szukam aktu po actNum:', act.actNum);
                    
                    // Ustaw bieżący akt
                    app.currentActNum = act.actNum;
                    app.currentImageIdx = act.imageIdx || 0;
                    
                    console.log(`✅ Row clicked: ${act.original_id || act.actNum}`);
                    console.log(`✅ app.currentActNum=${app.currentActNum}, imageIdx=${app.currentImageIdx}`);
                    
                    // Odśwież panel po prawej z danymi aktu
                    renderFormSections();
                    
                    // Zaznacz wiersz
                    document.querySelectorAll('#dataTableBody tr').forEach(r => r.style.backgroundColor = '');
                    row.style.backgroundColor = '#2a4a4a';
                });
            });
        }
        
        function setupPostprocessSliders() {
            // Helper function to safely attach listeners
            const attachSliderListener = (id, key, valueId, suffix = '') => {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`⚠️ Slider element not found: ${id}`);
                    return;
                }
                el.addEventListener('input', (e) => {
                    postprocessState[key] = parseInt(e.target.value);
                    const valEl = document.getElementById(valueId);
                    if (valEl) valEl.textContent = e.target.value + suffix;
                    debouncePreview();
                });
            };
            
            const attachCheckboxListener = (id, key, valueId) => {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`⚠️ Checkbox element not found: ${id}`);
                    return;
                }
                el.addEventListener('change', (e) => {
                    postprocessState[key] = e.target.checked;
                    const valEl = document.getElementById(valueId);
                    if (valEl) valEl.textContent = e.target.checked ? 'ON' : 'OFF';
                    debouncePreview();
                });
            };
            
            // === CORE FILTERS ===
            attachSliderListener('contrastSlider', 'levels', 'contrastValue', '');
            attachSliderListener('brightnessSlider', 'archival', 'brightnessValue', '%');
            attachSliderListener('sharpenSlider', 'descreen', 'sharpenValue', '%');
            attachCheckboxListener('saturationSlider', 'autoContrast', 'saturationValue');
            
            // === ADVANCED FILTERS ===
            attachSliderListener('sepiaSlider', 'sepia', 'sepiaValue', '%');
            attachSliderListener('hueSlider', 'hue', 'hueValue', '°');
            attachSliderListener('saturSlider', 'saturation', 'saturValue', '%');
            attachSliderListener('invertSlider', 'invert', 'invertValue', '%');
            
            // === OPENCV ADVANCED FILTERS ===
            const adaptiveEl = document.getElementById('adaptiveThresholdSlider');
            if (adaptiveEl) {
                adaptiveEl.addEventListener('input', (e) => {
                    postprocessState.adaptiveThreshold = parseInt(e.target.value);
                    const valEl = document.getElementById('adaptiveThresholdValue');
                    if (valEl) valEl.textContent = e.target.value > 0 ? 'ON (' + e.target.value + '%)' : 'OFF';
                    debouncePreview();
                });
            }
            
            attachSliderListener('gaussianBlurSlider', 'gaussianBlur', 'gaussianBlurValue', '');
            attachSliderListener('medianBlurSlider', 'medianBlur', 'medianBlurValue', '');
            attachCheckboxListener('histogramEqCheckbox', 'histogramEq', 'histogramEqValue');
            
            // Presets - dodaj przycisk dla każdego presetu
            const presetsContainer = document.querySelector('.postprocess-buttons');
            if (presetsContainer && !presetsContainer.querySelector('.preset-buttons')) {
                const presetsDiv = document.createElement('div');
                presetsDiv.className = 'preset-buttons';
                presetsDiv.style.gridColumn = 'span 2';
                presetsDiv.style.display = 'grid';
                presetsDiv.style.gridTemplateColumns = '1fr 1fr';
                presetsDiv.style.gap = '6px';
                presetsDiv.style.marginBottom = '10px';
                
                const presetTooltips = {
                    'heavy-duty': '🔧 Dla najtrudniejszych: wyrównanie tła + morfologia + auto-invert'
                };
                
                Object.keys(presets).forEach(name => {
                    const btn = document.createElement('button');
                    btn.className = 'postprocess-btn preset-btn';
                    btn.textContent = name.charAt(0).toUpperCase() + name.slice(1);
                    btn.style.fontSize = '10px';
                    if (presetTooltips[name]) {
                        btn.title = presetTooltips[name];
                    }
                    btn.onclick = () => applyPreset(name);
                    presetsDiv.appendChild(btn);
                });
                
                presetsContainer.insertBefore(presetsDiv, presetsContainer.firstChild);
                console.log('✅ Preset buttons added:', Object.keys(presets).length, 'presets');
            } else {
                console.log('ℹ️ Presets container not found or already has preset buttons');
            }
        }
        
        function debouncePreview() {
            if (previewTimeout) clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                updateProcessedPreview();
            }, 300);
        }
        
        function updateProcessedPreview() {
            try {
                if (isProcessing || !app.images[app.currentImageIdx] || !app.images[app.currentImageIdx].data) {
                    console.warn('⚠️ Preview: Missing image data or already processing');
                    return;
                }
                if (!app.viewer) {
                    console.warn('⚠️ Preview: Viewer not initialized');
                    return;
                }
                
                isProcessing = true;
                const original = app.images[app.currentImageIdx];
                const img = new Image();
                img.src = original.data;
                
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        applyPostprocessFilters(canvas, postprocessState);
                        const processed = canvas.toDataURL('image/jpeg', 0.95);
                        
                        app.viewer.open({
                            type: 'image',
                            url: processed
                        });
                        console.log('✅ Live preview updated');
                    } catch (e) {
                        console.error('❌ Preview processing error:', e);
                    } finally {
                        isProcessing = false;
                    }
                };
                
                img.onerror = (err) => {
                    console.error('❌ Failed to load preview image:', err);
                    isProcessing = false;
                };
                
                // Timeout safety: if image doesn't load in 5s, cancel
                setTimeout(() => {
                    if (isProcessing) {
                        console.warn('⚠️ Preview timeout - image too large or slow connection');
                        isProcessing = false;
                    }
                }, 5000);
                
            } catch (e) {
                console.error('❌ updateProcessedPreview exception:', e);
                isProcessing = false;
            }
        }
        
        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;
            
            postprocessState.levels = preset.levels;
            postprocessState.autoContrast = preset.autoContrast;
            postprocessState.archival = preset.archival;
            postprocessState.descreen = preset.descreen;
            postprocessState.sepia = preset.sepia || 0;
            postprocessState.hue = preset.hue || 0;
            postprocessState.saturation = preset.saturation || 100;
            postprocessState.invert = preset.invert || 0;
            postprocessState.adaptiveThreshold = preset.adaptiveThreshold || 0;
            postprocessState.gaussianBlur = preset.gaussianBlur || 0;
            postprocessState.medianBlur = preset.medianBlur || 0;
            postprocessState.histogramEq = preset.histogramEq || false;
            postprocessState.backgroundSubtraction = preset.backgroundSubtraction || 0;
            postprocessState.morphologyClose = preset.morphologyClose || 0;
            postprocessState.autoInvert = preset.autoInvert || false;
            
            // Update sliders
            document.getElementById('contrastSlider').value = preset.levels;
            document.getElementById('contrastValue').textContent = preset.levels;
            document.getElementById('brightnessSlider').value = preset.archival;
            document.getElementById('brightnessValue').textContent = preset.archival + '%';
            document.getElementById('sharpenSlider').value = preset.descreen;
            document.getElementById('sharpenValue').textContent = preset.descreen + '%';
            document.getElementById('saturationSlider').checked = preset.autoContrast;
            document.getElementById('saturationValue').textContent = preset.autoContrast ? 'ON' : 'OFF';
            
            // Update advanced filters
            document.getElementById('sepiaSlider').value = preset.sepia || 0;
            document.getElementById('sepiaValue').textContent = (preset.sepia || 0) + '%';
            document.getElementById('hueSlider').value = preset.hue || 0;
            document.getElementById('hueValue').textContent = (preset.hue || 0) + '°';
            document.getElementById('saturSlider').value = preset.saturation || 100;
            document.getElementById('saturValue').textContent = (preset.saturation || 100) + '%';
            document.getElementById('invertSlider').value = preset.invert || 0;
            document.getElementById('invertValue').textContent = (preset.invert || 0) + '%';
            
            // Update OpenCV filters
            document.getElementById('adaptiveThresholdSlider').value = preset.adaptiveThreshold || 0;
            document.getElementById('adaptiveThresholdValue').textContent = (preset.adaptiveThreshold || 0) > 0 ? 'ON (' + (preset.adaptiveThreshold || 0) + '%)' : 'OFF';
            document.getElementById('gaussianBlurSlider').value = preset.gaussianBlur || 0;
            document.getElementById('gaussianBlurValue').textContent = (preset.gaussianBlur || 0);
            document.getElementById('medianBlurSlider').value = preset.medianBlur || 0;
            document.getElementById('medianBlurValue').textContent = (preset.medianBlur || 0);
            document.getElementById('histogramEqCheckbox').checked = preset.histogramEq || false;
            document.getElementById('histogramEqValue').textContent = (preset.histogramEq || false) ? 'ON' : 'OFF';
            
            debouncePreview();
            notify(`📋 Preset: ${presetName}`, 'success');
        }
        
        function applyPostprocessFilters(canvas, state) {
            const ctx = canvas.getContext('2d');
            console.log('🎨 applyPostprocessFilters START with state:', {
                levels: state.levels,
                archival: state.archival,
                descreen: state.descreen,
                adaptiveThreshold: state.adaptiveThreshold,
                gaussianBlur: state.gaussianBlur
            });
            let filterString = '';
            
            // Levels (shadows/highlights)
            const levels = state.levels || 0;
            if (levels > 0) {
                filterString += `brightness(${1 + (levels / 100)}) `;
            } else if (levels < 0) {
                filterString += `brightness(${1 + (levels / 100)}) `;
            }
            
            // Auto-contrast using brightness adjustment
            if (state.autoContrast) {
                filterString += 'contrast(1.3) ';
            }
            
            // Sepia filter
            if (state.sepia > 0) {
                filterString += `sepia(${state.sepia / 100}) `;
            }
            
            // Hue rotation
            if (state.hue !== 0) {
                filterString += `hue-rotate(${state.hue}deg) `;
            }
            
            // Saturation
            if (state.saturation !== 100) {
                filterString += `saturate(${state.saturation}%) `;
            }
            
            // Invert
            if (state.invert > 0) {
                filterString += `invert(${state.invert / 100}) `;
            }
            
            // Apply Canvas filters (szybkie, GPU-accelerated)
            if (filterString) {
                ctx.filter = filterString;
                ctx.drawImage(canvas, 0, 0);
                ctx.filter = 'none';
            }
            
            // === STEP 2: Histogram Equalization (OpenCV) ===
            if (state.histogramEq) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                imageData = histogramEqualization(imageData);
                ctx.putImageData(imageData, 0, 0);
                console.log('✅ Histogram Equalization applied');
            }
            
            // === STEP 3: Background Subtraction (Wyrównanie tła) - NOWE ===
            if (state.backgroundSubtraction > 0) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const kernelSize = Math.floor(state.backgroundSubtraction / 10) * 2 + 11;  // 0-100 → 11-111
                imageData = backgroundSubtraction(imageData, kernelSize);
                ctx.putImageData(imageData, 0, 0);
                console.log('✅ Background Subtraction applied (kernel: ' + kernelSize + ')');
            }
            
            // === STEP 4: Gaussian Blur (OpenCV - denoising) ===
            if (state.gaussianBlur > 0) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const kernelSize = state.gaussianBlur * 2 + 1;  // Konwersja 0-10 na kernel size
                imageData = gaussianBlurFilter(imageData, kernelSize, 1.0);
                ctx.putImageData(imageData, 0, 0);
                console.log('✅ Gaussian Blur applied (kernel: ' + kernelSize + ')');
            }
            
            // === STEP 5: Median Blur (OpenCV - denoising) ===
            if (state.medianBlur > 0) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const kernelSize = state.medianBlur * 2 + 1;
                imageData = medianBlurFilter(imageData, kernelSize);
                ctx.putImageData(imageData, 0, 0);
                console.log('✅ Median Blur applied (kernel: ' + kernelSize + ')');
            }
            
            // === STEP 6: Archival document enhancement (pixel-level, ale szybszy) ===
            if (state.archival > 0) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const strength = state.archival / 100;
                
                for (let i = 0; i < data.length; i += 4) {
                    let r = data[i], g = data[i+1], b = data[i+2];
                    
                    // Boost contrast dla wyblakłych dokumentów
                    const avg = (r + g + b) / 3;
                    const factor = 1 + strength * 0.5;
                    
                    r = Math.max(0, Math.min(255, (r - avg) * factor + avg));
                    g = Math.max(0, Math.min(255, (g - avg) * factor + avg));
                    b = Math.max(0, Math.min(255, (b - avg) * factor + avg));
                    
                    data[i] = r;
                    data[i+1] = g;
                    data[i+2] = b;
                }
                
                ctx.putImageData(imageData, 0, 0);
            }
            
            // === STEP 7: Descreen (removes halftone) ===
            if (state.descreen > 0) {
                const strength = state.descreen / 100 * 0.3;
                if (state.descreen > 30) {
                    ctx.filter = `blur(${strength}px)`;
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                }
            }
            
            // === STEP 8: Adaptive Threshold (OpenCV - binaryzacja) ===
            if (state.adaptiveThreshold > 0) {
                if (opencvReady) {
                    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const blockSize = Math.max(3, Math.floor(state.adaptiveThreshold / 20) * 2 + 1);  // Konwersja 0-100 na blockSize
                    const constant = Math.max(-50, Math.min(50, Math.floor((state.adaptiveThreshold - 50) / 2)));
                    
                    imageData = adaptiveThresholdFilter(imageData, blockSize, constant);
                    ctx.putImageData(imageData, 0, 0);
                    console.log('✅ Adaptive Threshold applied (blockSize: ' + blockSize + ', constant: ' + constant + ')');
                } else {
                    console.warn('⚠️ OpenCV.js nie jest jeszcze załadowany - Adaptive Threshold pominięty');
                }
            }
            
            // === STEP 9: Morphology Close (OpenCV - Połączenie przerwanych kresek) - NOWE ===
            if (state.morphologyClose > 0) {
                if (opencvReady) {
                    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const kernelSize = Math.floor(state.morphologyClose / 20) * 2 + 1;  // 0-100 → 1-11
                    imageData = morphologyClose(imageData, kernelSize);
                    ctx.putImageData(imageData, 0, 0);
                    console.log('✅ Morphology Close applied (kernel: ' + kernelSize + ')');
                } else {
                    console.warn('⚠️ OpenCV.js nie jest jeszcze załadowany - Morphology Close pominięty');
                }
            }
            
            // === STEP 10: Auto-Invert (Detekcja i inwersja tekstu białego) - NOWE ===
            if (state.autoInvert) {
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const shouldInvert = autoInvert(imageData);
                if (shouldInvert) {
                    imageData = invertColors(imageData);
                    ctx.putImageData(imageData, 0, 0);
                    console.log('✅ Auto-Invert applied (tekst był biały na czarnym)');
                } else {
                    console.log('ℹ️ Auto-Invert: Nie trzeba - tekst jest czarny');
                }
            }
            
            console.log('✅ applyPostprocessFilters COMPLETE');
        }
        
        function saveProcessedAsNew() {
            if (!app.images[app.currentImageIdx]) {
                notify('Załaduj obraz', 'error');
                return;
            }
            
            const hasChanges = postprocessState.levels !== 0 || 
                               postprocessState.autoContrast !== false || 
                               postprocessState.archival !== 0 || 
                               postprocessState.descreen !== 0 ||
                               postprocessState.sepia !== 0 ||
                               postprocessState.hue !== 0 ||
                               postprocessState.saturation !== 100 ||
                               postprocessState.invert !== 0 ||
                               postprocessState.adaptiveThreshold !== 0 ||
                               postprocessState.gaussianBlur !== 0 ||
                               postprocessState.medianBlur !== 0 ||
                               postprocessState.histogramEq !== false;
            
            if (!hasChanges) {
                notify('⚠️ Nie ma zmian do zapisania', 'warning');
                return;
            }
            
            const original = app.images[app.currentImageIdx];
            notify('⏳ Przetwarzanie...', 'info');
            
            setTimeout(() => {
                const img = new Image();
                img.src = original.data;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    applyPostprocessFilters(canvas, postprocessState);
                    const processedDataUrl = canvas.toDataURL('image/jpeg', 0.95);
                    
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/T/, '_').replace(/:/g, '');
                    const newImage = {
                        name: original.name.replace(/\\.[^/.]+$/, '') + '_processed_' + timestamp,
                        data: processedDataUrl
                    };
                    
                    app.images.push(newImage);
                    saveStorage();
                    updateThumbs();
                    
                    notify('✅ Zapisano: ' + newImage.name, 'success');
                    selectImage(app.images.length - 1);
                };
            }, 100);
        }
        
        function resetPostprocessing() {
            document.getElementById('contrastSlider').value = 0;
            document.getElementById('brightnessSlider').value = 0;
            document.getElementById('sharpenSlider').value = 0;
            document.getElementById('saturationSlider').checked = false;
            
            // Reset advanced filters
            document.getElementById('sepiaSlider').value = 0;
            document.getElementById('hueSlider').value = 0;
            document.getElementById('saturSlider').value = 100;
            document.getElementById('invertSlider').value = 0;
            
            // Reset OpenCV filters
            document.getElementById('adaptiveThresholdSlider').value = 0;
            document.getElementById('gaussianBlurSlider').value = 0;
            document.getElementById('medianBlurSlider').value = 0;
            document.getElementById('histogramEqCheckbox').checked = false;
            
            postprocessState.levels = 0;
            postprocessState.autoContrast = false;
            postprocessState.archival = 0;
            postprocessState.descreen = 0;
            postprocessState.sepia = 0;
            postprocessState.hue = 0;
            postprocessState.saturation = 100;
            postprocessState.invert = 0;
            postprocessState.adaptiveThreshold = 0;
            postprocessState.gaussianBlur = 0;
            postprocessState.medianBlur = 0;
            postprocessState.histogramEq = false;
            postprocessState.backgroundSubtraction = 0;
            postprocessState.morphologyClose = 0;
            postprocessState.autoInvert = false;
            
            document.getElementById('contrastValue').textContent = '0';
            document.getElementById('brightnessValue').textContent = '0%';
            document.getElementById('sharpenValue').textContent = '0%';
            document.getElementById('saturationValue').textContent = 'OFF';
            document.getElementById('sepiaValue').textContent = '0%';
            document.getElementById('hueValue').textContent = '0°';
            document.getElementById('saturValue').textContent = '100%';
            document.getElementById('invertValue').textContent = '0%';
            document.getElementById('adaptiveThresholdValue').textContent = 'OFF';
            document.getElementById('gaussianBlurValue').textContent = '0';
            document.getElementById('medianBlurValue').textContent = '0';
            document.getElementById('histogramEqValue').textContent = 'OFF';
            
            if (app.images[app.currentImageIdx] && app.images[app.currentImageIdx].data) {
                const original = app.images[app.currentImageIdx];
                if (app.viewer) {
                    app.viewer.open({
                        type: 'image',
                        url: original.data
                    });
                }
            }
            
            notify('↻ Reset - oryginalny obraz', 'info');
        }
        
        // ===== ADVANCED FILTERS WITH OPENCV.JS =====
        
        function onOpenCvReady() {
            opencvReady = true;
            console.log('✅ OpenCV.js załadowany i gotowy');
        }
        
        function adaptiveThresholdFilter(imageData, blockSize = 11, constant = 2) {
            if (!opencvReady) {
                console.warn('⚠️ OpenCV.js nie jest jeszcze załadowany');
                return imageData;
            }
            
            try {
                let src = cv.matFromImageData(imageData);
                let dst = new cv.Mat();
                let gray = new cv.Mat();
                
                // Konwersja do skali szarości
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // Adaptive Thresholding
                cv.adaptiveThreshold(gray, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, blockSize, constant);
                
                // Konwersja z powrotem do RGBA
                cv.cvtColor(dst, src, cv.COLOR_GRAY2RGBA);
                
                // Kopiowanie wyników do ImageData
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(src.data),
                    src.cols,
                    src.rows
                );
                
                // Czyszczenie pamięci
                src.delete();
                dst.delete();
                gray.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Adaptive Threshold:', e);
                return imageData;
            }
        }
        
        function gaussianBlurFilter(imageData, kernelSize = 5, sigma = 1.0) {
            if (!opencvReady) return imageData;
            
            try {
                let src = cv.matFromImageData(imageData);
                let dst = new cv.Mat();
                
                // Gaussian Blur
                let ksize = new cv.Size(kernelSize, kernelSize);
                cv.GaussianBlur(src, dst, ksize, sigma, sigma, cv.BORDER_DEFAULT);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(dst.data),
                    dst.cols,
                    dst.rows
                );
                
                src.delete();
                dst.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Gaussian Blur:', e);
                return imageData;
            }
        }
        
        function medianBlurFilter(imageData, kernelSize = 5) {
            if (!opencvReady) return imageData;
            
            try {
                let src = cv.matFromImageData(imageData);
                let dst = new cv.Mat();
                
                // Median Blur (dla denoising)
                cv.medianBlur(src, dst, kernelSize);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(dst.data),
                    dst.cols,
                    dst.rows
                );
                
                src.delete();
                dst.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Median Blur:', e);
                return imageData;
            }
        }
        
        function histogramEqualization(imageData) {
            if (!opencvReady) return imageData;
            
            try {
                let src = cv.matFromImageData(imageData);
                let gray = new cv.Mat();
                let dst = new cv.Mat();
                
                // Konwersja do szarości
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // Equalization
                cv.equalizeHist(gray, dst);
                
                // Konwersja z powrotem
                cv.cvtColor(dst, src, cv.COLOR_GRAY2RGBA);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(src.data),
                    src.cols,
                    src.rows
                );
                
                src.delete();
                gray.delete();
                dst.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Histogram Equalization:', e);
                return imageData;
            }
        }
        
        // ===== HEAVY-DUTY FILTER FUNCTIONS =====
        
        function backgroundSubtraction(imageData, kernelSize = 21) {
            if (!opencvReady) return imageData;
            
            try {
                console.log('🎨 Background Subtraction: Wyrównanie nierównego tła...');
                let src = cv.matFromImageData(imageData);
                let gray = new cv.Mat();
                let background = new cv.Mat();
                let result = new cv.Mat();
                
                // 1. Konwersja do szarości
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // 2. Estimacja tła za pomocą morphology (opening)
                let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(kernelSize, kernelSize));
                cv.morphologyEx(gray, background, cv.MORPH_OPEN, kernel);
                
                // 3. Odejmij tło od oryginału (contrast boost)
                cv.subtract(gray, background, result);
                
                // 4. Normalizuj wynik
                let minVal = new cv.Mat();
                let maxVal = new cv.Mat();
                cv.normalize(result, result, 0, 255, cv.NORM_MINMAX);
                
                // 5. Konwersja z powrotem na RGBA
                cv.cvtColor(result, src, cv.COLOR_GRAY2RGBA);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(src.data),
                    src.cols,
                    src.rows
                );
                
                kernel.delete();
                src.delete();
                gray.delete();
                background.delete();
                result.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Background Subtraction:', e);
                return imageData;
            }
        }
        
        function morphologyClose(imageData, kernelSize = 5) {
            if (!opencvReady) return imageData;
            
            try {
                console.log('🎨 Morphology Close: Połączenie przerwanych kresek...');
                let src = cv.matFromImageData(imageData);
                let gray = new cv.Mat();
                let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(kernelSize, kernelSize));
                let result = new cv.Mat();
                
                // Konwersja do szarości
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // Morphology Close: dylatacja + erozja (zamyka małe otwory)
                cv.morphologyEx(gray, result, cv.MORPH_CLOSE, kernel);
                
                // Konwersja z powrotem
                cv.cvtColor(result, src, cv.COLOR_GRAY2RGBA);
                
                let outputImageData = new ImageData(
                    new Uint8ClampedArray(src.data),
                    src.cols,
                    src.rows
                );
                
                kernel.delete();
                src.delete();
                gray.delete();
                result.delete();
                
                return outputImageData;
            } catch (e) {
                console.error('❌ Błąd Morphology Close:', e);
                return imageData;
            }
        }
        
        function autoInvert(imageData) {
            // Detekuj czy tekst jest jasny na ciemnym tle
            const ctx = document.createElement('canvas').getContext('2d');
            const data = imageData.data;
            let darkPixels = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
                if (brightness < 128) darkPixels++;
            }
            
            const darkRatio = darkPixels / (data.length / 4);
            console.log(`🎨 Auto-Invert: ${(darkRatio * 100).toFixed(1)}% ciemnych pikseli - ${darkRatio > 0.7 ? 'INWERTUJ' : 'pozostaw'}`);
            
            // Jeśli >70% pikseli jest ciemnych, obrócić (tekst biały na czarnym)
            return darkRatio > 0.7;
        }
        
        function invertColors(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                data[i] = 255 - data[i];        // R
                data[i+1] = 255 - data[i+1];    // G
                data[i+2] = 255 - data[i+2];    // B
                // A nie zmieniamy
            }
            return imageData;
        }
        
        // ═════════════════════════════════════════════════════════════════
        // 🚀 V7.1 ENHANCEMENTS - Features A, B, C, D, E
        // ═════════════════════════════════════════════════════════════════
        
        // 💡 A: SUGGESTIONS FAN (Wachlarz podpowiedzi)
        function showSuggestionsForField(inputEl) {
            const fieldId = inputEl.dataset.field;
            const currentValue = inputEl.value.toLowerCase().trim();
            
            // Jeśli mniej niż 2 znaki, ukryj sugestie
            if (currentValue.length < 2) {
                hideSuggestions();
                return;
            }
            
            // Zbierz wszystkie wartości tego pola z aktów tej strony
            const suggestions = new Set();
            const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
            
            currentActList.forEach(act => {
                if (act.fieldValues && act.fieldValues[fieldId]) {
                    const val = act.fieldValues[fieldId].toString().toLowerCase();
                    // Jeśli zawiera to co piszt i nie jest identyczne
                    if (val.includes(currentValue) && val !== currentValue) {
                        suggestions.add(act.fieldValues[fieldId]);
                    }
                }
            });
            
            if (suggestions.size === 0) {
                hideSuggestions();
                return;
            }
            
            // Pozycjonuj wachlarz wokół input'a
            const rect = inputEl.getBoundingClientRect();
            const container = document.querySelector('.viewer-container');
            const containerRect = container.getBoundingClientRect();
            const wachlarz = document.getElementById('suggestionsWachlarz');
            
            wachlarz.style.left = (rect.left - containerRect.left - 220) + 'px';
            wachlarz.style.top = (rect.top - containerRect.top + rect.height + 5) + 'px';
            wachlarz.innerHTML = '';
            
            // Dodaj sugestie (max 5)
            Array.from(suggestions).slice(0, 5).forEach((suggestion, idx) => {
                const div = document.createElement('div');
                div.className = 'suggestion';
                div.textContent = suggestion.substring(0, 30);
                div.title = suggestion;
                div.style.animation = `fanRotate 0.4s ease-out ${idx * 0.08}s backwards`;
                div.onclick = (e) => {
                    e.stopPropagation();
                    inputEl.value = suggestion;
                    inputEl.focus();
                    hideSuggestions();
                    updateFieldStatus();
                    updateProgressBar();
                    inputEl.dispatchEvent(new Event('change'));
                };
                div.onmouseenter = () => {
                    div.style.transform = 'translateX(10px) rotate(0deg) scale(1.05)';
                    div.style.color = '#00ff88';
                };
                div.onmouseleave = () => {
                    div.style.transform = 'translateX(-10px) rotate(-3deg) scale(1)';
                    div.style.color = 'inherit';
                };
                wachlarz.appendChild(div);
            });
            
            wachlarz.classList.add('visible');
            console.log(`💡 A: Wachlarz ${suggestions.size} sugestii dla "${fieldId}"`);
        }
        
        function hideSuggestions() {
            const wachlarz = document.getElementById('suggestionsWachlarz');
            wachlarz.classList.remove('visible');
            setTimeout(() => { wachlarz.innerHTML = ''; }, 300);
        }
        
        // 📊 C: STATISTICS - Aktualizuj pasek postępu
        function updateProgressBar() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const inputs = activeForm.querySelectorAll('.field-input');
            const completed = Array.from(inputs).filter(input => 
                input.value?.trim().length > 0
            ).length;
            
            const total = inputs.length;
            const percent = total > 0 ? (completed / total) * 100 : 0;
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressFill) {
                progressFill.style.width = percent + '%';
                progressFill.style.backgroundColor = percent === 100 ? '#10b981' : '#0078d4';
            }
            if (progressText) progressText.textContent = `${completed}/${total}`;
            
            // 📊 Pokaż statystyki w toolbar'u
            updateActStatistics();
        }
        
        function updateActStatistics() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const act = getCurrentAct();
            if (!act) return;
            
            const inputs = activeForm.querySelectorAll('.field-input');
            const filledCount = Array.from(inputs).filter(inp => inp.value?.trim().length > 0).length;
            const roiCount = Object.keys(act.fieldROIs || {}).length;
            
            // Pokaż w statusu
            const stats = `📊 ${filledCount}/${inputs.length} pól | 🎨 ${roiCount} ROI`;
            const existingStats = document.getElementById('actStatistics');
            if (existingStats) {
                existingStats.textContent = stats;
            }
        }
        
        // E: AUTO-FOCUS pierwszy input gdy wybieramy akt
        function focusFirstField() {
            const activeForm = document.querySelector('.form-section.active');
            if (!activeForm) return;
            
            const firstInput = activeForm.querySelector('.field-input');
            if (firstInput) {
                setTimeout(() => {
                    firstInput.focus();
                    firstInput.select?.();
                }, 100);
            }
        }
        
        // B: KEYBOARD SHORTCUTS (Skróty klawiszowe)
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignoruj jeśli wpisujemy w textaree (chyba że Ctrl/Cmd)
                const isTextarea = e.target.tagName === 'TEXTAREA';
                const isInput = e.target.tagName === 'INPUT';
                const hasCtrlCmd = e.ctrlKey || e.metaKey;
                
                // Ctrl+S = Zapisz akt
                if (e.key === 's' || e.key === 'S') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        saveRecord();
                        console.log('⌨️ B: Ctrl+S → Zapisz');
                        return;
                    }
                }
                
                // Ctrl+D = Usuń akt
                if (e.key === 'd' || e.key === 'D') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        if (confirm('🗑️  Usunąć bieżący akt?')) {
                            deleteCurrentRecord();
                        }
                        console.log('⌨️ B: Ctrl+D → Usuń');
                        return;
                    }
                }
                
                // Ctrl+C = Duplikuj poprzedni (przy focus na input, pamiętaj!)
                if (e.key === 'c' || e.key === 'C') {
                    if (hasCtrlCmd && !isTextarea) { // W textarea, Ctrl+C to zwykły copy
                        e.preventDefault();
                        copyPreviousActEnhanced();
                        console.log('⌨️ B: Ctrl+C → Copy Previous');
                        return;
                    }
                }
                
                // Ctrl+A = Toggle Act ROI drawing mode (TASK #1)
                if (e.key === 'a' || e.key === 'A') {
                    if (hasCtrlCmd && !isInput && !isTextarea) {
                        e.preventDefault();
                        toggleActMode();
                        console.log('⌨️ B: Ctrl+A → Act Mode Toggle');
                        return;
                    }
                }
                
                // Ctrl+N = Nowy akt
                if (e.key === 'n' || e.key === 'N') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        const count = prompt('📋 Ile aktów dodać?', '1');
                        if (!count) return;
                        
                        const numToAdd = Math.max(1, parseInt(count) || 1);
                        for (let i = 0; i < numToAdd; i++) {
                            const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                            const newActNum = (currentActList.length || 0) + 1 + i;
                            
                            const newAct = {
                                actNum: newActNum,
                                imageIdx: app.currentImageIdx,
                                type: 'birth',  // Domyślny typ
                                fieldValues: {},
                                fieldROIs: {},
                                actROI: null,
                                timestamp: new Date().toISOString()
                            };
                            app.imageActs.push(newAct);
                        }
                        
                        saveStorage();
                        renderActButtons();
                        
                        // Zaznacz ostatnio dodany
                        const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                        selectAct(currentActList[currentActList.length - numToAdd].actNum);
                        
                        notify(`✨ Dodano ${numToAdd} aktów`, 'success');
                        console.log(`⌨️ B: Ctrl+N → +${numToAdd} aktów`);
                    }
                }
                
                // Arrow Left/Right = poprzedni/następny akt
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    if (isInput || isTextarea) return; // Nie w polu tekstowym
                    
                    const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
                    const currentAct = getCurrentAct();
                    if (!currentAct) return;
                    
                    const currentIdx = currentActList.findIndex(a => a.actNum === currentAct.actNum);
                    let nextIdx = currentIdx;
                    
                    if (e.key === 'ArrowLeft' && currentIdx > 0) {
                        nextIdx = currentIdx - 1;
                    } else if (e.key === 'ArrowRight' && currentIdx < currentActList.length - 1) {
                        nextIdx = currentIdx + 1;
                    }
                    
                    if (nextIdx !== currentIdx) {
                        selectAct(currentActList[nextIdx].actNum);
                        console.log(`⌨️ Nawigacja: Akt ${currentActList[nextIdx].actNum}`);
                    }
                }
                
                // Ctrl+M = Toggle thumbnails panel
                if (e.key === 'm' || e.key === 'M') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        toggleThumbsPanel();
                        console.log('⌨️ B: Ctrl+M → Toggle Thumbs');
                        return;
                    }
                }
                
                // Ctrl+L = Toggle acts panel
                if (e.key === 'l' || e.key === 'L') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        toggleActsPanel();
                        console.log('⌨️ B: Ctrl+L → Toggle Acts');
                        return;
                    }
                }
                
                // TASK #3: Ctrl+J = Import JSON
                if (e.key === 'j' || e.key === 'J') {
                    if (hasCtrlCmd) {
                        e.preventDefault();
                        importJSON();
                        console.log('⌨️ B: Ctrl+J → JSON Import');
                        return;
                    }
                }
            });
        }
        
        // D: ENHANCED COPY PREVIOUS
        function copyPreviousActEnhanced() {
            if (app.currentActNum === null || app.currentActNum === undefined) {
                notify('❌ Najpierw wybierz akt', 'error');
                return;
            }
            
            const currentActList = app.imageActs.filter(a => a.imageIdx === app.currentImageIdx);
            const currentIdx = currentActList.findIndex(a => a.actNum === app.currentActNum);
            
            if (currentIdx === 0) {
                notify('ℹ️ Brak poprzedniego aktu do skopiowania', 'info');
                return;
            }
            
            const previousAct = currentActList[currentIdx - 1];
            const currentAct = getCurrentAct();
            if (!currentAct) return;
            
            // Kopiuj wartości pól
            currentAct.fieldValues = { ...previousAct.fieldValues };
            renderFormSections();
            
            // Kopiuj ROI'e jeśli istnieją
            if (previousAct.fieldROIs && Object.keys(previousAct.fieldROIs).length > 0) {
                currentAct.fieldROIs = JSON.parse(JSON.stringify(previousAct.fieldROIs));
                redrawROIs();
            }
            
            saveStorage();
            updateProgressBar();
            updateFieldStatus();
            focusFirstField();
            
            notify(`✨ Skopiowano z Aktu ${previousAct.actNum}`, 'success');
            console.log(`📋 D: Copy Previous - Akt ${app.currentActNum} ← Akt ${previousAct.actNum}`);
        }
        
        // ===== PASTE DIALOG FUNCTIONS =====
        function showPasteDialog() {
            const pasteOverlay = document.getElementById('pasteOverlay');
            if (pasteOverlay) {
                pasteOverlay.classList.add('visible');
                const textarea = document.getElementById('pasteTextarea');
                if (textarea) {
                    textarea.value = '';
                    textarea.focus();
                }
            }
        }
        
        function closePasteDialog() {
            const pasteOverlay = document.getElementById('pasteOverlay');
            if (pasteOverlay) {
                pasteOverlay.classList.remove('visible');
            }
        }
        
        function processPastedData() {
            const textarea = document.getElementById('pasteTextarea');
            if (!textarea || !textarea.value.trim()) {
                notify('⚠️ Wklejone pole jest puste', 'warning');
                return;
            }
            
            const pastedData = textarea.value;
            const lines = pastedData.split('\n').filter(line => line.trim());
            
            if (lines.length === 0) {
                notify('⚠️ Brak danych do wklejenia', 'warning');
                return;
            }
            
            // Parsuj nagłówki (pierwszy wiersz) lub użyj default headers
            let headers = [];
            let dataLines = lines;
            
            // Spróbuj rozpoznać czy pierwszy wiersz to nagłówki (zawiera słowa jak "Imię", "Nazwisko", itp)
            const firstLineColumns = lines[0].split('\t');
            const headerKeywords = ['imię', 'nazwisko', 'data', 'wiek', 'zawód', 'status', 'parafia', 'księga', 'strona', 'miejsce', 'należy'];
            const isHeader = firstLineColumns.some(col => headerKeywords.some(kw => col.toLowerCase().includes(kw)));
            
            if (isHeader) {
                headers = firstLineColumns.map(h => h.trim().toLowerCase());
                dataLines = lines.slice(1);
            } else {
                // Default headers w kolejności jak w tabeli (bez checkboxa)
                headers = [
                    'id źródłowe', 'księga (nr)', 'strona (nr)', 'numer aktu', 'data chrztu', 'data zgłoszenia', 'parafia',
                    'imię dziecka', 'nazwisko dziecka', 'data ur. dziecka', 'płeć dziecka', 'status dziecka',
                    'ojciec (imię)', 'ojciec (nazwisko)', 'ojciec (wiek)', 'ojciec (zawód)', 'ojciec (stan cywilny)',
                    'matka (imię)', 'matka (nazwisko)', 'matka (panieńskie)', 'matka (wiek)', 'matka (zawód)', 'matka (stan cywilny)', 'matka (miejsce)',
                    'ojciec chrzestny (imię)', 'ojciec chrzestny (nazwisko)', 'ojciec chrzestny (miejsce)',
                    'matka chrzestna (imię)', 'matka chrzestna (nazwisko)', 'matka chrzestna (miejsce)',
                    'ksiądz (imię)', 'ksiądz (nazwisko)', 'ksiądz (zawód)',
                    'zgł. (imię)', 'zgł. (nazwisko)', 'zgł. (zawód)', 'zgł. (wiek)', 'zgł. (miejsce)',
                    'świadek 1 (imię)', 'świadek 1 (nazwisko)', 'świadek 1 (zawód)', 'świadek 1 (miejsce)',
                    'świadek 2 (imię)', 'świadek 2 (nazwisko)', 'świadek 2 (zawód)', 'świadek 2 (miejsce)',
                    'świadek 3 (imię)', 'świadek 3 (nazwisko)', 'świadek 3 (zawód)', 'świadek 3 (miejsce)',
                    'uwagi', 'opis źródła'
                ];
            }
            
            // Mapowanie kolumn na fieldValues keys
            const columnMap = {
                'id źródłowe': 'original_id',
                'księga (nr)': 'ksiega_nr',
                'strona (nr)': 'strona_nr',
                'numer aktu': 'nr_aktu',
                'data chrztu': 'christening_date',
                'data zgłoszenia': 'report_date',
                'parafia': 'parafia',
                'imię dziecka': 'dziecko_imie',
                'nazwisko dziecka': 'dziecko_nazwisko',
                'data ur. dziecka': 'dziecko_data_ur',
                'płeć dziecka': 'dziecko_plec',
                'status dziecka': 'dziecko_status',
                'ojciec (imię)': 'ojciec_imie',
                'ojciec (nazwisko)': 'ojciec_nazwisko',
                'ojciec (wiek)': 'ojciec_wiek',
                'ojciec (zawód)': 'ojciec_zawod',
                'ojciec (stan cywilny)': 'ojciec_stan_cywilny',
                'matka (imię)': 'matka_imie',
                'matka (nazwisko)': 'matka_nazwisko',
                'matka (panieńskie)': 'matka_panienskie',
                'matka (wiek)': 'matka_lata',
                'matka (zawód)': 'matka_zawod',
                'matka (stan cywilny)': 'matka_stan_cywilny',
                'matka (miejsce)': 'matka_miejsce',
                'ojciec chrzestny (imię)': 'ojciec_chrzestny_imie',
                'ojciec chrzestny (nazwisko)': 'ojciec_chrzestny_nazwisko',
                'ojciec chrzestny (miejsce)': 'ojciec_chrzestny_miejsce',
                'matka chrzestna (imię)': 'matka_chrzestna_imie',
                'matka chrzestna (nazwisko)': 'matka_chrzestna_nazwisko',
                'matka chrzestna (miejsce)': 'matka_chrzestna_miejsce',
                'ksiądz (imię)': 'ksiadz_imie',
                'ksiądz (nazwisko)': 'ksiadz_nazwisko',
                'ksiądz (zawód)': 'ksiadz_zawod',
                'zgł. (imię)': 'zglaszajacy_imie',
                'zgł. (nazwisko)': 'zglaszajacy_nazwisko',
                'zgł. (zawód)': 'zglaszajacy_zawod',
                'zgł. (wiek)': 'zglaszajacy_wiek',
                'zgł. (miejsce)': 'zglaszajacy_miejsce',
                'świadek 1 (imię)': 'swiadek_1_imie',
                'świadek 1 (nazwisko)': 'swiadek_1_nazwisko',
                'świadek 1 (zawód)': 'swiadek_1_zawod',
                'świadek 1 (miejsce)': 'swiadek_1_miejsce',
                'świadek 2 (imię)': 'swiadek_2_imie',
                'świadek 2 (nazwisko)': 'swiadek_2_nazwisko',
                'świadek 2 (zawód)': 'swiadek_2_zawod',
                'świadek 2 (miejsce)': 'swiadek_2_miejsce',
                'świadek 3 (imię)': 'swiadek_3_imie',
                'świadek 3 (nazwisko)': 'swiadek_3_nazwisko',
                'świadek 3 (zawód)': 'swiadek_3_zawod',
                'świadek 3 (miejsce)': 'swiadek_3_miejsce',
                'uwagi': 'custom_note',
                'opis źródła': 'notes_org'
            };
            
            // Przetwarzaj wiersze danych
            let importedCount = 0;
            dataLines.forEach((line, lineIdx) => {
                const columns = line.split('\t');
                const act = app.imageActs[lineIdx];
                
                if (!act) {
                    console.warn(`⚠️ Brak aktu dla wiersza ${lineIdx + 1}`);
                    return;
                }
                
                if (!act.fieldValues) {
                    act.fieldValues = {};
                }
                
                // Mapuj kolumny na fieldValues
                columns.forEach((value, colIdx) => {
                    if (value.trim()) {
                        const header = headers[colIdx]?.toLowerCase().trim() || '';
                        const fieldKey = columnMap[header];
                        
                        if (fieldKey) {
                            act.fieldValues[fieldKey] = value.trim();
                        }
                    }
                });
                
                importedCount++;
                updateCurrentRowInTable();
            });
            
            // Zapisz i odśwież
            saveStorage();
            renderRecordsTable();
            closePasteDialog();
            
            notify(`✅ Wklejono ${importedCount} wierszy danych`, 'success');
            console.log(`📋 Imported ${importedCount} rows from paste data`);
        }
        
        // ===== EXPOSE FUNCTIONS TO WINDOW =====
        window.showPasteDialog = showPasteDialog;
        window.closePasteDialog = closePasteDialog;
        window.processPastedData = processPastedData;
    </script>
    
    <!-- OpenCV.js - Asynchroniczne załadowanie -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>
    <script>
        // Callback gdy OpenCV jest gotowy
        if (typeof cv !== 'undefined') {
            cv.onRuntimeInitialized = onOpenCvReady;
        }
    </script>
</body>
</html>
