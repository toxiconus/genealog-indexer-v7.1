<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Wyczy≈õƒá Supabase - Batch Delete</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 30px; 
            background: #1a1a1a; 
            color: #0f0;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { color: #f00; margin-bottom: 20px; }
        .status { 
            margin: 15px 0; 
            padding: 10px; 
            border-left: 4px solid #0f0; 
            background: #0a0a0a;
        }
        .error { border-left-color: #f00; color: #f00; }
        .warning { border-left-color: #ff0; color: #ff0; }
        .success { border-left-color: #0f0; color: #0f0; }
        button { 
            padding: 15px 30px; 
            background: #f00; 
            color: white; 
            border: none; 
            cursor: pointer; 
            margin: 20px 0;
            font-size: 16px;
            border-radius: 5px;
        }
        button:hover { background: #c00; }
        button:disabled { background: #666; cursor: not-allowed; }
        #progressBar {
            height: 30px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }
        #progress {
            height: 100%;
            background: linear-gradient(90deg, #0f0, #00ff00);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }
        #output { margin-top: 30px; }
    </style>
</head>
<body>
    <h1>üßπ WYCZY≈öƒÜ SUPABASE - BATCH DELETE</h1>
    <p>‚ö†Ô∏è OSTRZE≈ªENIE: To usunie WSZYSTKIE 22260 rekord√≥w!</p>
    <button id="cleanBtn" onclick="batchDelete()">üóëÔ∏è ZACZNIJ CZYSZCZENIE</button>
    <button id="stopBtn" onclick="stopDelete()" style="background: #ff6600; display: none;">‚èπÔ∏è ZATRZYMAJ</button>
    
    <div id="progressBar" style="display: none;">
        <div id="progress"></div>
    </div>
    <div id="progressText" style="color: #0f0; text-align: center; margin-bottom: 20px;"></div>
    
    <div id="output"></div>

    <script>
        let isDeleting = false;

        function log(msg, type = 'status') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('output').appendChild(div);
            console.log(msg);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function setProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('progress').textContent = percent + '%';
            document.getElementById('progressText').textContent = `Usuniƒôto ${current} / ${total} rekord√≥w`;
        }

        const SUPABASE_URL = 'https://jbwkrconzozhgzikabmv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_X0Qm9TSqq0nOOtCo8RycMQ_PeirqbMt';

        async function batchDelete() {
            if (!confirm('‚ö†Ô∏è NA PEWNO? Usuniesz 22260 rekord√≥w! Tego nie mo≈ºna cofnƒÖƒá!')) {
                return;
            }

            isDeleting = true;
            document.getElementById('cleanBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('progressBar').style.display = 'block';

            log('‚è≥ Zaczynam czyszczenie batch DELETE...', 'warning');
            
            try {
                const batchSize = 1000; // Usu≈Ñ po 1000 naraz
                let deleted = 0;
                const totalToDelete = 22260;

                while (isDeleting && deleted < totalToDelete) {
                    const remaining = totalToDelete - deleted;
                    const size = Math.min(batchSize, remaining);

                    log(`‚è≥ Batch: DELETE first ${size} records...`, 'warning');

                    // DELETE z WHERE clause: id >= 0 (wszystkie) + LIMIT
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/public_imports?id=gte.0&limit=${size}`,
                        {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );

                    if (!response.ok) {
                        const error = await response.text();
                        log(`‚ùå B≈ÇƒÖd batch: ${response.status} - ${error}`, 'error');
                        break;
                    }

                    deleted += size;
                    setProgress(deleted, totalToDelete);
                    log(`‚úÖ Batch OK: ${deleted}/${totalToDelete}`, 'success');

                    // Czekaj 500ms miƒôdzy batches
                    await new Promise(r => setTimeout(r, 500));
                }

                if (deleted >= totalToDelete) {
                    log('‚úÖ WSZYSTKIE REKORDY USUNIƒòTE!', 'success');
                    log('üìä Tabela jest teraz pusta', 'success');
                    log('', 'status');
                    log('üîÑ NASTƒòPNE KROKI:', 'warning');
                    log('1. Otw√≥rz import-ch-blin.html', 'status');
                    log('2. Za≈Çaduj plik CH BLIN.txt', 'status');
                    log('3. Mapuj kolumny prawid≈Çowo', 'status');
                    log('4. Kliknij EKSPORTUJ DO SUPABASE', 'status');
                    log('5. Czekaj a≈º pasek postƒôpu dojdzie do 100%', 'status');
                } else {
                    log('‚ö†Ô∏è Czyszczenie przerwane', 'warning');
                }

            } catch (error) {
                log(`‚ùå WyjƒÖtek: ${error.message}`, 'error');
            } finally {
                isDeleting = false;
                document.getElementById('cleanBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            }
        }

        function stopDelete() {
            isDeleting = false;
            log('‚èπÔ∏è Zatrzymano', 'warning');
        }

        window.batchDelete = batchDelete;
        window.stopDelete = stopDelete;

        log('‚úÖ Skrypt za≈Çadowany - kliknij przycisk aby wyczy≈õciƒá', 'warning');
    </script>
</body>
</html>
